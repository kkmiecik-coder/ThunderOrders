{% extends "admin/base_admin.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin/orders-list.css') }}">
<style>
/* Bulk Toolbar Animation Override - ensures animation works */
#bulkToolbar.bulk-toolbar {
    display: block !important;
    opacity: 1;
    filter: blur(0);
    transform: translateX(-50%) translateY(0);
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1),
                opacity 0.3s ease-out,
                filter 0.3s ease-out;
}
#bulkToolbar.bulk-toolbar.hidden {
    opacity: 0;
    pointer-events: none;
    transform: translateX(-50%) translateY(100px);
    filter: blur(8px);
}
</style>
{% endblock %}

{% block content %}
<div class="orders-page-wrapper">
    <!-- Status Filter Sidebar -->
    <aside class="status-sidebar">
        <div class="status-sidebar-header">
            <h3>Statusy</h3>
        </div>
        <div class="status-list">
            <!-- All orders -->
            <a href="{{ url_for('orders.admin_list', **request.args|reject_key('status')) }}"
               class="status-item {% if not request.args.get('status') %}active{% endif %}">
                <span class="status-name">Wszystkie</span>
                <span class="status-count">{{ total_orders_count }}</span>
            </a>

            <!-- Individual statuses -->
            {% for status in statuses_with_counts %}
            <a href="{{ url_for('orders.admin_list', status=status.slug) }}"
               class="status-item {% if request.args.get('status') == status.slug %}active{% endif %}">
                <span class="status-dot" style="background-color: {{ status.badge_color }};"></span>
                <span class="status-name">{{ status.name }}</span>
                <span class="status-count" style="background-color: {{ status.badge_color }};">{{ status.count }}</span>
            </a>
            {% endfor %}
        </div>
    </aside>

    <!-- Main Content -->
    <div class="orders-list-page">
        <!-- Page Header + Quick Filters -->
        <div class="page-header">
            <div class="page-header-left">
                <h1>Zam√≥wienia</h1>
                <button class="btn btn-primary" id="addOrderBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12h14"/>
                    </svg>
                    Dodaj zam√≥wienie
                </button>
            </div>
            <div class="quick-filters">
                <a href="{{ url_for('orders.admin_list') }}"
                   class="filter-btn {% if not request.args.get('order_type') %}active{% endif %}">
                    Wszystkie
                </a>
                <a href="{{ url_for('orders.admin_list', order_type='pre_order') }}"
                   class="filter-btn {% if request.args.get('order_type') == 'pre_order' %}active{% endif %}">
                    Pre-order
                </a>
                <a href="{{ url_for('orders.admin_list', order_type='on_hand') }}"
                   class="filter-btn {% if request.args.get('order_type') == 'on_hand' %}active{% endif %}">
                    On-hand
                </a>
                <a href="{{ url_for('orders.admin_list', order_type='exclusive') }}"
                   class="filter-btn {% if request.args.get('order_type') == 'exclusive' %}active{% endif %}">
                    Exclusive
                </a>
            </div>
        </div>

    <!-- Advanced Filters (collapsible) -->
    {% set active_filters = namespace(count=0) %}
    {% if request.args.get('date_from') %}{% set active_filters.count = active_filters.count + 1 %}{% endif %}
    {% if request.args.get('date_to') %}{% set active_filters.count = active_filters.count + 1 %}{% endif %}
    {% if request.args.get('search') %}{% set active_filters.count = active_filters.count + 1 %}{% endif %}
    {% if request.args.get('products') %}{% set active_filters.count = active_filters.count + 1 %}{% endif %}
    <div class="filters-panel{% if active_filters.count > 0 %} expanded{% endif %}" id="filtersPanel">
        <div class="filters-header" onclick="toggleFilters()">
            <div class="filters-header-left">
                <svg class="filters-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                </svg>
                <span>Filtry zaawansowane</span>
                {% if active_filters.count > 0 %}
                <span class="filters-badge">{{ active_filters.count }}</span>
                {% endif %}
            </div>
            <svg class="chevron{% if active_filters.count > 0 %} rotated{% endif %}" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 01.708 0L8 10.293l5.646-5.647a.5.5 0 01.708.708l-6 6a.5.5 0 01-.708 0l-6-6a.5.5 0 010-.708z"/>
            </svg>
        </div>
        <div class="filters-content{% if active_filters.count > 0 %} expanded{% endif %}">
            <form method="get" action="{{ url_for('orders.admin_list') }}" id="filterForm">
                <div class="filters-grid">
                    <!-- Search -->
                    <div class="form-group form-group-search">
                        <label class="form-label">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="m21 21-4.35-4.35"></path>
                            </svg>
                            Szukaj
                        </label>
                        <div class="input-icon-wrapper">
                            <svg class="input-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="m21 21-4.35-4.35"></path>
                            </svg>
                            {{ filter_form.search(class="form-input form-input-icon", placeholder="Numer, klient, email...") }}
                        </div>
                    </div>

                    <!-- Date range -->
                    <div class="form-group">
                        <label class="form-label">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            Data od
                        </label>
                        {{ filter_form.date_from(class="form-input") }}
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            Data do
                        </label>
                        {{ filter_form.date_to(class="form-input") }}
                    </div>

                    <!-- Product filter (full width) -->
                    <div class="form-group form-group-full">
                        <label class="form-label">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                                <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                                <line x1="12" y1="22.08" x2="12" y2="12"></line>
                            </svg>
                            Produkty
                        </label>
                        <div class="product-filter-container">
                            <div class="product-search-wrapper">
                                <input type="text"
                                       class="form-input"
                                       id="productFilterSearch"
                                       placeholder="Wpisz nazwƒô lub SKU produktu..."
                                       autocomplete="off">
                                <div class="product-search-results" id="productSearchResults"></div>
                            </div>
                            <div class="selected-products" id="selectedProducts">
                                <!-- Selected products will be added here by JS -->
                            </div>
                            <input type="hidden" name="products" id="productsHiddenInput" value="{{ request.args.get('products', '') }}">
                        </div>
                    </div>

                </div>

                <!-- Action buttons -->
                <div class="filters-actions">
                    <a href="{{ url_for('orders.admin_list') }}" class="btn btn-ghost">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18"></path>
                            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                        </svg>
                        Wyczy≈õƒá filtry
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                        </svg>
                        Zastosuj filtry
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Active Filters Tags -->
    {% set has_active_filters = request.args.get('date_from') or request.args.get('date_to') or request.args.get('search') or request.args.get('order_type') or request.args.get('products') %}
    {% if has_active_filters %}
    <div class="active-filters-bar">
        <span class="active-filters-label">Aktywne filtry:</span>
        <div class="active-filters-tags">
            {% if request.args.get('order_type') %}
            <a href="{{ url_for('orders.admin_list', **request.args|reject_key('order_type')) }}" class="filter-tag">
                <span>Typ:
                    {% if request.args.get('order_type') == 'pre_order' %}Pre-order
                    {% elif request.args.get('order_type') == 'on_hand' %}On-hand
                    {% elif request.args.get('order_type') == 'exclusive' %}Exclusive
                    {% else %}{{ request.args.get('order_type') }}{% endif %}
                </span>
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </a>
            {% endif %}
            {% if request.args.get('date_from') %}
            <a href="{{ url_for('orders.admin_list', **request.args|reject_key('date_from')) }}" class="filter-tag">
                <span>Od: {{ request.args.get('date_from') }}</span>
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </a>
            {% endif %}
            {% if request.args.get('date_to') %}
            <a href="{{ url_for('orders.admin_list', **request.args|reject_key('date_to')) }}" class="filter-tag">
                <span>Do: {{ request.args.get('date_to') }}</span>
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </a>
            {% endif %}
            {% if request.args.get('search') %}
            <a href="{{ url_for('orders.admin_list', **request.args|reject_key('search')) }}" class="filter-tag">
                <span>Szukaj: "{{ request.args.get('search') }}"</span>
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </a>
            {% endif %}
            {% if request.args.get('products') %}
            <a href="{{ url_for('orders.admin_list', **request.args|reject_key('products')) }}" class="filter-tag">
                <span>Produkty: {{ request.args.get('products').split(',')|length }} wybranych</span>
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </a>
            {% endif %}
        </div>
        <a href="{{ url_for('orders.admin_list') }}" class="clear-all-filters">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
            </svg>
            Wyczy≈õƒá wszystkie
        </a>
    </div>
    {% endif %}

    <!-- Bulk Actions Toolbar (floating, shows when checkboxes checked) -->
    <div id="bulkToolbar" class="bulk-toolbar hidden">
        <div class="bulk-toolbar-content">
            <span class="selected-count" id="selectedCount">0 zaznaczonych</span>
            <div class="bulk-actions">
                <div class="bulk-status-wrapper">
                    <button class="btn-bulk" data-action="status" title="Zmie≈Ñ status">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                            <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/>
                        </svg>
                        Zmie≈Ñ status
                        <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16" class="dropdown-arrow">
                            <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/>
                        </svg>
                    </button>
                    <div class="bulk-status-dropdown" id="bulkStatusDropdown">
                        {% for status in statuses_with_counts %}
                        <div class="bulk-status-option" data-status="{{ status.slug }}">
                            <span class="badge" style="background-color: {{ status.badge_color }}; color: #fff;">{{ status.name }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <button class="btn-bulk" data-action="export" title="Export Excel">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                        <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                    </svg>
                    Export Excel
                </button>
                <button class="btn-bulk" data-action="wms" title="Zabierz do WMS">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M0 2.5A.5.5 0 0 1 .5 2H2a.5.5 0 0 1 .485.379L2.89 4H14.5a.5.5 0 0 1 .485.621l-1.5 6A.5.5 0 0 1 13 11H4a.5.5 0 0 1-.485-.379L1.61 3H.5a.5.5 0 0 1-.5-.5zM3.14 5l1.25 5h8.22l1.25-5H3.14zM5 13a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0zm9-1a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0z"/>
                    </svg>
                    Zabierz do WMS
                </button>
                {% if current_user.is_admin %}
                <button class="btn-bulk btn-bulk-danger" data-action="delete" title="Usu≈Ñ">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                    </svg>
                    Usu≈Ñ
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Table Header Bar (results count + per page) -->
    <div class="table-header-bar">
        <div class="results-count">
            {% if orders.total %}
            Wy≈õwietlanie {{ ((orders.page - 1) * orders.per_page) + 1 }}-{{ [orders.page * orders.per_page, orders.total]|min }} z {{ orders.total }} zam√≥wie≈Ñ
            {% else %}
            Brak zam√≥wie≈Ñ
            {% endif %}
        </div>
        <div class="per-page-selector">
            <label for="perPageSelect">Na stronƒô:</label>
            <select id="perPageSelect" onchange="changePerPage(this.value)">
                <option value="20" {% if request.args.get('per_page', '20') == '20' %}selected{% endif %}>20</option>
                <option value="50" {% if request.args.get('per_page') == '50' %}selected{% endif %}>50</option>
                <option value="100" {% if request.args.get('per_page') == '100' %}selected{% endif %}>100</option>
            </select>
        </div>
    </div>

    <!-- Orders Table -->
    <div class="table-container" id="ordersTable">
        {% if orders.items %}
        <table class="orders-table orders-table-new">
            <thead>
                <tr>
                    <th class="checkbox-col">
                        <input type="checkbox" id="selectAll" aria-label="Zaznacz wszystkie">
                    </th>
                    <th class="col-number">Numer</th>
                    <th class="col-customer">Imiƒô nazwisko</th>
                    <th class="col-items hide-mobile">Przedmioty</th>
                    <th class="col-info">Informacje</th>
                    <th class="col-amount text-right">Kwota</th>
                    <th class="col-extra">Info dodatkowe</th>
                    <th class="col-date">Data z≈Ço≈ºenia</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders.items %}
                <tr data-order-id="{{ order.id }}">
                    <!-- Checkbox -->
                    <td class="checkbox-col">
                        <input type="checkbox" class="order-checkbox" value="{{ order.id }}" aria-label="Zaznacz zam√≥wienie {{ order.order_number }}">
                    </td>

                    <!-- Numer zam√≥wienia -->
                    <td class="col-number">
                        <a href="{{ url_for('orders.admin_detail', order_id=order.id) }}" class="order-number-link">
                            {{ order.order_number }}
                        </a>
                    </td>

                    <!-- Klient z flagƒÖ i ≈∫r√≥d≈Çem -->
                    <td class="col-customer">
                        <div class="customer-cell-new">
                            <div class="customer-name-row">
                                <span class="country-flag" data-tooltip="{{ order.shipping_country or 'Polska' }}">{{ order.shipping_country_flag }}</span>
                                {% if order.is_guest_order %}
                                    <span class="customer-name">{{ order.guest_name }}</span>
                                    <span class="badge badge-guest-sm">Go≈õƒá</span>
                                {% elif order.user %}
                                    <a href="{{ url_for('admin.client_detail', id=order.user.id) }}" class="customer-name customer-link">
                                        {{ order.user.full_name }}
                                    </a>
                                {% else %}
                                    <span class="customer-name text-muted">Nieznany</span>
                                {% endif %}
                            </div>
                            <div class="customer-source">{{ order.order_source_display }}</div>
                        </div>
                    </td>

                    <!-- Przedmioty (ukryte na mobile) -->
                    <td class="col-items hide-mobile">
                        <div class="items-list" data-order-id="{{ order.id }}">
                            {% set visible_items = order.items[:3] %}
                            {% set hidden_items = order.items[3:] %}
                            {% for item in visible_items %}
                            {% if item.fulfilled_quantity is not none and item.fulfilled_quantity > 0 and item.fulfilled_quantity < item.quantity %}
                            {# CZƒò≈öCIOWE ZREALIZOWANIE - dwie linie #}
                            <div class="item-row">
                                <div class="item-thumb-wrapper">
                                    <img src="{{ item.product_image_url }}" alt="" class="item-thumb">
                                    {% if item.fulfilled_quantity > 1 %}
                                    <span class="item-qty-badge">{{ item.fulfilled_quantity }}</span>
                                    {% endif %}
                                </div>
                                <div class="item-details">
                                    <span class="item-name" title="{{ item.product_name }} (z≈Çapane)">{{ item.fulfilled_quantity }}√ó {{ item.product_name|truncate(35, True) }}</span>
                                    <span class="item-price">{{ "%.2f"|format(item.price) }} z≈Ç/szt</span>
                                </div>
                            </div>
                            <div class="item-row item-outside-set">
                                <div class="item-thumb-wrapper">
                                    <img src="{{ item.product_image_url }}" alt="" class="item-thumb">
                                    {% if item.quantity - item.fulfilled_quantity > 1 %}
                                    <span class="item-qty-badge">{{ item.quantity - item.fulfilled_quantity }}</span>
                                    {% endif %}
                                </div>
                                <div class="item-details">
                                    <span class="item-name text-outside-set" title="{{ item.product_name }} (poza setem)">{{ item.quantity - item.fulfilled_quantity }}√ó {{ item.product_name|truncate(35, True) }}</span>
                                    <span class="item-price text-outside-set">0.00 z≈Ç/szt</span>
                                </div>
                            </div>
                            {% elif item.is_set_fulfilled == false %}
                            {# CA≈ÅO≈öƒÜ POZA SETEM #}
                            <div class="item-row item-outside-set">
                                <div class="item-thumb-wrapper">
                                    <img src="{{ item.product_image_url }}" alt="" class="item-thumb">
                                    {% if item.quantity > 1 %}
                                    <span class="item-qty-badge">{{ item.quantity }}</span>
                                    {% endif %}
                                </div>
                                <div class="item-details">
                                    <span class="item-name text-outside-set" title="{{ item.product_name }} (poza setem)">{{ item.quantity }}√ó {{ item.product_name|truncate(35, True) }}</span>
                                    <span class="item-price text-outside-set">0.00 z≈Ç/szt</span>
                                </div>
                            </div>
                            {% else %}
                            {# NORMALNIE #}
                            <div class="item-row{% if item.is_full_set %} item-full-set{% elif item.is_custom %} item-custom{% endif %}">
                                <div class="item-thumb-wrapper">
                                    {% if item.is_full_set %}
                                    <div class="item-thumb item-thumb-icon" style="background: linear-gradient(135deg, #9D4EDD 0%, #7B2CBF 100%);">‚ú®</div>
                                    {% elif item.is_custom %}
                                    <div class="item-thumb item-thumb-icon" style="background: linear-gradient(135deg, #FF8500 0%, #FF6D00 100%);">üì¶</div>
                                    {% else %}
                                    <img src="{{ item.product_image_url }}" alt="" class="item-thumb">
                                    {% endif %}
                                    {% if item.quantity > 1 %}
                                    <span class="item-qty-badge">{{ item.quantity }}</span>
                                    {% endif %}
                                </div>
                                <div class="item-details">
                                    <span class="item-name" title="{{ item.product_name }}{% if item.is_full_set %} (Pe≈Çny Set){% elif item.is_custom %} (Rƒôczny){% endif %}">{{ item.quantity }}√ó {{ item.product_name|truncate(35, True) }}{% if item.is_full_set %}<span class="item-badge-mini item-badge-set">SET</span>{% elif item.is_custom %}<span class="item-badge-mini item-badge-custom">RƒòCZNY</span>{% endif %}</span>
                                    <span class="item-price">{{ "%.2f"|format(item.price) }} z≈Ç/szt</span>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                            {% if hidden_items|length > 0 %}
                            <div class="items-hidden" id="hiddenItems-{{ order.id }}" style="display: none;">
                                {% for item in hidden_items %}
                                {% if item.fulfilled_quantity is not none and item.fulfilled_quantity > 0 and item.fulfilled_quantity < item.quantity %}
                                {# CZƒò≈öCIOWE ZREALIZOWANIE - dwie linie #}
                                <div class="item-row">
                                    <div class="item-thumb-wrapper">
                                        <img src="{{ item.product_image_url }}" alt="" class="item-thumb">
                                        {% if item.fulfilled_quantity > 1 %}
                                        <span class="item-qty-badge">{{ item.fulfilled_quantity }}</span>
                                        {% endif %}
                                    </div>
                                    <div class="item-details">
                                        <span class="item-name" title="{{ item.product_name }} (z≈Çapane)">{{ item.fulfilled_quantity }}√ó {{ item.product_name|truncate(35, True) }}</span>
                                        <span class="item-price">{{ "%.2f"|format(item.price) }} z≈Ç/szt</span>
                                    </div>
                                </div>
                                <div class="item-row item-outside-set">
                                    <div class="item-thumb-wrapper">
                                        <img src="{{ item.product_image_url }}" alt="" class="item-thumb">
                                        {% if item.quantity - item.fulfilled_quantity > 1 %}
                                        <span class="item-qty-badge">{{ item.quantity - item.fulfilled_quantity }}</span>
                                        {% endif %}
                                    </div>
                                    <div class="item-details">
                                        <span class="item-name text-outside-set" title="{{ item.product_name }} (poza setem)">{{ item.quantity - item.fulfilled_quantity }}√ó {{ item.product_name|truncate(35, True) }}</span>
                                        <span class="item-price text-outside-set">0.00 z≈Ç/szt</span>
                                    </div>
                                </div>
                                {% elif item.is_set_fulfilled == false %}
                                {# CA≈ÅO≈öƒÜ POZA SETEM #}
                                <div class="item-row item-outside-set">
                                    <div class="item-thumb-wrapper">
                                        <img src="{{ item.product_image_url }}" alt="" class="item-thumb">
                                        {% if item.quantity > 1 %}
                                        <span class="item-qty-badge">{{ item.quantity }}</span>
                                        {% endif %}
                                    </div>
                                    <div class="item-details">
                                        <span class="item-name text-outside-set" title="{{ item.product_name }} (poza setem)">{{ item.quantity }}√ó {{ item.product_name|truncate(35, True) }}</span>
                                        <span class="item-price text-outside-set">0.00 z≈Ç/szt</span>
                                    </div>
                                </div>
                                {% else %}
                                {# NORMALNIE #}
                                <div class="item-row{% if item.is_full_set %} item-full-set{% elif item.is_custom %} item-custom{% endif %}">
                                    <div class="item-thumb-wrapper">
                                        {% if item.is_full_set %}
                                        <div class="item-thumb item-thumb-icon" style="background: linear-gradient(135deg, #9D4EDD 0%, #7B2CBF 100%);">‚ú®</div>
                                        {% elif item.is_custom %}
                                        <div class="item-thumb item-thumb-icon" style="background: linear-gradient(135deg, #FF8500 0%, #FF6D00 100%);">üì¶</div>
                                        {% else %}
                                        <img src="{{ item.product_image_url }}" alt="" class="item-thumb">
                                        {% endif %}
                                        {% if item.quantity > 1 %}
                                        <span class="item-qty-badge">{{ item.quantity }}</span>
                                        {% endif %}
                                    </div>
                                    <div class="item-details">
                                        <span class="item-name" title="{{ item.product_name }}{% if item.is_full_set %} (Pe≈Çny Set){% elif item.is_custom %} (Rƒôczny){% endif %}">{{ item.quantity }}√ó {{ item.product_name|truncate(35, True) }}{% if item.is_full_set %}<span class="item-badge-mini item-badge-set">SET</span>{% elif item.is_custom %}<span class="item-badge-mini item-badge-custom">RƒòCZNY</span>{% endif %}</span>
                                        <span class="item-price">{{ "%.2f"|format(item.price) }} z≈Ç/szt</span>
                                    </div>
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                            <button type="button" class="items-toggle-btn" onclick="toggleOrderItems({{ order.id }}, {{ order.items|length }})">
                                <span class="toggle-text">W sumie {{ order.items|length }} przedmiot√≥w - poka≈º pozosta≈Çe</span>
                            </button>
                            {% endif %}
                        </div>
                    </td>

                    <!-- Informacje (admin_notes) -->
                    <td class="col-info">
                        {% if order.admin_notes %}
                        <div class="info-notes" title="{{ order.admin_notes }}">
                            <span class="info-label">Uwagi:</span>
                            <span class="info-text">{{ order.admin_notes|truncate(40, True) }}</span>
                        </div>
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>

                    <!-- Kwota -->
                    <td class="col-amount text-right">
                        <span class="amount-cell">{{ "%.2f"|format(order.effective_grand_total) }} z≈Ç</span>
                    </td>

                    <!-- Info dodatkowe (status + wysy≈Çka + ikony) -->
                    <td class="col-extra">
                        <div class="extra-info">
                            <!-- Status badge -->
                            <span class="badge status-badge" style="background-color: {{ order.status_badge_color }}; color: #fff;">
                                {{ order.status_display_name }}
                            </span>
                            <!-- Spos√≥b dostawy (tylko gdy jest) -->
                            {% if order.delivery_method and order.delivery_method != '-' %}
                            <span class="delivery-method">{{ order.delivery_method_display }}</span>
                            {% endif %}
                            <!-- Ikony status√≥w -->
                            <div class="status-icons">
                                <!-- P≈Çatno≈õƒá: szara=brak, zielona=OK, czerwona=niezgodna -->
                                <span class="status-icon {% if order.is_fully_paid %}status-icon-active{% elif order.is_partially_paid or order.is_overpaid %}status-icon-warning{% else %}status-icon-inactive{% endif %}" data-tooltip="{% if order.is_fully_paid %}Op≈Çacone{% elif order.is_overpaid %}Nadp≈Çata{% elif order.is_partially_paid %}Czƒô≈õciowo op≈Çacone{% else %}Brak wp≈Çaty{% endif %}">
                                    $
                                </span>
                                <!-- Tracking - klikniƒôcie otwiera ≈õledzenie -->
                                {% if order.has_tracking %}
                                <a href="{{ order.first_tracking_url }}" target="_blank" class="status-icon status-icon-active status-icon-link" data-tooltip="Przesy≈Çka {{ order.first_tracking_number }}">
                                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M0 3.5A1.5 1.5 0 0 1 1.5 2h9A1.5 1.5 0 0 1 12 3.5V5h1.02a1.5 1.5 0 0 1 1.17.563l1.481 1.85a1.5 1.5 0 0 1 .329.938V10.5a1.5 1.5 0 0 1-1.5 1.5H14a2 2 0 1 1-4 0H5a2 2 0 1 1-3.998-.085A1.5 1.5 0 0 1 0 10.5v-7zm1.294 7.456A1.999 1.999 0 0 1 4.732 11h5.536a2.01 2.01 0 0 1 .732-.732V3.5a.5.5 0 0 0-.5-.5h-9a.5.5 0 0 0-.5.5v7a.5.5 0 0 0 .294.456zM12 10a2 2 0 0 1 1.732 1h.768a.5.5 0 0 0 .5-.5V8.35a.5.5 0 0 0-.11-.312l-1.48-1.85A.5.5 0 0 0 13.02 6H12v4zm-9 1a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm9 0a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/>
                                    </svg>
                                </a>
                                {% else %}
                                <span class="status-icon status-icon-inactive" data-tooltip="Brak listu przewozowego">
                                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M0 3.5A1.5 1.5 0 0 1 1.5 2h9A1.5 1.5 0 0 1 12 3.5V5h1.02a1.5 1.5 0 0 1 1.17.563l1.481 1.85a1.5 1.5 0 0 1 .329.938V10.5a1.5 1.5 0 0 1-1.5 1.5H14a2 2 0 1 1-4 0H5a2 2 0 1 1-3.998-.085A1.5 1.5 0 0 1 0 10.5v-7zm1.294 7.456A1.999 1.999 0 0 1 4.732 11h5.536a2.01 2.01 0 0 1 .732-.732V3.5a.5.5 0 0 0-.5-.5h-9a.5.5 0 0 0-.5.5v7a.5.5 0 0 0 .294.456zM12 10a2 2 0 0 1 1.732 1h.768a.5.5 0 0 0 .5-.5V8.35a.5.5 0 0 0-.11-.312l-1.48-1.85A.5.5 0 0 0 13.02 6H12v4zm-9 1a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm9 0a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/>
                                    </svg>
                                </span>
                                {% endif %}
                                <!-- Uwagi sprzedawcy -->
                                <span class="status-icon {% if order.admin_notes %}status-icon-info{% else %}status-icon-inactive{% endif %}" data-tooltip="{% if order.admin_notes %}Uwagi: {{ order.admin_notes|truncate(50) }}{% else %}Brak uwag{% endif %}">
                                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
                                    </svg>
                                </span>
                                <!-- Dow√≥d wp≈Çaty: szara=nie wgrany, ≈º√≥≈Çta=pending, zielona=zaakceptowany, czerwona=odrzucony -->
                                <span class="status-icon {% if order.payment_proof_is_approved %}status-icon-active{% elif order.payment_proof_is_pending %}status-icon-warning{% elif order.payment_proof_is_rejected %}status-icon-danger{% else %}status-icon-inactive{% endif %}" data-tooltip="{% if order.payment_proof_is_approved %}Dow√≥d zaakceptowany{% elif order.payment_proof_is_pending %}Dow√≥d oczekuje na weryfikacjƒô{% elif order.payment_proof_is_rejected %}Dow√≥d odrzucony{% else %}Brak dowodu wp≈Çaty{% endif %}">
                                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4zm2.5 1a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h2a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-2zm0 3a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5zm0 2a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1h-1zm3 0a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1h-1zm3 0a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1h-1zm3 0a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1h-1z"/>
                                    </svg>
                                </span>
                            </div>
                        </div>
                    </td>

                    <!-- Data z≈Ço≈ºenia -->
                    <td class="col-date">
                        <div class="date-cell-new">
                            <span class="date-created">{{ order.created_at|format_datetime('%d.%m.%Y %H:%M') }}</span>
                            <span class="date-updated" title="Ostatnia zmiana statusu">{{ order.updated_at|format_datetime('%d.%m.%Y %H:%M') }}</span>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Pagination -->
        {% if orders.pages > 1 %}
        <div class="pagination">
            <div class="pagination-info">
                Strona {{ orders.page }} z {{ orders.pages }} ({{ orders.total }} zam√≥wie≈Ñ)
            </div>
            <div class="pagination-controls">
                {% if orders.has_prev %}
                <a href="{{ url_for('orders.admin_list', page=orders.prev_num, **request.args) }}"
                   class="pagination-btn">
                    ¬´ Poprzednia
                </a>
                {% endif %}

                {% for page_num in orders.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                    {% if page_num %}
                        <a href="{{ url_for('orders.admin_list', page=page_num, **request.args) }}"
                           class="pagination-btn {% if page_num == orders.page %}active{% endif %}">
                            {{ page_num }}
                        </a>
                    {% else %}
                        <span class="pagination-ellipsis">...</span>
                    {% endif %}
                {% endfor %}

                {% if orders.has_next %}
                <a href="{{ url_for('orders.admin_list', page=orders.next_num, **request.args) }}"
                   class="pagination-btn">
                    Nastƒôpna ¬ª
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% else %}
        <div class="empty-state">
            <svg width="64" height="64" fill="currentColor" viewBox="0 0 16 16">
                <path d="M0 2.5A.5.5 0 0 1 .5 2H2a.5.5 0 0 1 .485.379L2.89 4H14.5a.5.5 0 0 1 .485.621l-1.5 6A.5.5 0 0 1 13 11H4a.5.5 0 0 1-.485-.379L1.61 3H.5a.5.5 0 0 1-.5-.5zM3.14 5l1.25 5h8.22l1.25-5H3.14zM5 13a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0zm9-1a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0z"/>
            </svg>
            <h3>Brak zam√≥wie≈Ñ</h3>
            <p>Nie znaleziono ≈ºadnych zam√≥wie≈Ñ spe≈ÇniajƒÖcych kryteria</p>
        </div>
        {% endif %}
    </div>
    </div><!-- /.orders-list-page -->
</div><!-- /.orders-page-wrapper -->

<!-- Add Order Modal -->
<div class="modal-overlay" id="addOrderModal">
    <div class="modal-content modal-medium">
        <div class="modal-header">
            <h2>Dodaj zam√≥wienie</h2>
            <button class="modal-close" onclick="closeAddOrderModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <!-- New Client Button -->
            <button class="btn btn-secondary btn-full-width mb-4" id="newClientBtn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="8.5" cy="7" r="4"/>
                    <line x1="20" y1="8" x2="20" y2="14"/>
                    <line x1="23" y1="11" x2="17" y2="11"/>
                </svg>
                Nowy klient
            </button>

            <!-- Search Client -->
            <div class="form-group">
                <label class="form-label">Wyszukaj istniejƒÖcego klienta</label>
                <div class="input-icon-wrapper">
                    <svg class="input-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <input type="text" class="form-input form-input-icon" id="clientSearchInput"
                           placeholder="Wpisz min. 3 znaki (imiƒô, nazwisko, email...)"
                           autocomplete="off">
                </div>
                <small class="form-hint">Szukaj po imieniu, nazwisku lub emailu</small>
            </div>

            <!-- Search Results -->
            <div class="client-search-results" id="clientSearchResults">
                <!-- Results will be loaded here via JS -->
            </div>
        </div>
    </div>
</div>

<!-- New Client Modal -->
<div class="modal-overlay" id="newClientModal">
    <div class="modal-content modal-medium">
        <div class="modal-header">
            <h2>Nowy klient</h2>
            <button class="modal-close" onclick="closeNewClientModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <form id="newClientForm">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Imiƒô *</label>
                        <input type="text" class="form-input" name="first_name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nazwisko *</label>
                        <input type="text" class="form-input" name="last_name" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Email *</label>
                    <input type="email" class="form-input" name="email" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Telefon</label>
                    <input type="tel" class="form-input" name="phone">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-ghost" onclick="closeNewClientModal()">Anuluj</button>
                    <button type="submit" class="btn btn-primary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                        Utw√≥rz i przejd≈∫ do zam√≥wienia
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Delete Confirmation Modal -->
<div class="modal-overlay" id="bulkDeleteModal">
    <div class="modal-content modal-medium">
        <div class="modal-header">
            <h2>Usu≈Ñ zam√≥wienia</h2>
            <button class="modal-close" onclick="closeBulkDeleteModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="bulk-delete-warning">
                <svg width="48" height="48" fill="currentColor" viewBox="0 0 16 16" class="warning-icon">
                    <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                </svg>
                <p>Czy na pewno chcesz usunƒÖƒá <strong id="bulkDeleteCount">0</strong> zam√≥wie≈Ñ?</p>
                <p class="warning-text">Ta operacja jest nieodwracalna!</p>
            </div>
            <div class="bulk-delete-orders-list" id="bulkDeleteOrdersList">
                <!-- Lista zam√≥wie≈Ñ do usuniƒôcia -->
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-ghost" onclick="closeBulkDeleteModal()">Anuluj</button>
            <button type="button" class="btn btn-danger" id="bulkDeleteConfirmBtn" onclick="confirmBulkDelete()">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                </svg>
                Usu≈Ñ zam√≥wienia
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/pages/admin/orders-list.js') }}"></script>
{% endblock %}
