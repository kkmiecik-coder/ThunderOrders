{% extends "admin/base_admin.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin/orders-list.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin/shipping-requests-list.css') }}">
{% endblock %}

{% block content %}
<div class="orders-page-wrapper shipping-requests-page">
    <!-- Status Filter Sidebar -->
    <aside class="status-sidebar">
        <div class="status-sidebar-header">
            <h3>Statusy</h3>
        </div>
        <div class="status-list">
            <!-- All requests -->
            <a href="{{ url_for('orders.admin_shipping_requests_list') }}"
               class="status-item {% if not current_status %}active{% endif %}">
                <span class="status-name">Wszystkie</span>
            </a>

            <!-- Individual statuses -->
            {% for status in statuses %}
            <a href="{{ url_for('orders.admin_shipping_requests_list', status=status.slug) }}"
               class="status-item {% if current_status == status.slug %}active{% endif %}">
                <span class="status-dot" style="background-color: {{ status.badge_color }};"></span>
                <span class="status-name">{{ status.name }}</span>
            </a>
            {% endfor %}
        </div>
    </aside>

    <!-- Main Content -->
    <div class="orders-list-page">
        <!-- Page Header -->
        <div class="page-header">
            <div class="page-header-left">
                <h1>Zlecenia wysyłki</h1>
            </div>
            <div class="page-header-right">
                <!-- Search -->
                <form method="get" action="{{ url_for('orders.admin_shipping_requests_list') }}" class="search-form">
                    {% if current_status %}
                    <input type="hidden" name="status" value="{{ current_status }}">
                    {% endif %}
                    <div class="input-icon-wrapper">
                        <svg class="input-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                        <input type="text" name="search" class="form-input form-input-icon" placeholder="Szukaj numeru lub klienta..." value="{{ search }}">
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm">Szukaj</button>
                </form>
            </div>
        </div>

        <!-- Orders Table -->
        <div class="orders-table-wrapper">
            <table class="orders-table">
                <thead>
                    <tr>
                        <th class="col-number">Numer</th>
                        <th class="col-client">Klient</th>
                        <th class="col-orders">Zamówienia</th>
                        <th class="col-address">Adres dostawy</th>
                        <th class="col-cost">Koszt wysyłki</th>
                        <th class="col-tracking">Tracking</th>
                        <th class="col-status">Status</th>
                        <th class="col-date">Data</th>
                        <th class="col-actions">Akcje</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sr in shipping_requests %}
                    <tr class="order-row" data-shipping-request-id="{{ sr.id }}">
                        <td class="col-number">
                            <strong>{{ sr.request_number }}</strong>
                        </td>
                        <td class="col-client">
                            {% if sr.user %}
                                <a href="{{ url_for('admin.client_detail', id=sr.user.id) }}" class="client-link">
                                    {{ sr.user.first_name }} {{ sr.user.last_name }}
                                </a>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="col-orders">
                            <div class="orders-preview-expanded">
                                {% for order in sr.orders %}
                                <div class="order-block">
                                    <a href="{{ url_for('orders.admin_detail', order_id=order.id) }}" class="order-badge-link">{{ order.order_number }}</a>
                                    <div class="order-products">
                                        {% for item in order.items[:3] %}
                                        <div class="order-product-item">
                                            <span class="product-qty">{{ item.quantity }}x</span>
                                            <span class="product-name">{{ item.product_name }}</span>
                                        </div>
                                        {% endfor %}
                                        {% if order.items|length > 3 %}
                                        <div class="order-products-hidden" style="display: none;">
                                            {% for item in order.items[3:] %}
                                            <div class="order-product-item">
                                                <span class="product-qty">{{ item.quantity }}x</span>
                                                <span class="product-name">{{ item.product_name }}</span>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        <button type="button" class="order-products-toggle" onclick="toggleOrderProducts(this)">
                                            +{{ order.items|length - 3 }} więcej...
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </td>
                        <td class="col-address">
                            {% if sr.address_type == 'home' %}
                                <div class="address-preview">
                                    <span class="address-name">{{ sr.shipping_name }}</span>
                                    <span class="address-city">{{ sr.shipping_city }}</span>
                                </div>
                            {% else %}
                                <div class="address-preview pickup">
                                    <span class="address-name">{{ sr.pickup_courier }}</span>
                                    <span class="address-city">{{ sr.pickup_city }}</span>
                                </div>
                            {% endif %}
                        </td>
                        <td class="col-cost">
                            {% if sr.total_shipping_cost %}
                                <strong>{{ "%.2f"|format(sr.total_shipping_cost) }} PLN</strong>
                            {% else %}
                                <span class="text-muted">Brak wyceny</span>
                            {% endif %}
                        </td>
                        <td class="col-tracking">
                            {% if sr.tracking_number %}
                                {% if sr.tracking_url %}
                                    <a href="{{ sr.tracking_url }}" target="_blank" class="tracking-link" title="Śledź przesyłkę">
                                        {{ sr.tracking_number }}
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                            <polyline points="15 3 21 3 21 9"></polyline>
                                            <line x1="10" y1="14" x2="21" y2="3"></line>
                                        </svg>
                                    </a>
                                {% else %}
                                    <span class="tracking-number">{{ sr.tracking_number }}</span>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="col-status">
                            <span class="badge" style="background-color: {{ sr.status_badge_color }};">
                                {{ sr.status_display_name }}
                            </span>
                        </td>
                        <td class="col-date">
                            {{ sr.created_at.strftime('%d.%m.%Y') }}<br>
                            <small class="text-muted">{{ sr.created_at.strftime('%H:%M') }}</small>
                        </td>
                        <td class="col-actions">
                            <div class="actions-wrapper">
                                <button type="button" class="btn btn-sm btn-secondary" onclick="openShippingRequestModal({{ sr.id }})" title="Edytuj">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                                {% if sr.tracking_number %}
                                <a href="{{ sr.tracking_url or '#' }}" target="_blank" class="btn btn-sm btn-ghost" title="Tracking">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                        <circle cx="12" cy="10" r="3"></circle>
                                    </svg>
                                </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="9" class="empty-state">
                            <div class="empty-state-content">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/>
                                    <path d="M3 4h2l3.6 7.59a1 1 0 00.9.56h7.2a1 1 0 00.95-.68l2.25-6.76A1 1 0 0019 3.5H6"/>
                                </svg>
                                <p>Brak zleceń wysyłki</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if pagination.pages > 1 %}
        <div class="pagination-wrapper">
            <nav class="pagination">
                {% if pagination.has_prev %}
                <a href="{{ url_for('orders.admin_shipping_requests_list', page=pagination.prev_num, status=current_status, search=search) }}" class="pagination-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 18l-6-6 6-6"/>
                    </svg>
                </a>
                {% endif %}

                {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                    {% if page_num %}
                        <a href="{{ url_for('orders.admin_shipping_requests_list', page=page_num, status=current_status, search=search) }}"
                           class="pagination-btn {% if page_num == pagination.page %}active{% endif %}">
                            {{ page_num }}
                        </a>
                    {% else %}
                        <span class="pagination-ellipsis">...</span>
                    {% endif %}
                {% endfor %}

                {% if pagination.has_next %}
                <a href="{{ url_for('orders.admin_shipping_requests_list', page=pagination.next_num, status=current_status, search=search) }}" class="pagination-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 18l6-6-6-6"/>
                    </svg>
                </a>
                {% endif %}
            </nav>
            <div class="pagination-info">
                Strona {{ pagination.page }} z {{ pagination.pages }}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Shipping Request Edit Modal -->
<div id="editShippingRequestModal" class="modal-overlay">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2>Zlecenie <span id="srModalNumber"></span></h2>
            <button type="button" class="modal-close" onclick="closeShippingRequestModal()">&times;</button>
        </div>
        <form id="editShippingRequestForm">
            <input type="hidden" id="srModalId" name="id">
            <div class="modal-body">
                <!-- Status, Courier, Tracking and Parcel Size Row -->
                <div class="sr-form-row sr-form-row-4">
                    <div class="form-group">
                        <label for="srStatus">Status</label>
                        <select id="srStatus" name="status" class="form-select">
                            <!-- Populated via JS -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="srCourier">Kurier</label>
                        <select id="srCourier" name="courier" class="form-select">
                            <option value="">-- Wybierz kuriera --</option>
                            <option value="inpost">InPost</option>
                            <option value="dpd">DPD</option>
                            <option value="dhl">DHL</option>
                            <option value="ups">UPS</option>
                            <option value="fedex">FedEx</option>
                            <option value="gls">GLS</option>
                            <option value="pocztex">Pocztex</option>
                            <option value="orlen">Orlen Paczka</option>
                            <option value="other">Inny</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="srTracking">Numer tracking</label>
                        <input type="text" id="srTracking" name="tracking_number" class="form-input" placeholder="Numer przesyłki">
                    </div>
                    <div id="srParcelSizeGroup" class="form-group" style="display: none;">
                        <label for="srParcelSize">Gabaryt</label>
                        <select id="srParcelSize" name="parcel_size" class="form-select">
                            <option value="">-- Wybierz --</option>
                            <option value="A">A - Mały</option>
                            <option value="B">B - Średni</option>
                            <option value="C">C - Duży</option>
                        </select>
                    </div>
                </div>

                <!-- Total Cost Row -->
                <div class="sr-form-row sr-cost-row">
                    <div class="form-group">
                        <label for="srTotalCost">Całkowity koszt wysyłki</label>
                        <div class="sr-cost-input-group">
                            <input type="number" id="srTotalCost" name="total_cost" class="form-input" step="0.01" min="0" placeholder="0.00">
                            <span class="currency">PLN</span>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="distributeShippingCost()" title="Rozłóż równo na zamówienia">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M16 3h5v5M8 3H3v5M3 16v5h5M21 16v5h-5M12 8v8M8 12h8"/>
                                </svg>
                                Rozłóż
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Orders Table -->
                <div class="sr-section">
                    <h3>Zamówienia w zleceniu</h3>
                    <div class="sr-orders-table-wrapper">
                        <table class="sr-orders-table">
                            <thead>
                                <tr>
                                    <th>Numer zamówienia</th>
                                    <th class="text-right">Wartość</th>
                                    <th>Koszt wysyłki</th>
                                </tr>
                            </thead>
                            <tbody id="srOrdersTableBody">
                                <!-- Populated via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Address Preview -->
                <div class="sr-section">
                    <h3>Adres dostawy</h3>
                    <div id="srAddressPreview" class="sr-address-preview">
                        <!-- Populated via JS -->
                    </div>
                </div>
            </div>
            <div class="modal-footer sr-modal-footer">
                <button type="submit" class="btn btn-primary sr-save-btn">Zapisz</button>
                <div class="sr-footer-bottom">
                    <button type="button" class="btn btn-danger" onclick="cancelShippingRequest()">Anuluj zlecenie</button>
                    <button type="button" class="btn btn-secondary" onclick="closeShippingRequestModal()">Zamknij</button>
                </div>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/pages/admin/shipping-requests.js') }}"></script>
{% endblock %}
