{% extends "admin/base_admin.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin/order-detail.css') }}">
{% endblock %}

{% block content %}
<div class="order-detail-page">
    <!-- Header -->
    <div class="order-header">
        <div class="order-header-main">
            <a href="{{ url_for('orders.admin_list') }}" class="back-link">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                </svg>
                Powr√≥t do listy
            </a>
            <h1>{{ order.order_number }}</h1>
            <span class="badge" style="background-color: {{ order.type_badge_color }}; color: #fff;">{{ order.type_display_name }}</span>
            <span class="badge" style="background-color: {{ order.status_badge_color }}; color: #fff;" id="statusBadge">{{ order.status_display_name }}</span>
        </div>
        <div class="order-header-right">
            <span class="order-total">{{ "%.2f"|format(order.effective_total) }} PLN</span>
        </div>
    </div>

    <!-- ROW 1: Produkty -->
    <div class="card products-card">
        <div class="card-header">
            <h2>Zam√≥wione produkty</h2>
            <span class="items-count">{{ order.sorted_items|length }} pozycji</span>
        </div>
        <div class="table-scroll-wrapper">
        <table class="products-table">
            <thead>
                <tr>
                    <th class="col-image"></th>
                    <th class="col-id">ID</th>
                    <th class="col-name">Nazwa</th>
                    <th class="col-qty text-center">Ilo≈õƒá</th>
                    <th class="col-price text-right">Cena</th>
                    <th class="col-total text-right">Warto≈õƒá</th>
                    <th class="col-wms text-center">WMS</th>
                    <th class="col-set text-center">Set</th>
                    <th class="col-actions"></th>
                </tr>
            </thead>
            <tbody>
                {% for item in order_items %}
                {% if item.fulfilled_quantity is not none and item.fulfilled_quantity > 0 and item.fulfilled_quantity < item.quantity %}
                {# CZƒò≈öCIOWE ZREALIZOWANIE - dwa wiersze #}
                {# Wiersz 1: Zrealizowana czƒô≈õƒá #}
                <tr data-item-id="{{ item.id }}" class="item-partial-fulfilled">
                    <td class="col-image">
                        <img src="{{ item.product_image_url }}" alt="{{ item.product_name }}" class="product-thumb">
                    </td>
                    <td class="col-id">
                        <span class="product-id">{{ item.product_id }}</span>
                    </td>
                    <td class="col-name">
                        <div class="product-name-cell">
                            <div class="mobile-name-row">
                                <span class="product-name">{{ item.product_name }}</span>
                                <span class="mobile-badges">
                                    <span class="wms-badge" style="background-color: {{ item.wms_status_color }};">{{ item.wms_status_name }}</span>
                                    <span class="set-badge set-badge-ok" title="Z≈Çapany">‚úì</span>
                                </span>
                            </div>
                            {% if item.product_sku or item.product_ean %}
                            <span class="product-codes">
                                {% if item.product_sku %}SKU: {{ item.product_sku }}{% endif %}
                                {% if item.product_sku and item.product_ean %} ¬∑ {% endif %}
                                {% if item.product_ean %}EAN: {{ item.product_ean }}{% endif %}
                            </span>
                            {% endif %}
                            <!-- Mobile values row -->
                            <div class="mobile-values-row">
                                <div class="mobile-values-data">
                                    <span class="mobile-value"><span class="label">Ilo≈õƒá:</span> {{ item.fulfilled_quantity }}</span>
                                    <span class="mobile-value"><span class="label">Cena:</span> {{ "%.2f"|format(item.price) }} PLN</span>
                                    <span class="mobile-value total"><span class="label">Warto≈õƒá:</span> {{ "%.2f"|format(item.price * item.fulfilled_quantity) }} PLN</span>
                                </div>
                                <div class="mobile-actions">
                                    <button type="button" class="mobile-action-btn btn-edit-item"
                                            data-item-id="{{ item.id }}"
                                            data-product-name="{{ item.product_name }}"
                                            data-quantity="{{ item.quantity }}"
                                            data-price="{{ item.price }}"
                                            title="Edytuj produkt">
                                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                                        </svg>
                                    </button>
                                    <button type="button" class="mobile-action-btn mobile-action-btn-danger btn-delete-item"
                                            data-item-id="{{ item.id }}"
                                            data-product-name="{{ item.product_name }}"
                                            title="Usu≈Ñ produkt">
                                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                            <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="col-qty text-center">{{ item.fulfilled_quantity }}</td>
                    <td class="col-price text-right">{{ "%.2f"|format(item.price) }} PLN</td>
                    <td class="col-total text-right"><strong>{{ "%.2f"|format(item.price * item.fulfilled_quantity) }} PLN</strong></td>
                    <td class="col-wms text-center">
                        <span class="wms-badge" style="background-color: {{ item.wms_status_color }};">
                            {{ item.wms_status_name }}
                        </span>
                    </td>
                    <td class="col-set text-center">
                        <span class="set-badge set-badge-ok" title="Z≈Çapany - produkt w komplecie">‚úì</span>
                    </td>
                    <td class="col-actions">
                        <div class="item-actions-wrapper">
                            <button type="button" class="btn-item-actions" onclick="toggleItemActions(this, {{ item.id }})">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/>
                                </svg>
                            </button>
                            <div class="item-actions-dropdown" id="itemActions-{{ item.id }}">
                                <button type="button" class="dropdown-item btn-edit-item"
                                        data-item-id="{{ item.id }}"
                                        data-product-name="{{ item.product_name }}"
                                        data-quantity="{{ item.quantity }}"
                                        data-price="{{ item.price }}">
                                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                                    </svg>
                                    Edytuj produkt
                                </button>
                                <button type="button" class="dropdown-item dropdown-item-danger btn-delete-item"
                                        data-item-id="{{ item.id }}"
                                        data-product-name="{{ item.product_name }}">
                                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                    </svg>
                                    Usu≈Ñ produkt
                                </button>
                            </div>
                        </div>
                    </td>
                </tr>
                {# Wiersz 2: Niezrealizowana czƒô≈õƒá (poza setem) #}
                <tr data-item-id="{{ item.id }}" class="item-outside-set">
                    <td class="col-image">
                        <img src="{{ item.product_image_url }}" alt="{{ item.product_name }}" class="product-thumb" style="opacity: 0.5;">
                    </td>
                    <td class="col-id">
                        <span class="product-id text-outside-set">{{ item.product_id }}</span>
                    </td>
                    <td class="col-name">
                        <div class="product-name-cell">
                            <div class="mobile-name-row">
                                <span class="product-name text-outside-set">{{ item.product_name }}</span>
                                <span class="mobile-badges">
                                    <span class="wms-badge" style="background-color: #9e9e9e;">‚Äî</span>
                                    <span class="set-badge set-badge-fail" title="Poza setem">‚úó</span>
                                </span>
                            </div>
                            <span class="product-codes text-outside-set">(poza setem)</span>
                            <!-- Mobile values row -->
                            <div class="mobile-values-row">
                                <div class="mobile-values-data">
                                    <span class="mobile-value"><span class="label">Ilo≈õƒá:</span> {{ item.quantity - item.fulfilled_quantity }}</span>
                                    <span class="mobile-value"><span class="label">Cena:</span> 0.00 PLN</span>
                                    <span class="mobile-value total"><span class="label">Warto≈õƒá:</span> 0.00 PLN</span>
                                </div>
                                <div class="mobile-actions">
                                    <button type="button" class="mobile-action-btn btn-edit-item"
                                            data-item-id="{{ item.id }}"
                                            data-product-name="{{ item.product_name }}"
                                            data-quantity="{{ item.quantity }}"
                                            data-price="{{ item.price }}"
                                            title="Edytuj produkt">
                                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                                        </svg>
                                    </button>
                                    <button type="button" class="mobile-action-btn mobile-action-btn-danger btn-delete-item"
                                            data-item-id="{{ item.id }}"
                                            data-product-name="{{ item.product_name }}"
                                            title="Usu≈Ñ produkt">
                                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                            <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="col-qty text-center text-outside-set">{{ item.quantity - item.fulfilled_quantity }}</td>
                    <td class="col-price text-right text-outside-set">0.00 PLN</td>
                    <td class="col-total text-right text-outside-set"><strong>0.00 PLN</strong></td>
                    <td class="col-wms text-center">
                        <span class="wms-badge" style="background-color: #9e9e9e;">‚Äî</span>
                    </td>
                    <td class="col-set text-center">
                        <span class="set-badge set-badge-fail" title="Poza setem - nie za≈Çapa≈Ç siƒô do kompletu">‚úó</span>
                    </td>
                    <td class="col-actions">
                        <div class="item-actions-wrapper">
                            <button type="button" class="btn-item-actions" onclick="toggleItemActions(this, {{ item.id }})">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/>
                                </svg>
                            </button>
                            <div class="item-actions-dropdown" id="itemActions-{{ item.id }}-outside">
                                <button type="button" class="dropdown-item btn-edit-item"
                                        data-item-id="{{ item.id }}"
                                        data-product-name="{{ item.product_name }}"
                                        data-quantity="{{ item.quantity }}"
                                        data-price="{{ item.price }}">
                                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                                    </svg>
                                    Edytuj produkt
                                </button>
                                <button type="button" class="dropdown-item dropdown-item-danger btn-delete-item"
                                        data-item-id="{{ item.id }}"
                                        data-product-name="{{ item.product_name }}">
                                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                    </svg>
                                    Usu≈Ñ produkt
                                </button>
                            </div>
                        </div>
                    </td>
                </tr>
                {% elif item.is_set_fulfilled == false %}
                {# CA≈ÅO≈öƒÜ POZA SETEM #}
                <tr data-item-id="{{ item.id }}" class="item-outside-set">
                    <td class="col-image">
                        <img src="{{ item.product_image_url }}" alt="{{ item.product_name }}" class="product-thumb" style="opacity: 0.5;">
                    </td>
                    <td class="col-id">
                        <span class="product-id text-outside-set">{{ item.product_id }}</span>
                    </td>
                    <td class="col-name">
                        <div class="product-name-cell">
                            <div class="mobile-name-row">
                                <span class="product-name text-outside-set">{{ item.product_name }}</span>
                                <span class="mobile-badges">
                                    <span class="wms-badge" style="background-color: {{ item.wms_status_color }};">{{ item.wms_status_name }}</span>
                                    <span class="set-badge set-badge-fail" title="Poza setem">‚úó</span>
                                </span>
                            </div>
                            {% if item.product_sku or item.product_ean %}
                            <span class="product-codes text-outside-set">
                                {% if item.product_sku %}SKU: {{ item.product_sku }}{% endif %}
                                {% if item.product_sku and item.product_ean %} ¬∑ {% endif %}
                                {% if item.product_ean %}EAN: {{ item.product_ean }}{% endif %}
                            </span>
                            {% endif %}
                            <!-- Mobile values row -->
                            <div class="mobile-values-row">
                                <div class="mobile-values-data">
                                    <span class="mobile-value"><span class="label">Ilo≈õƒá:</span> {{ item.quantity }}</span>
                                    <span class="mobile-value"><span class="label">Cena:</span> {{ "%.2f"|format(item.price) }} PLN</span>
                                    <span class="mobile-value total"><span class="label">Warto≈õƒá:</span> {{ "%.2f"|format(item.total) }} PLN</span>
                                </div>
                                <div class="mobile-actions">
                                    <button type="button" class="mobile-action-btn btn-edit-item"
                                            data-item-id="{{ item.id }}"
                                            data-product-name="{{ item.product_name }}"
                                            data-quantity="{{ item.quantity }}"
                                            data-price="{{ item.price }}"
                                            title="Edytuj produkt">
                                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                                        </svg>
                                    </button>
                                    <button type="button" class="mobile-action-btn mobile-action-btn-danger btn-delete-item"
                                            data-item-id="{{ item.id }}"
                                            data-product-name="{{ item.product_name }}"
                                            title="Usu≈Ñ produkt">
                                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                            <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="col-qty text-center text-outside-set">{{ item.quantity }}</td>
                    <td class="col-price text-right text-outside-set">{{ "%.2f"|format(item.price) }} PLN</td>
                    <td class="col-total text-right text-outside-set"><strong>{{ "%.2f"|format(item.total) }} PLN</strong></td>
                    <td class="col-wms text-center">
                        <span class="wms-badge" style="background-color: {{ item.wms_status_color }};">
                            {{ item.wms_status_name }}
                        </span>
                    </td>
                    <td class="col-set text-center">
                        <span class="set-badge set-badge-fail" title="Poza setem - nie za≈Çapa≈Ç siƒô do kompletu">‚úó</span>
                    </td>
                    <td class="col-actions">
                        <div class="item-actions-wrapper">
                            <button type="button" class="btn-item-actions" onclick="toggleItemActions(this, {{ item.id }})">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/>
                                </svg>
                            </button>
                            <div class="item-actions-dropdown" id="itemActions-{{ item.id }}">
                                <button type="button" class="dropdown-item btn-edit-item"
                                        data-item-id="{{ item.id }}"
                                        data-product-name="{{ item.product_name }}"
                                        data-quantity="{{ item.quantity }}"
                                        data-price="{{ item.price }}">
                                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                                    </svg>
                                    Edytuj produkt
                                </button>
                                <button type="button" class="dropdown-item dropdown-item-danger btn-delete-item"
                                        data-item-id="{{ item.id }}"
                                        data-product-name="{{ item.product_name }}">
                                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                    </svg>
                                    Usu≈Ñ produkt
                                </button>
                            </div>
                        </div>
                    </td>
                </tr>
                {% else %}
                {# NORMALNIE #}
                <tr data-item-id="{{ item.id }}" class="{% if item.is_full_set %}full-set-row{% elif item.is_custom %}custom-product-row{% endif %}">
                    <td class="col-image">
                        {% if item.is_full_set %}
                        <div class="product-thumb" style="display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #9D4EDD 0%, #7B2CBF 100%); color: white; font-size: 1.25rem;">
                            ‚ú®
                        </div>
                        {% elif item.is_custom %}
                        <div class="product-thumb" style="display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #FF8500 0%, #FF6D00 100%); color: white; font-size: 1.25rem;">
                            üì¶
                        </div>
                        {% else %}
                        <img src="{{ item.product_image_url }}" alt="{{ item.product_name }}" class="product-thumb">
                        {% endif %}
                    </td>
                    <td class="col-id">
                        <span class="product-id">{% if item.product_id %}{{ item.product_id }}{% else %}‚Äî{% endif %}</span>
                    </td>
                    <td class="col-name">
                        <div class="product-name-cell">
                            <div class="mobile-name-row">
                                <span class="product-name">
                                    {{ item.product_name }}
                                    {% if item.is_full_set %}
                                    <span class="product-badge product-badge-full-set" title="Pe≈Çny set z exclusive">
                                        <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M2 1a1 1 0 0 0-1 1v4.586a1 1 0 0 0 .293.707l7 7a1 1 0 0 0 1.414 0l4.586-4.586a1 1 0 0 0 0-1.414l-7-7A1 1 0 0 0 6.586 1H2zm4 3.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                                        </svg>
                                        PE≈ÅNY SET
                                    </span>
                                    {% elif item.is_custom %}
                                    <span class="product-badge product-badge-custom" title="Produkt dodany rƒôcznie">
                                        <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                                        </svg>
                                        RƒòCZNY
                                    </span>
                                    {% endif %}
                                </span>
                                <span class="mobile-badges">
                                    <span class="wms-badge" style="background-color: {{ item.wms_status_color }};">{{ item.wms_status_name }}</span>
                                    {% if item.is_set_fulfilled is not none %}
                                        {% if item.is_set_fulfilled %}
                                        <span class="set-badge set-badge-ok" title="Z≈Çapany">‚úì</span>
                                        {% else %}
                                        <span class="set-badge set-badge-fail" title="Poza setem">‚úó</span>
                                        {% endif %}
                                    {% else %}
                                    <span class="set-badge set-badge-na" title="Nie dotyczy">‚Äî</span>
                                    {% endif %}
                                </span>
                            </div>
                            {% if item.product_sku or item.product_ean or item.custom_sku %}
                            <span class="product-codes">
                                {% if item.custom_sku %}SKU: {{ item.custom_sku }}{% endif %}
                                {% if item.product_sku %}SKU: {{ item.product_sku }}{% endif %}
                                {% if (item.product_sku or item.custom_sku) and item.product_ean %} ¬∑ {% endif %}
                                {% if item.product_ean %}EAN: {{ item.product_ean }}{% endif %}
                            </span>
                            {% endif %}
                            <!-- Mobile values row -->
                            <div class="mobile-values-row">
                                <div class="mobile-values-data">
                                    <span class="mobile-value"><span class="label">Ilo≈õƒá:</span> {{ item.quantity }}</span>
                                    <span class="mobile-value"><span class="label">Cena:</span> {{ "%.2f"|format(item.price) }} PLN</span>
                                    <span class="mobile-value total"><span class="label">Warto≈õƒá:</span> {{ "%.2f"|format(item.total) }} PLN</span>
                                </div>
                                <div class="mobile-actions">
                                    <button type="button" class="mobile-action-btn btn-edit-item"
                                            data-item-id="{{ item.id }}"
                                            data-product-name="{{ item.product_name }}"
                                            data-quantity="{{ item.quantity }}"
                                            data-price="{{ item.price }}"
                                            title="Edytuj produkt">
                                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                                        </svg>
                                    </button>
                                    <button type="button" class="mobile-action-btn mobile-action-btn-danger btn-delete-item"
                                            data-item-id="{{ item.id }}"
                                            data-product-name="{{ item.product_name }}"
                                            title="Usu≈Ñ produkt">
                                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                            <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="col-qty text-center">{{ item.quantity }}</td>
                    <td class="col-price text-right">{{ "%.2f"|format(item.price) }} PLN</td>
                    <td class="col-total text-right"><strong>{{ "%.2f"|format(item.total) }} PLN</strong></td>
                    <td class="col-wms text-center">
                        <span class="wms-badge" style="background-color: {{ item.wms_status_color }};">
                            {{ item.wms_status_name }}
                        </span>
                    </td>
                    <td class="col-set text-center">
                        {% if item.is_set_fulfilled is not none %}
                            {% if item.is_set_fulfilled %}
                            <span class="set-badge set-badge-ok" title="Z≈Çapany - produkt w komplecie">‚úì</span>
                            {% else %}
                            <span class="set-badge set-badge-fail" title="Poza setem - nie za≈Çapa≈Ç siƒô do kompletu">‚úó</span>
                            {% endif %}
                        {% else %}
                        <span class="set-badge-na" title="Nie dotyczy - produkt spoza setu">‚Äî</span>
                        {% endif %}
                    </td>
                    <td class="col-actions">
                        <div class="item-actions-wrapper">
                            <button type="button" class="btn-item-actions" onclick="toggleItemActions(this, {{ item.id }})">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/>
                                </svg>
                            </button>
                            <div class="item-actions-dropdown" id="itemActions-{{ item.id }}">
                                <button type="button" class="dropdown-item btn-edit-item"
                                        data-item-id="{{ item.id }}"
                                        data-product-name="{{ item.product_name }}"
                                        data-quantity="{{ item.quantity }}"
                                        data-price="{{ item.price }}">
                                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                                    </svg>
                                    Edytuj produkt
                                </button>
                                <button type="button" class="dropdown-item dropdown-item-danger btn-delete-item"
                                        data-item-id="{{ item.id }}"
                                        data-product-name="{{ item.product_name }}">
                                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                    </svg>
                                    Usu≈Ñ produkt
                                </button>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>

        <!-- Order Summary Box -->
        <div class="order-summary-box">
            <div class="order-summary-inner">
                <div class="summary-row">
                    <span class="summary-label">Produkty:</span>
                    <span class="summary-value">{{ "%.2f"|format(order.total_amount) }} PLN</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Dostawa:</span>
                    <span class="summary-value">
                        {% if order.shipping_cost and order.shipping_cost > 0 %}
                            {{ "%.2f"|format(order.shipping_cost) }} PLN
                        {% else %}
                            <span class="shipping-pending">Wkr√≥tce</span>
                        {% endif %}
                    </span>
                </div>
                <div class="summary-row summary-total">
                    <span class="summary-label">Suma:</span>
                    <span class="summary-value total-amount">
                        {{ "%.2f"|format(order.effective_total) }} PLN
                        {% if not order.shipping_cost or order.shipping_cost <= 0 %}
                            <span class="plus-shipping">+ dostawa</span>
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
        </div>
    </div>

    <!-- Przycisk: Dodaj produkty (dropdown) -->
    <div class="add-products-section">
        <div class="add-products-dropdown" id="addProductsDropdown">
            <button class="btn btn-secondary dropdown-toggle" onclick="toggleAddProductsDropdown()">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                </svg>
                Dodaj produkty do zam√≥wienia
                <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/>
                </svg>
            </button>
            <div class="dropdown-menu" id="addProductsDropdownMenu">
                <button type="button" class="dropdown-item" onclick="showManualProductForm(); closeAddProductsDropdown();">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                    </svg>
                    Dodaj produkt rƒôcznie
                </button>
                <button type="button" class="dropdown-item" onclick="openAddProductsModal(); closeAddProductsDropdown();">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                        <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                        <line x1="12" y1="22.08" x2="12" y2="12"/>
                    </svg>
                    Dodaj produkt z magazynu
                </button>
            </div>
        </div>
    </div>

    <!-- Formularz: Dodaj produkt rƒôcznie (inline, ukryty domy≈õlnie) -->
    <div id="manualProductForm" class="manual-product-form" style="display: none;">
        <div class="manual-product-card">
            <div class="manual-product-header">
                <h4>Dodaj produkt rƒôcznie</h4>
                <button type="button" class="btn-close-manual" onclick="hideManualProductForm()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="form-row">
                <div class="form-group flex-2">
                    <label for="manualProductName">Nazwa produktu *</label>
                    <input type="text" id="manualProductName" class="form-control" placeholder="np. Pe≈Çny Set: Nazwa..." required>
                </div>
                <div class="form-group flex-1">
                    <label for="manualProductQty">Ilo≈õƒá *</label>
                    <input type="number" id="manualProductQty" class="form-control" min="1" value="1" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group flex-1">
                    <label for="manualProductPrice">Cena za szt. (PLN) *</label>
                    <input type="number" id="manualProductPrice" class="form-control" step="0.01" min="0" placeholder="0.00" required>
                </div>
                <div class="form-group flex-1">
                    <label for="manualProductSku">SKU (opcjonalnie)</label>
                    <input type="text" id="manualProductSku" class="form-control" placeholder="np. SET-001">
                </div>
            </div>
            <div class="calculated-total-row">
                <label>Warto≈õƒá</label>
                <span id="manualProductTotal" class="total-value">0.00 PLN</span>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-ghost" onclick="hideManualProductForm()">
                    Anuluj
                </button>
                <button type="button" class="btn btn-primary" onclick="saveManualProduct()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    Zapisz produkt
                </button>
            </div>
        </div>
    </div>

    <!-- ROW 2: Informacje o zam√≥wieniu (jedna karta, 2 kolumny wewnƒÖtrz) -->
    <div class="card order-info-card">
        <h3>Informacje o zam√≥wieniu</h3>
        <div class="order-info-two-col">
            <!-- Lewa kolumna: P≈Çatno≈õƒá, Klient, Dostawa -->
            <div class="info-col-left">
                <!-- Zap≈Çacono -->
                <div class="info-item payment-row">
                    <label>Zap≈Çacono:</label>
                    <div class="payment-display" id="paymentDisplay">
                        <span class="payment-badge {% if order.is_overpaid %}payment-badge-overpaid{% elif order.is_fully_paid %}payment-badge-paid{% elif order.is_partially_paid %}payment-badge-partial{% else %}payment-badge-unpaid{% endif %}"
                              id="paidAmountBadge">{{ "%.2f"|format(order.paid_amount) }} PLN</span>
                        <span class="payment-total" id="grandTotalDisplay">z {{ "%.2f"|format(order.effective_grand_total) }} PLN</span>
                        <button type="button" class="btn-edit-payment" onclick="togglePaymentEditor()" title="Edytuj p≈Çatno≈õƒá">
                            <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="payment-editor" id="paymentEditor" style="display: none;">
                        <input type="number"
                               class="payment-input"
                               id="paidAmountInput"
                               step="0.01"
                               min="0"
                               value="{{ "%.2f"|format(order.paid_amount) }}"
                               data-order-id="{{ order.id }}"
                               data-total="{{ "%.2f"|format(order.effective_grand_total) }}"
                               data-products-total="{{ "%.2f"|format(order.effective_total) }}"
                               data-shipping-cost="{{ "%.2f"|format(order.shipping_cost) }}">
                        <span class="payment-total">z <span id="grandTotalEditor">{{ "%.2f"|format(order.effective_grand_total) }}</span> PLN</span>
                        <button type="button" class="btn-payment-save" onclick="savePayment()" title="Zapisz">
                            <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
                            </svg>
                        </button>
                        <button type="button" class="btn-payment-full" onclick="setFullPayment()" title="Ustaw jako op≈Çacone" id="btnPaymentFull">
                            {{ "%.2f"|format(order.effective_grand_total) }}
                        </button>
                        <button type="button" class="btn-payment-zero" onclick="setZeroPayment()" title="Ustaw jako nieop≈Çacone">
                            0.00
                        </button>
                        <button type="button" class="btn-payment-cancel" onclick="cancelPaymentEdit()" title="Anuluj">
                            <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Separator 1 -->
                <div class="info-separator"></div>

                <!-- Klient -->
                <div class="info-item">
                    <label>Klient:</label>
                    {% if order.is_guest_order %}
                        <span>{{ order.guest_name }} <span class="badge badge-guest">Go≈õƒá</span></span>
                    {% elif order.user %}
                        <a href="{{ url_for('admin.client_detail', id=order.user.id) }}" class="customer-link">{{ order.user.full_name }}</a>
                    {% else %}
                        <span class="text-muted">Nieznany</span>
                    {% endif %}
                </div>
                <div class="info-item">
                    <label>Email:</label>
                    <span>{{ order.guest_email if order.is_guest_order else (order.user.email if order.user else '-') }}</span>
                </div>
                <div class="info-item">
                    <label>Telefon:</label>
                    <span>{{ order.guest_phone if order.is_guest_order else (order.user.phone if order.user and order.user.phone else '-') }}</span>
                </div>

                <!-- Separator 2 -->
                <div class="info-separator"></div>

                <!-- Sekcja p≈Çatno≈õci i dostawy -->
                <div class="payment-delivery-section">
                    <!-- Spos√≥b dostawy - edytowalny -->
                    <div class="info-item editable-row" data-field="delivery_method">
                    <label>Spos√≥b dostawy:</label>
                    <div class="editable-display" id="deliveryMethodDisplay">
                        <span class="editable-value" id="deliveryMethodValue">{{ order.delivery_method_display }}</span>
                        <button type="button" class="btn-edit-inline" onclick="toggleInlineEditor('deliveryMethod')" title="Edytuj">
                            <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="editable-editor" id="deliveryMethodEditor" style="display: none;">
                        <select class="form-select form-select-sm" id="deliveryMethodSelect" data-original="{{ order.delivery_method or '' }}">
                            <option value="">-- Wybierz --</option>
                            <option value="kurier" {% if order.delivery_method == 'kurier' %}selected{% endif %}>Kurier</option>
                            <option value="paczkomat" {% if order.delivery_method == 'paczkomat' %}selected{% endif %}>InPost</option>
                            <option value="odbior_osobisty" {% if order.delivery_method == 'odbior_osobisty' %}selected{% endif %}>Odbi√≥r osobisty</option>
                            <option value="poczta" {% if order.delivery_method == 'poczta' %}selected{% endif %}>Poczta Polska</option>
                            <option value="dpd_pickup" {% if order.delivery_method == 'dpd_pickup' %}selected{% endif %}>DPD Pickup</option>
                            <option value="orlen_paczka" {% if order.delivery_method == 'orlen_paczka' %}selected{% endif %}>Orlen Paczka</option>
                        </select>
                        <button type="button" class="btn-inline-save" onclick="saveInlineField('deliveryMethod')" title="Zapisz">
                            <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
                            </svg>
                        </button>
                        <button type="button" class="btn-inline-cancel" onclick="cancelInlineEditor('deliveryMethod')" title="Anuluj">
                            <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Koszt wysy≈Çki - edytowalny -->
                <div class="info-item editable-row" data-field="shipping_cost">
                    <label>Koszt wysy≈Çki:</label>
                    <div class="editable-display" id="shippingCostDisplay">
                        <span class="editable-value" id="shippingCostValue">{{ "%.2f"|format(order.shipping_cost) }} PLN</span>
                        <button type="button" class="btn-edit-inline" onclick="toggleInlineEditor('shippingCost')" title="Edytuj">
                            <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="editable-editor" id="shippingCostEditor" style="display: none;">
                        <input type="number"
                               class="form-input-sm"
                               id="shippingCostInput"
                               step="0.01"
                               min="0"
                               value="{{ "%.2f"|format(order.shipping_cost) }}"
                               data-original="{{ "%.2f"|format(order.shipping_cost) }}">
                        <span class="input-suffix">PLN</span>
                        <button type="button" class="btn-inline-save" onclick="saveInlineField('shippingCost')" title="Zapisz">
                            <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
                            </svg>
                        </button>
                        <button type="button" class="btn-inline-cancel" onclick="cancelInlineEditor('shippingCost')" title="Anuluj">
                            <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                </div>
            </div>

            <!-- Prawa kolumna: Status + Akcje -->
            <div class="info-col-right">
                <!-- Status -->
                <div class="status-section">
                    <label>Status zam√≥wienia</label>
                    <div class="status-change-form">
                        <form id="statusChangeForm"
                              hx-post="{{ url_for('orders.admin_update_status', order_id=order.id) }}"
                              hx-target="#statusBadge"
                              hx-swap="outerHTML">
                            {{ status_form.hidden_tag() }}

                            <!-- Custom Status Dropdown -->
                            <div class="custom-status-dropdown" id="statusDropdown">
                                <!-- Trigger button showing current status -->
                                <button type="button" class="status-dropdown-trigger" onclick="toggleOrderStatusDropdown(event)">
                                    <span class="status-color-box" style="background-color: {{ order.status_badge_color }}"></span>
                                    <span class="status-name">{{ order.status_rel.name if order.status_rel else order.status }}</span>
                                    <svg class="dropdown-chevron" width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                                    </svg>
                                </button>

                                <!-- Dropdown menu -->
                                <div class="status-dropdown-menu" id="statusDropdownMenu">
                                    <!-- Search input -->
                                    <div class="status-search-wrapper">
                                        <input type="text"
                                               class="status-search-input"
                                               placeholder="Szukaj..."
                                               oninput="filterStatuses(this.value)">
                                        <svg class="search-icon" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                                        </svg>
                                    </div>

                                    <!-- Status options -->
                                    <div class="status-options-list">
                                        {% for status in statuses_with_colors %}
                                        <div class="status-option {% if status.slug == order.status %}selected{% endif %}"
                                             data-value="{{ status.slug }}"
                                             data-name="{{ status.name }}"
                                             data-color="{{ status.color }}"
                                             onclick="selectStatus('{{ status.slug }}', '{{ status.name }}', '{{ status.color }}')">
                                            <span class="status-color-box" style="background-color: {{ status.color }}"></span>
                                            <span class="status-option-name">{{ status.name }}</span>
                                            {% if status.slug == order.status %}
                                            <svg class="check-icon" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                                <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
                                            </svg>
                                            {% endif %}
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>

                                <!-- Hidden input for form submission -->
                                <input type="hidden" name="status" id="statusHiddenInput" value="{{ order.status }}">
                            </div>

                            <button type="submit" class="btn btn-sm btn-primary">Przenie≈õ</button>
                        </form>
                    </div>
                </div>

                <!-- Akcje -->
                <div class="actions-section">
                    <label>Szybkie akcje</label>
                    <div class="actions-grid">
                        <button class="btn btn-secondary btn-sm" onclick="alert('Funkcja WMS w budowie')">
                            <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M0 2.5A.5.5 0 0 1 .5 2H2a.5.5 0 0 1 .485.379L2.89 4H14.5a.5.5 0 0 1 .485.621l-1.5 6A.5.5 0 0 1 13 11H4a.5.5 0 0 1-.485-.379L1.61 3H.5a.5.5 0 0 1-.5-.5z"/>
                            </svg>
                            Zabierz do WMS
                        </button>
                        {% if current_user.is_admin %}
                        <button class="btn btn-danger btn-sm" onclick="confirmDeleteOrder({{ order.id }}, '{{ order.order_number }}')">
                            <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                            </svg>
                            Usu≈Ñ zam√≥wienie
                        </button>
                        {% endif %}
                    </div>
                </div>

                <!-- Uwagi sprzedawcy (wewnƒôtrzne) -->
                <div class="admin-notes-section">
                    <label>
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
                        </svg>
                        Uwagi sprzedawcy
                        <span class="notes-hint">(widoczne tylko dla admina/moda)</span>
                    </label>
                    <div class="admin-notes-wrapper">
                        <textarea
                            class="admin-notes-textarea"
                            id="adminNotesTextarea"
                            placeholder="Dodaj wewnƒôtrzne uwagi do zam√≥wienia..."
                            data-order-id="{{ order.id }}"
                        >{{ order.admin_notes or '' }}</textarea>
                        <div class="admin-notes-actions">
                            <span class="admin-notes-status" id="adminNotesStatus"></span>
                            <button type="button" class="btn btn-sm btn-primary" onclick="saveAdminNotes()" id="saveAdminNotesBtn">
                                <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
                                </svg>
                                Zapisz
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ROW 3: Zlecenie wysy≈Çki -->
    <div class="confirmations-shipments-row">
        <!-- Karta: Zlecenia wysy≈Çki -->
        <div class="card shipping-requests-card">
            <h3>
                <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M0 3.5A1.5 1.5 0 0 1 1.5 2h9A1.5 1.5 0 0 1 12 3.5V5h1.02a1.5 1.5 0 0 1 1.17.563l1.481 1.85a1.5 1.5 0 0 1 .329.938V10.5a1.5 1.5 0 0 1-1.5 1.5H14a2 2 0 1 1-4 0H5a2 2 0 1 1-3.998-.085A1.5 1.5 0 0 1 0 10.5v-7zm1.294 7.456A1.999 1.999 0 0 1 4.732 11h5.536a2.01 2.01 0 0 1 .732-.732V3.5a.5.5 0 0 0-.5-.5h-9a.5.5 0 0 0-.5.5v7a.5.5 0 0 0 .294.456zM12 10a2 2 0 0 1 1.732 1h.768a.5.5 0 0 0 .5-.5V8.35a.5.5 0 0 0-.11-.312l-1.48-1.85A.5.5 0 0 0 13.02 6H12v4zm-9 1a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm9 0a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/>
                </svg>
                Zlecenie wysy≈Çki
            </h3>

            {% set sr = order.shipping_request %}
            {% if sr %}
            <div class="shipping-request-details">
                <!-- Header z numerem i statusem -->
                <div class="sr-header">
                    <div class="sr-number">
                        <span class="sr-label">Numer:</span>
                        <strong>{{ sr.request_number }}</strong>
                    </div>
                    <span class="badge" style="background-color: {{ sr.status_badge_color }}; color: #fff;">
                        {{ sr.status_display_name }}
                    </span>
                </div>

                <!-- Informacje podstawowe -->
                <div class="sr-info-grid">
                    <div class="sr-info-row">
                        <span class="sr-info-label">Zam√≥wienia:</span>
                        <span class="sr-info-value">
                            {% for o in sr.orders %}
                            <a href="{{ url_for('orders.admin_detail', order_id=o.id) }}"
                               class="sr-order-badge {% if o.id == order.id %}current{% endif %}">
                                {{ o.order_number }}
                            </a>
                            {% endfor %}
                        </span>
                    </div>
                    <div class="sr-info-row">
                        <span class="sr-info-label">Koszt wysy≈Çki:</span>
                        <span class="sr-info-value">
                            {% if sr.calculated_shipping_cost %}
                                <strong>{{ "%.2f"|format(sr.calculated_shipping_cost) }} PLN</strong>
                            {% else %}
                                <span class="text-muted">Oczekuje na wycenƒô</span>
                            {% endif %}
                        </span>
                    </div>
                    <div class="sr-info-row">
                        <span class="sr-info-label">Utworzono:</span>
                        <span class="sr-info-value">{{ sr.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                    </div>
                </div>

                <!-- Adres dostawy -->
                <div class="sr-address-section">
                    <div class="sr-section-header">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
                        </svg>
                        Adres dostawy
                    </div>
                    <div class="sr-address-content">
                        {% if sr.address_type == 'pickup_point' %}
                            <div class="sr-pickup-badge">
                                <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M8.186 1.113a.5.5 0 0 0-.372 0L1.846 3.5 8 5.961 14.154 3.5 8.186 1.113zM15 4.239l-6.5 2.6v7.922l6.5-2.6V4.24zM7.5 14.762V6.838L1 4.239v7.923l6.5 2.6zM7.443.184a1.5 1.5 0 0 1 1.114 0l7.129 2.852A.5.5 0 0 1 16 3.5v8.662a1 1 0 0 1-.629.928l-7.185 2.874a.5.5 0 0 1-.372 0L.63 13.09a1 1 0 0 1-.63-.928V3.5a.5.5 0 0 1 .314-.464L7.443.184z"/>
                                </svg>
                                Paczkomat / Punkt odbioru
                            </div>
                            {% if sr.pickup_courier %}<div><strong>{{ sr.pickup_courier }}</strong></div>{% endif %}
                            {% if sr.pickup_point_id %}<div class="sr-pickup-id">{{ sr.pickup_point_id }}</div>{% endif %}
                            {% if sr.pickup_address %}<div>{{ sr.pickup_address }}</div>{% endif %}
                            {% if sr.pickup_postal_code or sr.pickup_city %}
                                <div>{{ sr.pickup_postal_code }} {{ sr.pickup_city }}</div>
                            {% endif %}
                        {% else %}
                            {% if sr.shipping_name %}<div><strong>{{ sr.shipping_name }}</strong></div>{% endif %}
                            {% if sr.shipping_address %}<div>{{ sr.shipping_address }}</div>{% endif %}
                            {% if sr.shipping_postal_code or sr.shipping_city %}
                                <div>{{ sr.shipping_postal_code }} {{ sr.shipping_city }}</div>
                            {% endif %}
                            {% if sr.shipping_voivodeship %}<div class="text-muted">woj. {{ sr.shipping_voivodeship }}</div>{% endif %}
                        {% endif %}
                    </div>
                </div>

                <!-- Tracking -->
                {% if sr.tracking_number or sr.courier %}
                <div class="sr-tracking-section">
                    <div class="sr-section-header">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                        </svg>
                        ≈öledzenie przesy≈Çki
                    </div>
                    <div class="sr-tracking-content">
                        {% if sr.courier %}<span class="sr-courier-badge">{{ sr.courier }}</span>{% endif %}
                        {% if sr.tracking_number %}
                            {% if sr.tracking_url %}
                                <a href="{{ sr.tracking_url }}" target="_blank" class="sr-tracking-link">
                                    {{ sr.tracking_number }}
                                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5z"/>
                                        <path fill-rule="evenodd" d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0v-5z"/>
                                    </svg>
                                </a>
                            {% else %}
                                <span class="sr-tracking-number">{{ sr.tracking_number }}</span>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Notatki admina -->
                {% if sr.admin_notes %}
                <div class="sr-notes-section">
                    <div class="sr-section-header">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M5 4a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1H5zm-.5 2.5A.5.5 0 0 1 5 6h6a.5.5 0 0 1 0 1H5a.5.5 0 0 1-.5-.5zM5 8a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1H5zm0 2a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1H5z"/>
                            <path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2zm10-1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1z"/>
                        </svg>
                        Notatki
                    </div>
                    <div class="sr-notes-content">{{ sr.admin_notes }}</div>
                </div>
                {% endif %}

                <!-- Przycisk edycji -->
                <div class="sr-actions">
                    <button type="button" class="btn btn-sm btn-primary" onclick="openShippingRequestModal({{ sr.id }})">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                        </svg>
                        Edytuj zlecenie
                    </button>
                </div>
            </div>
            {% else %}
            <div class="shipping-requests-empty">
                <div class="empty-icon">
                    <svg width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M0 3.5A1.5 1.5 0 0 1 1.5 2h9A1.5 1.5 0 0 1 12 3.5V5h1.02a1.5 1.5 0 0 1 1.17.563l1.481 1.85a1.5 1.5 0 0 1 .329.938V10.5a1.5 1.5 0 0 1-1.5 1.5H14a2 2 0 1 1-4 0H5a2 2 0 1 1-3.998-.085A1.5 1.5 0 0 1 0 10.5v-7zm1.294 7.456A1.999 1.999 0 0 1 4.732 11h5.536a2.01 2.01 0 0 1 .732-.732V3.5a.5.5 0 0 0-.5-.5h-9a.5.5 0 0 0-.5.5v7a.5.5 0 0 0 .294.456zM12 10a2 2 0 0 1 1.732 1h.768a.5.5 0 0 0 .5-.5V8.35a.5.5 0 0 0-.11-.312l-1.48-1.85A.5.5 0 0 0 13.02 6H12v4zm-9 1a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm9 0a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/>
                    </svg>
                </div>
                <h4>Brak zlecenia wysy≈Çki</h4>
                <p class="text-muted">To zam√≥wienie nie jest jeszcze przypisane do ≈ºadnego zlecenia wysy≈Çki.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ROW 4: Wymiana wiadomo≈õci + Informacje dodatkowe -->
    <div class="two-col-row align-start">
        <!-- Wymiana wiadomo≈õci -->
        <div class="card messages-card">
            <h3>Wymiana wiadomo≈õci</h3>
            <div class="messages-container" id="messagesContainer">
                {% for event in timeline %}
                    {% if event.type == 'comment' %}
                        <div class="message {% if event.is_internal %}internal{% endif %} {% if event.is_from_admin %}from-admin{% else %}from-client{% endif %}">
                            <div class="message-avatar">
                                {{ event.user.first_name[0] }}{{ event.user.last_name[0] }}
                            </div>
                            <div class="message-content">
                                <div class="message-header">
                                    <strong>{{ event.user.full_name }}</strong>
                                    {% if event.is_internal %}
                                        <span class="badge badge-internal">Wewnƒôtrzna</span>
                                    {% endif %}
                                    <span class="message-date">{{ event.created_at|format_datetime }}</span>
                                </div>
                                <p>{{ event.comment }}</p>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
            <!-- Add Comment Form -->
            <form hx-post="{{ url_for('orders.admin_add_comment', order_id=order.id) }}"
                  hx-target="#messagesContainer"
                  hx-swap="beforeend"
                  hx-on::after-request="if(event.detail.successful) { this.reset(); document.getElementById('messagesContainer').scrollTop = document.getElementById('messagesContainer').scrollHeight; }"
                  class="message-form">
                {{ comment_form.hidden_tag() }}
                <div class="form-group">
                    {{ comment_form.comment(class="form-textarea", placeholder="Napisz wiadomo≈õƒá...", rows=3) }}
                </div>
                <div class="form-actions">
                    {% if current_user.role in ['admin', 'mod'] %}
                    <label class="checkbox-label">
                        {{ comment_form.is_internal(class="form-checkbox") }}
                        <span>Notatka wewnƒôtrzna</span>
                    </label>
                    {% endif %}
                    <button type="submit" class="btn btn-primary">Wy≈õlij</button>
                </div>
            </form>
        </div>

        <!-- Informacje dodatkowe -->
        <div class="card additional-info-card">
            <h3>Informacje dodatkowe</h3>

            <!-- Daty -->
            <div class="collapsible-section open">
                <button class="collapsible-trigger" onclick="toggleSection(this)">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="chevron">
                        <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                    Daty
                </button>
                <div class="collapsible-content">
                    <div class="dates-info">
                        <p><strong>Utworzone:</strong> {{ order.created_at|format_datetime }}</p>
                        <p><strong>Ostatnia aktualizacja:</strong> {{ order.updated_at|format_datetime }}</p>
                    </div>
                </div>
            </div>

            <!-- Uwagi klienta -->
            {% if order.notes %}
            <div class="collapsible-section">
                <button class="collapsible-trigger" onclick="toggleSection(this)">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="chevron">
                        <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                    Uwagi klienta
                </button>
                <div class="collapsible-content">
                    <p>{{ order.notes }}</p>
                </div>
            </div>
            {% endif %}

            <!-- Historia zmian -->
            <div class="collapsible-section">
                <button class="collapsible-trigger" onclick="toggleSection(this)">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="chevron">
                        <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                    Historia zmian
                </button>
                <div class="collapsible-content">
                    <div class="history-list">
                        {% for event in timeline %}
                            {% if event.type == 'created' %}
                            <div class="history-item">
                                <span class="history-icon">üì¶</span>
                                <span class="history-text">Zam√≥wienie utworzone</span>
                                <span class="history-date">{{ event.created_at|format_datetime }}</span>
                            </div>
                            {% elif event.type == 'refund' %}
                            <div class="history-item">
                                <span class="history-icon">üí∞</span>
                                <span class="history-text">Zwrot {{ "%.2f"|format(event.amount) }} PLN - {{ event.status }}</span>
                                <span class="history-date">{{ event.created_at|format_datetime }}</span>
                            </div>
                            {% elif event.type == 'activity' %}
                            <div class="history-item">
                                {% if event.action == 'order_products_added' %}
                                <span class="history-icon">‚ûï</span>
                                <span class="history-text">
                                    Dodano {{ event.new_value.added_products }} produkt(√≥w)
                                    {% if event.user %}<span class="history-user">przez {{ event.user.full_name }}</span>{% endif %}
                                </span>
                                {% elif event.action == 'order_status_change' %}
                                <span class="history-icon">üîÑ</span>
                                <span class="history-text">
                                    Zmiana statusu: {{ event.old_value.status }} ‚Üí {{ event.new_value.status }}
                                    {% if event.user %}<span class="history-user">przez {{ event.user.full_name }}</span>{% endif %}
                                </span>
                                {% elif event.action == 'order_created' %}
                                <span class="history-icon">üì¶</span>
                                <span class="history-text">Zam√≥wienie utworzone</span>
                                {% elif event.action == 'order_item_updated' %}
                                <span class="history-icon">‚úèÔ∏è</span>
                                <span class="history-text">
                                    Edytowano produkt "{{ event.new_value.product_name }}":
                                    ilo≈õƒá {{ event.old_value.quantity }} ‚Üí {{ event.new_value.quantity }},
                                    cena {{ "%.2f"|format(event.old_value.price) }} ‚Üí {{ "%.2f"|format(event.new_value.price) }} PLN
                                    {% if event.user %}<span class="history-user">przez {{ event.user.full_name }}</span>{% endif %}
                                </span>
                                {% elif event.action == 'order_item_deleted' %}
                                <span class="history-icon">üóëÔ∏è</span>
                                <span class="history-text">
                                    Usuniƒôto produkt "{{ event.old_value.product_name }}" ({{ event.old_value.quantity }} szt.)
                                    {% if event.user %}<span class="history-user">przez {{ event.user.full_name }}</span>{% endif %}
                                </span>
                                {% else %}
                                <span class="history-icon">üìù</span>
                                <span class="history-text">
                                    {{ event.action }}
                                    {% if event.user %}<span class="history-user">przez {{ event.user.full_name }}</span>{% endif %}
                                </span>
                                {% endif %}
                                <span class="history-date">{{ event.created_at|format_datetime }}</span>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Zwroty -->
            {% if order.refunds %}
            <div class="collapsible-section">
                <button class="collapsible-trigger" onclick="toggleSection(this)">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="chevron">
                        <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                    Zwroty ({{ order.refunds|length }})
                </button>
                <div class="collapsible-content">
                    {% for refund in order.refunds %}
                    <div class="refund-item">
                        <div class="refund-amount">{{ "%.2f"|format(refund.amount) }} PLN</div>
                        <div class="refund-reason">{{ refund.reason }}</div>
                        <div class="refund-meta">
                            <span class="badge badge-{{ refund.status }}">{{ refund.status }}</span>
                            <span>{{ refund.created_at|format_date }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal: Dodaj produkty do zam√≥wienia -->
<div class="modal-overlay" id="addProductsModal">
    <div class="modal-container modal-xl add-products-modal">
        <div class="modal-header">
            <h2>Dodaj produkty do zam√≥wienia</h2>
            <button type="button" class="modal-close" onclick="closeAddProductsModal()">&times;</button>
        </div>

        <div class="modal-body add-products-body">
            <!-- Left: Products List -->
            <div class="products-list-panel">
                <!-- Filters -->
                <div class="products-filters">
                    <div class="search-input-wrapper">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                        </svg>
                        <input type="text"
                               id="productSearchInput"
                               class="form-input"
                               placeholder="Szukaj produktu..."
                               oninput="debounceSearch()">
                    </div>
                    <select id="categoryFilter" class="form-select" onchange="loadProducts()">
                        <option value="">Wszystkie kategorie</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                    <select id="seriesFilter" class="form-select" onchange="loadProducts()">
                        <option value="">Wszystkie serie</option>
                        {% for series in product_series %}
                        <option value="{{ series.id }}">{{ series.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Products list -->
                <div class="products-list-scroll" id="productsListContainer">
                    <div class="loading-products">
                        <div class="spinner"></div>
                        <p>≈Åadowanie produkt√≥w...</p>
                    </div>
                </div>
            </div>

            <!-- Right: Selected Products -->
            <div class="selected-products-panel" id="selectedProductsPanel">
                <h3>Wybrane produkty</h3>
                <div class="selected-products-list" id="selectedProductsContainer">
                    <div class="empty-selection">
                        <p>Wybierz produkty z listy</p>
                    </div>
                </div>
                <div class="selected-products-footer" id="selectedProductsFooter">
                    <span>Suma:</span>
                    <span id="selectedProductsTotalValue">0.00 PLN</span>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeAddProductsModal()">Anuluj</button>
            <button type="button" class="btn btn-primary" onclick="submitAddProducts()">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                </svg>
                Dodaj do zam√≥wienia
            </button>
        </div>
    </div>
</div>

<!-- Modal: Edytuj produkt w zam√≥wieniu -->
<div class="modal-overlay" id="editItemModal">
    <div class="modal-container modal-sm">
        <div class="modal-header">
            <h2>Edytuj produkt</h2>
            <button type="button" class="modal-close" onclick="closeEditItemModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="editItemId">
            <div class="edit-item-product-name" id="editItemProductName"></div>

            <div class="form-group">
                <label class="form-label">Ilo≈õƒá</label>
                <input type="number" id="editItemQuantity" class="form-control" min="1" step="1">
            </div>

            <div class="form-group">
                <label class="form-label">Cena jednostkowa (PLN)</label>
                <input type="number" id="editItemPrice" class="form-control" min="0" step="0.01">
            </div>

            <div class="edit-item-summary">
                <span>Warto≈õƒá:</span>
                <strong id="editItemTotal">0.00 PLN</strong>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeEditItemModal()">Anuluj</button>
            <button type="button" class="btn btn-primary" onclick="submitEditItem()">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425a.247.247 0 0 1 .02-.022Z"/>
                </svg>
                Zapisz zmiany
            </button>
        </div>
    </div>
</div>

<!-- Modal: Potwierd≈∫ usuniƒôcie produktu -->
<div class="modal-overlay" id="deleteItemModal">
    <div class="modal-container modal-sm">
        <div class="modal-header">
            <h2>Usu≈Ñ produkt</h2>
            <button type="button" class="modal-close" onclick="closeDeleteItemModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="deleteItemId">
            <div class="delete-confirm-content">
                <div class="delete-icon">
                    <svg width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                        <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/>
                    </svg>
                </div>
                <p>Czy na pewno chcesz usunƒÖƒá produkt</p>
                <p class="delete-item-name" id="deleteItemName"></p>
                <p class="delete-warning">Ta operacja jest nieodwracalna.</p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteItemModal()">Anuluj</button>
            <button type="button" class="btn btn-danger" onclick="submitDeleteItem()">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                </svg>
                Usu≈Ñ produkt
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/pages/admin/order-detail.js') }}"></script>
<script>
function toggleSection(button) {
    const section = button.closest('.collapsible-section');
    section.classList.toggle('open');
}

// Scroll messages to bottom on page load
document.addEventListener('DOMContentLoaded', function() {
    const messagesContainer = document.getElementById('messagesContainer');
    if (messagesContainer) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
});

// ========================================
// ADD PRODUCTS MODAL
// ========================================

// Store for selected products
let selectedProducts = {};
const orderId = {{ order.id }};

// ========================================
// Dropdown: Add Products
// ========================================

function toggleAddProductsDropdown() {
    const dropdown = document.getElementById('addProductsDropdown');
    dropdown.classList.toggle('open');
}

function closeAddProductsDropdown() {
    const dropdown = document.getElementById('addProductsDropdown');
    dropdown.classList.remove('open');
}

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
    const dropdown = document.getElementById('addProductsDropdown');
    if (dropdown && !dropdown.contains(e.target)) {
        dropdown.classList.remove('open');
    }
});

// ========================================
// Manual Product Form
// ========================================

function showManualProductForm() {
    document.getElementById('manualProductForm').style.display = 'block';
    document.getElementById('manualProductName').focus();
}

function hideManualProductForm() {
    document.getElementById('manualProductForm').style.display = 'none';
    // Reset form
    document.getElementById('manualProductName').value = '';
    document.getElementById('manualProductQty').value = '1';
    document.getElementById('manualProductPrice').value = '';
    document.getElementById('manualProductSku').value = '';
    document.getElementById('manualProductTotal').textContent = '0.00 PLN';
}

function calculateManualTotal() {
    const qty = parseFloat(document.getElementById('manualProductQty').value) || 0;
    const price = parseFloat(document.getElementById('manualProductPrice').value) || 0;
    const total = qty * price;
    document.getElementById('manualProductTotal').textContent = total.toFixed(2) + ' PLN';
}

// Attach event listeners for auto-calculation
document.addEventListener('DOMContentLoaded', function() {
    const qtyInput = document.getElementById('manualProductQty');
    const priceInput = document.getElementById('manualProductPrice');

    if (qtyInput) qtyInput.addEventListener('input', calculateManualTotal);
    if (priceInput) priceInput.addEventListener('input', calculateManualTotal);
});

async function saveManualProduct() {
    const name = document.getElementById('manualProductName').value.trim();
    const qty = parseInt(document.getElementById('manualProductQty').value) || 0;
    const price = parseFloat(document.getElementById('manualProductPrice').value) || 0;
    const sku = document.getElementById('manualProductSku').value.trim();

    // Validate
    if (!name) {
        showToast('Podaj nazwƒô produktu', 'error');
        return;
    }
    if (qty <= 0) {
        showToast('Ilo≈õƒá musi byƒá wiƒôksza od 0', 'error');
        return;
    }
    if (price < 0) {
        showToast('Cena nie mo≈ºe byƒá ujemna', 'error');
        return;
    }

    // Get CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || '';

    try {
        const response = await fetch(`/admin/orders/${orderId}/add-custom-product`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                custom_name: name,
                custom_sku: sku || null,
                quantity: qty,
                price: price
            })
        });

        const result = await response.json();

        if (result.success) {
            showToast('Produkt zosta≈Ç dodany', 'success');
            hideManualProductForm();
            // Reload page to show new product
            location.reload();
        } else {
            showToast(result.message || 'B≈ÇƒÖd dodawania produktu', 'error');
        }
    } catch (error) {
        console.error('Error saving manual product:', error);
        showToast('WystƒÖpi≈Ç b≈ÇƒÖd podczas zapisywania', 'error');
    }
}

// ========================================
// Add Products Modal
// ========================================

function openAddProductsModal() {
    const modal = document.getElementById('addProductsModal');
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
    // Load products
    loadProducts();
}

function closeAddProductsModal() {
    const modal = document.getElementById('addProductsModal');
    modal.classList.add('closing');

    setTimeout(() => {
        modal.classList.remove('active', 'closing');
        document.body.style.overflow = '';
        // Reset state
        selectedProducts = {};
        const modalBody = document.querySelector('.add-products-body');
        const selectedPanel = document.getElementById('selectedProductsPanel');
        modalBody.classList.remove('has-selection');
        selectedPanel.classList.remove('has-products');
        document.getElementById('selectedProductsContainer').innerHTML = `
            <div class="empty-selection">
                <p>Wybierz produkty z listy</p>
            </div>
        `;
        document.getElementById('productSearchInput').value = '';
        document.getElementById('categoryFilter').value = '';
        document.getElementById('seriesFilter').value = '';
    }, 350);
}

function loadProducts() {
    const search = document.getElementById('productSearchInput').value;
    const category = document.getElementById('categoryFilter').value;
    const series = document.getElementById('seriesFilter').value;

    const params = new URLSearchParams();
    if (search) params.append('search', search);
    if (category) params.append('category_id', category);
    if (series) params.append('series_id', series);

    fetch(`/admin/orders/api/products?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            renderProductsList(data.products);
        })
        .catch(error => {
            console.error('Error loading products:', error);
            showToast('B≈ÇƒÖd podczas ≈Çadowania produkt√≥w', 'error');
        });
}

function renderProductsList(products) {
    const container = document.getElementById('productsListContainer');

    if (products.length === 0) {
        container.innerHTML = `
            <div class="no-products-message">
                <svg width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M2.5 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h11a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1h-11z"/>
                </svg>
                <p>Nie znaleziono produkt√≥w</p>
            </div>
        `;
        return;
    }

    const defaultImage = '/static/img/placeholders/product.svg';
    container.innerHTML = products.map(product => {
        const imgUrl = product.image_url || defaultImage;
        return `
        <div class="product-row" data-product-id="${product.id}">
            <div class="product-image">
                <img src="${imgUrl}" alt="${product.name}" onerror="this.src='${defaultImage}'">
            </div>
            <div class="product-info">
                <div class="product-name">${product.name}</div>
                <div class="product-meta">
                    ${product.category_name ? `<span>${product.category_name}</span>` : ''}
                    ${product.series_name ? `<span>${product.series_name}</span>` : ''}
                </div>
                <div class="product-price">${parseFloat(product.sale_price).toFixed(2)} PLN</div>
            </div>
            <div class="product-stock ${product.quantity > 0 ? 'in-stock' : 'out-of-stock'}">
                Stan: ${product.quantity}
            </div>
            <button type="button" class="btn btn-sm btn-add-product" onclick="addProductToSelection(${product.id}, '${escapeHtml(product.name)}', ${product.sale_price}, '${imgUrl}')">
                <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                </svg>
                Dodaj
            </button>
        </div>
    `;
    }).join('');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML.replace(/'/g, "\\'");
}

function addProductToSelection(productId, productName, price, imageUrl) {
    if (selectedProducts[productId]) {
        selectedProducts[productId].quantity++;
    } else {
        selectedProducts[productId] = {
            id: productId,
            name: productName,
            price: price,
            image_url: imageUrl,
            quantity: 1
        };
    }
    updateSelectedProductsPanel();
}

function removeProductFromSelection(productId) {
    delete selectedProducts[productId];
    updateSelectedProductsPanel();
}

function updateProductQuantity(productId, change) {
    if (selectedProducts[productId]) {
        selectedProducts[productId].quantity += change;
        if (selectedProducts[productId].quantity <= 0) {
            removeProductFromSelection(productId);
        } else {
            updateSelectedProductsPanel();
        }
    }
}

function updateSelectedProductsPanel() {
    const container = document.getElementById('selectedProductsContainer');
    const selectedPanel = document.getElementById('selectedProductsPanel');
    const modalBody = document.querySelector('.add-products-body');
    const productIds = Object.keys(selectedProducts);

    if (productIds.length === 0) {
        selectedPanel.classList.remove('has-products');
        modalBody.classList.remove('has-selection');
        container.innerHTML = `
            <div class="empty-selection">
                <p>Wybierz produkty z listy</p>
            </div>
        `;
        return;
    }

    selectedPanel.classList.add('has-products');
    modalBody.classList.add('has-selection');

    let totalValue = 0;
    const defaultImage = '/static/img/placeholders/product.svg';
    const html = productIds.map(id => {
        const product = selectedProducts[id];
        const itemTotal = product.price * product.quantity;
        totalValue += itemTotal;
        const imgUrl = product.image_url || defaultImage;

        return `
            <div class="selected-product-item">
                <img src="${imgUrl}" alt="${product.name}" class="selected-product-image" onerror="this.src='${defaultImage}'">
                <div class="selected-product-info">
                    <div class="selected-product-name">${product.name}</div>
                    <div class="selected-product-price">${parseFloat(product.price).toFixed(2)} PLN</div>
                </div>
                <div class="quantity-controls">
                    <button type="button" class="qty-btn" onclick="updateProductQuantity(${id}, -1)">-</button>
                    <span class="qty-value">${product.quantity}</span>
                    <button type="button" class="qty-btn" onclick="updateProductQuantity(${id}, 1)">+</button>
                </div>
                <button type="button" class="btn-remove" onclick="removeProductFromSelection(${id})">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                </button>
            </div>
        `;
    }).join('');

    container.innerHTML = html;

    // Update total in footer
    document.getElementById('selectedProductsTotalValue').textContent = totalValue.toFixed(2) + ' PLN';
}

function submitAddProducts() {
    const productIds = Object.keys(selectedProducts);

    if (productIds.length === 0) {
        showToast('Wybierz przynajmniej jeden produkt', 'error');
        return;
    }

    const products = productIds.map(id => ({
        product_id: parseInt(id),
        quantity: selectedProducts[id].quantity
    }));

    fetch(`/admin/orders/${orderId}/add-products`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        },
        body: JSON.stringify({ products: products })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Produkty zosta≈Çy dodane do zam√≥wienia', 'success');
            closeAddProductsModal();
            // Reload page to see updated products
            setTimeout(() => {
                window.location.reload();
            }, 500);
        } else {
            showToast(data.message || 'B≈ÇƒÖd podczas dodawania produkt√≥w', 'error');
        }
    })
    .catch(error => {
        console.error('Error adding products:', error);
        showToast('WystƒÖpi≈Ç b≈ÇƒÖd podczas dodawania produkt√≥w', 'error');
    });
}

// Debounce function for search
let searchTimeout;
function debounceSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(loadProducts, 300);
}

// Close modal on overlay click
document.addEventListener('click', function(e) {
    if (e.target.id === 'addProductsModal') {
        closeAddProductsModal();
    }
    if (e.target.id === 'editItemModal') {
        closeEditItemModal();
    }
    if (e.target.id === 'deleteItemModal') {
        closeDeleteItemModal();
    }
});

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const addModal = document.getElementById('addProductsModal');
        if (addModal && addModal.classList.contains('active')) {
            closeAddProductsModal();
        }
        const editModal = document.getElementById('editItemModal');
        if (editModal && editModal.classList.contains('active')) {
            closeEditItemModal();
        }
        const deleteModal = document.getElementById('deleteItemModal');
        if (deleteModal && deleteModal.classList.contains('active')) {
            closeDeleteItemModal();
        }
    }
});

// Close all dropdowns when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.item-actions-wrapper')) {
        document.querySelectorAll('.item-actions-dropdown.active').forEach(dropdown => {
            dropdown.classList.remove('active');
        });
    }
});

// ========================================
// ITEM ACTIONS DROPDOWN
// ========================================

function toggleItemActions(button, itemId) {
    event.stopPropagation();

    // Close all other dropdowns
    document.querySelectorAll('.item-actions-dropdown.active').forEach(dropdown => {
        dropdown.classList.remove('active');
    });

    const dropdown = document.getElementById('itemActions-' + itemId);
    dropdown.classList.toggle('active');
}

// ========================================
// EDIT ITEM MODAL
// ========================================

// Event listener dla przycisk√≥w edycji
document.querySelectorAll('.btn-edit-item').forEach(btn => {
    btn.addEventListener('click', function(e) {
        e.stopPropagation();
        const itemId = this.dataset.itemId;
        const productName = this.dataset.productName;
        const quantity = this.dataset.quantity;
        const price = this.dataset.price;
        openEditItemModal(itemId, productName, quantity, price);
    });
});

function openEditItemModal(itemId, productName, quantity, price) {
    // Close dropdown first
    document.querySelectorAll('.item-actions-dropdown.active').forEach(dropdown => {
        dropdown.classList.remove('active');
    });

    document.getElementById('editItemId').value = itemId;
    document.getElementById('editItemProductName').textContent = productName;
    document.getElementById('editItemQuantity').value = quantity;
    document.getElementById('editItemPrice').value = parseFloat(price).toFixed(2);

    updateEditItemTotal();

    const modal = document.getElementById('editItemModal');
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeEditItemModal() {
    const modal = document.getElementById('editItemModal');
    modal.classList.add('closing');

    setTimeout(() => {
        modal.classList.remove('active', 'closing');
        document.body.style.overflow = '';
    }, 350);
}

function updateEditItemTotal() {
    const quantity = parseInt(document.getElementById('editItemQuantity').value) || 0;
    const price = parseFloat(document.getElementById('editItemPrice').value) || 0;
    const total = quantity * price;
    document.getElementById('editItemTotal').textContent = total.toFixed(2) + ' PLN';
}

// Add event listeners for live total update
document.getElementById('editItemQuantity').addEventListener('input', updateEditItemTotal);
document.getElementById('editItemPrice').addEventListener('input', updateEditItemTotal);

function submitEditItem() {
    const itemId = document.getElementById('editItemId').value;
    const quantity = parseInt(document.getElementById('editItemQuantity').value);
    const price = parseFloat(document.getElementById('editItemPrice').value);

    if (quantity < 1) {
        showToast('Ilo≈õƒá musi byƒá wiƒôksza ni≈º 0', 'error');
        return;
    }

    if (price < 0) {
        showToast('Cena nie mo≈ºe byƒá ujemna', 'error');
        return;
    }

    fetch(`/admin/orders/${orderId}/items/${itemId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        },
        body: JSON.stringify({ quantity, price })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Produkt zosta≈Ç zaktualizowany', 'success');
            closeEditItemModal();
            // Reload page to see updated data
            setTimeout(() => {
                window.location.reload();
            }, 500);
        } else {
            showToast(data.message || 'B≈ÇƒÖd podczas aktualizacji', 'error');
        }
    })
    .catch(error => {
        console.error('Error updating item:', error);
        showToast('WystƒÖpi≈Ç b≈ÇƒÖd podczas aktualizacji', 'error');
    });
}

// ========================================
// DELETE ITEM MODAL
// ========================================

// Event listener dla przycisk√≥w usuwania
document.querySelectorAll('.btn-delete-item').forEach(btn => {
    btn.addEventListener('click', function(e) {
        e.stopPropagation();
        const itemId = this.dataset.itemId;
        const productName = this.dataset.productName;
        confirmDeleteItem(itemId, productName);
    });
});

function confirmDeleteItem(itemId, productName) {
    // Close dropdown first
    document.querySelectorAll('.item-actions-dropdown.active').forEach(dropdown => {
        dropdown.classList.remove('active');
    });

    document.getElementById('deleteItemId').value = itemId;
    document.getElementById('deleteItemName').textContent = '"' + productName + '"';

    const modal = document.getElementById('deleteItemModal');
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeDeleteItemModal() {
    const modal = document.getElementById('deleteItemModal');
    modal.classList.add('closing');

    setTimeout(() => {
        modal.classList.remove('active', 'closing');
        document.body.style.overflow = '';
    }, 350);
}

function submitDeleteItem() {
    const itemId = document.getElementById('deleteItemId').value;

    fetch(`/admin/orders/${orderId}/items/${itemId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            closeDeleteItemModal();
            // Reload page to see updated data
            setTimeout(() => {
                window.location.reload();
            }, 500);
        } else {
            showToast(data.message || 'B≈ÇƒÖd podczas usuwania', 'error');
        }
    })
    .catch(error => {
        console.error('Error deleting item:', error);
        showToast('WystƒÖpi≈Ç b≈ÇƒÖd podczas usuwania', 'error');
    });
}

// ========================================
// PAYMENT EDITOR
// ========================================

let originalPaidAmount = null;

function togglePaymentEditor() {
    const display = document.getElementById('paymentDisplay');
    const editor = document.getElementById('paymentEditor');
    const input = document.getElementById('paidAmountInput');

    // Store original value for cancel
    originalPaidAmount = input.value;

    display.style.display = 'none';
    editor.style.display = 'flex';
    input.focus();
    input.select();
}

function cancelPaymentEdit() {
    const display = document.getElementById('paymentDisplay');
    const editor = document.getElementById('paymentEditor');
    const input = document.getElementById('paidAmountInput');

    // Restore original value
    if (originalPaidAmount !== null) {
        input.value = originalPaidAmount;
    }

    editor.style.display = 'none';
    display.style.display = 'flex';
}

function setFullPayment() {
    const input = document.getElementById('paidAmountInput');
    const total = parseFloat(input.dataset.total) || 0;
    input.value = total.toFixed(2);
}

function setZeroPayment() {
    const input = document.getElementById('paidAmountInput');
    input.value = '0.00';
}

function savePayment() {
    const input = document.getElementById('paidAmountInput');
    const paidAmount = parseFloat(input.value) || 0;
    const total = parseFloat(input.dataset.total) || 0;

    if (paidAmount < 0) {
        showToast('Kwota nie mo≈ºe byƒá ujemna', 'error');
        return;
    }

    fetch(`/admin/orders/${orderId}/payment`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        },
        body: JSON.stringify({ paid_amount: paidAmount })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update UI without reload
            updatePaymentDisplay(paidAmount, total);
            showToast('P≈Çatno≈õƒá zosta≈Ça zaktualizowana', 'success');
        } else {
            showToast(data.message || 'B≈ÇƒÖd podczas aktualizacji p≈Çatno≈õci', 'error');
        }
    })
    .catch(error => {
        console.error('Error updating payment:', error);
        showToast('WystƒÖpi≈Ç b≈ÇƒÖd podczas aktualizacji p≈Çatno≈õci', 'error');
    });
}

function updatePaymentDisplay(paidAmount, total) {
    const display = document.getElementById('paymentDisplay');
    const editor = document.getElementById('paymentEditor');
    const badge = document.getElementById('paidAmountBadge');
    const input = document.getElementById('paidAmountInput');

    // Update badge text
    badge.textContent = paidAmount.toFixed(2) + ' PLN';

    // Update badge class
    badge.classList.remove('payment-badge-paid', 'payment-badge-partial', 'payment-badge-unpaid', 'payment-badge-overpaid');
    if (paidAmount > total && total > 0) {
        badge.classList.add('payment-badge-overpaid');
    } else if (paidAmount === total && total > 0) {
        badge.classList.add('payment-badge-paid');
    } else if (paidAmount > 0) {
        badge.classList.add('payment-badge-partial');
    } else {
        badge.classList.add('payment-badge-unpaid');
    }

    // Update input value
    input.value = paidAmount.toFixed(2);
    originalPaidAmount = paidAmount.toFixed(2);

    // Hide editor, show display
    editor.style.display = 'none';
    display.style.display = 'flex';
}

// Allow Enter key to save payment
document.getElementById('paidAmountInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        savePayment();
    } else if (e.key === 'Escape') {
        e.preventDefault();
        cancelPaymentEdit();
    }
});

// Click on badge also opens editor
document.getElementById('paidAmountBadge').addEventListener('click', function() {
    togglePaymentEditor();
});

// ========================================
// INLINE FIELD EDITORS
// ========================================

// Store original values
const originalValues = {
    deliveryMethod: null,
    shippingCost: null
};

// Display names mappings
const deliveryMethodNames = {
    '': '-',
    'kurier': 'Kurier',
    'paczkomat': 'InPost',
    'odbior_osobisty': 'Odbi√≥r osobisty',
    'poczta': 'Poczta Polska',
    'dpd_pickup': 'DPD Pickup',
    'orlen_paczka': 'Orlen Paczka'
};

function toggleInlineEditor(fieldName) {
    const display = document.getElementById(fieldName + 'Display');
    const editor = document.getElementById(fieldName + 'Editor');

    // Store original value
    if (fieldName === 'deliveryMethod') {
        originalValues.deliveryMethod = document.getElementById('deliveryMethodSelect').value;
    } else if (fieldName === 'shippingCost') {
        originalValues.shippingCost = document.getElementById('shippingCostInput').value;
    }

    display.style.display = 'none';
    editor.style.display = 'flex';

    // Focus on input/select
    if (fieldName === 'shippingCost') {
        const input = document.getElementById('shippingCostInput');
        input.focus();
        input.select();
    } else if (fieldName === 'deliveryMethod') {
        document.getElementById('deliveryMethodSelect').focus();
    }
}

function cancelInlineEditor(fieldName) {
    const display = document.getElementById(fieldName + 'Display');
    const editor = document.getElementById(fieldName + 'Editor');

    // Restore original value
    if (fieldName === 'deliveryMethod' && originalValues.deliveryMethod !== null) {
        document.getElementById('deliveryMethodSelect').value = originalValues.deliveryMethod;
    } else if (fieldName === 'shippingCost' && originalValues.shippingCost !== null) {
        document.getElementById('shippingCostInput').value = originalValues.shippingCost;
    }

    editor.style.display = 'none';
    display.style.display = 'flex';
}

function saveInlineField(fieldName) {
    let value, apiField;

    if (fieldName === 'deliveryMethod') {
        value = document.getElementById('deliveryMethodSelect').value;
        apiField = 'delivery_method';
    } else if (fieldName === 'shippingCost') {
        value = parseFloat(document.getElementById('shippingCostInput').value) || 0;
        apiField = 'shipping_cost';
        if (value < 0) {
            showToast('Koszt wysy≈Çki nie mo≈ºe byƒá ujemny', 'error');
            return;
        }
    }

    fetch(`/admin/orders/${orderId}/update-field`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        },
        body: JSON.stringify({
            field: apiField,
            value: value
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateInlineDisplay(fieldName, value, data);
            showToast('Zaktualizowano pomy≈õlnie', 'success');
        } else {
            showToast(data.message || 'B≈ÇƒÖd podczas aktualizacji', 'error');
        }
    })
    .catch(error => {
        console.error('Error updating field:', error);
        showToast('WystƒÖpi≈Ç b≈ÇƒÖd podczas aktualizacji', 'error');
    });
}

function updateInlineDisplay(fieldName, value, data) {
    const display = document.getElementById(fieldName + 'Display');
    const editor = document.getElementById(fieldName + 'Editor');
    const valueSpan = document.getElementById(fieldName + 'Value');

    if (fieldName === 'deliveryMethod') {
        valueSpan.textContent = deliveryMethodNames[value] || value || '-';
    } else if (fieldName === 'shippingCost') {
        valueSpan.textContent = parseFloat(value).toFixed(2) + ' PLN';
        // Update grand_total displays after shipping cost change
        if (data.grand_total !== undefined) {
            updateGrandTotalDisplays(data.grand_total, data.paid_amount);
        }
    }

    editor.style.display = 'none';
    display.style.display = 'flex';
}

function updateGrandTotalDisplays(grandTotal, paidAmount) {
    // Update grand total text displays
    const grandTotalDisplay = document.getElementById('grandTotalDisplay');
    const grandTotalEditor = document.getElementById('grandTotalEditor');
    const btnPaymentFull = document.getElementById('btnPaymentFull');
    const paidAmountInput = document.getElementById('paidAmountInput');
    const paidAmountBadge = document.getElementById('paidAmountBadge');

    if (grandTotalDisplay) {
        grandTotalDisplay.textContent = 'z ' + grandTotal.toFixed(2) + ' PLN';
    }
    if (grandTotalEditor) {
        grandTotalEditor.textContent = grandTotal.toFixed(2);
    }
    if (btnPaymentFull) {
        btnPaymentFull.textContent = grandTotal.toFixed(2);
    }
    if (paidAmountInput) {
        paidAmountInput.dataset.total = grandTotal.toFixed(2);
    }

    // Update payment badge color based on new grand_total
    if (paidAmountBadge && paidAmount !== undefined) {
        paidAmountBadge.classList.remove('payment-badge-paid', 'payment-badge-partial', 'payment-badge-unpaid', 'payment-badge-overpaid');
        if (paidAmount > grandTotal && grandTotal > 0) {
            paidAmountBadge.classList.add('payment-badge-overpaid');
        } else if (paidAmount === grandTotal && grandTotal > 0) {
            paidAmountBadge.classList.add('payment-badge-paid');
        } else if (paidAmount > 0) {
            paidAmountBadge.classList.add('payment-badge-partial');
        } else {
            paidAmountBadge.classList.add('payment-badge-unpaid');
        }
    }
}

// Keyboard shortcuts for inline editors
document.getElementById('shippingCostInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        saveInlineField('shippingCost');
    } else if (e.key === 'Escape') {
        e.preventDefault();
        cancelInlineEditor('shippingCost');
    }
});

document.getElementById('deliveryMethodSelect').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        saveInlineField('deliveryMethod');
    } else if (e.key === 'Escape') {
        e.preventDefault();
        cancelInlineEditor('deliveryMethod');
    }
});

</script>

<!-- Reject Payment Proof Modal -->
<div id="rejectPaymentProofModal" class="modal-overlay">
    <div class="modal-content modal-small">
        <div class="modal-header">
            <h2>Odrzuƒá dow√≥d wp≈Çaty</h2>
            <button class="modal-close" onclick="closeRejectPaymentProofModal()">&times;</button>
        </div>

        <div class="modal-body">
            <form id="rejectPaymentProofForm">
                <div class="form-group">
                    <label for="rejectionReason">Pow√≥d odrzucenia *</label>
                    <textarea id="rejectionReason"
                              name="rejection_reason"
                              rows="4"
                              required
                              placeholder="Np. Brak tytu≈Çu przelewu, nieczytelny obraz, inna kwota..."></textarea>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeRejectPaymentProofModal()">Anuluj</button>
                    <button type="submit" class="btn-danger">Odrzuƒá dow√≥d</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Reject Shipping Payment Proof Modal (for ShippingRequest) -->
<div id="rejectShippingPaymentProofModal" class="modal-overlay">
    <div class="modal-content modal-small">
        <div class="modal-header">
            <h2>Odrzuƒá dow√≥d wp≈Çaty za wysy≈Çkƒô</h2>
            <button class="modal-close" onclick="closeRejectShippingPaymentProofModal()">&times;</button>
        </div>

        <div class="modal-body">
            <form id="rejectShippingPaymentProofForm">
                <div class="form-group">
                    <label for="shippingRejectionReason">Pow√≥d odrzucenia *</label>
                    <textarea id="shippingRejectionReason"
                              name="rejection_reason"
                              rows="4"
                              required
                              placeholder="Np. Brak tytu≈Çu przelewu, nieczytelny obraz, inna kwota..."></textarea>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeRejectShippingPaymentProofModal()">Anuluj</button>
                    <button type="submit" class="btn-danger">Odrzuƒá dow√≥d</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Shipping Request Modal -->
<div id="editShippingRequestModal" class="modal-overlay">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2>
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M0 3.5A1.5 1.5 0 0 1 1.5 2h9A1.5 1.5 0 0 1 12 3.5V5h1.02a1.5 1.5 0 0 1 1.17.563l1.481 1.85a1.5 1.5 0 0 1 .329.938V10.5a1.5 1.5 0 0 1-1.5 1.5H14a2 2 0 1 1-4 0H5a2 2 0 1 1-3.998-.085A1.5 1.5 0 0 1 0 10.5v-7zm1.294 7.456A1.999 1.999 0 0 1 4.732 11h5.536a2.01 2.01 0 0 1 .732-.732V3.5a.5.5 0 0 0-.5-.5h-9a.5.5 0 0 0-.5.5v7a.5.5 0 0 0 .294.456zM12 10a2 2 0 0 1 1.732 1h.768a.5.5 0 0 0 .5-.5V8.35a.5.5 0 0 0-.11-.312l-1.48-1.85A.5.5 0 0 0 13.02 6H12v4zm-9 1a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm9 0a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/>
                </svg>
                Edytuj zlecenie wysy≈Çki
                <span id="srModalNumber" class="sr-modal-number"></span>
            </h2>
            <button class="modal-close" onclick="closeShippingRequestModal()">&times;</button>
        </div>

        <div class="modal-body">
            <form id="editShippingRequestForm">
                <input type="hidden" id="srModalId" name="shipping_request_id">

                <!-- Status i dane podstawowe -->
                <div class="sr-modal-section">
                    <h4>Status i dane podstawowe</h4>
                    <div class="sr-modal-grid">
                        <div class="form-group">
                            <label for="srStatus">Status</label>
                            <select id="srStatus" name="status" class="form-select">
                                <!-- Options will be loaded dynamically -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="srCourier">Kurier</label>
                            <select id="srCourier" name="courier" class="form-select">
                                <option value="">-- Wybierz kuriera --</option>
                                <option value="InPost">InPost</option>
                                <option value="DPD">DPD</option>
                                <option value="DHL">DHL</option>
                                <option value="GLS">GLS</option>
                                <option value="FedEx">FedEx</option>
                                <option value="UPS">UPS</option>
                                <option value="Poczta Polska">Poczta Polska</option>
                                <option value="Inny">Inny</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="srTracking">Numer tracking</label>
                            <input type="text" id="srTracking" name="tracking_number" class="form-input" placeholder="np. 123456789">
                        </div>
                    </div>
                </div>

                <!-- Koszty wysy≈Çki -->
                <div class="sr-modal-section">
                    <h4>Koszty wysy≈Çki</h4>
                    <div class="sr-shipping-costs">
                        <div class="sr-total-cost-row">
                            <label>Ca≈Çkowity koszt wysy≈Çki:</label>
                            <div class="sr-total-cost-input">
                                <input type="number" id="srTotalCost" step="0.01" min="0" placeholder="0.00" class="form-input">
                                <span class="currency">PLN</span>
                                <button type="button" class="btn btn-sm btn-secondary" onclick="distributeShippingCost()">
                                    Roz≈Ç√≥≈º na zam√≥wienia
                                </button>
                            </div>
                        </div>
                        <div class="sr-orders-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Zam√≥wienie</th>
                                        <th>Warto≈õƒá</th>
                                        <th>Koszt wysy≈Çki</th>
                                    </tr>
                                </thead>
                                <tbody id="srOrdersTableBody">
                                    <!-- Orders will be loaded dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Adres dostawy (readonly) -->
                <div class="sr-modal-section">
                    <h4>Adres dostawy</h4>
                    <div id="srAddressPreview" class="sr-address-preview">
                        <!-- Address will be loaded dynamically -->
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="cancelShippingRequest()">
                        Anuluj zlecenie
                    </button>
                    <div class="modal-footer-right">
                        <button type="button" class="btn btn-secondary" onclick="closeShippingRequestModal()">Zamknij</button>
                        <button type="submit" class="btn btn-primary">Zapisz zmiany</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/pages/admin/shipping-requests.js') }}"></script>
{% endblock %}
