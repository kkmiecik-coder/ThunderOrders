{% extends "admin/base_admin.html" %}

{% block title %}Potwierdzenia płatności - Admin - ThunderOrders{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin/orders-list.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin/payment-confirmations.css') }}">
{% endblock %}

{% block content %}
<div class="pc-list-page">
    <!-- Page Header + Quick Filters -->
    <div class="page-header">
        <div class="page-header-left">
            <h1>Potwierdzenia płatności</h1>
        </div>
        <div class="quick-filters">
            <a href="{{ url_for('admin.payment_confirmations_list', stage=stage_filter if stage_filter != 'all' else none) }}"
               class="filter-btn {% if status_filter == 'all' %}active{% endif %}">
                Wszystkie
                <span class="filter-count">{{ pending_count + approved_count + rejected_count }}</span>
            </a>
            <a href="{{ url_for('admin.payment_confirmations_list', status='pending', stage=stage_filter if stage_filter != 'all' else none) }}"
               class="filter-btn {% if status_filter == 'pending' %}active{% endif %}">
                Oczekujące
                <span class="filter-count">{{ pending_count }}</span>
            </a>
            <a href="{{ url_for('admin.payment_confirmations_list', status='approved', stage=stage_filter if stage_filter != 'all' else none) }}"
               class="filter-btn {% if status_filter == 'approved' %}active{% endif %}">
                Zaakceptowane
                <span class="filter-count">{{ approved_count }}</span>
            </a>
            <a href="{{ url_for('admin.payment_confirmations_list', status='rejected', stage=stage_filter if stage_filter != 'all' else none) }}"
               class="filter-btn {% if status_filter == 'rejected' %}active{% endif %}">
                Odrzucone
                <span class="filter-count">{{ rejected_count }}</span>
            </a>
        </div>
        <div class="quick-filters pc-stage-filters">
            <a href="{{ url_for('admin.payment_confirmations_list', status=status_filter if status_filter != 'all' else none) }}"
               class="filter-btn {% if stage_filter == 'all' %}active{% endif %}">
                Wszystkie etapy
            </a>
            <a href="{{ url_for('admin.payment_confirmations_list', stage='product', status=status_filter if status_filter != 'all' else none) }}"
               class="filter-btn {% if stage_filter == 'product' %}active{% endif %}">
                Produkt
                <span class="filter-count">{{ stage_counts.product }}</span>
            </a>
            <a href="{{ url_for('admin.payment_confirmations_list', stage='korean_shipping', status=status_filter if status_filter != 'all' else none) }}"
               class="filter-btn {% if stage_filter == 'korean_shipping' %}active{% endif %}">
                Wysyłka KR
                <span class="filter-count">{{ stage_counts.korean_shipping }}</span>
            </a>
            <a href="{{ url_for('admin.payment_confirmations_list', stage='customs_vat', status=status_filter if status_filter != 'all' else none) }}"
               class="filter-btn {% if stage_filter == 'customs_vat' %}active{% endif %}">
                Cło/VAT
                <span class="filter-count">{{ stage_counts.customs_vat }}</span>
            </a>
            <a href="{{ url_for('admin.payment_confirmations_list', stage='domestic_shipping', status=status_filter if status_filter != 'all' else none) }}"
               class="filter-btn {% if stage_filter == 'domestic_shipping' %}active{% endif %}">
                Wysyłka PL
                <span class="filter-count">{{ stage_counts.domestic_shipping }}</span>
            </a>
        </div>
    </div>

    <!-- Tabela potwierdzeń -->
    <div class="table-container">
        {% if groups|length > 0 %}
        <table class="orders-table">
            <thead>
                <tr>
                    <th class="col-date">Data</th>
                    <th class="col-number">Zamówienia</th>
                    <th class="col-customer">Klient</th>
                    <th class="col-stage hide-mobile">Etap</th>
                    <th class="col-amount text-right">Kwota</th>
                    <th class="col-extra">Status</th>
                    <th class="col-proof hide-mobile">Plik</th>
                    <th class="col-actions">Akcje</th>
                </tr>
            </thead>
            <tbody>
                {% for group in groups %}
                {% set items = group['items'] %}
                {% set first = items[0] %}
                {% set all_ids = items|map(attribute='id')|list %}
                {% set pending_items = items|selectattr('status', 'equalto', 'pending')|list %}
                {% set has_pending = pending_items|length > 0 %}
                {% set group_status = 'pending' if has_pending else first.status %}
                {% set total_amount = items|map(attribute='amount')|sum %}
                {% set is_pdf_row = first.proof_file and first.proof_file.lower().endswith('.pdf') %}
                <tr class="{% if has_pending %}row-pending{% endif %}"
                    data-confirmation-ids="{{ all_ids|join(',') }}"
                    data-status="{{ group_status }}"
                    data-proof-url="{{ first.proof_url or '' }}"
                    data-order-numbers="{{ items|map(attribute='order')|map(attribute='order_number')|join(',') }}"
                    data-total-amount="{{ '%.2f'|format(total_amount) }}"
                    data-is-pdf="{{ 'true' if is_pdf_row else 'false' }}"
                    data-proof-file="{{ first.proof_file or '' }}">
                    <!-- Data -->
                    <td class="col-date">
                        <div class="date-cell-new">
                            {% if first.uploaded_at %}
                                <span class="date-created">{{ first.uploaded_at.strftime('%d.%m.%Y') }}</span>
                                <span class="date-updated">{{ first.uploaded_at.strftime('%H:%M') }}</span>
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </div>
                    </td>

                    <!-- Zamówienia -->
                    <td class="col-number">
                        {% for item in items %}
                        <div class="pc-order-line">
                            <a href="{{ url_for('orders.admin_detail', order_id=item.order.id) }}" class="order-number-link">
                                {{ item.order.order_number }}
                            </a>
                            <span class="pc-order-amount">{{ "%.2f"|format(item.amount) }} PLN</span>
                        </div>
                        {% endfor %}
                    </td>

                    <!-- Klient -->
                    <td class="col-customer">
                        <div class="customer-cell-new">
                            <div class="customer-name-row">
                                {% if first.order.user %}
                                    <span class="customer-name">{{ first.order.user.full_name or first.order.user.email }}</span>
                                {% else %}
                                    <span class="customer-name">{{ first.order.customer_name or 'Gość' }}</span>
                                    <span class="badge badge-guest-sm">Gość</span>
                                {% endif %}
                            </div>
                        </div>
                    </td>

                    <!-- Etap (ukryty na mobile) -->
                    <td class="col-stage hide-mobile">
                        <span class="pc-stage-badge">{{ first.stage_display_name }}</span>
                    </td>

                    <!-- Kwota -->
                    <td class="col-amount text-right">
                        <span class="amount-cell">{{ "%.2f"|format(total_amount) }} PLN</span>
                        {% if items|length > 1 %}
                        <span class="pc-amount-count">({{ items|length }} zam.)</span>
                        {% endif %}
                    </td>

                    <!-- Status -->
                    <td class="col-extra">
                        <div class="extra-info">
                            <span class="badge status-badge pc-badge-{{ group_status }}">
                                {% if group_status == 'pending' %}Oczekujące
                                {% elif group_status == 'approved' %}Zaakceptowane
                                {% elif group_status == 'rejected' %}Odrzucone
                                {% endif %}
                            </span>
                            {% if group_status == 'rejected' and first.rejection_reason %}
                                <span class="rejection-reason-hint" title="{{ first.rejection_reason }}">
                                    {{ first.rejection_reason[:40] }}{% if first.rejection_reason|length > 40 %}...{% endif %}
                                </span>
                            {% endif %}
                        </div>
                    </td>

                    <!-- Plik (ukryty na mobile) -->
                    <td class="col-proof hide-mobile">
                        {% if first.proof_file %}
                            <div class="pc-thumbnail-wrapper" onclick="openLightboxFromRow(this)">
                                {% if is_pdf_row %}
                                    <div class="pc-thumbnail pc-thumbnail-pdf">PDF</div>
                                {% else %}
                                    <img src="{{ first.proof_url }}" alt="Dowód" class="pc-thumbnail">
                                {% endif %}
                            </div>
                        {% else %}
                            <span class="text-muted">Brak</span>
                        {% endif %}
                    </td>

                    <!-- Akcje -->
                    <td class="col-actions">
                        {% if has_pending %}
                        <div class="pc-actions">
                            <button type="button" class="pc-btn pc-btn-approve"
                                    onclick="openConfirmApproveFromRow(this)"
                                    aria-label="Akceptuj potwierdzenie płatności">
                                <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
                                </svg>
                                Akceptuj
                            </button>
                            <button type="button" class="pc-btn pc-btn-reject"
                                    onclick="openRejectFromRow(this)"
                                    aria-label="Odrzuć potwierdzenie płatności">
                                <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                                </svg>
                                Odrzuć
                            </button>
                        </div>
                        {% elif group_status == 'approved' %}
                            <span class="text-muted">Zatwierdzono</span>
                        {% elif group_status == 'rejected' %}
                            <span class="text-muted">Odrzucono</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% if pagination.pages > 1 %}
        <div class="pagination">
            <div class="pagination-info">
                Strona {{ pagination.page }} z {{ pagination.pages }} ({{ pagination.total }} potwierdzeń)
            </div>
            <div class="pagination-controls">
                {% if pagination.has_prev %}
                <a href="{{ url_for('admin.payment_confirmations_list', page=pagination.prev_num, status=status_filter if status_filter != 'all' else none, stage=stage_filter if stage_filter != 'all' else none) }}"
                   class="pagination-btn">
                    &laquo; Poprzednia
                </a>
                {% endif %}

                {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                    {% if page_num %}
                        <a href="{{ url_for('admin.payment_confirmations_list', page=page_num, status=status_filter if status_filter != 'all' else none, stage=stage_filter if stage_filter != 'all' else none) }}"
                           class="pagination-btn {% if page_num == pagination.page %}active{% endif %}">
                            {{ page_num }}
                        </a>
                    {% else %}
                        <span class="pagination-ellipsis">...</span>
                    {% endif %}
                {% endfor %}

                {% if pagination.has_next %}
                <a href="{{ url_for('admin.payment_confirmations_list', page=pagination.next_num, status=status_filter if status_filter != 'all' else none, stage=stage_filter if stage_filter != 'all' else none) }}"
                   class="pagination-btn">
                    Następna &raquo;
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% else %}
        <!-- Pusty stan -->
        <div class="empty-state">
            <svg width="64" height="64" fill="currentColor" viewBox="0 0 16 16">
                {% if status_filter == 'pending' %}
                <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
                {% else %}
                <path d="M5.5 9.511c.076.954.83 1.697 2.182 1.785V12h.6v-.709c1.4-.098 2.218-.846 2.218-1.932 0-.987-.626-1.496-1.745-1.76l-.473-.112V5.57c.6.068.982.396 1.074.85h1.052c-.076-.919-.864-1.638-2.126-1.716V4h-.6v.719c-1.195.117-2.01.836-2.01 1.853 0 .9.606 1.472 1.613 1.707l.397.098v2.034c-.615-.093-1.022-.43-1.114-.9H5.5zm2.177-2.166c-.59-.137-.91-.416-.91-.836 0-.47.345-.822.915-.925v1.76h-.005zm.692 1.193c.717.166 1.048.435 1.048.91 0 .542-.412.914-1.135.982V8.518l.087.02z"/>
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                {% endif %}
            </svg>
            <h3>
                {% if status_filter == 'pending' %}
                    Brak oczekujących potwierdzeń
                {% elif status_filter == 'approved' %}
                    Brak zaakceptowanych potwierdzeń
                {% elif status_filter == 'rejected' %}
                    Brak odrzuconych potwierdzeń
                {% else %}
                    Brak potwierdzeń płatności
                {% endif %}
            </h3>
            <p>
                {% if status_filter == 'pending' %}
                    Wszystkie potwierdzenia zostały rozpatrzone.
                {% else %}
                    Klienci jeszcze nie wgrali potwierdzeń płatności.
                {% endif %}
            </p>
        </div>
        {% endif %}
    </div>
</div>

<!-- ================================
     LIGHTBOX
     ================================ -->
<div class="pc-lightbox" id="pcLightbox">
    <button type="button" class="pc-lightbox-close" onclick="closeLightbox()" aria-label="Zamknij">&times;</button>
    <img id="pcLightboxImage" class="pc-lightbox-image" alt="Dowód wpłaty">
    <iframe id="pcLightboxPdf" class="pc-lightbox-pdf" style="display: none;"></iframe>
    <div class="pc-lightbox-info" id="pcLightboxInfo"></div>
    <div class="pc-lightbox-counter" id="pcLightboxCounter"></div>
    <div class="pc-lightbox-actions" id="pcLightboxActions">
        <button type="button" class="pc-btn pc-btn-approve" onclick="openConfirmApprove()">
            <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
            </svg>
            Akceptuj
        </button>
        <button type="button" class="pc-btn pc-btn-reject" onclick="openRejectModal()">
            <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
            </svg>
            Odrzuć
        </button>
    </div>
</div>

<!-- ================================
     CONFIRM APPROVE MODAL
     ================================ -->
<div class="modal-overlay" id="pcConfirmModal">
    <div class="modal-content">
        <div class="modal-body" style="text-align: center; padding: 2rem;">
            <div class="pc-confirm-icon">
                <svg width="48" height="48" fill="#4CAF50" viewBox="0 0 16 16">
                    <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
                </svg>
            </div>
            <h3 class="pc-confirm-title">Zaakceptować potwierdzenie?</h3>
            <p class="pc-confirm-text">
                Zamówienie: <strong id="pcConfirmOrderInfo"></strong>
            </p>
            <div class="pc-confirm-actions">
                <button type="button" class="btn btn-ghost" onclick="closeConfirmModal()">Anuluj</button>
                <button type="button" class="pc-btn pc-btn-approve" id="pcConfirmApproveBtn" onclick="submitApprove()">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
                    </svg>
                    Akceptuj
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ================================
     REJECT MODAL
     ================================ -->
<div class="modal-overlay" id="pcRejectModal">
    <div class="modal-content modal-medium">
        <div class="modal-header">
            <h2 class="pc-reject-header-title">Odrzuć potwierdzenie</h2>
            <button class="modal-close" onclick="closeRejectModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label" for="pcRejectReason">Powód odrzucenia <span style="color: #e53935;">*</span></label>
                <textarea id="pcRejectReason" class="form-input pc-reject-textarea" placeholder="Opisz dlaczego potwierdzenie zostało odrzucone..." minlength="10"></textarea>
                <small class="form-hint">Minimum 10 znaków. Klient zobaczy ten powód w emailu.</small>
                <p class="pc-reject-error" id="pcRejectError"></p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-ghost" onclick="closeRejectModal()">Anuluj</button>
            <button type="button" class="pc-btn pc-btn-reject" id="pcRejectSubmitBtn" onclick="submitReject()">
                <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                </svg>
                Odrzuć
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/pages/admin/payment-confirmations.js') }}"></script>
{% endblock %}
