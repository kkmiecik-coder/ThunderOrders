{% extends "admin/base_admin.html" %}

{% block title %}Panel Administratora - ThunderOrders{% endblock %}

{% block content %}
<div class="kpop-dashboard">
    <!-- Header -->
    <div class="dashboard-header">
        <div class="header-content">
            <h1 class="dashboard-title">
                Witaj z powrotem, <span class="title-gradient">{{ current_user.first_name }}!</span>
            </h1>
        </div>
    </div>

    <!-- Statistics Cards Grid -->
    <div class="stats-grid">
        <!-- Revenue Card -->
        <div class="stat-card stat-card-gradient-purple">
            <div class="stat-icon">üí∞</div>
            <div class="stat-content">
                <h3 class="stat-label">Przych√≥d</h3>
                <p class="stat-value">{{ "%.2f"|format(revenue.month) }} PLN</p>
                <div class="stat-meta">
                    <div><strong>MiesiƒÖc:</strong> {{ "%.2f"|format(revenue.month) }} PLN</div>
                    <div><strong>Tydzie≈Ñ:</strong> {{ "%.2f"|format(revenue.week) }} PLN</div>
                    <div><strong>Dzisiaj:</strong> {{ "%.2f"|format(revenue.today) }} PLN</div>
                </div>
            </div>
        </div>

        <!-- Orders Card -->
        <div class="stat-card stat-card-gradient-pink">
            <div class="stat-icon">üì¶</div>
            <div class="stat-content">
                <h3 class="stat-label">Zam√≥wienia</h3>
                <p class="stat-value">{{ orders.all }}</p>
                <div class="stat-meta">
                    <div><strong>MiesiƒÖc:</strong> {{ orders.month }}</div>
                    <div><strong>Tydzie≈Ñ:</strong> {{ orders.week }}</div>
                    <div><strong>Dzisiaj:</strong> {{ orders.today }}</div>
                </div>
            </div>
        </div>

        <!-- Clients Card -->
        <div class="stat-card stat-card-gradient-cyan">
            <div class="stat-icon">üë•</div>
            <div class="stat-content">
                <h3 class="stat-label">Wszyscy klienci</h3>
                <p class="stat-value">{{ clients.total }}</p>
                <div class="stat-meta">
                    <div><strong>Nowi w tym miesiƒÖcu:</strong> {{ clients.new }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Grid (2 columns) -->
    <div class="dashboard-grid">
        <!-- Left Column -->
        <div class="dashboard-column">
            <!-- Sales Chart -->
            <div class="widget widget-chart">
                <div class="widget-header">
                    <h2 class="widget-title">üìà Sprzeda≈º</h2>
                    <select id="salesRangeDropdown" class="sales-range-dropdown">
                        <option value="7d">7 dni</option>
                        <option value="14d">14 dni</option>
                        <option value="30d">30 dni</option>
                        <option value="3m">3 miesiƒÖce</option>
                        <option value="12m">12 miesiƒôcy</option>
                        <option value="ytd">Bie≈ºƒÖcy rok</option>
                    </select>
                </div>
                <div class="widget-body">
                    <canvas id="salesChart" height="200"></canvas>
                </div>
            </div>

            <!-- Recent Orders Widget -->
            <div class="widget widget-orders">
                <div class="widget-header">
                    <h2 class="widget-title">üì¶ Ostatnie Zam√≥wienia</h2>
                    <a href="{{ url_for('orders.admin_list') }}" class="widget-link">Zobacz wszystkie ‚Üí</a>
                </div>
                <div class="widget-body widget-body-table">
                    {% if recent_orders|length > 0 %}
                        <table class="recent-orders-table">
                            <thead>
                                <tr>
                                    <th>Numer</th>
                                    <th>Klient</th>
                                    <th>Status</th>
                                    <th class="text-right">Kwota</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in recent_orders %}
                                <tr onclick="window.location.href='{{ url_for('orders.admin_detail', order_id=order.id) }}'" style="cursor: pointer;">
                                    <td>
                                        <span class="order-number-link">{{ order.order_number }}</span>
                                    </td>
                                    <td>
                                        <span class="order-client">{{ order.customer_name }}</span>
                                    </td>
                                    <td>
                                        <span class="order-status" style="background-color: {{ order.status_badge_color }}; color: white;">
                                            {{ order.status_display_name }}
                                        </span>
                                    </td>
                                    <td class="text-right">
                                        <span class="order-amount">{{ "%.2f"|format(order.effective_grand_total) }} PLN</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <div class="empty-state">
                            <p class="empty-icon">üì≠</p>
                            <p class="empty-text">Brak zam√≥wie≈Ñ</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="dashboard-column">
            <!-- Top Products Chart -->
            <div class="widget widget-chart">
                <div class="widget-header">
                    <h2 class="widget-title">üî• Top Produkty</h2>
                </div>
                <div class="widget-body">
                    <canvas id="productsChart" height="200"></canvas>
                </div>
            </div>

            <!-- TODO Widget -->
            <div class="widget widget-todo">
                <div class="widget-header">
                    <h2 class="widget-title">‚úÖ Moje TODO</h2>
                    <button class="widget-link" onclick="openTaskModal()">+ Dodaj</button>
                </div>
                <div class="widget-body widget-body-table">
                    {% if tasks.recent_tasks|length > 0 %}
                        <table class="todo-table">
                            <thead>
                                <tr>
                                    <th>Zadanie</th>
                                    <th>Priorytet</th>
                                    <th>Termin</th>
                                    <th class="text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for task in tasks.recent_tasks %}
                                <tr onclick="openTaskPreview({{ task.id }})" style="cursor: pointer;" class="todo-row-status-{{ task.status }}">
                                    <td>
                                        <span class="todo-name{% if task.status == 'completed' %} todo-completed{% endif %}">
                                            {{ task.name }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="todo-priority todo-priority-{{ task.priority }}">
                                            {% if task.priority == 'high' %}Pilne{% elif task.priority == 'medium' %}≈öredni{% else %}Niski{% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        {% if task.due_date %}
                                            <span class="todo-date{% if task.is_overdue() %} todo-overdue{% endif %}">
                                                {% if task.is_overdue() %}‚ö†Ô∏è {% endif %}{{ task.due_date|format_date('%d.%m.%Y') }}
                                            </span>
                                        {% else %}
                                            <span class="todo-no-date">‚Äî</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <span class="todo-status-badge todo-status-badge-{{ task.status }}">
                                            {% if task.status == 'pending' %}Do zrobienia
                                            {% elif task.status == 'in_progress' %}W trakcie
                                            {% elif task.status == 'completed' %}‚úì Gotowe
                                            {% endif %}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% if tasks.total > 5 %}
                            <div style="padding: var(--space-4);">
                                <a href="{{ url_for('admin.tasks_list') }}" class="view-all-link">
                                    Zobacz wszystkie ({{ tasks.total }}) ‚Üí
                                </a>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="empty-state">
                            <p class="empty-icon">‚ú®</p>
                            <p class="empty-text">Brak zada≈Ñ</p>
                            <button class="btn-kpop btn-kpop-secondary" onclick="openTaskModal()">
                                Dodaj pierwsze TODO
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Exclusive Pages Widget -->
            <div class="widget widget-exclusive" id="exclusiveWidget">
                <div class="widget-header">
                    <h2 class="widget-title">‚ú® Strony Exclusive</h2>
                    <a href="{{ url_for('admin.exclusive_list') }}" class="widget-link">ZarzƒÖdzaj ‚Üí</a>
                </div>
                <div class="widget-body widget-body-table">
                    {% if exclusive_pages.visible|length > 0 %}
                        <table class="exclusive-table">
                            <thead>
                                <tr>
                                    <th>Nazwa</th>
                                    <th>Status</th>
                                    <th>Start</th>
                                    <th>Koniec</th>
                                </tr>
                            </thead>
                            <tbody id="exclusiveTableBody">
                                {# Visible pages #}
                                {% for page in exclusive_pages.visible %}
                                <tr onclick="window.location.href='{{ url_for('admin.exclusive_edit', page_id=page.id) }}'" style="cursor: pointer;">
                                    <td>
                                        <span class="exclusive-name">{{ page.name }}</span>
                                    </td>
                                    <td>
                                        {% if page.status == 'ended' and page.is_fully_closed %}
                                            <span class="exclusive-status exclusive-status-closed">Zamkniƒôta</span>
                                        {% elif page.status == 'ended' %}
                                            <span class="exclusive-status exclusive-status-ended">Zako≈Ñczona</span>
                                        {% else %}
                                            <span class="exclusive-status exclusive-status-{{ page.status }}">
                                                {% if page.status == 'draft' %}Draft
                                                {% elif page.status == 'scheduled' %}Zaplanowana
                                                {% elif page.status == 'active' %}Aktywna
                                                {% elif page.status == 'paused' %}Wstrzymana
                                                {% endif %}
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if page.starts_at %}
                                            <span class="exclusive-date">{{ page.starts_at|format_date('%d.%m.%Y %H:%M') }}</span>
                                        {% else %}
                                            <span class="exclusive-no-date">‚Äî</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if page.ends_at %}
                                            <span class="exclusive-date">{{ page.ends_at|format_date('%d.%m.%Y %H:%M') }}</span>
                                        {% else %}
                                            <span class="exclusive-no-date">‚Äî</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                                {# Buffer pages (hidden, will be shown on "load more") #}
                                {% for page in exclusive_pages.buffer %}
                                <tr class="exclusive-buffered" style="display: none;" onclick="window.location.href='{{ url_for('admin.exclusive_edit', page_id=page.id) }}'">
                                    <td>
                                        <span class="exclusive-name">{{ page.name }}</span>
                                    </td>
                                    <td>
                                        {% if page.status == 'ended' and page.is_fully_closed %}
                                            <span class="exclusive-status exclusive-status-closed">Zamkniƒôta</span>
                                        {% elif page.status == 'ended' %}
                                            <span class="exclusive-status exclusive-status-ended">Zako≈Ñczona</span>
                                        {% else %}
                                            <span class="exclusive-status exclusive-status-{{ page.status }}">
                                                {% if page.status == 'draft' %}Draft
                                                {% elif page.status == 'scheduled' %}Zaplanowana
                                                {% elif page.status == 'active' %}Aktywna
                                                {% elif page.status == 'paused' %}Wstrzymana
                                                {% endif %}
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if page.starts_at %}
                                            <span class="exclusive-date">{{ page.starts_at|format_date('%d.%m.%Y %H:%M') }}</span>
                                        {% else %}
                                            <span class="exclusive-no-date">‚Äî</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if page.ends_at %}
                                            <span class="exclusive-date">{{ page.ends_at|format_date('%d.%m.%Y %H:%M') }}</span>
                                        {% else %}
                                            <span class="exclusive-no-date">‚Äî</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% if exclusive_pages.remaining > 0 %}
                            <div class="exclusive-show-more" id="exclusiveShowMore">
                                <button type="button" class="show-more-btn" id="exclusiveLoadMoreBtn"
                                        data-visible="{{ exclusive_pages.visible|length }}"
                                        data-buffer="{{ exclusive_pages.buffer|length }}"
                                        data-total="{{ exclusive_pages.total }}"
                                        data-remaining="{{ exclusive_pages.remaining }}">
                                    Poka≈º {{ [exclusive_pages.remaining, 5]|min }} wiƒôcej ‚Üí
                                </button>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="empty-state">
                            <p class="empty-icon">‚ú®</p>
                            <p class="empty-text">Brak stron Exclusive</p>
                            <a href="{{ url_for('admin.exclusive_list') }}" class="btn-kpop btn-kpop-secondary">
                                Utw√≥rz pierwszƒÖ
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin/dashboard.css') }}">
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// ====================================
// CHARTS WITH DARK MODE SUPPORT
// ====================================

// Check if dark mode is active
const isDarkMode = () => document.documentElement.getAttribute('data-theme') === 'dark';

// Get theme-aware colors
const getChartColors = () => {
    const dark = isDarkMode();
    return {
        gridColor: dark ? 'rgba(255, 255, 255, 0.08)' : 'rgba(0, 0, 0, 0.05)',
        textColor: dark ? 'rgba(255, 255, 255, 0.7)' : undefined,
        tooltipBg: dark ? 'rgba(15, 12, 41, 0.95)' : 'rgba(0, 0, 0, 0.8)',
        tooltipBorder: dark ? 'rgba(240, 147, 251, 0.3)' : 'transparent',
        lineColor: dark ? '#f093fb' : '#8338EC',
        lineBgColor: dark ? 'rgba(240, 147, 251, 0.15)' : 'rgba(131, 56, 236, 0.1)',
        pointBorderColor: dark ? 'rgba(15, 12, 41, 0.9)' : '#fff'
    };
};

const colors = getChartColors();

// Sales Chart (7 days)
const salesData = {{ sales_chart|tojson }};
const salesCtx = document.getElementById('salesChart');
let salesChart = null;

if (salesCtx) {
    salesChart = new Chart(salesCtx, {
        type: 'line',
        data: {
            labels: salesData.map(d => d.date_label),
            datasets: [{
                label: 'Przych√≥d (PLN)',
                data: salesData.map(d => d.revenue),
                borderColor: colors.lineColor,
                backgroundColor: colors.lineBgColor,
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 6,
                pointHoverRadius: 8,
                pointBackgroundColor: colors.lineColor,
                pointBorderColor: colors.pointBorderColor,
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: colors.tooltipBg,
                    borderColor: colors.tooltipBorder,
                    borderWidth: 1,
                    padding: 12,
                    titleFont: { size: 14, weight: 'bold' },
                    titleColor: isDarkMode() ? '#f0f0f0' : '#fff',
                    bodyFont: { size: 13 },
                    bodyColor: isDarkMode() ? 'rgba(255, 255, 255, 0.8)' : '#fff',
                    cornerRadius: 8
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) { return value.toFixed(2) + ' PLN'; },
                        font: { size: 12 },
                        color: colors.textColor
                    },
                    grid: { color: colors.gridColor }
                },
                x: {
                    ticks: { font: { size: 12 }, color: colors.textColor },
                    grid: { display: false }
                }
            }
        }
    });
}

// Top Products Chart
const productsData = {{ top_products|tojson }};
const productsCtx = document.getElementById('productsChart');
let productsChart = null;

if (productsCtx && productsData.length > 0) {
    productsChart = new Chart(productsCtx, {
        type: 'bar',
        data: {
            labels: productsData.map(p => p.name.substring(0, 20) + (p.name.length > 20 ? '...' : '')),
            datasets: [{
                label: 'Sprzedane sztuki',
                data: productsData.map(p => p.total_sold),
                backgroundColor: [
                    'rgba(240, 147, 251, 0.8)',
                    'rgba(245, 87, 108, 0.8)',
                    'rgba(0, 245, 255, 0.8)',
                    'rgba(102, 126, 234, 0.8)',
                    'rgba(157, 78, 221, 0.8)'
                ],
                borderRadius: 8,
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: colors.tooltipBg,
                    borderColor: colors.tooltipBorder,
                    borderWidth: 1,
                    padding: 12,
                    titleColor: isDarkMode() ? '#f0f0f0' : '#fff',
                    bodyColor: isDarkMode() ? 'rgba(255, 255, 255, 0.8)' : '#fff',
                    cornerRadius: 8
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        font: { size: 12 },
                        color: colors.textColor
                    },
                    grid: { color: colors.gridColor }
                },
                x: {
                    ticks: { font: { size: 11 }, color: colors.textColor },
                    grid: { display: false }
                }
            }
        }
    });
}

// Listen for theme changes and update charts dynamically
const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
        if (mutation.attributeName === 'data-theme') {
            // Update charts with new theme colors (smooth transition)
            const newColors = getChartColors();

            if (salesChart) {
                salesChart.data.datasets[0].borderColor = newColors.lineColor;
                salesChart.data.datasets[0].backgroundColor = newColors.lineBgColor;
                salesChart.data.datasets[0].pointBackgroundColor = newColors.lineColor;
                salesChart.data.datasets[0].pointBorderColor = newColors.pointBorderColor;
                salesChart.options.plugins.tooltip.backgroundColor = newColors.tooltipBg;
                salesChart.options.plugins.tooltip.borderColor = newColors.tooltipBorder;
                salesChart.options.plugins.tooltip.titleColor = isDarkMode() ? '#f0f0f0' : '#fff';
                salesChart.options.plugins.tooltip.bodyColor = isDarkMode() ? 'rgba(255, 255, 255, 0.8)' : '#fff';
                salesChart.options.scales.y.ticks.color = newColors.textColor;
                salesChart.options.scales.y.grid.color = newColors.gridColor;
                salesChart.options.scales.x.ticks.color = newColors.textColor;
                salesChart.update('none'); // 'none' for instant update without animation
            }

            if (productsChart) {
                productsChart.options.plugins.tooltip.backgroundColor = newColors.tooltipBg;
                productsChart.options.plugins.tooltip.borderColor = newColors.tooltipBorder;
                productsChart.options.plugins.tooltip.titleColor = isDarkMode() ? '#f0f0f0' : '#fff';
                productsChart.options.plugins.tooltip.bodyColor = isDarkMode() ? 'rgba(255, 255, 255, 0.8)' : '#fff';
                productsChart.options.scales.y.ticks.color = newColors.textColor;
                productsChart.options.scales.y.grid.color = newColors.gridColor;
                productsChart.options.scales.x.ticks.color = newColors.textColor;
                productsChart.update('none');
            }
        }
    });
});

observer.observe(document.documentElement, { attributes: true });

// ====================================
// SALES RANGE DROPDOWN HANDLER
// ====================================

const salesRangeDropdown = document.getElementById('salesRangeDropdown');

if (salesRangeDropdown) {
    salesRangeDropdown.addEventListener('change', function() {
        const range = this.value;

        // Fetch new data from backend
        fetch(`/admin/dashboard/sales-data?range=${range}`)
            .then(response => response.json())
            .then(data => {
                if (salesChart && data.success) {
                    // Update chart data
                    salesChart.data.labels = data.labels;
                    salesChart.data.datasets[0].data = data.values;

                    // Update chart with smooth animation
                    salesChart.update();
                }
            })
            .catch(error => console.error('Error fetching sales data:', error));
    });
}

// ====================================
// TODO FUNCTIONS
// ====================================

function toggleTaskStatus(taskId) {
    fetch(`/admin/tasks/${taskId}/toggle-status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload page to update stats
            location.reload();
        }
    })
    .catch(error => console.error('Error:', error));
}

function openTaskModal(taskId) {
    // Redirect to tasks page with modal open
    if (taskId) {
        window.location.href = `/admin/tasks?edit=${taskId}`;
    } else {
        window.location.href = '/admin/tasks?new=1';
    }
}

function openTaskPreview(taskId) {
    // Redirect to tasks page and open preview modal for this task
    window.location.href = `/admin/tasks?view=${taskId}`;
}

// ====================================
// EXCLUSIVE PAGES - LAZY LOADING
// ====================================
(function() {
    const loadMoreBtn = document.getElementById('exclusiveLoadMoreBtn');
    const tableBody = document.getElementById('exclusiveTableBody');
    const showMoreContainer = document.getElementById('exclusiveShowMore');

    if (!loadMoreBtn || !tableBody) return;

    let currentOffset = parseInt(loadMoreBtn.dataset.visible) + parseInt(loadMoreBtn.dataset.buffer);
    let isLoading = false;

    // Create row HTML from page data
    function createRowHTML(page) {
        return `
            <tr onclick="window.location.href='${page.edit_url}'" style="cursor: pointer;">
                <td><span class="exclusive-name">${page.name}</span></td>
                <td><span class="exclusive-status exclusive-status-${page.status_class}">${page.status_text}</span></td>
                <td>${page.starts_at ? `<span class="exclusive-date">${page.starts_at}</span>` : '<span class="exclusive-no-date">‚Äî</span>'}</td>
                <td>${page.ends_at ? `<span class="exclusive-date">${page.ends_at}</span>` : '<span class="exclusive-no-date">‚Äî</span>'}</td>
            </tr>
        `;
    }

    // Fetch more pages from API
    async function fetchMorePages(offset, limit = 5) {
        try {
            const response = await fetch(`/admin/dashboard/exclusive-pages?offset=${offset}&limit=${limit}`);
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error fetching exclusive pages:', error);
            return null;
        }
    }

    // Update button text
    function updateButtonText(remaining) {
        if (remaining <= 0) {
            showMoreContainer.style.display = 'none';
        } else {
            loadMoreBtn.textContent = `Poka≈º ${Math.min(remaining, 5)} wiƒôcej ‚Üí`;
            loadMoreBtn.dataset.remaining = remaining;
        }
    }

    // Handle load more click
    loadMoreBtn.addEventListener('click', async function(e) {
        e.preventDefault();

        if (isLoading) return;

        // 1. Show buffered rows first
        const bufferedRows = tableBody.querySelectorAll('.exclusive-buffered');
        let shownFromBuffer = 0;

        bufferedRows.forEach((row, index) => {
            if (index < 5 && row.style.display === 'none') {
                row.style.display = '';
                row.classList.remove('exclusive-buffered');
                shownFromBuffer++;
            }
        });

        // Calculate new remaining
        let remaining = parseInt(loadMoreBtn.dataset.remaining) - shownFromBuffer;

        // 2. If we showed buffered rows, fetch more for the buffer in background
        if (shownFromBuffer > 0 && remaining > 0) {
            isLoading = true;
            loadMoreBtn.textContent = '≈Åadowanie...';

            const data = await fetchMorePages(currentOffset, 5);

            if (data && data.success && data.pages.length > 0) {
                // Add new rows as buffered (hidden)
                data.pages.forEach(page => {
                    const rowHTML = createRowHTML(page);
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = rowHTML;
                    const newRow = tempDiv.firstElementChild;
                    newRow.classList.add('exclusive-buffered');
                    newRow.style.display = 'none';
                    tableBody.appendChild(newRow);
                });

                currentOffset += data.pages.length;
                remaining = data.remaining + (data.pages.length > 0 ? data.pages.length : 0);
                remaining = Math.max(0, parseInt(loadMoreBtn.dataset.total) - tableBody.querySelectorAll('tr:not([style*="display: none"])').length);
            }

            isLoading = false;
        }

        // Recalculate remaining based on actual visible rows
        const visibleRows = tableBody.querySelectorAll('tr:not([style*="display: none"])').length;
        const total = parseInt(loadMoreBtn.dataset.total);
        remaining = Math.max(0, total - visibleRows);

        updateButtonText(remaining);
    });
})();
</script>
{% endblock %}
