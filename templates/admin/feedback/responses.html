{% extends "admin/base_admin.html" %}

{% block title %}Odpowiedzi: {{ survey.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin/feedback-responses.css') }}">
{% endblock %}

{% block content %}
<div class="responses-page">
    <!-- Header -->
    <div class="responses-header">
        <div class="header-left">
            <h1>
                {{ survey.name }}
                <span class="status-indicator status-{{ survey.status }}">
                    {% if survey.status == 'draft' %}
                    <svg width="8" height="8" viewBox="0 0 8 8" fill="currentColor"><circle cx="4" cy="4" r="4"/></svg>
                    Draft
                    {% elif survey.status == 'active' %}
                    <svg width="8" height="8" viewBox="0 0 8 8" fill="currentColor"><circle cx="4" cy="4" r="4"/></svg>
                    Aktywna
                    {% elif survey.status == 'closed' %}
                    <svg width="8" height="8" viewBox="0 0 8 8" fill="currentColor"><circle cx="4" cy="4" r="4"/></svg>
                    Zamkniƒôta
                    {% endif %}
                </span>
            </h1>
            <p class="header-subtitle">PrzeglƒÖd odpowiedzi na ankietƒô</p>
        </div>
        <div class="header-actions">
            <a href="{{ url_for('feedback.admin_edit', survey_id=survey.id) }}" class="btn btn-secondary">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                </svg>
                Edytuj ankietƒô
            </a>
            <a href="{{ url_for('feedback.admin_export', survey_id=survey.id) }}" class="btn btn-primary">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                </svg>
                Eksportuj CSV
            </a>
        </div>
    </div>

    {% if responses %}
    <!-- Stats Overview -->
    <div class="stats-overview">
        <div class="stat-card">
            <div class="stat-icon icon-responses">
                <svg viewBox="0 0 16 16" fill="currentColor">
                    <path d="M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H4.414A2 2 0 0 0 3 11.586l-2 2V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12.793a.5.5 0 0 0 .854.353l2.853-2.853A1 1 0 0 1 4.414 12H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
                    <path d="M3 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM3 6a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 6zm0 2.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>
                </svg>
            </div>
            <div class="stat-value">{{ responses|length }}</div>
            <div class="stat-label">Odpowiedzi</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon icon-questions">
                <svg viewBox="0 0 16 16" fill="currentColor">
                    <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/>
                </svg>
            </div>
            <div class="stat-value">{{ questions|rejectattr('is_display_only')|list|length }}</div>
            <div class="stat-label">Pyta≈Ñ</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon icon-rating">
                <svg viewBox="0 0 16 16" fill="currentColor">
                    <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
                </svg>
            </div>
{% set overall_avg = survey.get_overall_average_rating() %}
            <div class="stat-value">{% if overall_avg %}{{ "%.1f"|format(overall_avg) }}{% else %}-{% endif %}</div>
            <div class="stat-label">≈örednia ocena</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon icon-completion">
                <svg viewBox="0 0 16 16" fill="currentColor">
                    <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                </svg>
            </div>
            <div class="stat-value">100%</div>
            <div class="stat-label">Uko≈Ñczone</div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs-container">
        <div class="tabs-nav">
            <button class="tab-btn active" data-tab="statistics">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M4 11H2v3h2v-3zm5-4H7v7h2V7zm5-5h-2v12h2V2zm-2-1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1h-2zM6 7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7zm-5 4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1v-3z"/>
                </svg>
                Statystyki
            </button>
            <button class="tab-btn" data-tab="responses">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M7 14s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1H7Zm4-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6Zm-5.784 6A2.238 2.238 0 0 1 5 13c0-1.355.68-2.75 1.936-3.72A6.325 6.325 0 0 0 5 9c-4 0-5 3-5 4s1 1 1 1h4.216ZM4.5 8a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z"/>
                </svg>
                Indywidualne odpowiedzi ({{ responses|length }})
            </button>
        </div>

        <!-- Statistics Tab -->
        <div class="tab-content active" id="tab-statistics">
            <div class="stats-section">
                {% for question in questions %}
                {% if not question.is_display_only %}
                <div class="question-stat-card">
                    <div class="question-stat-header">
                        <h3 class="question-stat-title">{{ question.content }}</h3>
                        <span class="question-stat-badge">
                            {% if question.question_type == 'rating_scale' %}‚≠ê Ocena 1-5
                            {% elif question.question_type == 'rating_10' %}üî¢ Ocena 1-10
                            {% elif question.question_type == 'emoji_rating' %}üòä Emoji
                            {% elif question.question_type == 'yes_no' %}‚úì Tak/Nie
                            {% elif question.question_type == 'yes_no_comment' %}‚úì Tak/Nie + komentarz
                            {% elif question.question_type == 'multiple_choice' %}‚óã Wyb√≥r jednokrotny
                            {% elif question.question_type == 'checkbox_list' %}‚òë Wyb√≥r wielokrotny
                            {% elif question.question_type == 'textarea' %}üìù Tekst
                            {% endif %}
                        </span>
                    </div>

                    <div class="question-stat-body">
                        {% if question.question_type in ['rating_scale', 'rating_10', 'emoji_rating'] %}
                        <!-- Rating Statistics -->
                        {% set avg = question.get_average_rating() %}
                        {% set max_val = 10 if question.question_type == 'rating_10' else 5 %}
                        <div class="rating-display">
                            <div class="rating-big-number">
                                <div class="number">{% if avg %}{{ "%.1f"|format(avg) }}{% else %}-{% endif %}</div>
                                <div class="label">≈õrednia z {{ max_val }}</div>
                            </div>
                            <div class="rating-bars-container">
                                {% for i in range(max_val, 0, -1) %}
                                {% set count = question.answers.filter_by(answer_value=i|string).count() %}
                                {% set total = question.answers.count() %}
                                {% set percent = (count / total * 100) if total > 0 else 0 %}
                                <div class="rating-bar-item">
                                    <span class="rating-bar-label">{{ i }}</span>
                                    <div class="rating-bar-track">
                                        <div class="rating-bar-fill" style="width: {{ percent }}%"></div>
                                    </div>
                                    <span class="rating-bar-count">{{ count }}</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        {% elif question.question_type in ['yes_no', 'yes_no_comment'] %}
                        <!-- Yes/No Statistics -->
                        {% set stats = question.get_yes_no_stats() %}
                        {% if stats %}
                        <div class="yesno-display">
                            <div class="yesno-item yes-item">
                                <div class="percent">{{ "%.0f"|format(stats.yes_percent) }}%</div>
                                <div class="count">Tak ({{ stats.yes }} g≈Ços√≥w)</div>
                            </div>
                            <div class="yesno-item no-item">
                                <div class="percent">{{ "%.0f"|format(stats.no_percent) }}%</div>
                                <div class="count">Nie ({{ stats.no }} g≈Ços√≥w)</div>
                            </div>
                        </div>
                        {% else %}
                        <p style="color: var(--text-secondary); text-align: center;">Brak odpowiedzi</p>
                        {% endif %}

                        {% elif question.question_type in ['multiple_choice', 'checkbox_list'] %}
                        <!-- Choice Statistics -->
                        {% set stats = question.get_choice_stats() %}
                        {% if stats %}
                        <div class="choice-display">
                            {% for item in stats %}
                            <div class="choice-item">
                                <span class="choice-label">{{ item.option }}</span>
                                <div class="choice-bar-wrapper">
                                    <div class="choice-bar-track">
                                        <div class="choice-bar-fill" style="width: {{ item.percent }}%">
                                            <span>{{ "%.0f"|format(item.percent) }}%</span>
                                        </div>
                                    </div>
                                    <span class="choice-count">{{ item.count }} g≈Ços√≥w</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p style="color: var(--text-secondary); text-align: center;">Brak odpowiedzi</p>
                        {% endif %}

                        {% elif question.question_type == 'textarea' %}
                        <!-- Text Responses -->
                        <div class="text-responses-display">
                            {% for answer in question.answers.limit(5).all() %}
                            {% if answer.answer_text %}
                            <div class="text-response-card">
                                <div class="text-response-content">{{ answer.answer_text }}</div>
                                <div class="text-response-meta">
                                    {% if not survey.is_anonymous and answer.response.user %}
                                    <span class="user-avatar">{{ answer.response.user.full_name[0] if answer.response.user.full_name else answer.response.user.email[0] }}</span>
                                    <span>{{ answer.response.user.full_name or answer.response.user.email }}</span>
                                    <span>‚Ä¢</span>
                                    {% endif %}
                                    <span>{{ answer.response.submitted_at.strftime('%d.%m.%Y %H:%M') }}</span>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                            {% if question.answers.count() > 5 %}
                            <div class="more-responses-link">
                                ... i {{ question.answers.count() - 5 }} wiƒôcej odpowiedzi
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Individual Responses Tab -->
        <div class="tab-content" id="tab-responses">
            <div class="responses-list">
                {% for response in responses %}
                <div class="response-card">
                    <div class="response-card-header">
                        <div class="response-user">
                            <div class="response-avatar">
                                {% if not survey.is_anonymous and response.user %}
                                {{ response.user.full_name[0] if response.user.full_name else response.user.email[0] }}
                                {% else %}
                                #{{ loop.index }}
                                {% endif %}
                            </div>
                            <div class="response-user-info">
                                <h4>
                                    {% if not survey.is_anonymous and response.user %}
                                    {{ response.user.full_name or response.user.email }}
                                    {% else %}
                                    Odpowied≈∫ #{{ loop.index }}
                                    {% endif %}
                                </h4>
                                <p>
                                    {% if not survey.is_anonymous and response.user and response.user.email %}
                                    {{ response.user.email }}
                                    {% else %}
                                    Anonimowa odpowied≈∫
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        <div class="response-meta">
                            <div class="response-date">{{ response.submitted_at.strftime('%d.%m.%Y') }}</div>
                            <div class="response-time">{{ response.submitted_at.strftime('%H:%M') }}</div>
                        </div>
                    </div>
                    <div class="response-card-body">
                        <div class="response-answers">
                            {% for q in questions if not q.is_display_only %}
                            {% set answer = response.answers.filter_by(question_id=q.id).first() %}
                            {% if answer %}
                            <div class="answer-item">
                                <div class="answer-question">{{ q.content }}</div>
                                <div class="answer-value {% if q.question_type in ['rating_scale', 'rating_10', 'emoji_rating'] %}rating-answer{% elif q.question_type in ['yes_no', 'yes_no_comment'] and answer.answer_value == 'yes' %}yes-answer{% elif q.question_type in ['yes_no', 'yes_no_comment'] and answer.answer_value == 'no' %}no-answer{% endif %}">
                                    {% if q.question_type in ['rating_scale', 'emoji_rating'] %}
                                    <span class="stars">
                                        {% for i in range(1, 6) %}
                                        <span class="star{% if i > (answer.answer_value|int) %} empty{% endif %}">‚òÖ</span>
                                        {% endfor %}
                                    </span>
                                    {{ answer.answer_value }}/5
                                    {% elif q.question_type == 'rating_10' %}
                                    {{ answer.answer_value }}/10
                                    {% elif q.question_type in ['yes_no', 'yes_no_comment'] %}
                                    {% if answer.answer_value == 'yes' %}
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/></svg>
                                    Tak
                                    {% else %}
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>
                                    Nie
                                    {% endif %}
                                    {% if answer.answer_text %}
                                    <br><small style="color: var(--text-secondary); font-weight: normal;">{{ answer.answer_text }}</small>
                                    {% endif %}
                                    {% else %}
                                    {{ answer.display_value }}
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    {% else %}
    <!-- No Responses -->
    <div class="empty-state">
        <div class="empty-state-icon">
            <svg viewBox="0 0 16 16" fill="currentColor">
                <path d="M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H4.414A2 2 0 0 0 3 11.586l-2 2V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12.793a.5.5 0 0 0 .854.353l2.853-2.853A1 1 0 0 1 4.414 12H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
            </svg>
        </div>
        <h3>Brak odpowiedzi</h3>
        <p>Nikt jeszcze nie wype≈Çni≈Ç tej ankiety.</p>
        {% if survey.status == 'draft' %}
        <a href="{{ url_for('feedback.admin_edit', survey_id=survey.id) }}" class="btn btn-primary" style="margin-top: var(--space-4);">
            Aktywuj ankietƒô
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tab switching
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');

            // Remove active class from all
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));

            // Add active class to clicked
            this.classList.add('active');
            document.getElementById('tab-' + tabId).classList.add('active');
        });
    });
});
</script>
{% endblock %}
