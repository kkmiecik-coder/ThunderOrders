{% extends "admin/base_admin.html" %}

{% block title %}Zamówienia produktów - ThunderOrders{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin/warehouse-settings.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin/stock-orders.css') }}">
{% endblock %}

{% block content %}
<div class="stock-orders-page">
    <!-- Tabs Navigation -->
    <div class="tabs-navigation">
        <a href="{{ url_for('products.stock_orders', tab='do_zamowienia') }}"
           class="tab-link {% if active_tab == 'do_zamowienia' %}active{% endif %}"
           data-tab="do_zamowienia">
            DO ZAMÓWIENIA
            {% if to_order_count > 0 %}
            <span class="tab-badge tab-badge-red">{{ to_order_count }}</span>
            {% endif %}
        </a>
        <a href="{{ url_for('products.stock_orders', tab='proxy') }}"
           class="tab-link {% if active_tab == 'proxy' %}active{% endif %}"
           data-tab="proxy">
            PROXY
            <span class="tab-badge tab-badge-purple" id="proxyCountBadge" {% if proxy_count == 0 %}style="display: none;"{% endif %}>{{ proxy_count }}</span>
        </a>
        <a href="{{ url_for('products.stock_orders', tab='polska') }}"
           class="tab-link {% if active_tab == 'polska' %}active{% endif %}"
           data-tab="polska">
            POLSKA
            <span class="tab-badge tab-badge-blue" id="polskaCountBadge" {% if polska_count == 0 %}style="display: none;"{% endif %}>{{ polska_count }}</span>
        </a>
    </div>

    <!-- Tab Content -->
    <div class="tab-content active" id="tab-{{ active_tab }}">
        <div class="tab-pane">
            {% if active_tab == 'do_zamowienia' %}
            <!-- DO ZAMÓWIENIA Tab Content -->
            <div class="tab-header">
                <h2>Produkty do zamówienia</h2>
                <div class="tab-filters">
                    <div class="filter-group">
                        <input type="text" id="filterToOrderProduct" class="filter-input" placeholder="Szukaj produktu..." oninput="applyToOrderFilters()">
                    </div>
                    <div class="filter-group">
                        <select id="filterToOrderPayment" class="filter-select" onchange="applyToOrderFilters()">
                            <option value="">Wszystkie typy płatności</option>
                            {% set payment_types = [] %}
                            {% for item in products_to_order %}
                                {% set pt = 'proxy' if item.payment_stages == 4 else 'polska' %}
                                {% if pt not in payment_types %}
                                    {% if payment_types.append(pt) %}{% endif %}
                                {% endif %}
                            {% endfor %}
                            {% for pt in payment_types|sort %}
                            <option value="{{ pt }}">{{ 'Proxy (4 płat.)' if pt == 'proxy' else 'Polska (3 płat.)' }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <!-- Products to Order Table -->
            <div class="orders-list">
                {% if products_to_order %}
                    <div class="table-responsive">
                        <table class="data-table" id="toOrderTable">
                            <thead>
                                <tr>
                                    <th class="col-checkbox">
                                        <input type="checkbox" id="selectAllToOrder" onchange="toggleSelectAllToOrder(this)">
                                    </th>
                                    <th class="sortable" data-column="product_name" onclick="sortTable('product_name')">Produkt</th>
                                    <th class="sortable" data-column="sku" onclick="sortTable('sku')">SKU</th>
                                    <th class="sortable text-center" data-column="quantity" onclick="sortTable('quantity')">Ilość</th>
                                    <th class="sortable text-center" data-column="payment_type" onclick="sortTable('payment_type')">Typ płatności</th>
                                    <th class="sortable text-right" data-column="purchase_price" onclick="sortTable('purchase_price')">Cena zakupu</th>
                                    <th class="sortable text-right" data-column="purchase_value" onclick="sortTable('purchase_value')">Wartość zakupu</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in products_to_order %}
                                {% set product = item.product %}
                                {% set primary_image = product.primary_image %}
                                {% set payment_type = 'proxy' if item.payment_stages == 4 else 'polska' %}
                                {% set price_pln = product.purchase_price_pln or product.purchase_price or 0 %}
                                <tr class="to-order-row"
                                    data-product-id="{{ product.id }}"
                                    data-product-name="{{ product.name }}"
                                    data-supplier-id="{{ product.supplier_id or '' }}"
                                    data-supplier-name="{{ product.supplier.name if product.supplier else 'Brak dostawcy' }}"
                                    data-sku="{{ product.sku or '' }}"
                                    data-to-order="{{ item.to_order }}"
                                    data-purchase-price="{{ price_pln }}"
                                    data-purchase-value="{{ item.to_order * price_pln }}"
                                    data-payment-type="{{ payment_type }}">
                                    <td class="col-checkbox">
                                        <input type="checkbox" class="to-order-checkbox" value="{{ product.id }}"
                                               data-payment-type="{{ payment_type }}"
                                               onchange="handleToOrderCheckboxChange()">
                                    </td>
                                    <td>
                                        <div class="product-cell">
                                            {% if primary_image %}
                                            <img src="{{ url_for('static', filename='uploads/products/compressed/' + primary_image.filename) }}"
                                                 alt="{{ product.name }}"
                                                 class="product-thumbnail">
                                            {% else %}
                                            <div class="product-thumbnail-placeholder">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                                    <polyline points="21 15 16 10 5 21"></polyline>
                                                </svg>
                                            </div>
                                            {% endif %}
                                            <div class="product-info">
                                                <span class="product-name">{{ product.name }}</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-muted">{{ product.sku or '-' }}</td>
                                    <td class="text-center font-semibold">{{ item.to_order }}</td>
                                    <td class="text-center payment-stages-cell">
                                        {% if item.payment_stages == 4 %}
                                        <span class="badge-payment badge-payment-purple" title="Zamówienia przez proxy (4 płatności)">
                                            Proxy (4 płat.)
                                        </span>
                                        {% elif item.payment_stages == 3 %}
                                        <span class="badge-payment badge-payment-blue" title="Zamówienia do Polski (3 płatności)">
                                            Polska (3 płat.)
                                        </span>
                                        {% else %}
                                        <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-right">
                                        {% if product.purchase_price_pln %}
                                            <div class="price-pln">{{ "%.2f"|format(product.purchase_price_pln) }} PLN</div>
                                            {% if product.purchase_currency == 'KRW' and product.purchase_price %}
                                                <div class="price-krw">{{ "{:,.0f}"|format(product.purchase_price) }} ₩</div>
                                            {% endif %}
                                        {% elif product.purchase_price %}
                                            <div class="price-pln">{{ "%.2f"|format(product.purchase_price) }} {{ product.purchase_currency }}</div>
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-right">
                                        {% if product.purchase_price_pln %}
                                            {% set total_pln = item.to_order * product.purchase_price_pln %}
                                            <div class="price-pln"><strong>{{ "%.2f"|format(total_pln) }} PLN</strong></div>
                                            {% if product.purchase_currency == 'KRW' and product.purchase_price %}
                                                {% set total_krw = item.to_order * product.purchase_price %}
                                                <div class="price-krw">{{ "{:,.0f}"|format(total_krw) }} ₩</div>
                                            {% endif %}
                                        {% elif product.purchase_price %}
                                            {% set total_value = item.to_order * product.purchase_price %}
                                            <div class="price-pln"><strong>{{ "%.2f"|format(total_value) }} {{ product.purchase_currency }}</strong></div>
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"></path>
                            <rect x="9" y="3" width="6" height="4" rx="1"></rect>
                            <path d="M9 14l2 2 4-4"></path>
                        </svg>
                        <h3>Brak produktów do zamówienia</h3>
                        <p>Wszystkie produkty z zamówień klientów zostały już zamówione u dostawców.</p>
                    </div>
                {% endif %}
            </div>

            {% elif active_tab == 'proxy' %}
            <!-- PROXY Tab Content -->
            <div class="tab-header">
                <h2>Zamówienia PROXY</h2>
            </div>

            <!-- Filters Section -->
            <div class="orders-filters">
                <div class="filter-group">
                    <label>Nr zamówienia</label>
                    <input type="text" id="filterOrderNumber" class="filter-input" placeholder="Szukaj..." oninput="applyFilters()">
                </div>
                <div class="filter-group">
                    <label>Data od</label>
                    <input type="date" id="filterDateFrom" class="filter-input" onchange="applyFilters()">
                </div>
                <div class="filter-group">
                    <label>Data do</label>
                    <input type="date" id="filterDateTo" class="filter-input" onchange="applyFilters()">
                </div>
                <div class="filter-group filter-group-status">
                    <label>Status</label>
                    <div class="multi-select-wrapper">
                        <button type="button" class="multi-select-trigger" onclick="toggleStatusMultiSelect()">
                            <span id="statusSelectText">Wszystkie statusy</span>
                            <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                                <path d="M6 8L2 4h8L6 8z"/>
                            </svg>
                        </button>
                        <div id="statusMultiSelect" class="multi-select-dropdown" style="display: none;">
                            <div class="multi-select-option">
                                <label>
                                    <input type="checkbox" value="zamowiono" onchange="updateStatusFilter()">
                                    <span class="badge badge-zamowiono">Zamówiono</span>
                                </label>
                            </div>
                            <div class="multi-select-option">
                                <label>
                                    <input type="checkbox" value="dostarczone_do_proxy" onchange="updateStatusFilter()">
                                    <span class="badge badge-dostarczone_do_proxy">Dostarczone do Proxy</span>
                                </label>
                            </div>
                            <div class="multi-select-option">
                                <label>
                                    <input type="checkbox" value="anulowane" onchange="updateStatusFilter()">
                                    <span class="badge badge-anulowane">Anulowane</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="filter-actions-inline">
                    <button type="button" class="btn btn-sm btn-secondary" onclick="clearAllFilters()">
                        Wyczysc filtry
                    </button>
                </div>
            </div>

            <!-- Proxy Orders List -->
            <div class="orders-list">
                {% if proxy_orders %}
                    <div class="table-responsive">
                        <table class="data-table" id="proxyOrdersTable">
                            <thead>
                                <tr>
                                    <th class="col-checkbox">
                                        <input type="checkbox" id="selectAllOrders" onchange="toggleSelectAll(this)">
                                    </th>
                                    <th class="sortable" data-column="order_number" onclick="sortTable('order_number')">Nr zamowienia</th>
                                    <th>Produkty</th>
                                    <th class="sortable" data-column="status" onclick="sortTable('status')">Status</th>
                                    <th class="sortable" data-column="status_changed" onclick="sortTable('status_changed')">Ostatnia zmiana</th>
                                    <th class="sortable" data-column="date" onclick="sortTable('date')">Data zamowienia</th>
                                    <th class="sortable" data-column="amount" onclick="sortTable('amount')">Kwota</th>
                                    <th>Notatka</th>
                                    <th>Akcje</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in proxy_orders %}
                                <tr id="order-row-{{ order.id }}"
                                    data-order-id="{{ order.id }}"
                                    data-order-number="{{ order.order_number }}"
                                    data-status="{{ order.status }}"
                                    data-date="{{ order.created_at.timestamp() }}"
                                    data-status-changed="{{ order.updated_at.timestamp() if order.updated_at else order.created_at.timestamp() }}"
                                    data-amount="{{ order.total_amount_pln }}">
                                    <td class="col-checkbox">
                                        <input type="checkbox" class="order-checkbox proxy-checkbox" value="{{ order.id }}" onchange="handleCheckboxChange()">
                                    </td>
                                    <td class="font-semibold">{{ order.order_number }}</td>
                                    <td class="products-cell">
                                        <div class="products-list-compact">
                                            {% for item in order.items %}
                                            {% set product = item.product %}
                                            {% set primary_image = product.primary_image if product else None %}
                                            <div class="product-item-compact">
                                                {% if primary_image %}
                                                <img src="{{ url_for('static', filename='uploads/products/compressed/' + primary_image.filename) }}"
                                                     alt="{{ product.name }}" class="product-thumb-compact">
                                                {% else %}
                                                <div class="product-thumb-compact product-thumb-placeholder">
                                                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                                                        <path d="M6.002 5.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"></path>
                                                        <path d="M2.002 1a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V3a2 2 0 00-2-2h-12zm12 1a1 1 0 011 1v6.5l-3.777-1.947a.5.5 0 00-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 00-.63.062L1.002 12V3a1 1 0 011-1h12z"></path>
                                                    </svg>
                                                </div>
                                                {% endif %}
                                                <div class="product-item-info">
                                                    <span class="product-item-name">{{ product.name if product else '-' }}</span>
                                                    <span class="product-item-qty">({{ item.quantity }} szt)</span>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="status-dropdown-wrapper">
                                            <button class="status-badge-button badge-{{ order.status }}" onclick="toggleStatusDropdown({{ order.id }})">
                                                {% if order.status == 'zamowiono' %}Zamówiono
                                                {% elif order.status == 'dostarczone_do_proxy' %}Dostarczone do Proxy
                                                {% elif order.status == 'anulowane' %}Anulowane
                                                {% else %}{{ order.status|replace('_', ' ')|title }}
                                                {% endif %}
                                                <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                                                    <path d="M6 8L2 4h8L6 8z"/>
                                                </svg>
                                            </button>
                                            <div id="status-dropdown-{{ order.id }}" class="status-dropdown" style="display: none;">
                                                <div class="status-dropdown-option" onclick="changeOrderStatus({{ order.id }}, 'zamowiono')">
                                                    <span class="badge badge-zamowiono">Zamówiono</span>
                                                </div>
                                                <div class="status-dropdown-option" onclick="changeOrderStatus({{ order.id }}, 'dostarczone_do_proxy')">
                                                    <span class="badge badge-dostarczone_do_proxy">Dostarczone do Proxy</span>
                                                </div>
                                                <div class="status-dropdown-option" onclick="changeOrderStatus({{ order.id }}, 'anulowane')">
                                                    <span class="badge badge-anulowane">Anulowane</span>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-muted">{{ order.updated_at|format_datetime('%d.%m.%Y %H:%M') if order.updated_at else '-' }}</td>
                                    <td>{{ order.created_at|format_datetime('%d.%m.%Y %H:%M') }}</td>
                                    <td class="font-semibold">
                                        {{ '%.2f'|format(order.total_amount_pln) }} PLN
                                    </td>
                                    <td class="notes-cell">
                                        {% if order.notes %}
                                        <span class="note-text" title="{{ order.notes }}">{{ order.notes[:50] }}{% if order.notes|length > 50 %}...{% endif %}</span>
                                        {% else %}
                                        <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if current_user.role == 'admin' %}
                                        <button class="btn btn-sm btn-danger" title="Usun" onclick="deleteOrder({{ order.id }})">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <polyline points="3 6 5 6 21 6"></polyline>
                                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                            </svg>
                                        </button>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                            <line x1="1" y1="10" x2="23" y2="10"></line>
                        </svg>
                        <h3>Brak zamowien</h3>
                        <p>Nie znaleziono zadnych zamowien dla kategorii PROXY</p>
                    </div>
                {% endif %}
            </div>

            {% elif active_tab == 'polska' %}
            <!-- POLSKA Tab Content -->
            <div class="tab-header">
                <h2>Zamówienia POLSKA</h2>
            </div>

            <!-- Filters Section -->
            <div class="orders-filters">
                <div class="filter-group">
                    <label>Nr zamówienia</label>
                    <input type="text" id="filterOrderNumberPoland" class="filter-input" placeholder="Szukaj..." oninput="applyFiltersPoland()">
                </div>
                <div class="filter-group">
                    <label>Numer Kfriday RS</label>
                    <input type="text" id="filterTrackingPoland" class="filter-input" placeholder="Szukaj..." oninput="applyFiltersPoland()">
                </div>
                <div class="filter-group">
                    <label>Data od</label>
                    <input type="date" id="filterDateFromPoland" class="filter-input" onchange="applyFiltersPoland()">
                </div>
                <div class="filter-group">
                    <label>Data do</label>
                    <input type="date" id="filterDateToPoland" class="filter-input" onchange="applyFiltersPoland()">
                </div>
                <div class="filter-group filter-group-status">
                    <label>Status</label>
                    <div class="multi-select-wrapper">
                        <button type="button" class="multi-select-trigger" onclick="toggleStatusMultiSelectPoland()">
                            <span id="statusSelectTextPoland">Wszystkie statusy</span>
                            <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                                <path d="M6 8L2 4h8L6 8z"/>
                            </svg>
                        </button>
                        <div id="statusMultiSelectPoland" class="multi-select-dropdown" style="display: none;">
                            <div class="multi-select-option">
                                <label>
                                    <input type="checkbox" value="zamowione" onchange="updateStatusFilterPoland()">
                                    <span class="badge badge-zamowione">Zamówione</span>
                                </label>
                            </div>
                            <div class="multi-select-option">
                                <label>
                                    <input type="checkbox" value="dostarczone_gom" onchange="updateStatusFilterPoland()">
                                    <span class="badge badge-dostarczone_gom">Dostarczone GOM</span>
                                </label>
                            </div>
                            <div class="multi-select-option">
                                <label>
                                    <input type="checkbox" value="anulowane" onchange="updateStatusFilterPoland()">
                                    <span class="badge badge-anulowane">Anulowane</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="filter-actions-inline">
                    <button type="button" class="btn btn-sm btn-secondary" onclick="clearAllFiltersPoland()">
                        Wyczyść filtry
                    </button>
                </div>
            </div>

            <!-- Poland Orders List -->
            <div class="orders-list">
                {% if poland_orders %}
                    <div class="table-responsive">
                        <table class="data-table" id="polandOrdersTable">
                            <thead>
                                <tr>
                                    <th class="col-checkbox">
                                        <input type="checkbox" id="selectAllPolandOrders" onchange="toggleSelectAllPoland(this)">
                                    </th>
                                    <th class="sortable" data-column="order_number" onclick="sortTable('order_number')">Nr</th>
                                    <th>Produkty</th>
                                    <th class="sortable" data-column="status" onclick="sortTable('status')">Status</th>
                                    <th>Kfriday RS</th>
                                    <th class="sortable" data-column="amount" onclick="sortTable('amount')">Koszty</th>
                                    <th class="sortable" data-column="date" onclick="sortTable('date')">Info</th>
                                    <th>Akcje</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in poland_orders %}
                                <tr id="poland-order-row-{{ order.id }}"
                                    data-order-id="{{ order.id }}"
                                    data-order-number="{{ order.order_number }}"
                                    data-tracking="{{ order.tracking_number or '' }}"
                                    data-status="{{ order.status }}"
                                    data-date="{{ order.created_at.timestamp() if order.created_at else 0 }}"
                                    data-status-changed="{{ order.updated_at.timestamp() if order.updated_at else order.created_at.timestamp() if order.created_at else 0 }}"
                                    data-amount="{{ order.total_amount }}">
                                    <td class="col-checkbox">
                                        <input type="checkbox" class="order-checkbox poland-checkbox" value="{{ order.id }}" onchange="handleCheckboxChangePoland()">
                                    </td>
                                    <td class="font-semibold">{{ order.order_number }}</td>
                                    <td class="products-cell poland-products-cell">
                                        <table class="poland-products-inner-table">
                                            <thead>
                                                <tr>
                                                    <th>Nazwa</th>
                                                    <th class="text-right">Koszt zakupu (szt.)</th>
                                                    <th class="text-right">Cło/VAT (szt.)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for item in order.items %}
                                                {% set product = item.product %}
                                                {% set primary_image = product.primary_image if product else None %}
                                                {% set purchase_price = product.purchase_price_pln or product.purchase_price or 0 %}
                                                <tr class="{% if loop.index > 3 %}poland-product-hidden{% endif %}" {% if loop.index > 3 %}style="display: none;"{% endif %}>
                                                    <td class="poland-inner-product-name">
                                                        <div class="product-item-compact">
                                                            {% if primary_image %}
                                                            <img src="{{ url_for('static', filename='uploads/products/compressed/' + primary_image.filename) }}"
                                                                 alt="{{ product.name }}" class="product-thumb-compact">
                                                            {% else %}
                                                            <div class="product-thumb-compact product-thumb-placeholder">
                                                                <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                                                                    <path d="M6.002 5.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"></path>
                                                                    <path d="M2.002 1a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V3a2 2 0 00-2-2h-12zm12 1a1 1 0 011 1v6.5l-3.777-1.947a.5.5 0 00-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 00-.63.062L1.002 12V3a1 1 0 011-1h12z"></path>
                                                                </svg>
                                                            </div>
                                                            {% endif %}
                                                            <div class="product-item-info">
                                                                <span class="product-item-name">{{ product.name if product else '-' }}</span>
                                                                <span class="product-item-qty">({{ item.quantity }} szt)</span>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td class="text-right text-nowrap">{{ '%.2f'|format(purchase_price) }} zł</td>
                                                    <td class="text-right text-nowrap poland-customs-item-cell">
                                                        <span class="poland-item-customs-amount" data-item-id="{{ item.id }}">{{ '%.2f'|format(item.customs_vat_amount or 0) }} zł</span>
                                                        <button class="btn-edit-customs-item" onclick="openCustomsVatModalForItem({{ order.id }}, {{ item.id }})" title="Edytuj Cło/VAT">
                                                            <svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                                                <path d="M11.333 2.00004C11.5081 1.82494 11.716 1.68605 11.9447 1.59129C12.1735 1.49653 12.4187 1.44775 12.6663 1.44775C12.914 1.44775 13.1592 1.49653 13.3879 1.59129C13.6167 1.68605 13.8246 1.82494 13.9997 2.00004C14.1748 2.17513 14.3137 2.383 14.4084 2.61178C14.5032 2.84055 14.552 3.08575 14.552 3.33337C14.552 3.58099 14.5032 3.82619 14.4084 4.05497C14.3137 4.28374 14.1748 4.49161 13.9997 4.66671L5.33301 13.3334L1.33301 14.6667L2.66634 10.6667L11.333 2.00004Z"/>
                                                            </svg>
                                                        </button>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                        {% if order.items|length > 3 %}
                                        <span class="poland-products-toggle" onclick="togglePolandProducts(this)">Pokaż więcej ({{ order.items|length - 3 }})</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="status-dropdown-wrapper">
                                            <button class="status-badge-button badge-{{ order.status }}" onclick="togglePolandStatusDropdown({{ order.id }})">
                                                {% if order.status == 'zamowione' %}Zamówione
                                                {% elif order.status == 'urzad_celny' %}Urząd celny
                                                {% elif order.status == 'dostarczone_gom' %}Dostarczone GOM
                                                {% elif order.status == 'anulowane' %}Anulowane
                                                {% endif %}
                                                <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                                                    <path d="M6 8L2 4h8L6 8z"/>
                                                </svg>
                                            </button>
                                            <div id="poland-status-dropdown-{{ order.id }}" class="status-dropdown" style="display: none;">
                                                <div class="status-dropdown-option" onclick="changePolandOrderStatus({{ order.id }}, 'zamowione')">
                                                    <span class="badge badge-zamowione">Zamówione</span>
                                                </div>
                                                <div class="status-dropdown-option" onclick="changePolandOrderStatus({{ order.id }}, 'urzad_celny')">
                                                    <span class="badge badge-urzad_celny">Urząd celny</span>
                                                </div>
                                                <div class="status-dropdown-option" onclick="changePolandOrderStatus({{ order.id }}, 'dostarczone_gom')">
                                                    <span class="badge badge-dostarczone_gom">Dostarczone GOM</span>
                                                </div>
                                                <div class="status-dropdown-option" onclick="changePolandOrderStatus({{ order.id }}, 'anulowane')">
                                                    <span class="badge badge-anulowane">Anulowane</span>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ order.tracking_number or '-' }}</td>
                                    <td class="poland-costs-cell" data-order-id="{{ order.id }}">
                                        <table class="poland-costs-table">
                                            <tbody>
                                                <tr>
                                                    <td class="poland-cost-label">Produkty</td>
                                                    <td class="poland-cost-value poland-product-value-cell" data-order-id="{{ order.id }}">{{ '%.2f'|format(order.total_amount - order.shipping_cost - (order.customs_cost or 0)) }} PLN</td>
                                                </tr>
                                                <tr>
                                                    <td class="poland-cost-label">Wysyłka</td>
                                                    <td class="poland-cost-value">{{ '%.2f'|format(order.shipping_cost) }} PLN</td>
                                                </tr>
                                                <tr>
                                                    <td class="poland-cost-label">Cło/VAT</td>
                                                    <td class="poland-cost-value poland-customs-cost-cell" data-order-id="{{ order.id }}">{{ '%.2f'|format(order.customs_cost or 0) }} PLN</td>
                                                </tr>
                                            </tbody>
                                            <tfoot>
                                                <tr class="poland-cost-total">
                                                    <td class="poland-cost-label">Razem</td>
                                                    <td class="poland-cost-value poland-total-amount-cell" data-order-id="{{ order.id }}">{{ '%.2f'|format(order.total_amount) }} PLN</td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </td>
                                    <td class="poland-extra-info-cell">
                                        <div class="poland-date-cell">
                                            <div class="poland-date-primary">{{ order.created_at|format_datetime('%d.%m.%Y %H:%M') if order.created_at else '-' }}</div>
                                            <div class="poland-date-secondary">{{ order.updated_at|format_datetime('%d.%m.%Y %H:%M') if order.updated_at else '-' }}</div>
                                        </div>
                                        <span class="poland-note-icon {% if order.notes %}has-note{% endif %}" {% if order.notes %}data-tooltip="{{ order.notes }}"{% endif %}>
                                            <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                                                <path d="M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1h-2.5a2 2 0 0 0-1.6.8L8 14.333 6.1 11.8a2 2 0 0 0-1.6-.8H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h2.5a1 1 0 0 1 .8.4l1.9 2.533a1 1 0 0 0 1.6 0l1.9-2.533a1 1 0 0 1 .8-.4H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
                                                <path d="M3 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM3 6a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 6zm0 2.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>
                                            </svg>
                                        </span>
                                    </td>
                                    <td>
                                        {% if current_user.role == 'admin' %}
                                        <button class="btn btn-sm btn-danger" title="Usuń" onclick="deletePolandOrder({{ order.id }})">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <polyline points="3 6 5 6 21 6"></polyline>
                                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                            </svg>
                                        </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                            <line x1="1" y1="10" x2="23" y2="10"></line>
                        </svg>
                        <h3>Brak zamówień do Polski</h3>
                        <p>Zamówienia pojawią się tutaj po utworzeniu ich z zakładki DO ZAMÓWIENIA lub PROXY</p>
                    </div>
                {% endif %}
            </div>
            {% endif %} {# End of tab content blocks #}
        </div>
    </div>

    <!-- Bulk Actions Toolbar for "Do zamówienia" tab (floating, shows when checkboxes checked) -->
    <!-- Placed outside tab-pane to avoid backdrop-filter stacking context issues -->
    <div id="toOrderBulkToolbar" class="bulk-toolbar hidden">
        <div class="bulk-toolbar-content">
            <span class="selected-count"><span id="toOrderSelectedCount">0</span> zaznaczonych</span>
            <div class="bulk-actions">
                <button type="button" class="btn-bulk" onclick="openOrderProductsModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"></path>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <path d="M16 10a4 4 0 01-8 0"></path>
                    </svg>
                    Zamów produkty
                </button>
                <button type="button" class="btn-bulk" onclick="clearToOrderSelection()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                    Anuluj
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Actions Toolbar for PROXY/POLSKA tabs (floating pill, same style as DO ZAMÓWIENIA) -->
<div id="bulkActionsModal" class="bulk-toolbar hidden">
    <div class="bulk-toolbar-content">
        <span class="selected-count"><span id="selectedCount">0</span> zaznaczonych</span>
        <div class="bulk-actions">
            {% if active_tab == 'proxy' %}
            <button type="button" class="btn-bulk" id="btnOrderToPoland" onclick="openPolandOrderModal()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"></path>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <path d="M16 10a4 4 0 01-8 0"></path>
                </svg>
                Zamów do Polska
            </button>
            {% endif %}
            {% if active_tab == 'polska' %}
            <button type="button" class="btn-bulk" onclick="openBulkCustomsVatModal()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
                </svg>
                Dodaj Cło/VAT
            </button>
            {% endif %}
            <button type="button" class="btn-bulk" onclick="openBulkStatusChange()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                    <path d="M12 6v6l4 2"/>
                </svg>
                Zmień status
            </button>
            {% if current_user.role == 'admin' %}
            <button type="button" class="btn-bulk" onclick="{% if active_tab == 'polska' %}bulkDeletePolandOrders(){% else %}bulkDeleteOrders(){% endif %}">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                Usuń
            </button>
            {% endif %}
        </div>
    </div>
</div>

<!-- Bulk Status Change Dropdown -->
<div id="bulkStatusDropdown" class="bulk-status-dropdown" style="display: none;">
    {% if active_tab == 'proxy' %}
    <div class="bulk-status-option" onclick="applyBulkStatus('zamowiono')">
        <span class="badge badge-zamowiono">Zamówiono</span>
    </div>
    <div class="bulk-status-option" onclick="applyBulkStatus('dostarczone_do_proxy')">
        <span class="badge badge-dostarczone_do_proxy">Dostarczone do Proxy</span>
    </div>
    <div class="bulk-status-option" onclick="applyBulkStatus('anulowane')">
        <span class="badge badge-anulowane">Anulowane</span>
    </div>
    {% elif active_tab == 'polska' %}
    <div class="bulk-status-option" onclick="applyBulkStatus('zamowione')">
        <span class="badge badge-zamowione">Zamówione</span>
    </div>
    <div class="bulk-status-option" onclick="applyBulkStatus('urzad_celny')">
        <span class="badge badge-urzad_celny">Urząd celny</span>
    </div>
    <div class="bulk-status-option" onclick="applyBulkStatus('dostarczone_gom')">
        <span class="badge badge-dostarczone_gom">Dostarczone GOM</span>
    </div>
    <div class="bulk-status-option" onclick="applyBulkStatus('anulowane')">
        <span class="badge badge-anulowane">Anulowane</span>
    </div>
    {% endif %}
</div>

<!-- Modal: Edycja Cło/VAT -->
<div id="customsVatModal" class="modal-overlay">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h2 class="modal-title" id="customsVatModalTitle">Edycja Cło/VAT</h2>
            <button class="modal-close" onclick="closeCustomsVatModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <!-- Globalny % (widoczny tylko w trybie bulk) -->
            <div id="customsVatGlobalSection" class="customs-vat-global-section" style="display: none;">
                <div class="customs-vat-global-row">
                    <label for="customsVatGlobalPercent">Zastosuj % do wszystkich produktów:</label>
                    <div class="customs-vat-global-input-group">
                        <input type="number" id="customsVatGlobalPercent" class="form-control customs-vat-percent-input" min="0" max="100" step="0.01" placeholder="np. 23">
                        <span class="input-suffix">%</span>
                        <button type="button" class="btn btn-sm btn-primary" onclick="applyGlobalCustomsPercentage()">Zastosuj</button>
                    </div>
                </div>
            </div>

            <!-- Kontener na zamówienia/produkty -->
            <div id="customsVatItemsContainer" class="customs-vat-items-container">
                <div class="loading-spinner">Ładowanie danych...</div>
            </div>

            <!-- Podsumowanie -->
            <div class="customs-vat-summary">
                <div class="customs-vat-summary-row">
                    <span>Suma Cło/VAT:</span>
                    <strong id="customsVatTotalAmount">0,00 zł</strong>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeCustomsVatModal()">Anuluj</button>
            <button type="button" class="btn btn-primary" onclick="saveCustomsVat()">Zapisz</button>
        </div>
    </div>
</div>

<!-- Modal: Zamówienie grupowe -->
<div id="groupOrderModal" class="modal-overlay">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h2 class="modal-title">Zamówienie grupowe</h2>
            <button class="modal-close" onclick="closeGroupOrderModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <div class="modal-body">
            <p>Tworzysz zamówienie grupowe dla <strong id="groupOrderCount">0</strong> produktów
                (<span id="groupOrderType" class="font-semibold">...</span>).</p>

            <!-- Podsumowanie produktów -->
            <div class="order-products-table-wrapper">
                <table class="data-table order-products-table" id="groupOrderTable">
                    <thead>
                        <tr>
                            <th>Produkt</th>
                            <th class="text-center" style="width: 100px;">Ilość</th>
                            <th class="text-right">Cena jedn.</th>
                            <th class="text-right">Suma</th>
                        </tr>
                    </thead>
                    <tbody id="groupOrderTableBody">
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td colspan="3" class="text-right font-semibold">Suma całkowita:</td>
                            <td class="text-right font-semibold" id="groupOrderTotal">0.00 PLN</td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="form-group" style="margin-top: 16px;">
                <label for="groupOrderNote">Notatka (opcjonalna):</label>
                <textarea
                    id="groupOrderNote"
                    class="form-input"
                    rows="3"
                    placeholder="Dodaj notatkę do zamówienia..."></textarea>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeGroupOrderModal()">Anuluj</button>
            <button class="btn btn-primary" id="btnConfirmGroupOrder" onclick="confirmGroupOrder()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"></path>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <path d="M16 10a4 4 0 01-8 0"></path>
                </svg>
                Potwierdź zamówienie
            </button>
        </div>
    </div>
</div>

<!-- Modal: Zamów do Polska -->
<div id="orderToPolandModal" class="modal-overlay">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h2 class="modal-title">Zamówienie do Polski</h2>
            <button class="modal-close" onclick="closePolandModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <div class="modal-body">
            <!-- Tracking + Total shipping cost — two separate boxes -->
            <div class="poland-modal-top-row">
                <div class="poland-modal-box tracking-box">
                    <label for="polandTrackingNumber">Numer kfriday Shipping:</label>
                    <div class="tracking-input-group">
                        <span class="tracking-prefix">KB88900-RS</span>
                        <input
                            type="number"
                            id="polandTrackingNumber"
                            class="form-input tracking-number-field"
                            placeholder="nr"
                            min="1">
                    </div>
                </div>
                <div class="poland-modal-box shipping-cost-box">
                    <label for="totalShippingCost">Całkowity koszt wysyłki:</label>
                    <div class="total-shipping-input-group">
                        <input
                            type="number"
                            id="totalShippingCost"
                            class="form-input total-shipping-field"
                            placeholder="0.00"
                            step="0.01"
                            min="0">
                        <span class="input-suffix">PLN</span>
                    </div>
                </div>
            </div>

            <!-- Products table (filled by JS) -->
            <div id="polandProductsTable"></div>

            <!-- Summary -->
            <div class="shipping-summary-box">
                <div class="summary-row-item">
                    <span>Suma kosztów wysyłki:</span>
                    <strong id="sumShippingCost">0.00 PLN</strong>
                </div>
                <div class="summary-row-item summary-difference">
                    <span>Różnica (deklarowane - suma):</span>
                    <strong id="shippingDifference">0.00 PLN</strong>
                </div>
            </div>

            <!-- Note -->
            <div class="form-group poland-note-group">
                <label for="polandOrderNote">Notatka (opcjonalna):</label>
                <textarea
                    id="polandOrderNote"
                    class="form-input"
                    rows="2"
                    placeholder="Dodaj notatkę..."></textarea>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closePolandModal()">Anuluj</button>
            <button class="btn btn-primary" id="btnConfirmPolandOrder" onclick="confirmPolandOrder()">
                Potwierdź zamówienie
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/pages/admin/stock-orders.js') }}"></script>
<script>
// Jinja2 data bridge - server-side data that JS needs
window.STOCK_ORDERS_CONFIG = {
    activeTab: '{{ active_tab }}',
    proxyTabUrl: '{{ url_for("products.stock_orders", tab="proxy") }}'
};
const suppliersData = [
    {% for supplier in suppliers %}
    { id: {{ supplier.id }}, name: "{{ supplier.name }}" }{% if not loop.last %},{% endif %}
    {% endfor %}
];
</script>
{% endblock %}
