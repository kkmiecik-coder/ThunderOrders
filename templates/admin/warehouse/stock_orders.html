{% extends "admin/base_admin.html" %}

{% block title %}Zamówienia produktów - ThunderOrders{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin/warehouse-settings.css') }}">
{% endblock %}

{% block content %}
<div class="stock-orders-page">
    <!-- Tabs Navigation -->
    <div class="tabs-navigation">
        <a href="{{ url_for('products.stock_orders', tab='do_zamowienia') }}"
           class="tab-link {% if active_tab == 'do_zamowienia' %}active{% endif %}"
           data-tab="do_zamowienia">
            DO ZAMÓWIENIA
            {% if to_order_count > 0 %}
            <span class="tab-badge tab-badge-red">{{ to_order_count }}</span>
            {% endif %}
        </a>
        <a href="{{ url_for('products.stock_orders', tab='proxy') }}"
           class="tab-link {% if active_tab == 'proxy' %}active{% endif %}"
           data-tab="proxy">
            PROXY
            <span class="tab-badge tab-badge-purple" id="proxyCountBadge" {% if proxy_count == 0 %}style="display: none;"{% endif %}>{{ proxy_count }}</span>
        </a>
        <a href="{{ url_for('products.stock_orders', tab='polska') }}"
           class="tab-link {% if active_tab == 'polska' %}active{% endif %}"
           data-tab="polska">
            POLSKA
            <span class="tab-badge tab-badge-blue" id="polskaCountBadge" {% if polska_count == 0 %}style="display: none;"{% endif %}>{{ polska_count }}</span>
        </a>
    </div>

    <!-- Tab Content -->
    <div class="tab-content active" id="tab-{{ active_tab }}">
        <div class="tab-pane">
            {% if active_tab == 'do_zamowienia' %}
            <!-- DO ZAMÓWIENIA Tab Content -->
            <div class="tab-header">
                <h2>Produkty do zamówienia</h2>
                <div class="tab-filters">
                    <div class="filter-group">
                        <input type="text" id="filterToOrderProduct" class="filter-input" placeholder="Szukaj produktu..." oninput="applyToOrderFilters()">
                    </div>
                    <div class="filter-group">
                        <select id="filterToOrderPayment" class="filter-select" onchange="applyToOrderFilters()">
                            <option value="">Wszystkie typy płatności</option>
                            {% set payment_types = [] %}
                            {% for item in products_to_order %}
                                {% set pt = 'proxy' if item.payment_stages == 4 else 'polska' %}
                                {% if pt not in payment_types %}
                                    {% if payment_types.append(pt) %}{% endif %}
                                {% endif %}
                            {% endfor %}
                            {% for pt in payment_types|sort %}
                            <option value="{{ pt }}">{{ 'Proxy (4 płat.)' if pt == 'proxy' else 'Polska (3 płat.)' }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <!-- Products to Order Table -->
            <div class="orders-list">
                {% if products_to_order %}
                    <div class="table-responsive">
                        <table class="data-table" id="toOrderTable">
                            <thead>
                                <tr>
                                    <th class="col-checkbox">
                                        <input type="checkbox" id="selectAllToOrder" onchange="toggleSelectAllToOrder(this)">
                                    </th>
                                    <th class="sortable" data-column="product_name" onclick="sortTable('product_name')">Produkt</th>
                                    <th class="sortable" data-column="sku" onclick="sortTable('sku')">SKU</th>
                                    <th class="sortable text-center" data-column="quantity" onclick="sortTable('quantity')">Ilość</th>
                                    <th class="sortable text-center" data-column="payment_type" onclick="sortTable('payment_type')">Typ płatności</th>
                                    <th class="sortable text-right" data-column="purchase_price" onclick="sortTable('purchase_price')">Cena zakupu</th>
                                    <th class="sortable text-right" data-column="purchase_value" onclick="sortTable('purchase_value')">Wartość zakupu</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in products_to_order %}
                                {% set product = item.product %}
                                {% set primary_image = product.primary_image %}
                                {% set payment_type = 'proxy' if item.payment_stages == 4 else 'polska' %}
                                {% set price_pln = product.purchase_price_pln or product.purchase_price or 0 %}
                                <tr class="to-order-row"
                                    data-product-id="{{ product.id }}"
                                    data-product-name="{{ product.name }}"
                                    data-supplier-id="{{ product.supplier_id or '' }}"
                                    data-supplier-name="{{ product.supplier.name if product.supplier else 'Brak dostawcy' }}"
                                    data-sku="{{ product.sku or '' }}"
                                    data-to-order="{{ item.to_order }}"
                                    data-purchase-price="{{ price_pln }}"
                                    data-purchase-value="{{ item.to_order * price_pln }}"
                                    data-payment-type="{{ payment_type }}">
                                    <td class="col-checkbox">
                                        <input type="checkbox" class="to-order-checkbox" value="{{ product.id }}"
                                               data-payment-type="{{ payment_type }}"
                                               onchange="handleToOrderCheckboxChange()">
                                    </td>
                                    <td>
                                        <div class="product-cell">
                                            {% if primary_image %}
                                            <img src="{{ url_for('static', filename='uploads/products/compressed/' + primary_image.filename) }}"
                                                 alt="{{ product.name }}"
                                                 class="product-thumbnail">
                                            {% else %}
                                            <div class="product-thumbnail-placeholder">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                                    <polyline points="21 15 16 10 5 21"></polyline>
                                                </svg>
                                            </div>
                                            {% endif %}
                                            <div class="product-info">
                                                <span class="product-name">{{ product.name }}</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-muted">{{ product.sku or '-' }}</td>
                                    <td class="text-center font-semibold">{{ item.to_order }}</td>
                                    <td class="text-center payment-stages-cell">
                                        {% if item.payment_stages == 4 %}
                                        <span class="badge-payment badge-payment-purple" title="Zamówienia przez proxy (4 płatności)">
                                            Proxy (4 płat.)
                                        </span>
                                        {% elif item.payment_stages == 3 %}
                                        <span class="badge-payment badge-payment-blue" title="Zamówienia do Polski (3 płatności)">
                                            Polska (3 płat.)
                                        </span>
                                        {% else %}
                                        <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-right">
                                        {% if product.purchase_price_pln %}
                                            <div class="price-pln">{{ "%.2f"|format(product.purchase_price_pln) }} PLN</div>
                                            {% if product.purchase_currency == 'KRW' and product.purchase_price %}
                                                <div class="price-krw">{{ "{:,.0f}"|format(product.purchase_price) }} ₩</div>
                                            {% endif %}
                                        {% elif product.purchase_price %}
                                            <div class="price-pln">{{ "%.2f"|format(product.purchase_price) }} {{ product.purchase_currency }}</div>
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-right">
                                        {% if product.purchase_price_pln %}
                                            {% set total_pln = item.to_order * product.purchase_price_pln %}
                                            <div class="price-pln"><strong>{{ "%.2f"|format(total_pln) }} PLN</strong></div>
                                            {% if product.purchase_currency == 'KRW' and product.purchase_price %}
                                                {% set total_krw = item.to_order * product.purchase_price %}
                                                <div class="price-krw">{{ "{:,.0f}"|format(total_krw) }} ₩</div>
                                            {% endif %}
                                        {% elif product.purchase_price %}
                                            {% set total_value = item.to_order * product.purchase_price %}
                                            <div class="price-pln"><strong>{{ "%.2f"|format(total_value) }} {{ product.purchase_currency }}</strong></div>
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"></path>
                            <rect x="9" y="3" width="6" height="4" rx="1"></rect>
                            <path d="M9 14l2 2 4-4"></path>
                        </svg>
                        <h3>Brak produktów do zamówienia</h3>
                        <p>Wszystkie produkty z zamówień klientów zostały już zamówione u dostawców.</p>
                    </div>
                {% endif %}
            </div>

            {% elif active_tab == 'proxy' %}
            <!-- PROXY Tab Content -->
            <div class="tab-header">
                <h2>Zamówienia PROXY</h2>
            </div>

            <!-- Filters Section -->
            <div class="orders-filters">
                <div class="filter-group">
                    <label>Nr zamówienia</label>
                    <input type="text" id="filterOrderNumber" class="filter-input" placeholder="Szukaj..." oninput="applyFilters()">
                </div>
                <div class="filter-group">
                    <label>Data od</label>
                    <input type="date" id="filterDateFrom" class="filter-input" onchange="applyFilters()">
                </div>
                <div class="filter-group">
                    <label>Data do</label>
                    <input type="date" id="filterDateTo" class="filter-input" onchange="applyFilters()">
                </div>
                <div class="filter-group filter-group-status">
                    <label>Status</label>
                    <div class="multi-select-wrapper">
                        <button type="button" class="multi-select-trigger" onclick="toggleStatusMultiSelect()">
                            <span id="statusSelectText">Wszystkie statusy</span>
                            <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                                <path d="M6 8L2 4h8L6 8z"/>
                            </svg>
                        </button>
                        <div id="statusMultiSelect" class="multi-select-dropdown" style="display: none;">
                            <div class="multi-select-option">
                                <label>
                                    <input type="checkbox" value="zamowiono" onchange="updateStatusFilter()">
                                    <span class="badge badge-zamowiono">Zamówiono</span>
                                </label>
                            </div>
                            <div class="multi-select-option">
                                <label>
                                    <input type="checkbox" value="dostarczone_do_proxy" onchange="updateStatusFilter()">
                                    <span class="badge badge-dostarczone_do_proxy">Dostarczone do Proxy</span>
                                </label>
                            </div>
                            <div class="multi-select-option">
                                <label>
                                    <input type="checkbox" value="anulowane" onchange="updateStatusFilter()">
                                    <span class="badge badge-anulowane">Anulowane</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="filter-actions-inline">
                    <button type="button" class="btn btn-sm btn-secondary" onclick="clearAllFilters()">
                        Wyczysc filtry
                    </button>
                </div>
            </div>

            <!-- Proxy Orders List -->
            <div class="orders-list">
                {% if proxy_orders %}
                    <div class="table-responsive">
                        <table class="data-table" id="proxyOrdersTable">
                            <thead>
                                <tr>
                                    <th class="col-checkbox">
                                        <input type="checkbox" id="selectAllOrders" onchange="toggleSelectAll(this)">
                                    </th>
                                    <th class="sortable" data-column="order_number" onclick="sortTable('order_number')">Nr zamowienia</th>
                                    <th>Produkty</th>
                                    <th class="sortable" data-column="status" onclick="sortTable('status')">Status</th>
                                    <th class="sortable" data-column="status_changed" onclick="sortTable('status_changed')">Ostatnia zmiana</th>
                                    <th class="sortable" data-column="date" onclick="sortTable('date')">Data zamowienia</th>
                                    <th class="sortable" data-column="amount" onclick="sortTable('amount')">Kwota</th>
                                    <th>Notatka</th>
                                    <th>Akcje</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in proxy_orders %}
                                <tr id="order-row-{{ order.id }}"
                                    data-order-id="{{ order.id }}"
                                    data-order-number="{{ order.order_number }}"
                                    data-status="{{ order.status }}"
                                    data-date="{{ order.created_at.timestamp() }}"
                                    data-status-changed="{{ order.updated_at.timestamp() if order.updated_at else order.created_at.timestamp() }}"
                                    data-amount="{{ order.total_amount_pln }}">
                                    <td class="col-checkbox">
                                        <input type="checkbox" class="order-checkbox proxy-checkbox" value="{{ order.id }}" onchange="handleCheckboxChange()">
                                    </td>
                                    <td class="font-semibold">{{ order.order_number }}</td>
                                    <td class="products-cell">
                                        <div class="products-list-compact">
                                            {% for item in order.items %}
                                            {% set product = item.product %}
                                            {% set primary_image = product.primary_image if product else None %}
                                            <div class="product-item-compact">
                                                {% if primary_image %}
                                                <img src="{{ url_for('static', filename='uploads/products/compressed/' + primary_image.filename) }}"
                                                     alt="{{ product.name }}" class="product-thumb-compact">
                                                {% else %}
                                                <div class="product-thumb-compact product-thumb-placeholder">
                                                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                                                        <path d="M6.002 5.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"></path>
                                                        <path d="M2.002 1a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V3a2 2 0 00-2-2h-12zm12 1a1 1 0 011 1v6.5l-3.777-1.947a.5.5 0 00-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 00-.63.062L1.002 12V3a1 1 0 011-1h12z"></path>
                                                    </svg>
                                                </div>
                                                {% endif %}
                                                <div class="product-item-info">
                                                    <span class="product-item-name">{{ product.name if product else '-' }}</span>
                                                    <span class="product-item-qty">({{ item.quantity }} szt)</span>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="status-dropdown-wrapper">
                                            <button class="status-badge-button badge-{{ order.status }}" onclick="toggleStatusDropdown({{ order.id }})">
                                                {% if order.status == 'zamowiono' %}Zamówiono
                                                {% elif order.status == 'dostarczone_do_proxy' %}Dostarczone do Proxy
                                                {% elif order.status == 'anulowane' %}Anulowane
                                                {% else %}{{ order.status|replace('_', ' ')|title }}
                                                {% endif %}
                                                <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                                                    <path d="M6 8L2 4h8L6 8z"/>
                                                </svg>
                                            </button>
                                            <div id="status-dropdown-{{ order.id }}" class="status-dropdown" style="display: none;">
                                                <div class="status-dropdown-option" onclick="changeOrderStatus({{ order.id }}, 'zamowiono')">
                                                    <span class="badge badge-zamowiono">Zamówiono</span>
                                                </div>
                                                <div class="status-dropdown-option" onclick="changeOrderStatus({{ order.id }}, 'dostarczone_do_proxy')">
                                                    <span class="badge badge-dostarczone_do_proxy">Dostarczone do Proxy</span>
                                                </div>
                                                <div class="status-dropdown-option" onclick="changeOrderStatus({{ order.id }}, 'anulowane')">
                                                    <span class="badge badge-anulowane">Anulowane</span>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-muted">{{ order.updated_at|format_datetime('%d.%m.%Y %H:%M') if order.updated_at else '-' }}</td>
                                    <td>{{ order.created_at|format_datetime('%d.%m.%Y %H:%M') }}</td>
                                    <td class="font-semibold">
                                        {{ '%.2f'|format(order.total_amount_pln) }} PLN
                                    </td>
                                    <td class="notes-cell">
                                        {% if order.notes %}
                                        <span class="note-text" title="{{ order.notes }}">{{ order.notes[:50] }}{% if order.notes|length > 50 %}...{% endif %}</span>
                                        {% else %}
                                        <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if current_user.role == 'admin' %}
                                        <button class="btn btn-sm btn-danger" title="Usun" onclick="deleteOrder({{ order.id }})">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <polyline points="3 6 5 6 21 6"></polyline>
                                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                            </svg>
                                        </button>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                            <line x1="1" y1="10" x2="23" y2="10"></line>
                        </svg>
                        <h3>Brak zamowien</h3>
                        <p>Nie znaleziono zadnych zamowien dla kategorii PROXY</p>
                    </div>
                {% endif %}
            </div>

            {% elif active_tab == 'polska' %}
            <!-- POLSKA Tab Content -->
            <div class="tab-header">
                <h2>Zamówienia POLSKA</h2>
            </div>

            <!-- Filters Section -->
            <div class="orders-filters">
                <div class="filter-group">
                    <label>Nr zamówienia</label>
                    <input type="text" id="filterOrderNumberPoland" class="filter-input" placeholder="Szukaj..." oninput="applyFiltersPoland()">
                </div>
                <div class="filter-group">
                    <label>Numer Kfriday RS</label>
                    <input type="text" id="filterTrackingPoland" class="filter-input" placeholder="Szukaj..." oninput="applyFiltersPoland()">
                </div>
                <div class="filter-group">
                    <label>Data od</label>
                    <input type="date" id="filterDateFromPoland" class="filter-input" onchange="applyFiltersPoland()">
                </div>
                <div class="filter-group">
                    <label>Data do</label>
                    <input type="date" id="filterDateToPoland" class="filter-input" onchange="applyFiltersPoland()">
                </div>
                <div class="filter-group filter-group-status">
                    <label>Status</label>
                    <div class="multi-select-wrapper">
                        <button type="button" class="multi-select-trigger" onclick="toggleStatusMultiSelectPoland()">
                            <span id="statusSelectTextPoland">Wszystkie statusy</span>
                            <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                                <path d="M6 8L2 4h8L6 8z"/>
                            </svg>
                        </button>
                        <div id="statusMultiSelectPoland" class="multi-select-dropdown" style="display: none;">
                            <div class="multi-select-option">
                                <label>
                                    <input type="checkbox" value="zamowione" onchange="updateStatusFilterPoland()">
                                    <span class="badge badge-zamowione">Zamówione</span>
                                </label>
                            </div>
                            <div class="multi-select-option">
                                <label>
                                    <input type="checkbox" value="dostarczone_gom" onchange="updateStatusFilterPoland()">
                                    <span class="badge badge-dostarczone_gom">Dostarczone GOM</span>
                                </label>
                            </div>
                            <div class="multi-select-option">
                                <label>
                                    <input type="checkbox" value="anulowane" onchange="updateStatusFilterPoland()">
                                    <span class="badge badge-anulowane">Anulowane</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="filter-actions-inline">
                    <button type="button" class="btn btn-sm btn-secondary" onclick="clearAllFiltersPoland()">
                        Wyczyść filtry
                    </button>
                </div>
            </div>

            <!-- Poland Orders List -->
            <div class="orders-list">
                {% if poland_orders %}
                    <div class="table-responsive">
                        <table class="data-table" id="polandOrdersTable">
                            <thead>
                                <tr>
                                    <th class="col-checkbox">
                                        <input type="checkbox" id="selectAllPolandOrders" onchange="toggleSelectAllPoland(this)">
                                    </th>
                                    <th class="sortable" data-column="order_number" onclick="sortTable('order_number')">Nr</th>
                                    <th>Produkty</th>
                                    <th class="sortable" data-column="status" onclick="sortTable('status')">Status</th>
                                    <th>Kfriday RS</th>
                                    <th class="sortable" data-column="amount" onclick="sortTable('amount')">Koszty</th>
                                    <th class="sortable" data-column="date" onclick="sortTable('date')">Info</th>
                                    <th>Akcje</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in poland_orders %}
                                <tr id="poland-order-row-{{ order.id }}"
                                    data-order-id="{{ order.id }}"
                                    data-order-number="{{ order.order_number }}"
                                    data-tracking="{{ order.tracking_number or '' }}"
                                    data-status="{{ order.status }}"
                                    data-date="{{ order.created_at.timestamp() if order.created_at else 0 }}"
                                    data-status-changed="{{ order.updated_at.timestamp() if order.updated_at else order.created_at.timestamp() if order.created_at else 0 }}"
                                    data-amount="{{ order.total_amount }}">
                                    <td class="col-checkbox">
                                        <input type="checkbox" class="order-checkbox poland-checkbox" value="{{ order.id }}" onchange="handleCheckboxChangePoland()">
                                    </td>
                                    <td class="font-semibold">{{ order.order_number }}</td>
                                    <td class="products-cell poland-products-cell">
                                        <table class="poland-products-inner-table">
                                            <thead>
                                                <tr>
                                                    <th>Nazwa</th>
                                                    <th class="text-right">Koszt zakupu (szt.)</th>
                                                    <th class="text-right">Cło/VAT (szt.)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for item in order.items %}
                                                {% set product = item.product %}
                                                {% set primary_image = product.primary_image if product else None %}
                                                {% set purchase_price = product.purchase_price_pln or product.purchase_price or 0 %}
                                                <tr class="{% if loop.index > 3 %}poland-product-hidden{% endif %}" {% if loop.index > 3 %}style="display: none;"{% endif %}>
                                                    <td class="poland-inner-product-name">
                                                        <div class="product-item-compact">
                                                            {% if primary_image %}
                                                            <img src="{{ url_for('static', filename='uploads/products/compressed/' + primary_image.filename) }}"
                                                                 alt="{{ product.name }}" class="product-thumb-compact">
                                                            {% else %}
                                                            <div class="product-thumb-compact product-thumb-placeholder">
                                                                <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                                                                    <path d="M6.002 5.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"></path>
                                                                    <path d="M2.002 1a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V3a2 2 0 00-2-2h-12zm12 1a1 1 0 011 1v6.5l-3.777-1.947a.5.5 0 00-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 00-.63.062L1.002 12V3a1 1 0 011-1h12z"></path>
                                                                </svg>
                                                            </div>
                                                            {% endif %}
                                                            <div class="product-item-info">
                                                                <span class="product-item-name">{{ product.name if product else '-' }}</span>
                                                                <span class="product-item-qty">({{ item.quantity }} szt)</span>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td class="text-right text-nowrap">{{ '%.2f'|format(purchase_price) }} zł</td>
                                                    <td class="text-right text-nowrap poland-customs-item-cell">
                                                        <span class="poland-item-customs-amount" data-item-id="{{ item.id }}">{{ '%.2f'|format(item.customs_vat_amount or 0) }} zł</span>
                                                        <button class="btn-edit-customs-item" onclick="openCustomsVatModalForItem({{ order.id }}, {{ item.id }})" title="Edytuj Cło/VAT">
                                                            <svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                                                <path d="M11.333 2.00004C11.5081 1.82494 11.716 1.68605 11.9447 1.59129C12.1735 1.49653 12.4187 1.44775 12.6663 1.44775C12.914 1.44775 13.1592 1.49653 13.3879 1.59129C13.6167 1.68605 13.8246 1.82494 13.9997 2.00004C14.1748 2.17513 14.3137 2.383 14.4084 2.61178C14.5032 2.84055 14.552 3.08575 14.552 3.33337C14.552 3.58099 14.5032 3.82619 14.4084 4.05497C14.3137 4.28374 14.1748 4.49161 13.9997 4.66671L5.33301 13.3334L1.33301 14.6667L2.66634 10.6667L11.333 2.00004Z"/>
                                                            </svg>
                                                        </button>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                        {% if order.items|length > 3 %}
                                        <span class="poland-products-toggle" onclick="togglePolandProducts(this)">Pokaż więcej ({{ order.items|length - 3 }})</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="status-dropdown-wrapper">
                                            <button class="status-badge-button badge-{{ order.status }}" onclick="togglePolandStatusDropdown({{ order.id }})">
                                                {% if order.status == 'zamowione' %}Zamówione
                                                {% elif order.status == 'urzad_celny' %}Urząd celny
                                                {% elif order.status == 'dostarczone_gom' %}Dostarczone GOM
                                                {% elif order.status == 'anulowane' %}Anulowane
                                                {% endif %}
                                                <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                                                    <path d="M6 8L2 4h8L6 8z"/>
                                                </svg>
                                            </button>
                                            <div id="poland-status-dropdown-{{ order.id }}" class="status-dropdown" style="display: none;">
                                                <div class="status-dropdown-option" onclick="changePolandOrderStatus({{ order.id }}, 'zamowione')">
                                                    <span class="badge badge-zamowione">Zamówione</span>
                                                </div>
                                                <div class="status-dropdown-option" onclick="changePolandOrderStatus({{ order.id }}, 'urzad_celny')">
                                                    <span class="badge badge-urzad_celny">Urząd celny</span>
                                                </div>
                                                <div class="status-dropdown-option" onclick="changePolandOrderStatus({{ order.id }}, 'dostarczone_gom')">
                                                    <span class="badge badge-dostarczone_gom">Dostarczone GOM</span>
                                                </div>
                                                <div class="status-dropdown-option" onclick="changePolandOrderStatus({{ order.id }}, 'anulowane')">
                                                    <span class="badge badge-anulowane">Anulowane</span>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ order.tracking_number or '-' }}</td>
                                    <td class="poland-costs-cell" data-order-id="{{ order.id }}">
                                        <table class="poland-costs-table">
                                            <tbody>
                                                <tr>
                                                    <td class="poland-cost-label">Produkty</td>
                                                    <td class="poland-cost-value poland-product-value-cell" data-order-id="{{ order.id }}">{{ '%.2f'|format(order.total_amount - order.shipping_cost - (order.customs_cost or 0)) }} PLN</td>
                                                </tr>
                                                <tr>
                                                    <td class="poland-cost-label">Wysyłka</td>
                                                    <td class="poland-cost-value">{{ '%.2f'|format(order.shipping_cost) }} PLN</td>
                                                </tr>
                                                <tr>
                                                    <td class="poland-cost-label">Cło/VAT</td>
                                                    <td class="poland-cost-value poland-customs-cost-cell" data-order-id="{{ order.id }}">{{ '%.2f'|format(order.customs_cost or 0) }} PLN</td>
                                                </tr>
                                            </tbody>
                                            <tfoot>
                                                <tr class="poland-cost-total">
                                                    <td class="poland-cost-label">Razem</td>
                                                    <td class="poland-cost-value poland-total-amount-cell" data-order-id="{{ order.id }}">{{ '%.2f'|format(order.total_amount) }} PLN</td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </td>
                                    <td class="poland-extra-info-cell">
                                        <div class="poland-date-cell">
                                            <div class="poland-date-primary">{{ order.created_at|format_datetime('%d.%m.%Y %H:%M') if order.created_at else '-' }}</div>
                                            <div class="poland-date-secondary">{{ order.updated_at|format_datetime('%d.%m.%Y %H:%M') if order.updated_at else '-' }}</div>
                                        </div>
                                        <span class="poland-note-icon {% if order.notes %}has-note{% endif %}" {% if order.notes %}data-tooltip="{{ order.notes }}"{% endif %}>
                                            <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                                                <path d="M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1h-2.5a2 2 0 0 0-1.6.8L8 14.333 6.1 11.8a2 2 0 0 0-1.6-.8H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h2.5a1 1 0 0 1 .8.4l1.9 2.533a1 1 0 0 0 1.6 0l1.9-2.533a1 1 0 0 1 .8-.4H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
                                                <path d="M3 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM3 6a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 6zm0 2.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>
                                            </svg>
                                        </span>
                                    </td>
                                    <td>
                                        {% if current_user.role == 'admin' %}
                                        <button class="btn btn-sm btn-danger" title="Usuń" onclick="deletePolandOrder({{ order.id }})">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <polyline points="3 6 5 6 21 6"></polyline>
                                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                            </svg>
                                        </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                            <line x1="1" y1="10" x2="23" y2="10"></line>
                        </svg>
                        <h3>Brak zamówień do Polski</h3>
                        <p>Zamówienia pojawią się tutaj po utworzeniu ich z zakładki DO ZAMÓWIENIA lub PROXY</p>
                    </div>
                {% endif %}
            </div>
            {% endif %} {# End of tab content blocks #}
        </div>
    </div>

    <!-- Bulk Actions Toolbar for "Do zamówienia" tab (floating, shows when checkboxes checked) -->
    <!-- Placed outside tab-pane to avoid backdrop-filter stacking context issues -->
    <div id="toOrderBulkToolbar" class="bulk-toolbar hidden">
        <div class="bulk-toolbar-content">
            <span class="selected-count"><span id="toOrderSelectedCount">0</span> zaznaczonych</span>
            <div class="bulk-actions">
                <button type="button" class="btn-bulk" onclick="openOrderProductsModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"></path>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <path d="M16 10a4 4 0 01-8 0"></path>
                    </svg>
                    Zamów produkty
                </button>
                <button type="button" class="btn-bulk" onclick="clearToOrderSelection()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                    Anuluj
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Actions Sliding Modal -->
<div id="bulkActionsModal" class="bulk-actions-modal">
    <div class="bulk-actions-content">
        <div class="bulk-actions-info">
            <span class="selected-count">Zaznaczono: <strong id="selectedCount">0</strong></span>
        </div>
        <div class="bulk-actions-buttons">
            {% if active_tab == 'proxy' %}
            <button type="button" class="bulk-action-btn bulk-action-move" id="btnOrderToPoland" onclick="openPolandOrderModal()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"></path>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <path d="M16 10a4 4 0 01-8 0"></path>
                </svg>
                Zamów do Polska
            </button>
            {% endif %}
            {% if active_tab == 'polska' %}
            <button type="button" class="bulk-action-btn bulk-action-customs" onclick="openBulkCustomsVatModal()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
                </svg>
                Dodaj Cło/VAT
            </button>
            {% endif %}
            <button type="button" class="bulk-action-btn bulk-action-status" onclick="openBulkStatusChange()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                    <path d="M12 6v6l4 2"/>
                </svg>
                Zmień status
            </button>
            {% if current_user.role == 'admin' %}
            <button type="button" class="bulk-action-btn bulk-action-delete" onclick="{% if active_tab == 'polska' %}bulkDeletePolandOrders(){% else %}bulkDeleteOrders(){% endif %}">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                Usuń
            </button>
            {% endif %}
        </div>
    </div>
</div>

<!-- Bulk Status Change Dropdown -->
<div id="bulkStatusDropdown" class="bulk-status-dropdown" style="display: none;">
    {% if active_tab == 'proxy' %}
    <div class="bulk-status-option" onclick="applyBulkStatus('zamowiono')">
        <span class="badge badge-zamowiono">Zamówiono</span>
    </div>
    <div class="bulk-status-option" onclick="applyBulkStatus('dostarczone_do_proxy')">
        <span class="badge badge-dostarczone_do_proxy">Dostarczone do Proxy</span>
    </div>
    <div class="bulk-status-option" onclick="applyBulkStatus('anulowane')">
        <span class="badge badge-anulowane">Anulowane</span>
    </div>
    {% elif active_tab == 'polska' %}
    <div class="bulk-status-option" onclick="applyBulkStatus('zamowione')">
        <span class="badge badge-zamowione">Zamówione</span>
    </div>
    <div class="bulk-status-option" onclick="applyBulkStatus('urzad_celny')">
        <span class="badge badge-urzad_celny">Urząd celny</span>
    </div>
    <div class="bulk-status-option" onclick="applyBulkStatus('dostarczone_gom')">
        <span class="badge badge-dostarczone_gom">Dostarczone GOM</span>
    </div>
    <div class="bulk-status-option" onclick="applyBulkStatus('anulowane')">
        <span class="badge badge-anulowane">Anulowane</span>
    </div>
    {% endif %}
</div>

<!-- Modal: Edycja Cło/VAT -->
<div id="customsVatModal" class="modal-overlay">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h2 class="modal-title" id="customsVatModalTitle">Edycja Cło/VAT</h2>
            <button class="modal-close" onclick="closeCustomsVatModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <!-- Globalny % (widoczny tylko w trybie bulk) -->
            <div id="customsVatGlobalSection" class="customs-vat-global-section" style="display: none;">
                <div class="customs-vat-global-row">
                    <label for="customsVatGlobalPercent">Zastosuj % do wszystkich produktów:</label>
                    <div class="customs-vat-global-input-group">
                        <input type="number" id="customsVatGlobalPercent" class="form-control customs-vat-percent-input" min="0" max="100" step="0.01" placeholder="np. 23">
                        <span class="input-suffix">%</span>
                        <button type="button" class="btn btn-sm btn-primary" onclick="applyGlobalCustomsPercentage()">Zastosuj</button>
                    </div>
                </div>
            </div>

            <!-- Kontener na zamówienia/produkty -->
            <div id="customsVatItemsContainer" class="customs-vat-items-container">
                <div class="loading-spinner">Ładowanie danych...</div>
            </div>

            <!-- Podsumowanie -->
            <div class="customs-vat-summary">
                <div class="customs-vat-summary-row">
                    <span>Suma Cło/VAT:</span>
                    <strong id="customsVatTotalAmount">0,00 zł</strong>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeCustomsVatModal()">Anuluj</button>
            <button type="button" class="btn btn-primary" onclick="saveCustomsVat()">Zapisz</button>
        </div>
    </div>
</div>

<!-- Modal: Zamówienie grupowe -->
<div id="groupOrderModal" class="modal-overlay">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h2 class="modal-title">Zamówienie grupowe</h2>
            <button class="modal-close" onclick="closeGroupOrderModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <div class="modal-body">
            <p>Tworzysz zamówienie grupowe dla <strong id="groupOrderCount">0</strong> produktów
                (<span id="groupOrderType" class="font-semibold">...</span>).</p>

            <!-- Podsumowanie produktów -->
            <div class="order-products-table-wrapper">
                <table class="data-table order-products-table" id="groupOrderTable">
                    <thead>
                        <tr>
                            <th>Produkt</th>
                            <th class="text-center" style="width: 100px;">Ilość</th>
                            <th class="text-right">Cena jedn.</th>
                            <th class="text-right">Suma</th>
                        </tr>
                    </thead>
                    <tbody id="groupOrderTableBody">
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td colspan="3" class="text-right font-semibold">Suma całkowita:</td>
                            <td class="text-right font-semibold" id="groupOrderTotal">0.00 PLN</td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="form-group" style="margin-top: 16px;">
                <label for="groupOrderNote">Notatka (opcjonalna):</label>
                <textarea
                    id="groupOrderNote"
                    class="form-input"
                    rows="3"
                    placeholder="Dodaj notatkę do zamówienia..."></textarea>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeGroupOrderModal()">Anuluj</button>
            <button class="btn btn-primary" id="btnConfirmGroupOrder" onclick="confirmGroupOrder()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"></path>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <path d="M16 10a4 4 0 01-8 0"></path>
                </svg>
                Potwierdź zamówienie
            </button>
        </div>
    </div>
</div>

<!-- Modal: Zamów do Polska -->
<div id="orderToPolandModal" class="modal-overlay">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h2 class="modal-title">Zamówienie do Polski</h2>
            <button class="modal-close" onclick="closePolandModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <div class="modal-body">
            <!-- Tracking + Total shipping cost — two separate boxes -->
            <div class="poland-modal-top-row">
                <div class="poland-modal-box tracking-box">
                    <label for="polandTrackingNumber">Numer kfriday Shipping:</label>
                    <div class="tracking-input-group">
                        <span class="tracking-prefix">KB88900-RS</span>
                        <input
                            type="number"
                            id="polandTrackingNumber"
                            class="form-input tracking-number-field"
                            placeholder="nr"
                            min="1">
                    </div>
                </div>
                <div class="poland-modal-box shipping-cost-box">
                    <label for="totalShippingCost">Całkowity koszt wysyłki:</label>
                    <div class="total-shipping-input-group">
                        <input
                            type="number"
                            id="totalShippingCost"
                            class="form-input total-shipping-field"
                            placeholder="0.00"
                            step="0.01"
                            min="0">
                        <span class="input-suffix">PLN</span>
                    </div>
                </div>
            </div>

            <!-- Products table (filled by JS) -->
            <div id="polandProductsTable"></div>

            <!-- Summary -->
            <div class="shipping-summary-box">
                <div class="summary-row-item">
                    <span>Suma kosztów wysyłki:</span>
                    <strong id="sumShippingCost">0.00 PLN</strong>
                </div>
                <div class="summary-row-item summary-difference">
                    <span>Różnica (deklarowane - suma):</span>
                    <strong id="shippingDifference">0.00 PLN</strong>
                </div>
            </div>

            <!-- Note -->
            <div class="form-group poland-note-group">
                <label for="polandOrderNote">Notatka (opcjonalna):</label>
                <textarea
                    id="polandOrderNote"
                    class="form-input"
                    rows="2"
                    placeholder="Dodaj notatkę..."></textarea>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closePolandModal()">Anuluj</button>
            <button class="btn btn-primary" id="btnConfirmPolandOrder" onclick="confirmPolandOrder()">
                Potwierdź zamówienie
            </button>
        </div>
    </div>
</div>

<style>
.stock-orders-page {
    padding: 0;
}

/* Tabs Navigation */
.tabs-navigation {
    display: flex;
    gap: 8px;
    border-bottom: 2px solid #e5e7eb;
    background: white;
}

.tab-link {
    padding: 12px 24px;
    font-size: 14px;
    font-weight: 600;
    color: #6b7280;
    text-decoration: none;
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
    position: relative;
    bottom: -2px;
}

.tab-link:hover {
    color: #FF8500;
    background-color: #fff5ec;
}

.tab-link.active {
    color: #FF8500;
    border-bottom-color: #FF8500;
}

/* Tab Content */
.tab-content {
    display: none;
    padding: 24px;
}

.tab-content.active {
    display: block;
}

.tab-pane {
    background: white;
    border-radius: 8px;
    padding: 24px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.tab-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid #e5e7eb;
}

.tab-header h2 {
    font-size: 20px;
    font-weight: 600;
    color: #1a1a1a;
    margin: 0;
}

/* Tab Filters (inline in tab-header) */
.tab-filters {
    display: flex;
    gap: 10px;
    align-items: center;
}

.filter-input,
.filter-select {
    padding: 7px 12px;
    font-size: 13px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    background: #ffffff;
    color: #374151;
    outline: none;
    transition: border-color 0.2s;
}

.filter-input:focus,
.filter-select:focus {
    border-color: #6366f1;
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.15);
}

.filter-input::placeholder {
    color: #9ca3af;
}

.filter-select {
    cursor: pointer;
}

[data-theme="dark"] .filter-input,
[data-theme="dark"] .filter-select {
    background: rgba(255, 255, 255, 0.06);
    border-color: rgba(240, 147, 251, 0.2);
    color: #ffffff;
}

[data-theme="dark"] .filter-input:focus,
[data-theme="dark"] .filter-select:focus {
    border-color: rgba(240, 147, 251, 0.5);
    box-shadow: 0 0 0 2px rgba(240, 147, 251, 0.1);
}

[data-theme="dark"] .filter-input::placeholder {
    color: rgba(255, 255, 255, 0.4);
}

[data-theme="dark"] .filter-select option {
    background: #1e1e2e;
    color: #ffffff;
}

/* Orders Filters */
.orders-filters {
    display: flex;
    gap: 16px;
    align-items: flex-end;
    margin-bottom: 20px;
    padding: 16px;
    background: #f9fafb;
    border-radius: 8px;
    flex-wrap: wrap;
}

.orders-filters .filter-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.orders-filters .filter-group label {
    font-size: 12px;
    font-weight: 600;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.orders-filters .filter-input {
    padding: 8px 12px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    font-size: 14px;
    background: white;
    min-width: 150px;
}

.orders-filters .filter-input:focus {
    outline: none;
    border-color: #FF8500;
    box-shadow: 0 0 0 3px rgba(255, 133, 0, 0.1);
}

.filter-group-status {
    min-width: 200px;
}

.multi-select-wrapper {
    position: relative;
}

.multi-select-trigger {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    padding: 8px 12px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    font-size: 14px;
    background: white;
    cursor: pointer;
    min-width: 180px;
    text-align: left;
}

.multi-select-trigger:hover {
    border-color: #d1d5db;
}

.multi-select-dropdown {
    position: absolute;
    top: calc(100% + 4px);
    left: 0;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 100;
    min-width: 200px;
    padding: 4px;
}

.multi-select-option {
    padding: 6px 8px;
    border-radius: 4px;
    transition: background 0.2s;
}

.multi-select-option:hover {
    background: #f3f4f6;
}

.multi-select-option label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    text-transform: none;
    font-weight: normal;
}

.multi-select-option input[type="checkbox"] {
    width: 16px;
    height: 16px;
    cursor: pointer;
}

.filter-actions-inline {
    margin-left: auto;
}

/* Checkbox column */
.col-checkbox {
    width: 40px;
    text-align: center;
}

.col-checkbox input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

/* Bulk Actions Modal */
.bulk-actions-modal {
    position: fixed;
    bottom: -100px;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    border-radius: 12px 12px 0 0;
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    transition: bottom 0.3s ease;
    min-width: 400px;
}

.bulk-actions-modal.visible {
    bottom: 0;
}

.bulk-actions-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 24px;
    gap: 24px;
}

.bulk-actions-info {
    font-size: 14px;
    color: #374151;
}

.bulk-actions-info strong {
    color: #FF8500;
    font-size: 16px;
}

.bulk-actions-buttons {
    display: flex;
    gap: 12px;
}

.bulk-action-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
}

.bulk-action-status {
    background: #f3f4f6;
    color: #374151;
}

.bulk-action-status:hover {
    background: #e5e7eb;
}

.bulk-action-delete {
    background: #fef2f2;
    color: #dc2626;
}

.bulk-action-delete:hover {
    background: #fee2e2;
}

.bulk-action-move {
    background: #eff6ff;
    color: #2563eb;
}

.bulk-action-move:hover {
    background: #dbeafe;
}

/* Bulk Status Dropdown */
.bulk-status-dropdown {
    position: fixed;
    bottom: 70px;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 1001;
    min-width: 200px;
    padding: 4px;
}

.bulk-status-option {
    padding: 8px;
    cursor: pointer;
    border-radius: 4px;
    transition: background 0.2s;
}

.bulk-status-option:hover {
    background: #f3f4f6;
}

.bulk-status-option .badge {
    width: 100%;
    display: block;
    text-align: center;
}

/* Row highlight when selected */
.data-table tbody tr.selected {
    background-color: #fff5ec !important;
}

/* Table Styling */
.table-responsive {
    overflow: visible;
}

.data-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
}

.data-table thead {
    background-color: #f9fafb;
}

.data-table thead th {
    border-bottom: 2px solid #e5e7eb;
}

.data-table th {
    padding: 12px 16px;
    text-align: left;
    font-size: 12px;
    font-weight: 600;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    cursor: pointer;
    user-select: none;
    position: relative;
}

.data-table th:hover {
    background-color: #f3f4f6;
}

.data-table th.sortable::after {
    content: '⇅';
    position: absolute;
    right: 8px;
    opacity: 0.3;
    font-size: 14px;
}

.data-table th.sorted-asc::after {
    content: '↑';
    opacity: 1;
    color: #FF8500;
}

.data-table th.sorted-desc::after {
    content: '↓';
    opacity: 1;
    color: #FF8500;
}

.data-table tbody tr {
    transition: background-color 0.2s;
}

.data-table tbody td {
    border-bottom: 1px solid #e5e7eb;
}

.data-table tbody tr:hover {
    background-color: #f9fafb;
}

.data-table td {
    padding: 16px;
    font-size: 14px;
    color: #374151;
}

.data-table th,
.data-table td {
    border-right: 1px solid #e8e0f0;
}

.data-table th:last-child,
.data-table td:last-child {
    border-right: none;
}

[data-theme="dark"] .data-table th,
[data-theme="dark"] .data-table td {
    border-right-color: #3d2d50;
}

[data-theme="dark"] .data-table th:last-child,
[data-theme="dark"] .data-table td:last-child {
    border-right: none;
}

#polandOrdersTable {
    width: 100%;
}

#polandOrdersTable th,
#polandOrdersTable td {
    white-space: nowrap;
}

#polandOrdersTable th:nth-child(3),
#polandOrdersTable td:nth-child(3) {
    width: 100%;
    white-space: normal;
}

.font-semibold {
    font-weight: 600;
}

/* Notes cell (Proxy table) */
.notes-cell {
    max-width: 200px;
}

.note-text {
    font-size: 13px;
    color: #6b7280;
    display: block;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 200px;
    cursor: default;
}

[data-theme="dark"] .note-text {
    color: rgba(255, 255, 255, 0.6);
}

/* Poland Costs Column (inner table) */
.poland-costs-cell {
    padding: 6px 8px !important;
}

.poland-costs-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 12px;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    padding: 4px 8px;
}

.poland-costs-table td {
    padding: 2px 0;
    border: none !important;
    background: none;
}

.poland-cost-label {
    color: #6b7280;
    white-space: nowrap;
    padding-right: 12px !important;
    font-size: 11px;
}

.poland-cost-value {
    text-align: right;
    white-space: nowrap;
    color: #374151;
    font-weight: 500;
}

.poland-costs-table tfoot .poland-cost-total td {
    border-top: 1px solid #d1d5db !important;
    padding-top: 3px !important;
}

.poland-cost-total .poland-cost-label {
    font-weight: 600;
    color: #111827;
    font-size: 12px;
}

.poland-cost-total .poland-cost-value {
    font-weight: 700;
    color: #111827;
    font-size: 13px;
}

[data-theme="dark"] .poland-costs-table {
    background: rgba(255, 255, 255, 0.04);
    border-color: rgba(255, 255, 255, 0.1);
}

[data-theme="dark"] .poland-cost-label {
    color: rgba(255, 255, 255, 0.45);
}

[data-theme="dark"] .poland-cost-value {
    color: rgba(255, 255, 255, 0.75);
}

[data-theme="dark"] .poland-costs-table tfoot .poland-cost-total td {
    border-top: 1px solid rgba(255, 255, 255, 0.15) !important;
}

[data-theme="dark"] .poland-cost-total .poland-cost-label {
    color: rgba(255, 255, 255, 0.9);
}

[data-theme="dark"] .poland-cost-total .poland-cost-value {
    color: #ffffff;
}

/* Poland Extra Info Column (dates + note icon) */
.poland-extra-info-cell {
    white-space: nowrap;
}

.poland-date-cell {
    white-space: nowrap;
}

.poland-date-primary {
    font-size: 13px;
    font-weight: 600;
    color: #374151;
    line-height: 1.4;
}

.poland-date-secondary {
    font-size: 12px;
    font-weight: 400;
    color: #f97316;
    line-height: 1.4;
}

[data-theme="dark"] .poland-date-primary {
    color: rgba(255, 255, 255, 0.85);
}

[data-theme="dark"] .poland-date-secondary {
    color: #fb923c;
}

/* Note icon in Poland table */
.poland-note-icon {
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    border-radius: 4px;
    color: #9ca3af;
    cursor: default;
    margin-top: 4px;
}

.poland-note-icon.has-note {
    color: #22c55e;
    cursor: help;
}

[data-theme="dark"] .poland-note-icon {
    color: rgba(255, 255, 255, 0.25);
}

[data-theme="dark"] .poland-note-icon.has-note {
    color: #4ade80;
}

/* Note icon tooltip */
.poland-note-icon.has-note::before,
.poland-note-icon.has-note::after {
    position: absolute;
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s ease;
    pointer-events: none;
    z-index: 100;
}

.poland-note-icon.has-note::before {
    content: '';
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 6px solid transparent;
    border-top-color: #333;
    margin-bottom: -6px;
}

.poland-note-icon.has-note::after {
    content: attr(data-tooltip);
    bottom: calc(100% + 6px);
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: #fff;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 12px;
    line-height: 1.4;
    white-space: normal;
    max-width: 200px;
    text-align: left;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.poland-note-icon.has-note:hover::before,
.poland-note-icon.has-note:hover::after {
    opacity: 1;
    visibility: visible;
}

[data-theme="dark"] .poland-note-icon.has-note::before {
    border-top-color: rgba(30, 30, 50, 0.95);
}

[data-theme="dark"] .poland-note-icon.has-note::after {
    background: rgba(30, 30, 50, 0.95);
    border: 1px solid rgba(240, 147, 251, 0.2);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
}

/* Poland Products Toggle */
.poland-products-toggle {
    display: inline-block;
    margin: 4px 0 4px 6px;
    font-size: 12px;
    color: #6366f1;
    cursor: pointer;
    font-weight: 500;
}

.poland-products-toggle:hover {
    color: #4f46e5;
    text-decoration: underline;
}

[data-theme="dark"] .poland-products-toggle {
    color: #a5b4fc;
}

[data-theme="dark"] .poland-products-toggle:hover {
    color: #c7d2fe;
}

/* Badge Styling */
.badge {
    display: inline-block;
    padding: 6px 14px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.badge-nowe {
    background-color: #dbeafe;
    color: #1e40af;
}

.badge-zamowiono {
    background-color: #fef3c7;
    color: #92400e;
}

.badge-dostarczone_do_proxy {
    background-color: #ddd6fe;
    color: #5b21b6;
}

.badge-w_drodze {
    background-color: #fce7f3;
    color: #9f1239;
}

.badge-w_urzedzie_celnym {
    background-color: #e0e7ff;
    color: #3730a3;
}

.badge-zamowione {
    background-color: #fef3c7;
    color: #92400e;
}

.badge-dostarczone_gom {
    background-color: #d1fae5;
    color: #065f46;
}

.badge-anulowane {
    background-color: #f3f4f6;
    color: #6b7280;
}

/* Legacy badge aliases */
.badge-oczekujace {
    background-color: #fef3c7;
    color: #92400e;
}

.badge-dostarczone_proxy {
    background-color: #ddd6fe;
    color: #5b21b6;
}

/* Actions Group */
.actions-group {
    display: flex;
    gap: 8px;
}

/* Buttons */
.btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
}

.btn-primary {
    background-color: #FF8500;
    color: white;
}

.btn-primary:hover {
    background-color: #FF9100;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(255, 133, 0, 0.3);
}

.btn-secondary {
    background-color: #f3f4f6;
    color: #374151;
}

.btn-secondary:hover {
    background-color: #e5e7eb;
}

.btn-danger {
    background-color: #fef2f2;
    color: #dc2626;
}

.btn-danger:hover {
    background-color: #fee2e2;
}

.btn-sm {
    padding: 6px 10px;
    font-size: 12px;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 64px 24px;
}

.empty-state svg {
    color: #d1d5db;
    margin-bottom: 16px;
}

.empty-state h3 {
    font-size: 18px;
    font-weight: 600;
    color: #1a1a1a;
    margin: 0 0 8px 0;
}

.empty-state p {
    font-size: 14px;
    color: #6b7280;
    margin: 0 0 24px 0;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.filter-group label {
    font-size: 12px;
    font-weight: 600;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.filter-select {
    padding: 8px 12px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    font-size: 14px;
    background: white;
}

.filter-select:focus {
    outline: none;
    border-color: #FF8500;
}

.text-muted {
    color: #9ca3af;
    font-size: 14px;
    text-align: center;
    padding: 40px 0;
}

.text-right {
    text-align: right;
}

.text-center,
.data-table th.text-center,
.data-table td.text-center {
    text-align: center !important;
}

.font-semibold {
    font-weight: 600;
}

/* Product cell in orders table */
.product-cell {
    display: flex;
    align-items: center;
    gap: 12px;
}

.product-thumbnail-small {
    width: 40px;
    height: 40px;
    object-fit: contain;
    border-radius: 4px;
    border: 1px solid #e5e7eb;
    flex-shrink: 0;
}

.product-thumbnail-placeholder-small {
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f5f5f5;
    border: 1px dashed #ddd;
    color: #bbb;
}

.product-name-small {
    font-size: 13px;
    font-weight: 500;
    color: #1a1a1a;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Colored status badges */
.badge-nowe {
    background: #3b82f6;
    color: white;
    padding: 6px 14px;
    border-radius: 14px;
    font-size: 12px;
    font-weight: 600;
}

.badge-oczekujace {
    background: #f59e0b;
    color: white;
    padding: 6px 14px;
    border-radius: 14px;
    font-size: 12px;
    font-weight: 600;
}

.badge-dostarczone_proxy {
    background: #10b981;
    color: white;
    padding: 6px 14px;
    border-radius: 14px;
    font-size: 12px;
    font-weight: 600;
}

.badge-w_drodze_polska {
    background: #f97316;
    color: white;
    padding: 6px 14px;
    border-radius: 14px;
    font-size: 12px;
    font-weight: 600;
}

.badge-urzad_celny {
    background: #8b5cf6;
    color: white;
    padding: 6px 14px;
    border-radius: 14px;
    font-size: 12px;
    font-weight: 600;
}

.badge-dostarczone_gom {
    background: #059669;
    color: white;
    padding: 6px 14px;
    border-radius: 14px;
    font-size: 12px;
    font-weight: 600;
}

.badge-anulowane {
    background: #dc2626;
    color: white;
    padding: 6px 14px;
    border-radius: 14px;
    font-size: 12px;
    font-weight: 600;
}

/* Status dropdown */
.status-dropdown-wrapper {
    position: relative;
    display: inline-block;
}

/* Fixed width for status column to prevent jumping */
.data-table td:has(.status-dropdown-wrapper) {
    min-width: 250px;
    width: 250px;
}

.data-table th[data-column="status"] {
    min-width: 250px;
    width: 250px;
}

/* Status badge button - clean reset */
.status-badge-button,
.status-badge-button:hover,
.status-badge-button:focus,
.status-badge-button:active {
    all: unset;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 12px;
    border-radius: 14px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    cursor: pointer;
    box-sizing: border-box;
}

.status-badge-button:hover {
    opacity: 0.85;
}

/* Status colors - applied to button */
.status-badge-button.badge-zamowiono {
    background: #f59e0b;
    color: white;
}

.status-badge-button.badge-dostarczone_do_proxy {
    background: #8b5cf6;
    color: white;
}

.status-badge-button.badge-anulowane {
    background: #dc2626;
    color: white;
}

.status-badge-button.badge-zamowione {
    background: #f59e0b;
    color: white;
}

/* Legacy status colors (backward compat) */
.status-badge-button.badge-nowe {
    background: #3b82f6;
    color: white;
}

.status-badge-button.badge-oczekujace {
    background: #f59e0b;
    color: white;
}

.status-badge-button.badge-dostarczone_proxy {
    background: #10b981;
    color: white;
}

.status-badge-button.badge-w_drodze_polska {
    background: #f97316;
    color: white;
}

.status-badge-button.badge-urzad_celny {
    background: #8b5cf6;
    color: white;
}

.status-badge-button.badge-dostarczone_gom {
    background: #059669;
    color: white;
}

.status-dropdown {
    position: fixed;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 9999;
    min-width: 180px;
    padding: 4px;
}

.status-dropdown-option {
    padding: 6px 8px;
    cursor: pointer;
    border-radius: 4px;
    transition: background 0.2s;
}

.status-dropdown-option:hover {
    background: #f3f4f6;
}

.status-dropdown-option .badge {
    width: 100%;
    display: block;
    text-align: center;
    cursor: pointer;
}

/* ==========================================
   DARK MODE - GLASSMORPHISM
   ========================================== */

/* Page Background */
[data-theme="dark"] .stock-orders-page {
    background: transparent;
}

/* Tabs Navigation */
[data-theme="dark"] .tabs-navigation {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-bottom: 2px solid rgba(240, 147, 251, 0.2);
}

[data-theme="dark"] .tab-link {
    color: rgba(255, 255, 255, 0.6);
    transition: all 0.5s ease;
}

[data-theme="dark"] .tab-link:hover {
    color: #f093fb;
    background-color: rgba(240, 147, 251, 0.1);
}

[data-theme="dark"] .tab-link.active {
    color: #f093fb;
    border-bottom-color: #f093fb;
    text-shadow: 0 0 10px rgba(240, 147, 251, 0.5);
}

/* Tab Content */
[data-theme="dark"] .tab-content {
    background: transparent;
}

[data-theme="dark"] .tab-pane {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(240, 147, 251, 0.15);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

[data-theme="dark"] .tab-header {
    border-bottom-color: rgba(240, 147, 251, 0.15);
}

[data-theme="dark"] .tab-header h2 {
    color: #f0f0f0;
    text-shadow: 0 0 15px rgba(240, 147, 251, 0.3);
}

/* Orders Filters */
[data-theme="dark"] .orders-filters {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(240, 147, 251, 0.1);
}

[data-theme="dark"] .orders-filters .filter-group label {
    color: #f093fb;
}

[data-theme="dark"] .orders-filters .filter-input {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(240, 147, 251, 0.2);
    color: #f0f0f0;
}

[data-theme="dark"] .orders-filters .filter-input:focus {
    border-color: #f093fb;
    box-shadow: 0 0 0 3px rgba(240, 147, 251, 0.15);
}

/* Multi-select Dropdown */
[data-theme="dark"] .multi-select-trigger {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(240, 147, 251, 0.2);
    color: rgba(255, 255, 255, 0.8);
}

[data-theme="dark"] .multi-select-trigger:hover {
    border-color: rgba(240, 147, 251, 0.4);
}

[data-theme="dark"] .multi-select-dropdown {
    background: rgba(15, 12, 41, 0.98);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(240, 147, 251, 0.2);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
}

[data-theme="dark"] .multi-select-option {
    color: rgba(255, 255, 255, 0.8);
}

[data-theme="dark"] .multi-select-option:hover {
    background: rgba(240, 147, 251, 0.1);
}

[data-theme="dark"] .multi-select-option input[type="checkbox"] {
    accent-color: #f093fb;
}

/* Data Table */
[data-theme="dark"] .data-table {
    background: transparent;
}

[data-theme="dark"] .data-table thead {
    background-color: rgba(255, 255, 255, 0.03);
}

[data-theme="dark"] .data-table thead th {
    border-bottom: 2px solid #3d2d50;
}

[data-theme="dark"] .data-table th {
    color: rgba(255, 255, 255, 0.7);
}

[data-theme="dark"] .data-table th:hover {
    background-color: rgba(240, 147, 251, 0.1);
}

[data-theme="dark"] .data-table th.sorted-asc::after,
[data-theme="dark"] .data-table th.sorted-desc::after {
    color: #f093fb;
}

[data-theme="dark"] .data-table tbody td {
    border-bottom-color: #3d2d50;
}

[data-theme="dark"] .data-table tbody tr:hover {
    background-color: rgba(240, 147, 251, 0.08);
}

[data-theme="dark"] .data-table tbody tr.selected {
    background-color: rgba(240, 147, 251, 0.15) !important;
}

[data-theme="dark"] .data-table td {
    color: rgba(255, 255, 255, 0.8);
}

[data-theme="dark"] .data-table input[type="checkbox"] {
    accent-color: #f093fb;
}

/* Product Cell */
[data-theme="dark"] .product-thumbnail-small {
    border-color: rgba(240, 147, 251, 0.2);
}

[data-theme="dark"] .product-thumbnail-placeholder-small {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(240, 147, 251, 0.2);
    color: rgba(255, 255, 255, 0.3);
}

[data-theme="dark"] .product-name-small {
    color: #f0f0f0;
}

/* Status Badges - Dark Mode */
[data-theme="dark"] .badge-nowe {
    background: rgba(59, 130, 246, 0.3);
    color: #60a5fa;
}

[data-theme="dark"] .badge-oczekujace {
    background: rgba(245, 158, 11, 0.3);
    color: #fbbf24;
}

[data-theme="dark"] .badge-dostarczone_proxy {
    background: rgba(16, 185, 129, 0.3);
    color: #34d399;
}

[data-theme="dark"] .badge-w_drodze_polska {
    background: rgba(249, 115, 22, 0.3);
    color: #fb923c;
}

[data-theme="dark"] .badge-urzad_celny {
    background: rgba(139, 92, 246, 0.3);
    color: #a78bfa;
}

[data-theme="dark"] .badge-dostarczone_gom {
    background: rgba(5, 150, 105, 0.3);
    color: #10b981;
}

[data-theme="dark"] .badge-zamowione {
    background: rgba(245, 158, 11, 0.3);
    color: #fbbf24;
}

[data-theme="dark"] .badge-anulowane {
    background: rgba(220, 38, 38, 0.3);
    color: #f87171;
}

/* Status Badge Button - Dark Mode */
[data-theme="dark"] .status-badge-button.badge-zamowione {
    background: rgba(245, 158, 11, 0.3);
    color: #fbbf24;
}

[data-theme="dark"] .status-badge-button.badge-zamowiono {
    background: rgba(245, 158, 11, 0.3);
    color: #fbbf24;
}

[data-theme="dark"] .status-badge-button.badge-dostarczone_do_proxy {
    background: rgba(139, 92, 246, 0.3);
    color: #a78bfa;
}

[data-theme="dark"] .status-badge-button.badge-anulowane {
    background: rgba(220, 38, 38, 0.3);
    color: #f87171;
}

/* Legacy dark mode (backward compat) */
[data-theme="dark"] .status-badge-button.badge-nowe {
    background: rgba(59, 130, 246, 0.3);
    color: #60a5fa;
}

[data-theme="dark"] .status-badge-button.badge-oczekujace {
    background: rgba(245, 158, 11, 0.3);
    color: #fbbf24;
}

[data-theme="dark"] .status-badge-button.badge-dostarczone_proxy {
    background: rgba(16, 185, 129, 0.3);
    color: #34d399;
}

[data-theme="dark"] .status-badge-button.badge-w_drodze_polska {
    background: rgba(249, 115, 22, 0.3);
    color: #fb923c;
}

[data-theme="dark"] .status-badge-button.badge-urzad_celny {
    background: rgba(139, 92, 246, 0.3);
    color: #a78bfa;
}

[data-theme="dark"] .status-badge-button.badge-dostarczone_gom {
    background: rgba(5, 150, 105, 0.3);
    color: #10b981;
}

/* Status Dropdown - Dark Mode */
[data-theme="dark"] .status-dropdown {
    background: rgba(15, 12, 41, 0.98);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(240, 147, 251, 0.2);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
}

[data-theme="dark"] .status-dropdown-option:hover {
    background: rgba(240, 147, 251, 0.1);
}

/* Bulk Actions Modal - Dark Mode */
[data-theme="dark"] .bulk-actions-modal {
    background: rgba(15, 12, 41, 0.98);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(240, 147, 251, 0.2);
    box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.5), 0 0 30px rgba(240, 147, 251, 0.1);
}

[data-theme="dark"] .bulk-actions-info {
    color: rgba(255, 255, 255, 0.8);
}

[data-theme="dark"] .bulk-actions-info strong {
    color: #f093fb;
}

[data-theme="dark"] .bulk-action-status {
    background: rgba(240, 147, 251, 0.1);
    color: #f093fb;
}

[data-theme="dark"] .bulk-action-status:hover {
    background: rgba(240, 147, 251, 0.2);
}

[data-theme="dark"] .bulk-action-delete {
    background: rgba(248, 113, 113, 0.2);
    color: #f87171;
}

[data-theme="dark"] .bulk-action-delete:hover {
    background: rgba(248, 113, 113, 0.3);
}

[data-theme="dark"] .bulk-action-move {
    background: rgba(96, 165, 250, 0.15);
    color: #60a5fa;
}

[data-theme="dark"] .bulk-action-move:hover {
    background: rgba(96, 165, 250, 0.25);
}

/* Bulk Status Dropdown - Dark Mode */
[data-theme="dark"] .bulk-status-dropdown {
    background: rgba(15, 12, 41, 0.98);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(240, 147, 251, 0.2);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
}

[data-theme="dark"] .bulk-status-option:hover {
    background: rgba(240, 147, 251, 0.1);
}

/* Buttons - Dark Mode */
[data-theme="dark"] .btn-primary {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: #ffffff;
    box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);
}

[data-theme="dark"] .btn-primary:hover {
    box-shadow: 0 6px 25px rgba(240, 147, 251, 0.5);
}

[data-theme="dark"] .btn-secondary {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(240, 147, 251, 0.3);
    color: #f093fb;
}

[data-theme="dark"] .btn-secondary:hover {
    background: rgba(240, 147, 251, 0.1);
    border-color: #f093fb;
}

[data-theme="dark"] .btn-danger {
    background: rgba(248, 113, 113, 0.2);
    color: #f87171;
}

[data-theme="dark"] .btn-danger:hover {
    background: rgba(248, 113, 113, 0.3);
}

/* Empty State - Dark Mode */
[data-theme="dark"] .empty-state svg {
    color: rgba(255, 255, 255, 0.3);
}

[data-theme="dark"] .empty-state h3 {
    color: #f0f0f0;
}

[data-theme="dark"] .empty-state p {
    color: rgba(255, 255, 255, 0.5);
}

/* Modal Overlay - Dark Mode */
[data-theme="dark"] .modal-overlay {
    background: rgba(15, 12, 41, 0.8);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
}

[data-theme="dark"] .modal {
    background: rgba(15, 12, 41, 0.98);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(240, 147, 251, 0.2);
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6), 0 0 40px rgba(240, 147, 251, 0.1);
}

[data-theme="dark"] .modal-header {
    border-bottom-color: rgba(240, 147, 251, 0.15);
}

[data-theme="dark"] .modal-title {
    color: #f0f0f0;
}

[data-theme="dark"] .modal-close {
    color: rgba(255, 255, 255, 0.5);
}

[data-theme="dark"] .modal-close:hover {
    color: #f0f0f0;
}

[data-theme="dark"] .modal-footer {
    border-top-color: rgba(240, 147, 251, 0.15);
}

/* Filters - Dark Mode */
[data-theme="dark"] .filter-group label {
    color: #f093fb;
}

[data-theme="dark"] .filter-select {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(240, 147, 251, 0.2);
    color: #f0f0f0;
}

[data-theme="dark"] .filter-select:focus {
    border-color: #f093fb;
    box-shadow: 0 0 0 3px rgba(240, 147, 251, 0.15);
}

/* Text Utilities - Dark Mode */
[data-theme="dark"] .text-muted {
    color: rgba(255, 255, 255, 0.4);
}

[data-theme="dark"] .font-semibold {
    color: #f0f0f0;
}

/* Transitions for smooth theme switching */
.stock-orders-page,
.tabs-navigation,
.tab-link,
.tab-content,
.tab-pane,
.tab-header,
.tab-header h2,
.orders-filters,
.filter-input,
.multi-select-trigger,
.multi-select-dropdown,
.multi-select-option,
.data-table,
.data-table thead,
.data-table th,
.data-table tbody tr,
.data-table td,
.product-thumbnail-small,
.product-thumbnail-placeholder-small,
.product-name-small,
.badge,
.status-badge-button,
.status-dropdown,
.status-dropdown-option,
.bulk-actions-modal,
.bulk-actions-info,
.bulk-action-btn,
.bulk-status-dropdown,
.bulk-status-option,
.btn,
.empty-state,
.empty-state svg,
.empty-state h3,
.empty-state p,
.modal-overlay,
.modal,
.modal-header,
.modal-title,
.modal-close,
.modal-footer,
.filter-select,
.text-muted {
    transition: all 0.5s ease;
}

/* ============================================
   DO ZAMÓWIENIA Tab Styles
   ============================================ */

/* Tab Badge - Circle with number */
.tab-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 24px;
    height: 24px;
    padding: 0 6px;
    color: white;
    font-size: 12px;
    font-weight: 700;
    border-radius: 50%;
    margin-left: 10px;
}

/* Tab Badge Color Variants */
.tab-badge-red {
    background: #ef4444;
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
}

.tab-badge-purple {
    background: #8b5cf6;
    box-shadow: 0 2px 8px rgba(139, 92, 246, 0.4);
}

.tab-badge-blue {
    background: #3b82f6;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
}

/* Tab Subtitle */
.tab-subtitle {
    font-size: 14px;
    color: #6b7280;
    margin: 4px 0 0;
}

/* Text Orange */
.text-orange {
    color: #FF8500 !important;
}

/* To Order Table - Compact Rows */
.to-order-row td {
    padding: 10px 12px;
    vertical-align: middle;
}

.to-order-row .product-cell {
    display: flex;
    align-items: center;
    gap: 10px;
}

.to-order-row .product-thumbnail {
    width: 40px;
    height: 40px;
    object-fit: contain;
    border-radius: 4px;
    flex-shrink: 0;
}

.to-order-row .product-thumbnail-placeholder {
    width: 40px;
    height: 40px;
    max-width: 40px;
    margin: 0;
    flex-shrink: 0;
}

.to-order-row .product-thumbnail-placeholder svg {
    width: 16px;
    height: 16px;
}

.to-order-row .product-info {
    min-width: 0;
}

.to-order-row .product-name {
    font-size: 13px;
    font-weight: 500;
    line-height: 1.4;
}

/* Cena PLN + KRW (dwuwierszowo) */
.price-pln {
    font-size: 0.9rem;
    font-weight: 600;
    color: #1a1a1a;
}

.price-krw {
    font-size: 0.75rem;
    color: #6b7280;
    margin-top: 2px;
}

/* Zaznaczony wiersz */
.to-order-row.selected {
    background: rgba(255, 133, 0, 0.06);
}

.to-order-row.selected:hover {
    background: rgba(255, 133, 0, 0.1);
}

/* Supplier Badge */
.supplier-badge {
    display: inline-block;
    padding: 4px 8px;
    background: #f0f9ff;
    color: #0369a1;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
}

/* Bulk Toolbar (floating pill at bottom) */
.bulk-toolbar {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%) translateY(0);
    background: linear-gradient(135deg, #240046 0%, #5A189A 100%);
    color: white;
    padding: 1rem 2rem;
    border-radius: 50px;
    box-shadow: 0 8px 24px rgba(36, 0, 70, 0.4);
    z-index: 1000;
    opacity: 1;
    filter: blur(0);
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1),
                opacity 0.3s ease-out,
                filter 0.3s ease-out;
}

/* Override global .hidden { display: none } to allow animations */
.bulk-toolbar.hidden {
    display: block !important;
    opacity: 0;
    pointer-events: none;
    transform: translateX(-50%) translateY(100px);
    filter: blur(8px);
}

.bulk-toolbar-content {
    display: flex;
    align-items: center;
    gap: 2rem;
}

.bulk-toolbar .selected-count {
    font-weight: 600;
    font-size: 0.875rem;
}

.bulk-toolbar .bulk-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-bulk {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 6px;
    color: white;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-bulk:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.5);
}

/* Order Products Modal */
.order-products-table-wrapper {
    max-height: 400px;
    overflow-y: auto;
    margin-top: 16px;
}

.order-products-table {
    width: 100%;
}

.order-products-table .quantity-input {
    width: 80px;
    padding: 6px 8px;
    border: 1px solid #e5e7eb;
    border-radius: 4px;
    text-align: center;
    font-size: 14px;
}

.order-products-table .quantity-input:focus {
    outline: none;
    border-color: #FF8500;
    box-shadow: 0 0 0 2px rgba(255, 133, 0, 0.1);
}

.order-products-table .supplier-select {
    width: 150px;
    padding: 6px 8px;
    border: 1px solid #e5e7eb;
    border-radius: 4px;
    font-size: 13px;
}

.order-products-table .total-row td {
    padding-top: 16px;
    border-top: 2px solid #e5e7eb;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #6b7280;
}

.empty-state svg {
    color: #d1d5db;
    margin-bottom: 16px;
}

.empty-state h3 {
    font-size: 18px;
    font-weight: 600;
    color: #374151;
    margin: 0 0 8px;
}

.empty-state p {
    font-size: 14px;
    margin: 0;
}

/* ============================================
   Dark Mode Styles for DO ZAMÓWIENIA
   ============================================ */

/* Tab Badge Dark Mode Variants */
[data-theme="dark"] .tab-badge-red {
    background: #ef4444;
    box-shadow: 0 2px 12px rgba(239, 68, 68, 0.5), 0 0 20px rgba(239, 68, 68, 0.3);
}

[data-theme="dark"] .tab-badge-purple {
    background: #8b5cf6;
    box-shadow: 0 2px 12px rgba(139, 92, 246, 0.5), 0 0 20px rgba(139, 92, 246, 0.3);
}

[data-theme="dark"] .tab-badge-blue {
    background: #3b82f6;
    box-shadow: 0 2px 12px rgba(59, 130, 246, 0.5), 0 0 20px rgba(59, 130, 246, 0.3);
}

[data-theme="dark"] .tab-subtitle {
    color: rgba(255, 255, 255, 0.6);
}

[data-theme="dark"] .supplier-badge {
    background: rgba(240, 147, 251, 0.15);
    color: #f093fb;
}

/* Dark mode - To Order Table Compact Rows */
[data-theme="dark"] .to-order-row .product-thumbnail {
    border: 1px solid rgba(240, 147, 251, 0.2);
}

[data-theme="dark"] .to-order-row .product-thumbnail-placeholder {
    background: rgba(255, 255, 255, 0.03);
    border-color: rgba(240, 147, 251, 0.2);
    color: rgba(255, 255, 255, 0.3);
}

[data-theme="dark"] .to-order-row .product-name {
    color: #f0f0f0;
}

/* Dark mode - Cena PLN + KRW */
[data-theme="dark"] .price-pln {
    color: #ffffff;
}

[data-theme="dark"] .price-krw {
    color: rgba(255, 255, 255, 0.5);
}

/* Dark mode - Zaznaczony wiersz */
[data-theme="dark"] .to-order-row.selected {
    background: rgba(240, 147, 251, 0.08);
}

[data-theme="dark"] .to-order-row.selected:hover {
    background: rgba(240, 147, 251, 0.12);
}

/* Dark mode - Bulk Toolbar */
[data-theme="dark"] .bulk-toolbar {
    background: linear-gradient(135deg, rgba(15, 12, 41, 0.98) 0%, rgba(48, 43, 99, 0.98) 100%);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(240, 147, 251, 0.2);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), 0 0 40px rgba(240, 147, 251, 0.1);
}

[data-theme="dark"] .btn-bulk {
    background: rgba(240, 147, 251, 0.1);
    border-color: rgba(240, 147, 251, 0.3);
}

[data-theme="dark"] .btn-bulk:hover {
    background: rgba(240, 147, 251, 0.2);
    border-color: rgba(240, 147, 251, 0.5);
}

[data-theme="dark"] .order-products-table .quantity-input {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(240, 147, 251, 0.2);
    color: white;
}

[data-theme="dark"] .order-products-table .quantity-input:focus {
    border-color: #f093fb;
    box-shadow: 0 0 0 2px rgba(240, 147, 251, 0.2);
}

[data-theme="dark"] .order-products-table .supplier-select {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(240, 147, 251, 0.2);
    color: white;
}

[data-theme="dark"] .order-products-table .total-row td {
    border-top-color: rgba(240, 147, 251, 0.2);
}

[data-theme="dark"] .empty-state {
    color: rgba(255, 255, 255, 0.6);
}

[data-theme="dark"] .empty-state svg {
    color: rgba(255, 255, 255, 0.3);
}

[data-theme="dark"] .empty-state h3 {
    color: rgba(255, 255, 255, 0.9);
}

/* === PROXY ORDERS - Products Column === */
.products-cell {
    max-width: 350px;
}

.products-list-compact {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.product-item-compact {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 4px 8px;
    background: #f9fafb;
    border-radius: 6px;
}

.product-thumb-compact {
    width: 32px;
    height: 32px;
    object-fit: cover;
    border-radius: 4px;
    flex-shrink: 0;
}

.product-thumb-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    background: #e5e7eb;
    color: #9ca3af;
}

.product-item-info {
    display: flex;
    align-items: center;
    gap: 4px;
    min-width: 0;
}

.product-item-name {
    font-size: 13px;
    font-weight: 500;
    color: #374151;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.product-item-qty {
    font-size: 12px;
    color: #9ca3af;
    flex-shrink: 0;
}

/* === POLAND ORDER MODAL === */
.poland-modal-top-row {
    display: flex;
    gap: 10px;
    margin-bottom: 12px;
}

.poland-modal-box {
    border-radius: 6px;
    padding: 10px 14px;
}

.poland-modal-box label {
    display: block;
    font-weight: 600;
    font-size: 13px;
    margin: 0 0 6px 0;
    white-space: nowrap;
}

.tracking-box {
    background: #f0f4ff;
    border: 1px solid #6366f1;
    flex: 0 0 auto;
}

.shipping-cost-box {
    background: #fff7ed;
    border: 1px solid #FF8500;
    flex: 1 1 auto;
}

.tracking-input-group {
    display: flex;
    align-items: stretch;
}

.tracking-prefix {
    font-size: 13px;
    font-weight: 600;
    color: #374151;
    background: #e5e7eb;
    border: 1px solid #d1d5db;
    border-right: none;
    border-radius: 4px 0 0 4px;
    padding: 0 8px;
    white-space: nowrap;
    display: flex;
    align-items: center;
}

.tracking-number-field {
    font-size: 13px;
    font-weight: 600;
    width: 55px;
    padding: 6px 8px;
    border-radius: 0 4px 4px 0 !important;
    border: 1px solid #d1d5db;
    text-align: center;
    -moz-appearance: textfield;
}

.tracking-number-field::-webkit-outer-spin-button,
.tracking-number-field::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

/* Validation error */
.input-error {
    border: 2px solid #ef4444 !important;
    animation: shakeInput 0.3s ease-in-out;
    background-color: rgba(239, 68, 68, 0.05) !important;
}

[data-theme="dark"] .input-error {
    border: 2px solid #f87171 !important;
    background-color: rgba(248, 113, 113, 0.1) !important;
}

@keyframes shakeInput {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-4px); }
    75% { transform: translateX(4px); }
}

.total-shipping-input-group {
    display: flex;
    align-items: center;
    gap: 6px;
}

.total-shipping-field {
    font-size: 14px;
    font-weight: 600;
    width: 140px;
    padding: 6px 10px;
}

.input-suffix {
    font-size: 13px;
    font-weight: 500;
    color: #6b7280;
}

.help-text-small {
    font-size: 11px;
    color: #9ca3af;
    margin: 4px 0 0 0;
}

.package-shipping-input,
.shipping-price-input,
.shipping-value-input {
    width: 100%;
    box-sizing: border-box;
    padding: 4px 8px;
    background: #fff7ed;
    border: 1px solid #FF8500;
    border-radius: 4px;
    font-size: 13px;
    text-align: right;
}

.package-shipping-input:focus,
.shipping-price-input:focus,
.shipping-value-input:focus {
    border-color: #FF8500;
    outline: none;
    box-shadow: 0 0 0 2px rgba(255, 133, 0, 0.1);
}

/* Poland package (generated by JS) */
.poland-package {
    margin-bottom: 0;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    overflow: hidden;
    background: #f9fafb;
}

.poland-package-separator {
    border: none;
    height: 2px;
    background: #d1d5db;
    margin: 14px 0;
}

.poland-package-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 12px;
    background: #eef0f3;
    border-bottom: 1px solid #e5e7eb;
}

.poland-package-title {
    font-size: 12px;
    font-weight: 600;
    color: #374151;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.poland-package-shipping {
    display: flex;
    align-items: center;
    gap: 6px;
}

.poland-package-shipping label {
    margin: 0;
    font-weight: 500;
    font-size: 11px;
    color: #6b7280;
}

.poland-products-table {
    margin-bottom: 0;
    table-layout: fixed;
    width: 100%;
}

.poland-products-table thead th {
    padding: 4px 10px;
    font-size: 11px;
    text-align: left;
}

.poland-products-table td {
    padding: 5px 10px;
    font-size: 13px;
    text-align: left;
    overflow: hidden;
}

.poland-note-group {
    margin-top: 10px;
}

.poland-note-group label {
    font-size: 13px;
}

.shipping-summary-box {
    background: #f9fafb;
    border-radius: 6px;
    padding: 10px 14px;
    margin-top: 12px;
}

.summary-row-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0;
    font-size: 13px;
}

.summary-row-item.summary-difference {
    border-top: 1px solid #e5e7eb;
    margin-top: 4px;
    padding-top: 8px;
    font-size: 14px;
    font-weight: 500;
}

/* Dark mode - proxy products column */
[data-theme="dark"] .product-item-compact {
    background: rgba(255, 255, 255, 0.05);
}

[data-theme="dark"] .product-item-name {
    color: rgba(255, 255, 255, 0.9);
}

[data-theme="dark"] .product-thumb-placeholder {
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.4);
}

/* Dark mode - Poland modal */
[data-theme="dark"] .poland-modal-box label {
    color: rgba(255, 255, 255, 0.9);
}

[data-theme="dark"] .tracking-box {
    background: rgba(99, 102, 241, 0.1);
    border-color: rgba(99, 102, 241, 0.4);
}

[data-theme="dark"] .shipping-cost-box {
    background: rgba(255, 133, 0, 0.1);
    border-color: rgba(255, 133, 0, 0.4);
}

[data-theme="dark"] .tracking-prefix {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.2);
    color: rgba(255, 255, 255, 0.8);
}

[data-theme="dark"] .tracking-number-field {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.2);
    color: #fff;
}

[data-theme="dark"] .tracking-number-field:focus {
    border-color: rgba(99, 102, 241, 0.5);
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.15);
}

[data-theme="dark"] .input-suffix {
    color: rgba(255, 255, 255, 0.5);
}

[data-theme="dark"] .package-shipping-input,
[data-theme="dark"] .shipping-price-input,
[data-theme="dark"] .shipping-value-input {
    background: rgba(255, 133, 0, 0.1);
    border-color: rgba(255, 133, 0, 0.4);
    color: #fff;
}

[data-theme="dark"] .package-shipping-input:focus,
[data-theme="dark"] .shipping-price-input:focus,
[data-theme="dark"] .shipping-value-input:focus {
    border-color: rgba(255, 133, 0, 0.5);
    box-shadow: 0 0 0 2px rgba(255, 133, 0, 0.15);
}

[data-theme="dark"] .poland-package {
    border-color: rgba(255, 255, 255, 0.1);
    background: rgba(255, 255, 255, 0.04);
}

[data-theme="dark"] .poland-package-separator {
    background: rgba(255, 255, 255, 0.15);
}

[data-theme="dark"] .poland-package-header {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(255, 255, 255, 0.1);
}

[data-theme="dark"] .poland-package-title {
    color: rgba(255, 255, 255, 0.8);
}

[data-theme="dark"] .poland-package-shipping label {
    color: rgba(255, 255, 255, 0.5);
}

[data-theme="dark"] .shipping-summary-box {
    background: rgba(255, 255, 255, 0.05);
}

[data-theme="dark"] .help-text-small {
    color: rgba(255, 255, 255, 0.4);
}

.text-nowrap {
    white-space: nowrap;
}

/* ==========================================
   Poland Orders - Inner Products Table
   ========================================== */
.poland-products-cell {
    padding: 0 !important;
    min-width: 280px;
    vertical-align: top;
}

.poland-products-inner-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 12px;
}

.poland-products-inner-table thead th {
    padding: 2px 6px;
    font-size: 11px;
    font-weight: 600;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    border-bottom: 1px solid #e5e7eb;
    border-right: none;
    white-space: nowrap;
}

.poland-products-inner-table tbody td {
    padding: 4px 6px;
    vertical-align: middle;
    border-bottom: 1px solid #f3f4f6;
    border-right: none;
}

.poland-products-inner-table tbody tr:last-child td {
    border-bottom: none;
}

.poland-inner-product-name {
    max-width: 180px;
}

.poland-inner-product-name .product-item-compact {
    margin: 0;
    padding: 0;
}

.btn-edit-customs-vat {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    margin-top: 6px;
    padding: 3px 8px;
    font-size: 11px;
    color: #6366f1;
    background: none;
    border: 1px solid #e0e7ff;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-edit-customs-vat:hover {
    background: #e0e7ff;
    color: #4338ca;
}

/* Dark mode - Inner Products Table */
[data-theme="dark"] .poland-products-inner-table thead th {
    color: rgba(255, 255, 255, 0.5);
    border-bottom-color: rgba(255, 255, 255, 0.1);
    border-right: none;
}

[data-theme="dark"] .poland-products-inner-table tbody td {
    border-bottom-color: rgba(255, 255, 255, 0.05);
    border-right: none;
}

[data-theme="dark"] .btn-edit-customs-vat {
    color: #a5b4fc;
    border-color: rgba(165, 180, 252, 0.2);
}

[data-theme="dark"] .btn-edit-customs-vat:hover {
    background: rgba(165, 180, 252, 0.1);
    color: #c7d2fe;
}

/* Per-item customs edit button */
.poland-customs-item-cell {
    white-space: nowrap;
}

.poland-customs-item-cell .poland-item-customs-amount {
    vertical-align: middle;
}

.poland-customs-item-cell .btn-edit-customs-item {
    vertical-align: middle;
    margin-left: 4px;
}

.btn-edit-customs-item {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    padding: 0;
    background: none;
    border: none;
    border-radius: 3px;
    color: #9ca3af;
    cursor: pointer;
    transition: all 0.15s;
    flex-shrink: 0;
}

.btn-edit-customs-item:hover {
    color: #6366f1;
    background: #e0e7ff;
}

[data-theme="dark"] .btn-edit-customs-item {
    color: rgba(255, 255, 255, 0.3);
}

[data-theme="dark"] .btn-edit-customs-item:hover {
    color: #a5b4fc;
    background: rgba(165, 180, 252, 0.15);
}

/* ==========================================
   Customs/VAT Modal
   ========================================== */
.customs-vat-global-section {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    margin-bottom: 16px;
    background: #f0f9ff;
    border: 1px solid #bae6fd;
    border-radius: 8px;
}

.customs-vat-global-row {
    display: flex;
    align-items: center;
    gap: 12px;
    width: 100%;
}

.customs-vat-global-row label {
    font-size: 13px;
    font-weight: 600;
    color: #374151;
    white-space: nowrap;
}

.customs-vat-global-input-group {
    display: flex;
    align-items: center;
    gap: 6px;
}

.customs-vat-percent-wrapper {
    display: flex;
    align-items: center;
    gap: 2px;
}

.customs-vat-percent-input {
    width: 70px;
    padding: 4px 8px;
    font-size: 13px;
    text-align: center;
    border: 1px solid #d1d5db;
    border-radius: 4px;
}

.customs-vat-percent-input:focus {
    border-color: #6366f1;
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.15);
    outline: none;
}

.input-suffix {
    font-size: 13px;
    color: #6b7280;
    font-weight: 500;
}

.customs-vat-order-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 12px;
    margin-top: 12px;
    margin-bottom: 4px;
    font-size: 14px;
    font-weight: 600;
    color: #374151;
    background: #f9fafb;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
}

.customs-vat-order-header:first-child {
    margin-top: 0;
}

.customs-vat-order-header svg {
    color: #6b7280;
}

.customs-vat-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    margin-bottom: 8px;
}

.customs-vat-table thead th {
    padding: 8px 10px;
    font-size: 11px;
    font-weight: 600;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    border-bottom: 2px solid #e5e7eb;
    white-space: nowrap;
}

.customs-vat-table tbody td {
    padding: 8px 10px;
    vertical-align: middle;
    border-bottom: 1px solid #f3f4f6;
}

.customs-vat-table tbody tr:last-child td {
    border-bottom: none;
}

.customs-vat-product-cell {
    max-width: 200px;
}

.customs-vat-product {
    display: flex;
    align-items: center;
    gap: 8px;
}

.customs-vat-product-name {
    font-size: 13px;
    line-height: 1.3;
    max-width: 160px;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

.customs-vat-amount-cell {
    font-weight: 600;
    color: #059669;
}

.customs-vat-summary {
    margin-top: 16px;
    padding: 12px 16px;
    background: #f9fafb;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
}

.customs-vat-summary-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
}

.customs-vat-summary-row strong {
    font-size: 16px;
    color: #059669;
}

.customs-vat-items-container .loading-spinner {
    text-align: center;
    padding: 40px;
    color: #6b7280;
}

.customs-vat-items-container .empty-state-small {
    text-align: center;
    padding: 40px;
    color: #ef4444;
}

/* Bulk action customs button */
.bulk-action-customs {
    background: #ecfdf5;
    color: #059669;
}

.bulk-action-customs:hover {
    background: #d1fae5;
}

/* Dark mode - Customs/VAT Modal */
[data-theme="dark"] .customs-vat-global-section {
    background: rgba(96, 165, 250, 0.08);
    border-color: rgba(96, 165, 250, 0.2);
}

[data-theme="dark"] .customs-vat-global-row label {
    color: rgba(255, 255, 255, 0.9);
}

[data-theme="dark"] .customs-vat-percent-input {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.15);
    color: #ffffff;
}

[data-theme="dark"] .customs-vat-percent-input:focus {
    border-color: #f093fb;
    box-shadow: 0 0 0 2px rgba(240, 147, 251, 0.15);
}

[data-theme="dark"] .input-suffix {
    color: rgba(255, 255, 255, 0.5);
}

[data-theme="dark"] .customs-vat-order-header {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
    color: #ffffff;
}

[data-theme="dark"] .customs-vat-order-header svg {
    color: rgba(255, 255, 255, 0.5);
}

[data-theme="dark"] .customs-vat-table thead th {
    color: rgba(255, 255, 255, 0.5);
    border-bottom-color: rgba(255, 255, 255, 0.1);
}

[data-theme="dark"] .customs-vat-table tbody td {
    border-bottom-color: rgba(255, 255, 255, 0.05);
}

[data-theme="dark"] .customs-vat-product-name {
    color: #ffffff;
}

[data-theme="dark"] .customs-vat-amount-cell {
    color: #34d399;
}

[data-theme="dark"] .customs-vat-summary {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
}

[data-theme="dark"] .customs-vat-summary-row {
    color: rgba(255, 255, 255, 0.9);
}

[data-theme="dark"] .customs-vat-summary-row strong {
    color: #34d399;
}

[data-theme="dark"] .customs-vat-items-container .loading-spinner {
    color: rgba(255, 255, 255, 0.5);
}

[data-theme="dark"] .bulk-action-customs {
    background: rgba(52, 211, 153, 0.15);
    color: #34d399;
}

[data-theme="dark"] .bulk-action-customs:hover {
    background: rgba(52, 211, 153, 0.25);
}

</style>

<script src="{{ url_for('static', filename='js/pages/admin/stock-orders.js') }}"></script>

<script>
// ============================================
// Filter Functions
// ============================================

let selectedStatuses = [];

/**
 * Toggle status multi-select dropdown
 */
function toggleStatusMultiSelect() {
    const dropdown = document.getElementById('statusMultiSelect');
    if (dropdown.style.display === 'none') {
        dropdown.style.display = 'block';
    } else {
        dropdown.style.display = 'none';
    }
}

/**
 * Update status filter when checkboxes change
 */
function updateStatusFilter() {
    const checkboxes = document.querySelectorAll('#statusMultiSelect input[type="checkbox"]:checked');
    selectedStatuses = Array.from(checkboxes).map(cb => cb.value);

    // Update trigger button text
    const statusText = document.getElementById('statusSelectText');
    if (selectedStatuses.length === 0) {
        statusText.textContent = 'Wszystkie statusy';
    } else if (selectedStatuses.length === 1) {
        statusText.textContent = `1 status`;
    } else {
        statusText.textContent = `${selectedStatuses.length} statusy`;
    }

    applyFilters();
}

/**
 * Apply all filters (date + status)
 */
function applyFilters() {
    const orderNumberFilter = document.getElementById('filterOrderNumber').value.toLowerCase().trim();
    const dateFrom = document.getElementById('filterDateFrom').value;
    const dateTo = document.getElementById('filterDateTo').value;

    const rows = document.querySelectorAll('#proxyOrdersTable tbody tr');

    rows.forEach(row => {
        let showRow = true;

        // Order number filter
        if (orderNumberFilter) {
            const rowOrderNumber = (row.dataset.orderNumber || '').toLowerCase();
            if (!rowOrderNumber.includes(orderNumberFilter)) {
                showRow = false;
            }
        }

        // Date filter
        const rowDate = row.dataset.dateFormatted;
        if (rowDate) {
            if (dateFrom && rowDate < dateFrom) {
                showRow = false;
            }
            if (dateTo && rowDate > dateTo) {
                showRow = false;
            }
        }

        // Status filter
        if (selectedStatuses.length > 0) {
            const rowStatus = row.dataset.status;
            if (!selectedStatuses.includes(rowStatus)) {
                showRow = false;
            }
        }

        row.style.display = showRow ? '' : 'none';
    });

    // Update select all checkbox state
    updateSelectAllState();
}

/**
 * Clear all filters
 */
function clearAllFilters() {
    document.getElementById('filterOrderNumber').value = '';
    document.getElementById('filterDateFrom').value = '';
    document.getElementById('filterDateTo').value = '';

    // Uncheck all status checkboxes
    document.querySelectorAll('#statusMultiSelect input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    selectedStatuses = [];
    document.getElementById('statusSelectText').textContent = 'Wszystkie statusy';

    // Show all rows
    document.querySelectorAll('.data-table tbody tr').forEach(row => {
        row.style.display = '';
    });

    updateSelectAllState();
}

// Close multi-select when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('.multi-select-wrapper')) {
        const dropdown = document.getElementById('statusMultiSelect');
        if (dropdown) dropdown.style.display = 'none';
    }
});

// ============================================
// Checkbox & Bulk Actions Functions
// ============================================

/**
 * Toggle select all checkboxes
 */
function toggleSelectAll(selectAllCheckbox) {
    const visibleRows = document.querySelectorAll('.data-table tbody tr:not([style*="display: none"])');
    const checkboxes = Array.from(visibleRows).map(row => row.querySelector('.order-checkbox'));

    checkboxes.forEach(checkbox => {
        if (checkbox) {
            checkbox.checked = selectAllCheckbox.checked;
            const row = checkbox.closest('tr');
            if (selectAllCheckbox.checked) {
                row.classList.add('selected');
            } else {
                row.classList.remove('selected');
            }
        }
    });

    updateBulkActionsModal();
}

/**
 * Handle individual checkbox change
 */
function handleCheckboxChange() {
    const checkbox = event.target;
    const row = checkbox.closest('tr');

    if (checkbox.checked) {
        row.classList.add('selected');
    } else {
        row.classList.remove('selected');
    }

    updateSelectAllState();
    updateBulkActionsModal();
}

/**
 * Update select all checkbox state based on individual checkboxes
 */
function updateSelectAllState() {
    const selectAllCheckbox = document.getElementById('selectAllOrders');
    if (!selectAllCheckbox) return;

    const visibleRows = document.querySelectorAll('.data-table tbody tr:not([style*="display: none"])');
    const checkboxes = Array.from(visibleRows).map(row => row.querySelector('.order-checkbox')).filter(cb => cb);

    const allChecked = checkboxes.length > 0 && checkboxes.every(cb => cb.checked);
    const someChecked = checkboxes.some(cb => cb.checked);

    selectAllCheckbox.checked = allChecked;
    selectAllCheckbox.indeterminate = someChecked && !allChecked;
}

/**
 * Update bulk actions modal visibility
 */
function updateBulkActionsModal() {
    const checkedBoxes = document.querySelectorAll('.order-checkbox:checked');
    const modal = document.getElementById('bulkActionsModal');
    const countSpan = document.getElementById('selectedCount');

    if (checkedBoxes.length > 0) {
        modal.classList.add('visible');
        countSpan.textContent = checkedBoxes.length;
    } else {
        modal.classList.remove('visible');
        hideBulkStatusDropdown();
    }
}

/**
 * Get selected order IDs
 */
function getSelectedOrderIds() {
    return Array.from(document.querySelectorAll('.order-checkbox:checked')).map(cb => cb.value);
}

/**
 * Open bulk status change dropdown
 */
function openBulkStatusChange() {
    const dropdown = document.getElementById('bulkStatusDropdown');
    if (dropdown.style.display === 'none') {
        dropdown.style.display = 'block';
    } else {
        dropdown.style.display = 'none';
    }
}

/**
 * Hide bulk status dropdown
 */
function hideBulkStatusDropdown() {
    const dropdown = document.getElementById('bulkStatusDropdown');
    if (dropdown) dropdown.style.display = 'none';
}

/**
 * Apply bulk status change
 */
function applyBulkStatus(newStatus) {
    const orderIds = getSelectedOrderIds();
    if (orderIds.length === 0) return;

    const activeTab = '{{ active_tab }}';

    const statusLabelsProxy = {
        'zamowiono': 'Zamówiono',
        'dostarczone_do_proxy': 'Dostarczone do Proxy',
        'anulowane': 'Anulowane'
    };
    const statusLabelsPoland = {
        'zamowione': 'Zamówione',
        'urzad_celny': 'Urząd celny',
        'dostarczone_gom': 'Dostarczone GOM',
        'anulowane': 'Anulowane'
    };
    const statusLabels = activeTab === 'polska' ? statusLabelsPoland : statusLabelsProxy;
    const rowPrefix = activeTab === 'polska' ? 'poland-order-row' : 'order-row';

    let completed = 0;
    let errors = 0;

    orderIds.forEach(orderId => {
        const endpoint = activeTab === 'polska'
            ? `/admin/products/poland-orders/${orderId}/status`
            : `/admin/products/proxy-orders/${orderId}/status`;

        fetch(endpoint, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            completed++;

            if (data.success) {
                const row = document.getElementById(`${rowPrefix}-${orderId}`);

                if (row) {
                    const button = row.querySelector('.status-badge-button');
                    if (button) {
                        button.className = `status-badge-button badge-${newStatus}`;
                        button.childNodes[0].textContent = (statusLabels[newStatus] || newStatus) + ' ';
                    }
                    row.dataset.status = newStatus;

                    const checkbox = row.querySelector('.order-checkbox');
                    if (checkbox) {
                        checkbox.checked = false;
                        row.classList.remove('selected');
                    }
                }
            } else {
                errors++;
            }

            if (completed === orderIds.length) {
                hideBulkStatusDropdown();
                updateBulkActionsModal();
                updateSelectAllState();

                if (errors === 0) {
                    if (window.Toast) {
                        window.Toast.show(`Status ${orderIds.length} zamówień został zmieniony`, 'success');
                    }
                } else {
                    if (window.Toast) {
                        window.Toast.show(`Zmieniono status ${completed - errors} zamówień, ${errors} błędów`, 'warning');
                    }
                }
            }
        })
        .catch(error => {
            console.error('Bulk status change error:', error);
            errors++;
            completed++;
        });
    });
}

/**
 * Bulk delete orders
 */
function bulkDeleteOrders() {
    const orderIds = getSelectedOrderIds();
    if (orderIds.length === 0) return;

    if (!confirm(`Czy na pewno chcesz usunąć ${orderIds.length} zamówień?\n\nTa operacja jest nieodwracalna.`)) {
        return;
    }

    let completed = 0;
    let errors = 0;

    orderIds.forEach(orderId => {
        fetch(`/admin/products/stock-orders/${orderId}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            completed++;

            if (!data.success) {
                errors++;
            }

            // Gdy wszystkie requesty się zakończą — przeładuj stronę
            if (completed === orderIds.length) {
                if (errors === 0) {
                    if (window.Toast) {
                        window.Toast.show(`Usunięto ${orderIds.length} zamówień`, 'success');
                    }
                } else {
                    if (window.Toast) {
                        window.Toast.show(`Usunięto ${completed - errors} zamówień, ${errors} błędów`, 'warning');
                    }
                }

                setTimeout(() => {
                    window.location.reload();
                }, 500);
            }
        })
        .catch(error => {
            console.error('Bulk delete error:', error);
            errors++;
            completed++;

            if (completed === orderIds.length) {
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            }
        });
    });
}

/**
 * Bulk move orders to POLSKA tab
 */
function bulkMoveToPolska() {
    const orderIds = getSelectedOrderIds();
    if (orderIds.length === 0) return;

    if (!confirm(`Czy na pewno chcesz przenieść ${orderIds.length} zamówień do zakładki POLSKA?`)) {
        return;
    }

    let completed = 0;
    let errors = 0;
    const movedCount = orderIds.length;
    const successfulMoves = [];

    orderIds.forEach(orderId => {
        fetch(`/admin/products/stock-orders/${orderId}/move`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ order_type: 'polska' })
        })
        .then(response => response.json())
        .then(data => {
            completed++;

            if (data.success) {
                successfulMoves.push(orderId);
                const row = document.getElementById(`order-row-${orderId}`);
                if (row) {
                    row.style.transition = 'opacity 0.3s, transform 0.3s';
                    row.style.opacity = '0';
                    row.style.transform = 'translateX(50px)';
                }
            } else {
                errors++;
            }

            // When all requests complete
            if (completed === orderIds.length) {
                // Hide bulk actions modal
                const modal = document.getElementById('bulkActionsModal');
                if (modal) modal.classList.remove('visible');

                // Update tab badges
                updateTabBadges('proxy', 'polska', movedCount - errors);

                updateSelectAllState();

                if (errors === 0) {
                    if (window.Toast) {
                        window.Toast.show(`Przeniesiono ${movedCount} zamówień do zakładki POLSKA`, 'success');
                    }
                } else {
                    if (window.Toast) {
                        window.Toast.show(`Przeniesiono ${completed - errors} zamówień, ${errors} błędów`, 'warning');
                    }
                }

                // Wait for animation to complete, then remove rows and check if empty
                setTimeout(() => {
                    successfulMoves.forEach(id => {
                        const row = document.getElementById(`order-row-${id}`);
                        if (row) row.remove();
                    });

                    // Check if table is empty after removing rows
                    const tbody = document.querySelector('.data-table tbody');
                    if (tbody && tbody.children.length === 0) {
                        showEmptyState();
                    }
                }, 350);
            }
        })
        .catch(error => {
            console.error('Bulk move error:', error);
            errors++;
            completed++;
        });
    });
}

/**
 * Bulk move orders to PROXY tab
 */
function bulkMoveToProxy() {
    const orderIds = getSelectedOrderIds();
    if (orderIds.length === 0) return;

    if (!confirm(`Czy na pewno chcesz przenieść ${orderIds.length} zamówień do zakładki PROXY?`)) {
        return;
    }

    let completed = 0;
    let errors = 0;
    const movedCount = orderIds.length;
    const successfulMoves = [];

    orderIds.forEach(orderId => {
        fetch(`/admin/products/stock-orders/${orderId}/move`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ order_type: 'proxy' })
        })
        .then(response => response.json())
        .then(data => {
            completed++;

            if (data.success) {
                successfulMoves.push(orderId);
                const row = document.getElementById(`order-row-${orderId}`);
                if (row) {
                    row.style.transition = 'opacity 0.3s, transform 0.3s';
                    row.style.opacity = '0';
                    row.style.transform = 'translateX(-50px)';
                }
            } else {
                errors++;
            }

            // When all requests complete
            if (completed === orderIds.length) {
                // Hide bulk actions modal
                const modal = document.getElementById('bulkActionsModal');
                if (modal) modal.classList.remove('visible');

                // Update tab badges
                updateTabBadges('polska', 'proxy', movedCount - errors);

                updateSelectAllState();

                if (errors === 0) {
                    if (window.Toast) {
                        window.Toast.show(`Przeniesiono ${movedCount} zamówień do zakładki PROXY`, 'success');
                    }
                } else {
                    if (window.Toast) {
                        window.Toast.show(`Przeniesiono ${completed - errors} zamówień, ${errors} błędów`, 'warning');
                    }
                }

                // Wait for animation to complete, then remove rows and check if empty
                setTimeout(() => {
                    successfulMoves.forEach(id => {
                        const row = document.getElementById(`order-row-${id}`);
                        if (row) row.remove();
                    });

                    // Check if table is empty after removing rows
                    const tbody = document.querySelector('.data-table tbody');
                    if (tbody && tbody.children.length === 0) {
                        showEmptyState();
                    }
                }, 350);
            }
        })
        .catch(error => {
            console.error('Bulk move error:', error);
            errors++;
            completed++;
        });
    });
}

/**
 * Update tab badges after moving orders
 */
function updateTabBadges(fromTab, toTab, count) {
    const proxyBadge = document.getElementById('proxyCountBadge');
    const polskaBadge = document.getElementById('polskaCountBadge');

    if (fromTab === 'proxy' && proxyBadge) {
        let currentCount = parseInt(proxyBadge.textContent) || 0;
        let newCount = Math.max(0, currentCount - count);
        proxyBadge.textContent = newCount;
        proxyBadge.style.display = newCount > 0 ? '' : 'none';
    }

    if (fromTab === 'polska' && polskaBadge) {
        let currentCount = parseInt(polskaBadge.textContent) || 0;
        let newCount = Math.max(0, currentCount - count);
        polskaBadge.textContent = newCount;
        polskaBadge.style.display = newCount > 0 ? '' : 'none';
    }

    if (toTab === 'proxy' && proxyBadge) {
        let currentCount = parseInt(proxyBadge.textContent) || 0;
        let newCount = currentCount + count;
        proxyBadge.textContent = newCount;
        proxyBadge.style.display = newCount > 0 ? '' : 'none';
    }

    if (toTab === 'polska' && polskaBadge) {
        let currentCount = parseInt(polskaBadge.textContent) || 0;
        let newCount = currentCount + count;
        polskaBadge.textContent = newCount;
        polskaBadge.style.display = newCount > 0 ? '' : 'none';
    }
}

// Close bulk status dropdown when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('.bulk-action-status') && !event.target.closest('.bulk-status-dropdown')) {
        hideBulkStatusDropdown();
    }
});

// ============================================
// Existing Functions
// ============================================

/**
 * Toggle status dropdown
 * Note: In dark mode, .tab-pane has backdrop-filter which creates a new containing block.
 * We move dropdown to body to ensure position:fixed works relative to viewport.
 */
function toggleStatusDropdown(orderId) {
    const dropdown = document.getElementById(`status-dropdown-${orderId}`);
    const button = document.querySelector(`[onclick="toggleStatusDropdown(${orderId})"]`);
    const allDropdowns = document.querySelectorAll('.status-dropdown');

    // Close all other dropdowns
    allDropdowns.forEach(d => {
        if (d.id !== `status-dropdown-${orderId}`) {
            d.style.display = 'none';
        }
    });

    // Toggle current dropdown
    if (dropdown.style.display === 'none' || !dropdown.style.display) {
        // Move dropdown to body to escape backdrop-filter containing block
        if (dropdown.parentElement !== document.body) {
            document.body.appendChild(dropdown);
        }

        // Position dropdown relative to button
        const rect = button.getBoundingClientRect();
        const dropdownHeight = 280; // Approximate height of dropdown
        const viewportHeight = window.innerHeight;
        const viewportWidth = window.innerWidth;

        // Check if dropdown fits below button, otherwise show above
        let top;
        if (rect.bottom + dropdownHeight > viewportHeight) {
            // Not enough space below - show above
            top = rect.top - dropdownHeight - 4;
        } else {
            // Show below
            top = rect.bottom + 4;
        }

        // Check if dropdown fits horizontally, adjust if needed
        let left = rect.left;
        const dropdownWidth = 180; // min-width from CSS
        if (left + dropdownWidth > viewportWidth) {
            left = viewportWidth - dropdownWidth - 16;
        }

        dropdown.style.top = `${top}px`;
        dropdown.style.left = `${left}px`;
        dropdown.style.display = 'block';
    } else {
        dropdown.style.display = 'none';
    }
}

/**
 * Close dropdowns when clicking outside
 */
document.addEventListener('click', function(event) {
    if (!event.target.closest('.status-dropdown-wrapper')) {
        document.querySelectorAll('.status-dropdown').forEach(d => {
            d.style.display = 'none';
        });
    }
});

/**
 * Re-position dropdowns on scroll (for fixed position)
 */
const tableResponsive = document.querySelector('.table-responsive');
if (tableResponsive) {
    tableResponsive.addEventListener('scroll', function() {
        // Close all dropdowns on scroll
        document.querySelectorAll('.status-dropdown').forEach(d => {
            d.style.display = 'none';
        });
    });
}

/**
 * Change order status
 */
function changeOrderStatus(orderId, newStatus) {
    fetch(`/admin/products/proxy-orders/${orderId}/status`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ status: newStatus })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close dropdown first
            const dropdown = document.getElementById(`status-dropdown-${orderId}`);
            if (dropdown) {
                dropdown.style.display = 'none';
            }

            const statusLabels = {
                'zamowiono': 'Zamówiono',
                'dostarczone_do_proxy': 'Dostarczone do Proxy',
                'anulowane': 'Anulowane'
            };

            // Update the badge and status changed cell
            const row = document.getElementById(`order-row-${orderId}`);
            if (row) {
                const statusButton = row.querySelector('.status-badge-button');
                if (statusButton) {
                    const label = statusLabels[newStatus] || newStatus;
                    statusButton.className = `status-badge-button badge-${newStatus}`;
                    statusButton.innerHTML = `${label} <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor"><path d="M6 8L2 4h8L6 8z"/></svg>`;
                }

                row.dataset.status = newStatus;

                // Update "Ostatnia zmiana" column
                const now = new Date();
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const year = now.getFullYear();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const formattedDate = `${day}.${month}.${year} ${hours}:${minutes}`;

                // Columns: checkbox(0), order_number(1), products(2), status(3), ostatnia_zmiana(4), date(5), amount(6), actions(7)
                const cells = row.querySelectorAll('td');
                const statusChangedCell = cells[4]; // 5th column (0-indexed)
                if (statusChangedCell) {
                    statusChangedCell.textContent = formattedDate;
                    statusChangedCell.className = 'text-muted';

                    statusChangedCell.style.transition = 'background-color 0.3s';
                    statusChangedCell.style.backgroundColor = 'rgba(90, 24, 154, 0.15)';
                    setTimeout(() => {
                        statusChangedCell.style.backgroundColor = '';
                    }, 1000);
                }

                row.dataset.statusChanged = Math.floor(now.getTime() / 1000);
            }

            if (window.Toast) {
                window.Toast.show('Status zamowienia zostal zmieniony', 'success');
            }
        } else {
            if (window.Toast) {
                window.Toast.show('Blad: ' + data.error, 'error');
            }
        }
    })
    .catch(error => {
        console.error('Status change error:', error);
        if (window.Toast) {
            window.Toast.show('Wystapil blad podczas zmiany statusu', 'error');
        }
    });
}


/**
 * Delete order
 */
function deleteOrder(orderId) {
    if (confirm('Czy na pewno chcesz usunąć to zamówienie?\n\nTa operacja jest nieodwracalna.')) {
        fetch(`/admin/products/stock-orders/${orderId}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (window.Toast) {
                    window.Toast.show('Zamówienie zostało usunięte', 'success');
                }
                // Przeładuj tę samą zakładkę — countery i listy się odświeżą
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            } else {
                if (window.Toast) {
                    window.Toast.show('Błąd: ' + data.error, 'error');
                }
            }
        })
        .catch(error => {
            console.error('Delete error:', error);
            if (window.Toast) {
                window.Toast.show('Wystąpił błąd podczas usuwania zamówienia', 'error');
            }
        });
    }
}

/**
 * Toggle hidden products in Poland tab
 */
function togglePolandProducts(toggleEl) {
    const container = toggleEl.closest('.poland-products-cell') || toggleEl.closest('.products-cell');
    const hiddenItems = container.querySelectorAll('.poland-product-hidden');
    const isExpanded = toggleEl.dataset.expanded === 'true';

    hiddenItems.forEach(item => {
        item.style.display = isExpanded ? 'none' : '';
    });

    if (isExpanded) {
        toggleEl.textContent = `Pokaż więcej (${hiddenItems.length})`;
        toggleEl.dataset.expanded = 'false';
    } else {
        toggleEl.textContent = 'Pokaż mniej';
        toggleEl.dataset.expanded = 'true';
    }
}

/**
 * Delete Poland order
 */
function deletePolandOrder(orderId) {
    if (confirm('Czy na pewno chcesz usunąć to zamówienie POLSKA?\n\nTa operacja jest nieodwracalna.')) {
        fetch(`/admin/products/poland-orders/${orderId}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (window.Toast) {
                    window.Toast.show('Zamówienie POLSKA zostało usunięte', 'success');
                }
                // Przeładuj tę samą zakładkę — countery i listy się odświeżą
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            } else {
                if (window.Toast) {
                    window.Toast.show('Błąd: ' + data.error, 'error');
                }
            }
        })
        .catch(error => {
            console.error('Delete error:', error);
            if (window.Toast) {
                window.Toast.show('Wystąpił błąd podczas usuwania zamówienia', 'error');
            }
        });
    }
}

// ============================================
// POLSKA Tab Functions
// ============================================

let selectedStatusesPoland = [];

function toggleStatusMultiSelectPoland() {
    const dropdown = document.getElementById('statusMultiSelectPoland');
    if (dropdown.style.display === 'none') {
        dropdown.style.display = 'block';
    } else {
        dropdown.style.display = 'none';
    }
}

function updateStatusFilterPoland() {
    const checkboxes = document.querySelectorAll('#statusMultiSelectPoland input[type="checkbox"]:checked');
    selectedStatusesPoland = Array.from(checkboxes).map(cb => cb.value);

    const statusText = document.getElementById('statusSelectTextPoland');
    if (selectedStatusesPoland.length === 0) {
        statusText.textContent = 'Wszystkie statusy';
    } else if (selectedStatusesPoland.length === 1) {
        statusText.textContent = '1 status';
    } else {
        statusText.textContent = `${selectedStatusesPoland.length} statusy`;
    }

    applyFiltersPoland();
}

function applyFiltersPoland() {
    const orderNumberFilter = document.getElementById('filterOrderNumberPoland').value.toLowerCase().trim();
    const trackingFilter = document.getElementById('filterTrackingPoland').value.toLowerCase().trim();
    const dateFrom = document.getElementById('filterDateFromPoland').value;
    const dateTo = document.getElementById('filterDateToPoland').value;

    const table = document.getElementById('polandOrdersTable');
    if (!table) return;
    const rows = table.querySelectorAll('tbody tr');

    rows.forEach(row => {
        let showRow = true;

        // Order number filter
        if (orderNumberFilter) {
            const rowOrderNumber = (row.dataset.orderNumber || '').toLowerCase();
            if (!rowOrderNumber.includes(orderNumberFilter)) {
                showRow = false;
            }
        }

        // Tracking number (Kfriday RS) filter
        if (trackingFilter) {
            const rowTracking = (row.dataset.tracking || '').toLowerCase();
            if (!rowTracking.includes(trackingFilter)) {
                showRow = false;
            }
        }

        // Date filter (using timestamp)
        if (dateFrom || dateTo) {
            const rowTimestamp = parseFloat(row.dataset.date) || 0;
            const rowDateStr = new Date(rowTimestamp * 1000).toISOString().split('T')[0];
            if (dateFrom && rowDateStr < dateFrom) showRow = false;
            if (dateTo && rowDateStr > dateTo) showRow = false;
        }

        // Status filter
        if (selectedStatusesPoland.length > 0) {
            if (!selectedStatusesPoland.includes(row.dataset.status)) {
                showRow = false;
            }
        }

        row.style.display = showRow ? '' : 'none';
    });

    updateSelectAllStatePoland();
}

function clearAllFiltersPoland() {
    document.getElementById('filterOrderNumberPoland').value = '';
    document.getElementById('filterTrackingPoland').value = '';
    document.getElementById('filterDateFromPoland').value = '';
    document.getElementById('filterDateToPoland').value = '';

    document.querySelectorAll('#statusMultiSelectPoland input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    selectedStatusesPoland = [];
    document.getElementById('statusSelectTextPoland').textContent = 'Wszystkie statusy';

    const table = document.getElementById('polandOrdersTable');
    if (table) {
        table.querySelectorAll('tbody tr').forEach(row => {
            row.style.display = '';
        });
    }

    updateSelectAllStatePoland();
}

function toggleSelectAllPoland(selectAllCheckbox) {
    const table = document.getElementById('polandOrdersTable');
    if (!table) return;
    const visibleRows = table.querySelectorAll('tbody tr:not([style*="display: none"])');

    visibleRows.forEach(row => {
        const checkbox = row.querySelector('.poland-checkbox');
        if (checkbox) {
            checkbox.checked = selectAllCheckbox.checked;
            if (selectAllCheckbox.checked) {
                row.classList.add('selected');
            } else {
                row.classList.remove('selected');
            }
        }
    });

    updateBulkActionsModal();
}

function handleCheckboxChangePoland() {
    const checkbox = event.target;
    const row = checkbox.closest('tr');

    if (checkbox.checked) {
        row.classList.add('selected');
    } else {
        row.classList.remove('selected');
    }

    updateSelectAllStatePoland();
    updateBulkActionsModal();
}

function updateSelectAllStatePoland() {
    const selectAllCheckbox = document.getElementById('selectAllPolandOrders');
    if (!selectAllCheckbox) return;

    const table = document.getElementById('polandOrdersTable');
    if (!table) return;
    const visibleRows = table.querySelectorAll('tbody tr:not([style*="display: none"])');
    const checkboxes = Array.from(visibleRows).map(row => row.querySelector('.poland-checkbox')).filter(cb => cb);

    const allChecked = checkboxes.length > 0 && checkboxes.every(cb => cb.checked);
    const someChecked = checkboxes.some(cb => cb.checked);

    selectAllCheckbox.checked = allChecked;
    selectAllCheckbox.indeterminate = someChecked && !allChecked;
}

function togglePolandStatusDropdown(orderId) {
    const allDropdowns = document.querySelectorAll('[id^="poland-status-dropdown-"]');
    allDropdowns.forEach(d => {
        if (d.id !== `poland-status-dropdown-${orderId}`) {
            d.style.display = 'none';
        }
    });

    const dropdown = document.getElementById(`poland-status-dropdown-${orderId}`);
    if (!dropdown) return;

    if (dropdown.style.display === 'none') {
        const button = dropdown.previousElementSibling || dropdown.closest('.status-dropdown-wrapper').querySelector('.status-badge-button');
        const rect = button.getBoundingClientRect();
        dropdown.style.position = 'fixed';
        dropdown.style.top = (rect.bottom + 4) + 'px';
        dropdown.style.left = rect.left + 'px';
        dropdown.style.display = 'block';
        document.body.appendChild(dropdown);
    } else {
        dropdown.style.display = 'none';
    }
}

function changePolandOrderStatus(orderId, newStatus) {
    const dropdown = document.getElementById(`poland-status-dropdown-${orderId}`);
    if (dropdown) dropdown.style.display = 'none';

    fetch(`/admin/products/poland-orders/${orderId}/status`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: newStatus })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const row = document.getElementById(`poland-order-row-${orderId}`);
            if (row) {
                const button = row.querySelector('.status-badge-button');
                if (button) {
                    const statusLabels = {
                        'zamowione': 'Zamówione',
                        'urzad_celny': 'Urząd celny',
                        'dostarczone_gom': 'Dostarczone GOM',
                        'anulowane': 'Anulowane'
                    };
                    button.className = `status-badge-button badge-${newStatus}`;
                    button.childNodes[0].textContent = (statusLabels[newStatus] || newStatus) + ' ';
                }
                row.dataset.status = newStatus;

                // Update date in merged "Data" column
                const now = new Date();
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const year = now.getFullYear();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const formattedDate = `${day}.${month}.${year} ${hours}:${minutes}`;

                const dateSecondary = row.querySelector('.poland-date-secondary');
                if (dateSecondary) {
                    dateSecondary.textContent = formattedDate;
                    dateSecondary.style.transition = 'background-color 0.3s';
                    dateSecondary.style.backgroundColor = 'rgba(249, 115, 22, 0.15)';
                    setTimeout(() => {
                        dateSecondary.style.backgroundColor = '';
                    }, 1000);
                }
                row.dataset.statusChanged = Math.floor(now.getTime() / 1000);
            }

            if (window.Toast) {
                window.Toast.show(data.message || 'Status zmieniony', 'success');
            }
        } else {
            if (window.Toast) {
                window.Toast.show('Błąd: ' + data.error, 'error');
            }
        }
    })
    .catch(error => {
        console.error('Poland status change error:', error);
        if (window.Toast) {
            window.Toast.show('Wystąpił błąd podczas zmiany statusu', 'error');
        }
    });
}

function bulkDeletePolandOrders() {
    const orderIds = getSelectedOrderIds();
    if (orderIds.length === 0) return;

    if (!confirm(`Czy na pewno chcesz usunąć ${orderIds.length} zamówień POLSKA?\n\nTa operacja jest nieodwracalna.`)) {
        return;
    }

    let completed = 0;
    let errors = 0;

    orderIds.forEach(orderId => {
        fetch(`/admin/products/poland-orders/${orderId}/delete`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            completed++;
            if (!data.success) errors++;

            if (completed === orderIds.length) {
                if (errors === 0) {
                    if (window.Toast) {
                        window.Toast.show(`Usunięto ${orderIds.length} zamówień`, 'success');
                    }
                } else {
                    if (window.Toast) {
                        window.Toast.show(`Usunięto ${completed - errors} zamówień, ${errors} błędów`, 'warning');
                    }
                }
                setTimeout(() => { window.location.reload(); }, 500);
            }
        })
        .catch(error => {
            console.error('Bulk delete Poland error:', error);
            errors++;
            completed++;
            if (completed === orderIds.length) {
                setTimeout(() => { window.location.reload(); }, 500);
            }
        });
    });
}

// Close Poland multi-select when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('.multi-select-wrapper')) {
        const dropdown = document.getElementById('statusMultiSelectPoland');
        if (dropdown) dropdown.style.display = 'none';
    }
    // Close Poland status dropdowns when clicking outside
    if (!event.target.closest('.status-dropdown-wrapper') && !event.target.closest('.status-dropdown')) {
        document.querySelectorAll('[id^="poland-status-dropdown-"]').forEach(d => {
            d.style.display = 'none';
        });
    }
});

/**
 * Show empty state when table becomes empty
 */
function showEmptyState() {
    // Hide the filters section
    const filtersSection = document.querySelector('.orders-filters');
    if (filtersSection) {
        filtersSection.style.display = 'none';
    }

    const tableResponsive = document.querySelector('.table-responsive');
    if (tableResponsive) {
        tableResponsive.remove();
    }

    const ordersList = document.querySelector('.orders-list');
    if (ordersList) {
        const activeTab = '{{ active_tab }}';
        let emptyStateHTML = `
            <div class="empty-state">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                    <line x1="1" y1="10" x2="23" y2="10"></line>
                </svg>
                <h3>Brak zamówień</h3>
        `;

        if (activeTab === 'proxy') {
            emptyStateHTML += `
                <p>Nie znaleziono żadnych zamówień dla kategorii PROXY</p>
            `;
        } else {
            emptyStateHTML += `
                <p>Zamówienia pojawią się tutaj po zmianie statusu na "Dostarczone GOM" w zakładce PROXY</p>
                <a href="{{ url_for('products.stock_orders', tab='proxy') }}" class="btn btn-primary">
                    Przejdź do PROXY
                </a>
            `;
        }

        emptyStateHTML += '</div>';
        ordersList.innerHTML = emptyStateHTML;
    }
}

// ============================================
// DO ZAMÓWIENIA Tab Functions
// ============================================

/**
 * Filter rows in DO ZAMÓWIENIA tab
 */
function applyToOrderFilters() {
    const productFilter = document.getElementById('filterToOrderProduct').value.toLowerCase().trim();
    const paymentFilter = document.getElementById('filterToOrderPayment').value;
    const rows = document.querySelectorAll('#toOrderTable tbody .to-order-row');

    rows.forEach(row => {
        const productName = (row.dataset.productName || '').toLowerCase();
        const paymentType = row.dataset.paymentType || '';

        const matchProduct = !productFilter || productName.includes(productFilter);
        const matchPayment = !paymentFilter || paymentType === paymentFilter;

        row.style.display = (matchProduct && matchPayment) ? '' : 'none';
    });

    // Update select all checkbox state after filter change
    handleToOrderCheckboxChange();
}

/**
 * Toggle select all products in DO ZAMÓWIENIA tab
 */
function toggleSelectAllToOrder(checkbox) {
    const checkboxes = document.querySelectorAll('.to-order-checkbox');
    checkboxes.forEach(cb => {
        const row = cb.closest('tr');
        const isVisible = row.style.display !== 'none';
        if (isVisible) {
            cb.checked = checkbox.checked;
            if (checkbox.checked) {
                row.classList.add('selected');
            } else {
                row.classList.remove('selected');
            }
        }
    });
    handleToOrderCheckboxChange();
}

/**
 * Handle checkbox change in DO ZAMÓWIENIA tab
 */
function handleToOrderCheckboxChange() {
    const allCheckboxes = document.querySelectorAll('.to-order-checkbox');
    const visibleCheckboxes = [...allCheckboxes].filter(cb => cb.closest('tr').style.display !== 'none');
    const visibleChecked = visibleCheckboxes.filter(cb => cb.checked);

    const bulkToolbar = document.getElementById('toOrderBulkToolbar');
    const selectedCount = document.getElementById('toOrderSelectedCount');

    // Count all checked (visible + hidden) for toolbar
    const totalChecked = document.querySelectorAll('.to-order-checkbox:checked').length;
    if (totalChecked > 0) {
        bulkToolbar.classList.remove('hidden');
        selectedCount.textContent = totalChecked;
    } else {
        bulkToolbar.classList.add('hidden');
    }

    // Update select all checkbox state based on visible rows only
    const selectAllCheckbox = document.getElementById('selectAllToOrder');
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = visibleCheckboxes.length > 0 && visibleChecked.length === visibleCheckboxes.length;
        selectAllCheckbox.indeterminate = visibleChecked.length > 0 && visibleChecked.length < visibleCheckboxes.length;
    }
}

/**
 * Clear selection in DO ZAMÓWIENIA tab
 */
function clearToOrderSelection() {
    const checkboxes = document.querySelectorAll('.to-order-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = false;
        cb.closest('tr').classList.remove('selected');
    });
    const selectAllCheckbox = document.getElementById('selectAllToOrder');
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    }
    document.getElementById('toOrderBulkToolbar').classList.add('hidden');
}

/**
 * Suppliers data for the modal dropdown
 */
const suppliersData = [
    {% for supplier in suppliers %}
    { id: {{ supplier.id }}, name: "{{ supplier.name }}" }{% if not loop.last %},{% endif %}
    {% endfor %}
];

// Zamknij modal grupowy po kliknięciu na overlay
(function() {
    const groupModal = document.getElementById('groupOrderModal');
    if (groupModal) {
        groupModal.addEventListener('click', function(e) {
            if (e.target === groupModal) {
                closeGroupOrderModal();
            }
        });
    }
})();

// Podświetlanie zaznaczonych wierszy w tabeli DO ZAMÓWIENIA
document.querySelectorAll('.to-order-checkbox').forEach(box => {
    box.addEventListener('change', function() {
        const row = this.closest('tr');
        if (this.checked) {
            row.classList.add('selected');
        } else {
            row.classList.remove('selected');
        }
    });
});

/**
 * Otwórz modal zamówienia grupowego z walidacją typów płatności
 */
function openOrderProductsModal() {
    const checkboxes = document.querySelectorAll('.to-order-checkbox:checked');
    if (checkboxes.length === 0) {
        if (window.Toast) {
            window.Toast.show('Zaznacz produkty do zamówienia', 'warning');
        }
        return;
    }

    // Sprawdź typy płatności (Proxy vs Polska)
    const paymentTypes = new Set();
    checkboxes.forEach(box => {
        paymentTypes.add(box.dataset.paymentType);
    });

    // WALIDACJA: NIE można mieszać Proxy + Polska
    if (paymentTypes.size > 1) {
        if (window.Toast) {
            window.Toast.show('Nie można złożyć zamówienia grupowego łączącego produkty Proxy i Polska. Zaznacz produkty tylko jednego typu.', 'error');
        } else {
            alert('Nie można złożyć zamówienia grupowego łączącego produkty Proxy i Polska. Zaznacz produkty tylko jednego typu.');
        }
        return;
    }

    const orderType = Array.from(paymentTypes)[0]; // 'proxy' lub 'polska'
    const orderTypeLabel = orderType === 'proxy' ? 'Proxy' : 'Polska';

    // Uzupełnij dane w modalu
    document.getElementById('groupOrderCount').textContent = checkboxes.length;
    document.getElementById('groupOrderType').textContent = orderTypeLabel;

    // Wypełnij tabelę produktów
    const tbody = document.getElementById('groupOrderTableBody');
    tbody.innerHTML = '';
    let total = 0;

    checkboxes.forEach(checkbox => {
        const row = checkbox.closest('tr');
        const productName = row.dataset.productName;
        const toOrder = parseInt(row.dataset.toOrder);
        const purchasePrice = parseFloat(row.dataset.purchasePrice) || 0;
        const rowTotal = toOrder * purchasePrice;
        total += rowTotal;

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${escapeHtml(productName)}</td>
            <td class="text-center">${toOrder}</td>
            <td class="text-right">${purchasePrice.toFixed(2)} PLN</td>
            <td class="text-right font-semibold">${rowTotal.toFixed(2)} PLN</td>
        `;
        tbody.appendChild(tr);
    });

    document.getElementById('groupOrderTotal').textContent = total.toFixed(2) + ' PLN';

    // Pokaż modal
    document.getElementById('groupOrderModal').classList.add('active');
    document.body.style.overflow = 'hidden';
}

/**
 * Zamknij modal zamówienia grupowego
 */
function closeGroupOrderModal() {
    const modal = document.getElementById('groupOrderModal');
    if (modal) {
        modal.classList.add('closing');
        setTimeout(() => {
            modal.classList.remove('active');
            modal.classList.remove('closing');
            document.body.style.overflow = '';
            document.getElementById('groupOrderNote').value = '';
        }, 350);
    }
}

/**
 * Potwierdź i utwórz zamówienie grupowe
 */
function confirmGroupOrder() {
    const checkboxes = document.querySelectorAll('.to-order-checkbox:checked');
    if (checkboxes.length === 0) return;

    const note = document.getElementById('groupOrderNote').value.trim();
    const orderType = checkboxes[0].dataset.paymentType;

    // Zbierz dane produktów
    const products = [];
    checkboxes.forEach(checkbox => {
        const row = checkbox.closest('tr');
        products.push({
            product_id: parseInt(checkbox.value),
            supplier_id: row.dataset.supplierId ? parseInt(row.dataset.supplierId) : null,
            quantity: parseInt(row.dataset.toOrder),
            unit_price: parseFloat(row.dataset.purchasePrice) || 0
        });
    });

    // Wyłącz przycisk
    const btn = document.getElementById('btnConfirmGroupOrder');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-small"></span> Tworzenie...';

    // AJAX: Utwórz zamówienie grupowe
    fetch('/admin/products/api/create-group-proxy-order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            products: products,
            order_type: orderType,
            note: note
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeGroupOrderModal();
            if (window.Toast) {
                window.Toast.show(`Zamówienie grupowe utworzone! Numer: ${data.order_number}`, 'success');
            }
            // Przekieruj do odpowiedniej zakładki
            setTimeout(() => {
                window.location.href = `/admin/products/stock-orders?tab=${orderType}`;
            }, 1000);
        } else {
            if (window.Toast) {
                window.Toast.show('Błąd: ' + (data.error || 'Nieznany błąd'), 'error');
            }
            btn.disabled = false;
            btn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"></path>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <path d="M16 10a4 4 0 01-8 0"></path>
                </svg>
                Potwierdź zamówienie
            `;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (window.Toast) {
            window.Toast.show('Wystąpił błąd podczas tworzenia zamówienia', 'error');
        }
        btn.disabled = false;
        btn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"></path>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <path d="M16 10a4 4 0 01-8 0"></path>
            </svg>
            Potwierdź zamówienie
        `;
    });
}
</script>
{% endblock %}
