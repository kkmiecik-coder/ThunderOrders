{% extends "admin/base_admin.html" %}

{% block title %}Podsumowanie: {{ page.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin/exclusive-summary.css') }}">
{% endblock %}

{% block content %}
<div class="summary-page">
    <!-- Top Bar -->
    <div class="summary-topbar">
        <div class="topbar-left">
            <a href="{{ url_for('admin.exclusive_list') }}" class="btn-back">
                <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor">
                    <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                </svg>
                Powr√≥t do listy
            </a>
        </div>
        <div class="topbar-center">
            <h1>{{ page.name }}</h1>
            <span class="status-badge status-closed">Zamkniƒôta</span>
        </div>
        <div class="topbar-right">
            {% if current_user.role == 'admin' %}
            <a href="{{ url_for('admin.exclusive_export_excel', page_id=page.id) }}" class="btn btn-primary">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                </svg>
                Pobierz Excel
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Meta Info -->
    <div class="meta-info">
        <div class="meta-item">
            <span class="meta-label">Zamkniƒôto:</span>
            <span class="meta-value">{{ summary.closed_at|format_datetime('%d.%m.%Y %H:%M') if summary.closed_at else '-' }}</span>
        </div>
        <div class="meta-item">
            <span class="meta-label">Przez:</span>
            <span class="meta-value">{{ summary.closed_by or '-' }}</span>
        </div>
        <div class="meta-item">
            <span class="meta-label">Okres sprzeda≈ºy:</span>
            <span class="meta-value">
                {{ summary.starts_at|format_date('%d.%m.%Y') if summary.starts_at else '?' }}
                ‚Äî
                {{ summary.ends_at|format_date('%d.%m.%Y') if summary.ends_at else '?' }}
            </span>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-cards">
        <div class="stat-card">
            <div class="stat-icon stat-icon-orders">
                <svg width="24" height="24" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M0 2.5A.5.5 0 0 1 .5 2H2a.5.5 0 0 1 .485.379L2.89 4H14.5a.5.5 0 0 1 .485.621l-1.5 6A.5.5 0 0 1 13 11H4a.5.5 0 0 1-.485-.379L1.61 3H.5a.5.5 0 0 1-.5-.5zM3.14 5l1.25 5h8.22l1.25-5H3.14zM5 13a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0zm9-1a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0z"/>
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-value">{{ summary.total_orders }}</span>
                <span class="stat-label">Zam√≥wie≈Ñ</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon stat-icon-customers">
                <svg width="24" height="24" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M15 14s1 0 1-1-1-4-5-4-5 3-5 4 1 1 1 1h8zm-7.978-1A.261.261 0 0 1 7 12.996c.001-.264.167-1.03.76-1.72C8.312 10.629 9.282 10 11 10c1.717 0 2.687.63 3.24 1.276.593.69.758 1.457.76 1.72l-.008.002a.274.274 0 0 1-.014.002H7.022zM11 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm3-2a3 3 0 1 1-6 0 3 3 0 0 1 6 0zM6.936 9.28a5.88 5.88 0 0 0-1.23-.247A7.35 7.35 0 0 0 5 9c-4 0-5 3-5 4 0 .667.333 1 1 1h4.216A2.238 2.238 0 0 1 5 13c0-1.01.377-2.042 1.09-2.904.243-.294.526-.569.846-.816zM4.92 10A5.493 5.493 0 0 0 4 13H1c0-.26.164-1.03.76-1.724.545-.636 1.492-1.256 3.16-1.275zM1.5 5.5a3 3 0 1 1 6 0 3 3 0 0 1-6 0zm3-2a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"/>
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-value">{{ summary.unique_customers }}</span>
                <span class="stat-label">Klient√≥w</span>
            </div>
        </div>

        {% if include_financials %}
        <div class="stat-card stat-card-highlight">
            <div class="stat-icon stat-icon-revenue">
                <svg width="24" height="24" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M4 10.781c.148 1.667 1.513 2.85 3.591 3.003V15h1.043v-1.216c2.27-.179 3.678-1.438 3.678-3.3 0-1.59-.947-2.51-2.956-3.028l-.722-.187V3.467c1.122.11 1.879.714 2.07 1.616h1.47c-.166-1.6-1.54-2.748-3.54-2.875V1H7.591v1.233c-1.939.23-3.27 1.472-3.27 3.156 0 1.454.966 2.483 2.661 2.917l.61.162v4.031c-1.149-.17-1.94-.8-2.131-1.718H4zm3.391-3.836c-1.043-.263-1.6-.825-1.6-1.616 0-.944.704-1.641 1.8-1.828v3.495l-.2-.05zm1.591 1.872c1.287.323 1.852.859 1.852 1.769 0 1.097-.826 1.828-2.2 1.939V8.73l.348.086z"/>
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-value">{{ "%.2f"|format(summary.total_revenue) }} PLN</span>
                <span class="stat-label">Przych√≥d</span>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Sets Breakdown -->
    {% if summary.sets %}
    <div class="section">
        <h2 class="section-title">
            <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8.186 1.113a.5.5 0 0 0-.372 0L1.846 3.5 8 5.961 14.154 3.5 8.186 1.113zM15 4.239l-6.5 2.6v7.922l6.5-2.6V4.24zM7.5 14.762V6.838L1 4.239v7.923l6.5 2.6zM7.443.184a1.5 1.5 0 0 1 1.114 0l7.129 2.852A.5.5 0 0 1 16 3.5v8.662a1 1 0 0 1-.629.928l-7.185 2.874a.5.5 0 0 1-.372 0L.63 13.09a1 1 0 0 1-.63-.928V3.5a.5.5 0 0 1 .314-.464L7.443.184z"/>
            </svg>
            Podsumowanie set√≥w
        </h2>

        <div class="sets-grid">
            {% for set in summary.sets %}
            <div class="set-card">
                <div class="set-header">
                    {% if set.set_image %}
                    <img src="{{ url_for('static', filename=set.set_image) }}" alt="{{ set.set_name }}" class="set-image">
                    {% endif %}
                    <div class="set-info">
                        <h3 class="set-name">{{ set.set_name }}</h3>
                        <span class="set-count">{{ set.complete_sets }} kompletnych set√≥w</span>
                    </div>
                </div>
                <div class="set-products">
                    <table class="mini-table">
                        <thead>
                            <tr>
                                <th>Produkt</th>
                                <th class="text-center">Szt./set</th>
                                <th class="text-center">Zam√≥wiono</th>
                                <th class="text-center">Zrealizowano</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in set.products %}
                            <tr>
                                <td>{{ product.product_name[:40] }}{% if product.product_name|length > 40 %}...{% endif %}</td>
                                <td class="text-center">{{ product.quantity_per_set }}</td>
                                <td class="text-center">{{ product.total_ordered }}</td>
                                <td class="text-center">
                                    <span class="fulfilled-count">{{ product.fulfilled }}</span>
                                    {% if product.unfulfilled > 0 %}
                                    <span class="unfulfilled-count">({{ product.unfulfilled }} poza)</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Orders List -->
    <div class="section">
        <h2 class="section-title">
            <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor">
                <path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zm-3 0A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5h-2z"/>
                <path d="M4.5 12.5A.5.5 0 0 1 5 12h3a.5.5 0 0 1 0 1H5a.5.5 0 0 1-.5-.5zm0-2A.5.5 0 0 1 5 10h6a.5.5 0 0 1 0 1H5a.5.5 0 0 1-.5-.5zm0-2A.5.5 0 0 1 5 8h6a.5.5 0 0 1 0 1H5a.5.5 0 0 1-.5-.5zm0-2A.5.5 0 0 1 5 6h6a.5.5 0 0 1 0 1H5a.5.5 0 0 1-.5-.5z"/>
            </svg>
            Lista zam√≥wie≈Ñ ({{ summary.orders|length }})
        </h2>

        <div class="orders-table-container">
            <table class="orders-table">
                <thead>
                    <tr>
                        <th>Nr zam√≥wienia</th>
                        <th>Klient</th>
                        <th>Data</th>
                        <th>Produkty</th>
                        {% if include_financials %}
                        <th class="text-right">Warto≈õƒá</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for order in summary.orders %}
                    <tr>
                        <td>
                            <a href="{{ url_for('orders.admin_detail', order_id=order.order_id) }}" class="order-link">
                                {{ order.order_number }}
                            </a>
                        </td>
                        <td>
                            <div class="customer-info">
                                <span class="customer-name">{{ order.customer_name or 'Go≈õƒá' }}</span>
                                <span class="customer-email">{{ order.customer_email or '-' }}</span>
                            </div>
                        </td>
                        <td>
                            <span class="order-date">{{ order.created_at|format_datetime('%d.%m.%Y %H:%M') }}</span>
                        </td>
                        <td>
                            <div class="order-items">
                                {% for item in order.order_items %}
                                <div class="order-item {% if item.is_full_set %}item-full-set{% elif item.is_custom %}item-custom{% elif item.is_set_fulfilled == false %}item-unfulfilled{% elif item.is_set_fulfilled == true %}item-fulfilled{% endif %}">
                                    {% if item.is_full_set %}
                                    <span class="item-icon item-icon-set" title="Pe≈Çny Set">‚ú®</span>
                                    {% elif item.is_custom %}
                                    <span class="item-icon item-icon-custom" title="Produkt rƒôczny">üì¶</span>
                                    {% endif %}
                                    <span class="item-name">{{ item.product_name[:30] }}{% if item.product_name|length > 30 %}...{% endif %}</span>
                                    <span class="item-qty">x{{ item.quantity }}</span>
                                    {% if item.is_full_set %}
                                    <span class="item-badge item-badge-set">SET</span>
                                    {% elif item.is_custom %}
                                    <span class="item-badge item-badge-custom">RƒòCZNY</span>
                                    {% elif item.is_set_fulfilled is not none %}
                                        {% if item.is_set_fulfilled %}
                                        <span class="item-status item-status-ok" title="Z≈Çapany">&#10003;</span>
                                        {% else %}
                                        <span class="item-status item-status-fail" title="Poza setem">&#10007;</span>
                                        {% endif %}
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </td>
                        {% if include_financials %}
                        <td class="text-right">
                            <span class="order-total">{{ "%.2f"|format(order.total_amount) }} PLN</span>
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
