{% extends "base.html" %}

{% block title %}{{ page.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/exclusive/order-page.css') }}">
{% endblock %}

{% block body_content %}
<div class="exclusive-order-page">
    <!-- Sticky Reservation Header -->
    <div id="reservationHeader" class="reservation-header hidden">
        <div class="reservation-content">
            <!-- Lewa strona - ikona + "Rezerwacja aktywna" -->
            <div class="reservation-left">
                <div class="reservation-icon">
                    <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
                        <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/>
                    </svg>
                </div>
                <span class="reservation-label">Rezerwacja aktywna</span>
            </div>
            <!-- ≈örodek - "Wygasa za" + du≈ºy timer -->
            <div class="reservation-center">
                <span class="reservation-sublabel">Wygasa za</span>
                <span class="reservation-timer" id="reservationTimer">Sprawdzam...</span>
            </div>
            <!-- Prawa strona - przycisk przed≈Çu≈ºenia -->
            <div class="reservation-right">
                <button id="extendBtn" class="btn-extend" onclick="extendReservation()">
                    Przed≈Çu≈º +2 min
                </button>
            </div>
        </div>
    </div>

    <!-- Animated Background -->
    <div class="order-animated-bg">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
        <div class="orb orb-4"></div>
    </div>

    {% if preview_mode %}
    <!-- Preview Mode Banner -->
    <div class="preview-mode-banner">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
            <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
        </svg>
        <span>Tryb podglƒÖdu - Status strony: <strong>{{ page.status|upper }}</strong></span>
        <a href="{{ url_for('admin.exclusive_edit', page_id=page.id) }}" class="preview-back-link">Wr√≥ƒá do edycji</a>
    </div>
    {% endif %}

    <!-- Header -->
    <header class="page-header">
        <div class="header-content">
            <!-- Logo na samej g√≥rze -->
            <div class="header-logo">
                <img src="{{ url_for('static', filename='img/icons/logo-full.svg') }}" alt="ThunderOrders" class="logo-image">
            </div>

            <!-- Lewa kolumna: Tytu≈Ç i Opis -->
            <div class="header-main">
                <div class="header-left">
                    <h1>{{ page.name }}</h1>
                    {% if page.description %}
                    <p class="page-description">{{ page.description }}</p>
                    {% endif %}
                </div>

                <!-- Prawa kolumna: Timer zako≈Ñczenia -->
                <div class="header-right">
                    {% if page.ends_at %}
                    <div class="deadline-banner">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
                            <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/>
                        </svg>
                        <span>Koniec zam√≥wie≈Ñ: <strong>{{ page.ends_at|format_datetime('%d.%m.%Y, %H:%M') }}</strong></span>
                    </div>
                    {% else %}
                    <div class="deadline-banner deadline-unknown">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                            <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/>
                        </svg>
                        <span>Data zako≈Ñczenia nieznana - <strong>≈õpiesz siƒô!</strong></span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="page-content">
        <main class="sections-list">
            {% for section in sections %}
                {% if section.is_heading %}
                <section class="section section-heading">
                    <h2>{{ section.content }}</h2>
                </section>

                {% elif section.is_paragraph %}
                <section class="section section-paragraph">
                    <p>{{ section.content }}</p>
                </section>

                {% elif section.is_product %}
                <section class="section section-product" data-section-id="{{ section.id }}" data-product-id="{{ section.product_id }}">
                    {% if section.product %}
                    <!-- Header z nazwƒÖ produktu -->
                    <div class="product-header">
                        <h3 class="product-name">{{ section.product.name }}</h3>
                        {% if section.has_min_quantity or section.has_max_quantity %}
                        <div class="product-limits">
                            {% if section.has_min_quantity %}
                            <span class="limit-badge limit-min">Min: {{ section.min_quantity }}</span>
                            {% endif %}
                            {% if section.has_max_quantity %}
                            <span class="limit-badge limit-max">Max: {{ section.max_quantity }}</span>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    <!-- Body: obrazek wycentrowany + kontrolki po prawej -->
                    <div class="product-body">
                        <div class="product-image-area">
                            {% if section.product.primary_image %}
                            <div class="zoomable-image-wrapper" onclick="openLightbox(this)">
                                <img src="{{ url_for('static', filename=section.product.primary_image.path_compressed) }}"
                                     alt="{{ section.product.name }}" class="product-image-centered"
                                     data-full-src="{{ url_for('static', filename=section.product.primary_image.path_original or section.product.primary_image.path_compressed) }}">
                                <div class="zoom-icon">
                                    <svg viewBox="0 0 16 16" fill="currentColor">
                                        <path fill-rule="evenodd" d="M6.5 12a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11zM13 6.5a6.5 6.5 0 1 1-13 0 6.5 6.5 0 0 1 13 0z"/>
                                        <path d="M10.344 11.742c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1 6.538 6.538 0 0 1-1.398 1.4z"/>
                                        <path fill-rule="evenodd" d="M6.5 3a.5.5 0 0 1 .5.5V6h2.5a.5.5 0 0 1 0 1H7v2.5a.5.5 0 0 1-1 0V7H3.5a.5.5 0 0 1 0-1H6V3.5a.5.5 0 0 1 .5-.5z"/>
                                    </svg>
                                </div>
                            </div>
                            {% else %}
                            <div class="no-image">
                                <svg width="64" height="64" viewBox="0 0 16 16" fill="currentColor">
                                    <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                                    <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/>
                                </svg>
                            </div>
                            {% endif %}
                        </div>
                        <div class="product-controls-box">
                            <p class="product-price">{{ "%.2f"|format(section.product.sale_price) }} PLN</p>
                            <div class="quantity-wrapper">
                                <div class="quantity-control">
                                    <button type="button" class="qty-btn qty-minus" onclick="decreaseQty(this)">-</button>
                                    <input type="number" class="qty-input" value="0" min="0"
                                           {% if section.has_max_quantity %}max="{{ section.max_quantity }}"{% endif %}
                                           onchange="updateQty(this)">
                                    <button type="button" class="qty-btn qty-plus" onclick="increaseQty(this)">+</button>
                                </div>
                                <span class="availability-info availability-loading" data-availability-for="{{ section.product_id }}">≈Åadowanie</span>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="product-unavailable">
                        <p>Produkt niedostƒôpny</p>
                    </div>
                    {% endif %}
                </section>

                {% elif section.is_set %}
                <section class="section section-set" data-section-id="{{ section.id }}" data-set-min="{{ section.set_min_sets or 0 }}" data-set-max="{{ section.set_max_sets or 0 }}">
                    <div class="set-card {% if section.set_image %}has-image{% endif %}">
                        <div class="set-content">
                            <div class="set-header">
                                <h3 class="set-name">{{ section.set_name }}</h3>
                                {% if section.set_min_sets > 1 or section.set_max_sets %}
                                <div class="set-limits">
                                    {% if section.set_min_sets > 1 %}
                                    <span class="limit-badge limit-min">Min set√≥w: {{ section.set_min_sets }}</span>
                                    {% endif %}
                                    {% if section.set_max_sets %}
                                    <span class="limit-badge limit-max">Max set√≥w: {{ section.set_max_sets }}</span>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>

                            {% if section.set_image %}
                            <!-- T≈Ço seta -->
                            <div class="set-background zoomable-image-wrapper" onclick="openLightbox(this)">
                                <img src="{{ url_for('static', filename=section.set_image) }}" alt="{{ section.set_name }}"
                                     data-full-src="{{ url_for('static', filename=section.set_image) }}">
                                <div class="zoom-icon">
                                    <svg viewBox="0 0 16 16" fill="currentColor">
                                        <path fill-rule="evenodd" d="M6.5 12a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11zM13 6.5a6.5 6.5 0 1 1-13 0 6.5 6.5 0 0 1 13 0z"/>
                                        <path d="M10.344 11.742c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1 6.538 6.538 0 0 1-1.398 1.4z"/>
                                        <path fill-rule="evenodd" d="M6.5 3a.5.5 0 0 1 .5.5V6h2.5a.5.5 0 0 1 0 1H7v2.5a.5.5 0 0 1-1 0V7H3.5a.5.5 0 0 1 0-1H6V3.5a.5.5 0 0 1 .5-.5z"/>
                                    </svg>
                                </div>
                            </div>
                            {% endif %}

                            <div class="set-items">
                                {% for item in section.get_set_items_ordered() %}
                                    {% if item.is_product and item.product %}
                                    <!-- Pojedynczy produkt -->
                                    <div class="set-item" data-item-id="{{ item.id }}" data-product-id="{{ item.product_id }}">
                                        <div class="set-item-info">
                                            <span class="set-item-name">{{ item.product.name }}</span>
                                        </div>
                                        <div class="set-item-qty">
                                            <span class="set-item-price">{{ "%.2f"|format(item.product.sale_price) }} PLN</span>
                                            <div class="quantity-wrapper">
                                                <div class="quantity-control quantity-control-sm">
                                                    <button type="button" class="qty-btn qty-minus" onclick="decreaseQty(this)">-</button>
                                                    <input type="number" class="qty-input" value="0" min="0" onchange="updateQty(this)">
                                                    <button type="button" class="qty-btn qty-plus" onclick="increaseQty(this)">+</button>
                                                </div>
                                                <span class="availability-info availability-loading" data-availability-for="{{ item.product_id }}">≈Åadowanie</span>
                                            </div>
                                        </div>
                                    </div>
                                    {% elif item.is_variant_group and item.variant_group %}
                                    <!-- Grupa wariantowa w secie -->
                                    <div class="set-item-group" data-item-id="{{ item.id }}" data-variant-group-id="{{ item.variant_group_id }}">
                                        {% for product in item.get_products() %}
                                        <div class="set-item" data-product-id="{{ product.id }}">
                                            <div class="set-item-info">
                                                <span class="set-item-name">{{ product.name }}</span>
                                            </div>
                                            <div class="set-item-qty">
                                                <span class="set-item-price">{{ "%.2f"|format(product.sale_price) }} PLN</span>
                                                <div class="quantity-wrapper">
                                                    <div class="quantity-control quantity-control-sm">
                                                        <button type="button" class="qty-btn qty-minus" onclick="decreaseQty(this)">-</button>
                                                        <input type="number" class="qty-input" value="0" min="0" onchange="updateQty(this)">
                                                        <button type="button" class="qty-btn qty-plus" onclick="increaseQty(this)">+</button>
                                                    </div>
                                                    <span class="availability-info availability-loading" data-availability-for="{{ product.id }}">≈Åadowanie</span>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>

                            <!-- KUP PE≈ÅNY SET - Sekcja z grupƒÖ wariantowƒÖ -->
                            {% set ns = namespace(has_variant_group=false, variant_group_products=[], full_set_total=0) %}
                            {% for item in section.get_set_items_ordered() %}
                                {% if item.is_variant_group and item.variant_group %}
                                    {% set ns.has_variant_group = true %}
                                    {% set ns.variant_group_products = item.get_products() %}
                                    {% for p in ns.variant_group_products %}
                                        {% set ns.full_set_total = ns.full_set_total + (p.sale_price|float) %}
                                    {% endfor %}
                                {% endif %}
                            {% endfor %}

                            {% if ns.has_variant_group and ns.variant_group_products|length > 0 %}
                            <div class="full-set-section" data-section-id="{{ section.id }}" data-variant-group-products='{{ ns.variant_group_products|map(attribute="id")|list|tojson }}'>
                                <div class="full-set-confetti-container">
                                    <div class="full-set-inner">
                                        <div class="full-set-info">
                                            <span class="full-set-icon">‚ú®</span>
                                            <div class="full-set-title-big">KUP PE≈ÅNY SET</div>
                                        </div>
                                        <span class="full-set-price" data-full-set-price="{{ ns.full_set_total }}">{{ "%.2f"|format(ns.full_set_total) }} PLN</span>
                                        <div class="full-set-controls">
                                            <div class="quantity-control full-set-quantity">
                                                <button type="button" class="qty-btn qty-minus" onclick="decreaseFullSet(this)">-</button>
                                                <input type="number" class="qty-input full-set-qty-input" value="0" min="0" data-section-id="{{ section.id }}" onchange="updateFullSetQty(this)">
                                                <button type="button" class="qty-btn qty-plus full-set-plus-btn" onclick="increaseFullSet(this)">+</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </section>

                {% elif section.is_variant_group %}
                <section class="section section-variant-group" data-section-id="{{ section.id }}">
                    {% if section.variant_group %}
                    <div class="variant-group-card">
                        <div class="set-header">
                            <h3 class="set-name">{{ section.variant_group.name }}</h3>
                            {% if section.has_min_quantity or section.has_max_quantity %}
                            <div class="set-limits">
                                {% if section.has_min_quantity %}
                                <span class="limit-badge limit-min">Min/produkt: {{ section.min_quantity }}</span>
                                {% endif %}
                                {% if section.has_max_quantity %}
                                <span class="limit-badge limit-max">Max/produkt: {{ section.max_quantity }}</span>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="variant-group-products">
                            {% for product in section.get_variant_group_products() %}
                            {% if product.is_active %}
                            <div class="variant-product" data-product-id="{{ product.id }}">
                                <div class="variant-product-image {% if product.primary_image %}zoomable-image-wrapper{% endif %}" {% if product.primary_image %}onclick="openLightbox(this)"{% endif %}>
                                    {% if product.primary_image %}
                                    <img src="{{ url_for('static', filename=product.primary_image.path_compressed) }}"
                                         alt="{{ product.name }}"
                                         data-full-src="{{ url_for('static', filename=product.primary_image.path_original or product.primary_image.path_compressed) }}">
                                    <div class="zoom-icon zoom-icon-sm">
                                        <svg viewBox="0 0 16 16" fill="currentColor">
                                            <path fill-rule="evenodd" d="M6.5 12a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11zM13 6.5a6.5 6.5 0 1 1-13 0 6.5 6.5 0 0 1 13 0z"/>
                                            <path d="M10.344 11.742c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1 6.538 6.538 0 0 1-1.398 1.4z"/>
                                            <path fill-rule="evenodd" d="M6.5 3a.5.5 0 0 1 .5.5V6h2.5a.5.5 0 0 1 0 1H7v2.5a.5.5 0 0 1-1 0V7H3.5a.5.5 0 0 1 0-1H6V3.5a.5.5 0 0 1 .5-.5z"/>
                                        </svg>
                                    </div>
                                    {% else %}
                                    <div class="no-image-sm">
                                        <svg width="24" height="24" viewBox="0 0 16 16" fill="currentColor">
                                            <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                                            <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/>
                                        </svg>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="variant-product-info">
                                    <span class="variant-product-name">{{ product.name }}</span>
                                    <span class="variant-product-price">{{ "%.2f"|format(product.sale_price) }} PLN</span>
                                </div>
                                <div class="variant-product-qty">
                                    <div class="quantity-wrapper">
                                        <div class="quantity-control quantity-control-sm">
                                            <button type="button" class="qty-btn qty-minus" onclick="decreaseQty(this)">-</button>
                                            <input type="number" class="qty-input" value="0" min="0"
                                                   {% if section.has_max_quantity %}max="{{ section.max_quantity }}"{% endif %}
                                                   onchange="updateQty(this)">
                                            <button type="button" class="qty-btn qty-plus" onclick="increaseQty(this)">+</button>
                                        </div>
                                        <span class="availability-info availability-loading" data-availability-for="{{ product.id }}">≈Åadowanie</span>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    {% else %}
                    <div class="product-unavailable">
                        <p>Grupa wariantowa niedostƒôpna</p>
                    </div>
                    {% endif %}
                </section>
                {% endif %}
            {% endfor %}
        </main>

        <!-- Cart Sidebar -->
        <aside class="cart-sidebar">
            <div class="cart-header">
                <h3>Twoje zam√≥wienie</h3>
                <span class="cart-count" id="cartCount">0</span>
            </div>

            <div class="cart-items" id="cartItems">
                <div class="cart-empty">
                    <p>Koszyk jest pusty</p>
                </div>
            </div>

            <div class="cart-footer">
                <div class="cart-total">
                    <span>Suma:</span>
                    <span class="total-amount" id="cartTotal">0.00 PLN</span>
                </div>

                <button type="button" class="btn btn-primary btn-block" id="submitOrderBtn" disabled onclick="openOrderModal()">
                    Z≈Ç√≥≈º zam√≥wienie
                </button>
            </div>
        </aside>
    </div>

    <!-- Footer -->
    {% if page.footer_content %}
    <footer class="page-footer">
        <div class="footer-content">
            {{ page.footer_content|safe }}
        </div>
    </footer>
    {% endif %}
</div>

<!-- Guest Choice Modal - Wyb√≥r dla go≈õcia -->
<div id="guestChoiceModal" class="exclusive-modal-overlay">
    <div class="exclusive-modal-box exclusive-modal-choice">
        <!-- Close Button -->
        <button type="button" class="exclusive-modal-close-btn" onclick="closeGuestChoiceModal()">
            <svg width="24" height="24" viewBox="0 0 16 16" fill="currentColor">
                <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
            </svg>
        </button>

        <!-- Header -->
        <div class="exclusive-modal-header">
            <div class="exclusive-modal-sparkle">‚ú®</div>
            <h2 class="exclusive-modal-title">Z≈Ç√≥≈º zam√≥wienie</h2>
            <p class="exclusive-modal-subtitle">Jak chcesz kontynuowaƒá?</p>
        </div>

        <!-- Body -->
        <div class="exclusive-modal-body">
            <div class="guest-choice-options">
                <!-- Option 1: Guest Checkout -->
                <button type="button" class="guest-choice-btn" onclick="continueAsGuest()">
                    <div class="guest-choice-icon">
                        <svg width="32" height="32" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
                        </svg>
                    </div>
                    <div class="guest-choice-content">
                        <h3 class="guest-choice-title">Kontynuuj jako go≈õƒá</h3>
                        <p class="guest-choice-desc">Szybkie zam√≥wienie bez zak≈Çadania konta</p>
                    </div>
                    <div class="guest-choice-arrow">‚Üí</div>
                </button>

                <!-- Option 2: Login -->
                <button type="button" class="guest-choice-btn" onclick="showLoginModal()">
                    <div class="guest-choice-icon">
                        <svg width="32" height="32" viewBox="0 0 16 16" fill="currentColor">
                            <path fill-rule="evenodd" d="M6 3.5a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-2a.5.5 0 0 0-1 0v2A1.5 1.5 0 0 0 6.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-8A1.5 1.5 0 0 0 5 3.5v2a.5.5 0 0 0 1 0v-2z"/>
                            <path fill-rule="evenodd" d="M11.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5H1.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
                        </svg>
                    </div>
                    <div class="guest-choice-content">
                        <h3 class="guest-choice-title">Zaloguj siƒô</h3>
                        <p class="guest-choice-desc">Masz ju≈º konto? Zaloguj siƒô</p>
                    </div>
                    <div class="guest-choice-arrow">‚Üí</div>
                </button>
            </div>

            <!-- Create Account Link -->
            <div class="guest-choice-footer">
                <p class="guest-choice-register-text">
                    Nie masz jeszcze konta?
                    <a href="/auth/register" class="guest-choice-register-link">Utw√≥rz konto</a>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Login Modal -->
<div id="loginModal" class="exclusive-modal-overlay">
    <div class="exclusive-modal-box exclusive-modal-login">
        <!-- Close Button -->
        <button type="button" class="exclusive-modal-close-btn" onclick="closeLoginModal()">
            <svg width="24" height="24" viewBox="0 0 16 16" fill="currentColor">
                <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
            </svg>
        </button>

        <!-- Header -->
        <div class="exclusive-modal-header">
            <div class="exclusive-modal-sparkle">üîê</div>
            <h2 class="exclusive-modal-title">Zaloguj siƒô</h2>
            <p class="exclusive-modal-subtitle">Kontynuuj jako zalogowany u≈ºytkownik</p>
        </div>

        <!-- Body -->
        <div class="exclusive-modal-body">
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="exclusive-form-field">
                    <label class="exclusive-form-label">Email <span class="exclusive-req">*</span></label>
                    <input type="email" id="loginEmail" class="exclusive-form-input" required placeholder="twoj.email@example.com" autocomplete="email">
                </div>

                <div class="exclusive-form-field">
                    <label class="exclusive-form-label">Has≈Ço <span class="exclusive-req">*</span></label>
                    <input type="password" id="loginPassword" class="exclusive-form-input" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
                </div>

                <div id="loginError" class="exclusive-form-error" style="display: none;"></div>

                <!-- Footer -->
                <div class="exclusive-modal-footer">
                    <button type="button" class="exclusive-btn-cancel" onclick="backToGuestChoice()">
                        <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor">
                            <path fill-rule="evenodd" d="M12 8a.5.5 0 0 1-.5.5H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5a.5.5 0 0 1 .5.5z"/>
                        </svg>
                        <span>Wr√≥ƒá</span>
                    </button>
                    <button type="submit" class="exclusive-btn-submit" id="loginSubmitBtn">
                        <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor">
                            <path fill-rule="evenodd" d="M6 3.5a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-2a.5.5 0 0 0-1 0v2A1.5 1.5 0 0 0 6.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-8A1.5 1.5 0 0 0 5 3.5v2a.5.5 0 0 0 1 0v-2z"/>
                            <path fill-rule="evenodd" d="M11.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5H1.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
                        </svg>
                        <span>Zaloguj siƒô</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Order Modal - K-pop Style -->
<div id="orderModal" class="exclusive-modal-overlay">
    <div class="exclusive-modal-box">
        <!-- Close Button -->
        <button type="button" class="exclusive-modal-close-btn" onclick="closeOrderModal()">
            <svg width="24" height="24" viewBox="0 0 16 16" fill="currentColor">
                <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
            </svg>
        </button>

        <!-- Header -->
        <div class="exclusive-modal-header">
            <div class="exclusive-modal-sparkle">‚ú®</div>
            <h2 class="exclusive-modal-title">Z≈Ç√≥≈º zam√≥wienie</h2>
            <p class="exclusive-modal-subtitle">Jeszcze tylko krok!</p>
        </div>

        <!-- Body -->
        <div class="exclusive-modal-body">
            {% if current_user.is_authenticated %}
            <!-- Logged in user -->
            <div class="exclusive-user-card">
                <div class="exclusive-user-avatar">
                    {% if current_user.avatar_url %}
                    <img src="{{ current_user.avatar_url }}" alt="{{ current_user.full_name }}" class="user-avatar-img">
                    {% else %}
                    <svg width="28" height="28" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
                        <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/>
                    </svg>
                    {% endif %}
                </div>
                <div class="exclusive-user-info">
                    <p class="exclusive-user-name">{{ current_user.full_name }}</p>
                    <p class="exclusive-user-email">{{ current_user.email }}</p>
                </div>
            </div>

            <div class="exclusive-form-field">
                <label class="exclusive-form-label">
                    <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M5 4a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1H5zm-.5 2.5A.5.5 0 0 1 5 6h6a.5.5 0 0 1 0 1H5a.5.5 0 0 1-.5-.5zM5 8a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1H5zm0 2a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1H5z"/>
                        <path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2zm10-1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1z"/>
                    </svg>
                    <span>Notatka do zam√≥wienia <span class="exclusive-opt">(opcjonalnie)</span></span>
                </label>
                <textarea id="orderNote" class="exclusive-form-textarea" rows="3" placeholder="Dodatkowe informacje, uwagi, preferencje..."></textarea>
            </div>
            {% else %}
            <!-- Guest checkout -->
            <form id="guestForm">
                <div class="exclusive-guest-badge">
                    <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
                    </svg>
                    <span>Twoje dane</span>
                </div>

                <div class="exclusive-form-field">
                    <label class="exclusive-form-label">Imiƒô i nazwisko <span class="exclusive-req">*</span></label>
                    <input type="text" id="guestName" class="exclusive-form-input" required placeholder="Jan Kowalski">
                </div>

                <div class="exclusive-form-field">
                    <label class="exclusive-form-label">Email <span class="exclusive-req">*</span></label>
                    <input type="email" id="guestEmail" class="exclusive-form-input" required placeholder="jan.kowalski@example.com">
                </div>

                <div class="exclusive-form-field">
                    <label class="exclusive-form-label">Telefon <span class="exclusive-req">*</span></label>
                    <input type="tel" id="guestPhone" class="exclusive-form-input" required placeholder="+48 123 456 789">
                </div>

                <div class="exclusive-form-field">
                    <label class="exclusive-form-label">
                        <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M5 4a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1H5zm-.5 2.5A.5.5 0 0 1 5 6h6a.5.5 0 0 1 0 1H5a.5.5 0 0 1-.5-.5zM5 8a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1H5zm0 2a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1H5z"/>
                            <path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2zm10-1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1z"/>
                        </svg>
                        <span>Notatka <span class="exclusive-opt">(opcjonalnie)</span></span>
                    </label>
                    <textarea id="orderNote" class="exclusive-form-textarea" rows="3" placeholder="Dodatkowe informacje, uwagi, preferencje..."></textarea>
                </div>
            </form>
            {% endif %}
        </div>

        <!-- Footer -->
        <div class="exclusive-modal-footer">
            <button type="button" class="exclusive-btn-cancel" onclick="closeOrderModal()">
                <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
                </svg>
                <span>Anuluj</span>
            </button>
            <button type="button" class="exclusive-btn-submit" onclick="submitOrder()">
                <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                </svg>
                <span>Potwierd≈∫ zam√≥wienie</span>
            </button>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div id="successModal" class="exclusive-modal-overlay">
    <div class="exclusive-modal-box exclusive-modal-success">
        <!-- Success Icon -->
        <div class="exclusive-success-icon">
            <svg width="64" height="64" viewBox="0 0 16 16" fill="currentColor">
                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
            </svg>
        </div>

        <!-- Header -->
        <div class="exclusive-modal-header">
            <h2 class="exclusive-modal-title">Zam√≥wienie zosta≈Ço z≈Ço≈ºone!</h2>
            <p class="exclusive-modal-subtitle">Dziƒôkujemy za zakupy ‚ú®</p>
        </div>

        <!-- Body -->
        <div class="exclusive-modal-body">
            <div class="exclusive-success-info">
                <div class="exclusive-success-row">
                    <span class="exclusive-success-label">Numer zam√≥wienia:</span>
                    <span class="exclusive-success-value" id="successOrderNumber">-</span>
                </div>
                <div class="exclusive-success-row">
                    <span class="exclusive-success-label">Kwota:</span>
                    <span class="exclusive-success-value" id="successOrderTotal">-</span>
                </div>
            </div>

            <div class="exclusive-success-message">
                {% if current_user.is_authenticated %}
                <p>Szczeg√≥≈Çy zam√≥wienia znajdziesz w swoim panelu klienta.</p>
                {% else %}
                <p>Potwierdzenie zam√≥wienia zosta≈Ço wys≈Çane na podany adres email.</p>
                <p class="exclusive-success-note">Sprawd≈∫ swojƒÖ skrzynkƒô odbiorczƒÖ (oraz folder spam).</p>
                {% endif %}
            </div>
        </div>

        <!-- Footer -->
        <div class="exclusive-modal-footer">
            {% if current_user.is_authenticated %}
            <button type="button" class="exclusive-btn-submit" onclick="redirectToOrders()">
                <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor">
                    <path fill-rule="evenodd" d="M4.146 3.646a.5.5 0 0 0 0 .708L7.793 8l-3.647 3.646a.5.5 0 0 0 .708.708l4-4a.5.5 0 0 0 0-.708l-4-4a.5.5 0 0 0-.708 0z"/>
                </svg>
                <span>Przejd≈∫ do moich zam√≥wie≈Ñ</span>
            </button>
            {% else %}
            <button type="button" class="exclusive-btn-submit" onclick="closeSuccessModal()">
                <svg width="18" height="18" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                </svg>
                <span>OK</span>
            </button>
            {% endif %}
        </div>
    </div>
</div>

<!-- Image Lightbox Modal -->
<div id="imageLightbox" class="image-lightbox">
    <div class="image-lightbox-overlay" onclick="closeLightbox()"></div>
    <button class="image-lightbox-close" onclick="closeLightbox()">
        <svg viewBox="0 0 16 16" fill="currentColor">
            <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
        </svg>
    </button>
    <div class="image-lightbox-content">
        <img id="lightboxImage" class="image-lightbox-img" src="" alt="">
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ============================================
// Image Lightbox
// ============================================
function openLightbox(wrapper) {
    const img = wrapper.querySelector('img');
    if (!img) return;

    const fullSrc = img.dataset.fullSrc || img.src;
    const lightbox = document.getElementById('imageLightbox');
    const lightboxImg = document.getElementById('lightboxImage');

    lightboxImg.src = fullSrc;
    lightboxImg.alt = img.alt;
    lightbox.classList.add('active');

    // Prevent body scroll
    document.body.style.overflow = 'hidden';
}

function closeLightbox() {
    const lightbox = document.getElementById('imageLightbox');
    lightbox.classList.remove('active');

    // Restore body scroll
    document.body.style.overflow = '';
}

// Close on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeLightbox();
    }
});

// ============================================
// Auto-refresh when sale ends
// ============================================
{% if page.ends_at and not preview_mode %}
(function() {
    const endDate = new Date('{{ page.ends_at.isoformat() }}').getTime();
    const orderPageUrl = '{{ url_for("exclusive.order_page", token=page.token) }}';

    function checkSaleEnd() {
        const now = new Date().getTime();
        if (now >= endDate) {
            // Sale ended - redirect to refresh (will show ended page)
            window.location.href = orderPageUrl;
        }
    }

    // Check every second
    setInterval(checkSaleEnd, 1000);

    // Also check immediately
    checkSaleEnd();
})();
{% endif %}

// ============================================
// Cart state
// ============================================
let cart = [];

function updateCart() {
    console.log('[Cart] updateCart called');
    const cartItems = document.getElementById('cartItems');
    const cartCount = document.getElementById('cartCount');
    const cartTotal = document.getElementById('cartTotal');
    const submitBtn = document.getElementById('submitOrderBtn');

    // Collect all items with quantity > 0 (excluding full set inputs)
    cart = [];
    document.querySelectorAll('.qty-input:not(.full-set-qty-input)').forEach(input => {
        const qty = parseInt(input.value) || 0;
        if (qty > 0) {
            // Find the closest parent container with product info
            const productSection = input.closest('.section-product');
            const setItem = input.closest('.set-item');
            const variantProduct = input.closest('.variant-product');

            let productId, name, price;

            if (productSection) {
                // Product section
                productId = productSection.dataset.productId;
                // Try new layout first (.product-name), fallback to old (.set-name)
                const nameEl = productSection.querySelector('.product-name') || productSection.querySelector('.set-name');
                name = nameEl ? nameEl.textContent.trim() : 'Produkt';
                const priceEl = productSection.querySelector('.product-price');
                if (!priceEl) return; // Skip if price element not found
                const priceText = priceEl.textContent;
                price = parseFloat(priceText.replace(/[^\d.,]/g, '').replace(',', '.'));
            } else if (setItem) {
                // Set item
                productId = setItem.dataset.productId;
                const nameEl = setItem.querySelector('.set-item-name');
                const priceEl = setItem.querySelector('.set-item-price');
                if (!nameEl || !priceEl) return; // Skip if elements not found
                name = nameEl.textContent.trim();
                const priceText = priceEl.textContent;
                price = parseFloat(priceText.replace(/[^\d.,]/g, '').replace(',', '.'));
            } else if (variantProduct) {
                // Variant product
                productId = variantProduct.dataset.productId;
                const nameEl = variantProduct.querySelector('.variant-product-name');
                const priceEl = variantProduct.querySelector('.variant-product-price');
                if (!nameEl || !priceEl) return; // Skip if elements not found
                name = nameEl.textContent.trim();
                const priceText = priceEl.textContent;
                price = parseFloat(priceText.replace(/[^\d.,]/g, '').replace(',', '.'));
            }

            if (productId && name && !isNaN(price)) {
                console.log(`[Cart] Adding product to cart: id=${productId}, name=${name}, qty=${qty}, price=${price}`);
                cart.push({ productId, name, qty, price, isFullSet: false });
            } else {
                console.log(`[Cart] Skipping product: id=${productId}, name=${name}, price=${price} (qty=${qty})`);
            }
        }
    });

    // Collect full sets separately
    let fullSetItems = [];
    document.querySelectorAll('.full-set-qty-input').forEach(input => {
        const qty = parseInt(input.value) || 0;
        if (qty > 0) {
            const fullSetSection = input.closest('.full-set-section');
            if (fullSetSection) {
                const sectionId = fullSetSection.dataset.sectionId;
                const priceEl = fullSetSection.querySelector('.full-set-price');
                const price = priceEl ? parseFloat(priceEl.dataset.fullSetPrice) : 0;
                const productIds = JSON.parse(fullSetSection.dataset.variantGroupProducts || '[]');

                // Get section name for display
                const setSection = fullSetSection.closest('.section-set');
                let setName = 'Pe≈Çny Set';
                if (setSection) {
                    // Try different selectors for set name
                    const headerEl = setSection.querySelector('.set-header h3.set-name') ||
                                     setSection.querySelector('.set-name') ||
                                     setSection.querySelector('h3');
                    if (headerEl) {
                        setName = headerEl.textContent.trim();
                    }
                }

                console.log(`[Cart] Adding full set: ${setName}, qty=${qty}, price=${price}, products=${productIds.length}`);
                fullSetItems.push({
                    sectionId,
                    name: `‚ú® Pe≈Çny Set: ${setName}`,
                    qty,
                    price,
                    productIds,
                    isFullSet: true
                });
            }
        }
    });

    // Update UI
    const totalIndividualItems = cart.reduce((sum, item) => sum + item.qty, 0);
    const totalFullSetItems = fullSetItems.reduce((sum, item) => sum + item.qty, 0);
    const totalItems = totalIndividualItems + totalFullSetItems;

    const totalIndividualPrice = cart.reduce((sum, item) => sum + (item.qty * item.price), 0);
    const totalFullSetPrice = fullSetItems.reduce((sum, item) => sum + (item.qty * item.price), 0);
    const totalPrice = totalIndividualPrice + totalFullSetPrice;

    console.log(`[Cart] Cart updated: ${cart.length} individual products, ${fullSetItems.length} full sets, ${totalItems} total items, ${totalPrice.toFixed(2)} PLN`);

    cartCount.textContent = totalItems;
    cartTotal.textContent = totalPrice.toFixed(2) + ' PLN';
    submitBtn.disabled = totalItems === 0;

    // Update cart items list
    const allItems = [...fullSetItems, ...cart]; // Full sets first, then individual products

    if (allItems.length === 0) {
        cartItems.innerHTML = '<div class="cart-empty"><p>Koszyk jest pusty</p></div>';
    } else {
        cartItems.innerHTML = allItems.map(item => {
            const removeIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;

            if (item.isFullSet) {
                return `
                    <div class="cart-item cart-item-fullset">
                        <span class="cart-item-name">${item.name}</span>
                        <span class="cart-item-qty">x${item.qty}</span>
                        <span class="cart-item-price">${(item.qty * item.price).toFixed(2)} PLN</span>
                        <button type="button" class="cart-item-remove" onclick="removeFullSetFromCart('${item.sectionId}')" title="Usu≈Ñ z koszyka">
                            ${removeIcon}
                        </button>
                    </div>
                `;
            } else {
                return `
                    <div class="cart-item">
                        <span class="cart-item-name">${item.name}</span>
                        <span class="cart-item-qty">x${item.qty}</span>
                        <span class="cart-item-price">${(item.qty * item.price).toFixed(2)} PLN</span>
                        <button type="button" class="cart-item-remove" onclick="removeProductFromCart(${item.productId})" title="Usu≈Ñ z koszyka">
                            ${removeIcon}
                        </button>
                    </div>
                `;
            }
        }).join('');
    }

    // Update button states after cart update
    updateButtonStates();

    // Store full sets in global variable for order submission
    window.fullSetItems = fullSetItems;
}

// Update button states based on limits
function updateButtonStates() {
    // Update all quantity controls
    document.querySelectorAll('.qty-input').forEach(input => {
        const val = parseInt(input.value) || 0;
        const max = input.getAttribute('max');
        const quantityControl = input.closest('.quantity-control');
        if (!quantityControl) return;

        const minusBtn = quantityControl.querySelector('.qty-minus');
        const plusBtn = quantityControl.querySelector('.qty-plus');

        if (!minusBtn || !plusBtn) return;

        // Disable minus if at 0
        if (val <= 0) {
            minusBtn.disabled = true;
            minusBtn.style.opacity = '0.5';
            minusBtn.style.cursor = 'not-allowed';
        } else {
            minusBtn.disabled = false;
            minusBtn.style.opacity = '1';
            minusBtn.style.cursor = 'pointer';
        }

        // Check product max limit
        let atMax = max && val >= parseInt(max);

        // Check set max limit if in a set (applies to EACH product, not sum)
        // SKIP for full-set inputs - they are UNLIMITED
        const isFullSetInput = input.classList.contains('full-set-qty-input');
        if (!isFullSetInput) {
            const setSection = input.closest('.section-set');
            if (setSection && !atMax) {
                const setMax = parseInt(setSection.dataset.setMax) || 0;
                if (setMax > 0 && val >= setMax) {
                    atMax = true;
                }
            }
        }

        if (atMax) {
            plusBtn.disabled = true;
            plusBtn.style.opacity = '0.5';
            plusBtn.style.cursor = 'not-allowed';
        } else {
            plusBtn.disabled = false;
            plusBtn.style.opacity = '1';
            plusBtn.style.cursor = 'pointer';
        }
    });
}

function increaseQty(btn) {
    if (btn.disabled) return;

    const quantityControl = btn.closest('.quantity-control');
    if (!quantityControl) return;

    const input = quantityControl.querySelector('.qty-input');
    if (!input) return;

    const max = input.getAttribute('max');
    let val = parseInt(input.value) || 0;

    // Check product max limit
    if (max && val >= parseInt(max)) {
        return;
    }

    // Check set max limit (applies to EACH product, not sum)
    // SKIP for full-set inputs - they are UNLIMITED
    const isFullSetInput = input.classList.contains('full-set-qty-input');
    if (!isFullSetInput) {
        const setSection = input.closest('.section-set');
        if (setSection) {
            const setMax = parseInt(setSection.dataset.setMax) || 0;
            if (setMax > 0 && val >= setMax) {
                return;
            }
        }
    }

    input.value = val + 1;
    updateCart();
}

function decreaseQty(btn) {
    if (btn.disabled) return;

    const quantityControl = btn.closest('.quantity-control');
    if (!quantityControl) return;

    const input = quantityControl.querySelector('.qty-input');
    if (!input) return;

    let val = parseInt(input.value) || 0;
    if (val > 0) {
        input.value = val - 1;
        updateCart();
    }
}

function updateQty(input) {
    let val = parseInt(input.value) || 0;
    const max = input.getAttribute('max');
    if (val < 0) val = 0;
    if (max && val > parseInt(max)) val = parseInt(max);

    // Check set max limit (applies to EACH product, not sum)
    const setSection = input.closest('.section-set');
    if (setSection) {
        const setMax = parseInt(setSection.dataset.setMax) || 0;
        if (setMax > 0 && val > setMax) {
            val = setMax;
        }
    }

    input.value = val;
    updateCart();
}

function openOrderModal() {
    const isAuthenticated = {{ 'true' if current_user.is_authenticated else 'false' }};

    if (isAuthenticated) {
        // Logged in user - show order modal directly
        const modal = document.getElementById('orderModal');
        modal.classList.add('active');
    } else {
        // Guest - show choice modal first
        const modal = document.getElementById('guestChoiceModal');
        modal.classList.add('active');
    }
}

function closeOrderModal() {
    const modal = document.getElementById('orderModal');
    modal.classList.add('closing');
    setTimeout(() => {
        modal.classList.remove('active', 'closing');
    }, 350);
}

function closeGuestChoiceModal() {
    const modal = document.getElementById('guestChoiceModal');
    modal.classList.add('closing');
    setTimeout(() => {
        modal.classList.remove('active', 'closing');
    }, 350);
}

function continueAsGuest() {
    // Close choice modal
    closeGuestChoiceModal();

    // Wait for animation, then open guest order modal
    setTimeout(() => {
        const modal = document.getElementById('orderModal');
        modal.classList.add('active');
    }, 400);
}

function showLoginModal() {
    // Close choice modal
    closeGuestChoiceModal();

    // Wait for animation, then open login modal
    setTimeout(() => {
        const modal = document.getElementById('loginModal');
        modal.classList.add('active');
    }, 400);
}

function closeLoginModal() {
    const modal = document.getElementById('loginModal');
    modal.classList.add('closing');
    setTimeout(() => {
        modal.classList.remove('active', 'closing');
        // Clear error message
        const errorEl = document.getElementById('loginError');
        errorEl.style.display = 'none';
        errorEl.textContent = '';
    }, 350);
}

function backToGuestChoice() {
    // Close login modal
    closeLoginModal();

    // Wait for animation, then show choice modal again
    setTimeout(() => {
        const modal = document.getElementById('guestChoiceModal');
        modal.classList.add('active');
    }, 400);
}

async function handleLogin(event) {
    event.preventDefault();

    const btn = document.getElementById('loginSubmitBtn');
    const originalText = btn.innerHTML;
    const errorEl = document.getElementById('loginError');

    // Hide previous error
    errorEl.style.display = 'none';

    // Disable button and show loading
    btn.disabled = true;
    btn.innerHTML = '<span>Logowanie...</span>';

    try {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;

        // Send login request
        const response = await fetch('/auth/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                'email': email,
                'password': password,
                'remember_me': 'on'
            })
        });

        if (response.ok) {
            // Login successful - reload page
            // Rezerwacja zostanie zachowana (localStorage)
            window.location.reload();
        } else {
            // Login failed
            const data = await response.text();

            // Try to extract error message
            let errorMessage = 'Nieprawid≈Çowy email lub has≈Ço.';

            // Show error
            errorEl.textContent = errorMessage;
            errorEl.style.display = 'block';

            btn.disabled = false;
            btn.innerHTML = originalText;
        }

    } catch (error) {
        console.error('Login error:', error);
        errorEl.textContent = 'WystƒÖpi≈Ç b≈ÇƒÖd po≈ÇƒÖczenia. Spr√≥buj ponownie.';
        errorEl.style.display = 'block';
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

async function submitOrder() {
    const btn = document.querySelector('.exclusive-btn-submit');
    const originalText = btn.innerHTML;

    // Disable button and show loading
    btn.disabled = true;
    btn.innerHTML = '<span>Wysy≈Çanie...</span>';

    try {
        // Gather data
        const orderNote = document.getElementById('orderNote').value.trim();
        const isGuest = {{ 'false' if current_user.is_authenticated else 'true' }};

        let requestData = {
            session_id: reservationState.sessionId,
            order_note: orderNote || null
        };

        // If guest, gather guest data
        if (isGuest) {
            const guestName = document.getElementById('guestName').value.trim();
            const guestEmail = document.getElementById('guestEmail').value.trim();
            const guestPhone = document.getElementById('guestPhone').value.trim();

            // Validate guest data
            if (!guestName || !guestEmail || !guestPhone) {
                alert('Proszƒô wype≈Çniƒá wszystkie wymagane pola.');
                btn.disabled = false;
                btn.innerHTML = originalText;
                return;
            }

            requestData.guest_data = {
                name: guestName,
                email: guestEmail,
                phone: guestPhone
            };
        }

        // Send request
        const response = await fetch('/exclusive/{{ page.token }}/place-order', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });

        const data = await response.json();

        if (data.success) {
            // Close order modal
            closeOrderModal();

            // Clear localStorage reservation
            localStorage.removeItem('exclusive_reservation_{{ page.token }}');

            // Stop reservation timers
            if (reservationState.pollingInterval) {
                clearInterval(reservationState.pollingInterval);
            }
            if (reservationState.countdownInterval) {
                clearInterval(reservationState.countdownInterval);
            }

            // Reset reservation state
            reservationState = {
                sessionId: null,
                firstReservedAt: null,
                expiresAt: null,
                extended: false,
                pollingInterval: null,
                countdownInterval: null
            };

            // Show success modal
            showSuccessModal(data.order_number, data.total_amount);

        } else {
            // Handle error
            let errorMessage = 'WystƒÖpi≈Ç b≈ÇƒÖd podczas sk≈Çadania zam√≥wienia.';

            if (data.error === 'no_reservations') {
                errorMessage = 'Brak produkt√≥w w rezerwacji. Rezerwacja mog≈Ça wygasnƒÖƒá.';
            } else if (data.error === 'insufficient_stock') {
                errorMessage = `Produkt "${data.product_name}" nie ma wystarczajƒÖcej ilo≈õci w magazynie.`;
            } else if (data.error === 'page_not_active') {
                errorMessage = 'Sprzeda≈º nie jest ju≈º aktywna.';
            } else if (data.message) {
                errorMessage = data.message;
            }

            alert(errorMessage);
            btn.disabled = false;
            btn.innerHTML = originalText;

            // If reservation expired, reload page
            if (data.error === 'no_reservations') {
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }
        }

    } catch (error) {
        console.error('Order submission error:', error);
        alert('WystƒÖpi≈Ç b≈ÇƒÖd po≈ÇƒÖczenia. Spr√≥buj ponownie.');
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

function showSuccessModal(orderNumber, totalAmount) {
    // Update modal content
    document.getElementById('successOrderNumber').textContent = orderNumber;
    document.getElementById('successOrderTotal').textContent = totalAmount.toFixed(2) + ' PLN';

    // Show modal
    const modal = document.getElementById('successModal');
    modal.classList.add('active');

    // Prevent closing by clicking outside
    modal.onclick = null;
}

function closeSuccessModal() {
    const modal = document.getElementById('successModal');
    modal.classList.add('closing');
    setTimeout(() => {
        modal.classList.remove('active', 'closing');
        // Reload page to reset everything
        window.location.reload();
    }, 350);
}

function redirectToOrders() {
    {% if current_user.is_authenticated %}
        {% if current_user.role in ['admin', 'mod'] %}
        // Przekieruj admina/moda na panel admin
        window.location.href = '/admin/dashboard';
        {% else %}
        // Przekieruj klienta na panel klienta
        window.location.href = '/client/dashboard';
        {% endif %}
    {% else %}
    closeSuccessModal();
    {% endif %}
}

// Initialize button states on page load
document.addEventListener('DOMContentLoaded', function() {
    updateButtonStates();
});

// Close modal on Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modal = document.getElementById('orderModal');
        if (modal.classList.contains('active')) {
            closeOrderModal();
        }
    }
});

// Close modal on backdrop click
document.getElementById('orderModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeOrderModal();
    }
});

// ============================================
// Reservation System
// ============================================

let reservationState = {
    sessionId: null,
    firstReservedAt: null,
    expiresAt: null,
    extended: false,
    pollingInterval: null,
    countdownInterval: null
};

// Generate UUID v4
function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

// Initialize session
function initReservationSystem() {
    // Get or create session ID
    let stored = localStorage.getItem('exclusive_reservation_{{ page.token }}');
    if (stored) {
        try {
            const data = JSON.parse(stored);
            reservationState.sessionId = data.sessionId;
            // Try to restore reservation
            restoreReservation(data);
        } catch (e) {
            console.error('Failed to parse localStorage', e);
            createNewSession();
        }
    } else {
        createNewSession();
    }

    // Start polling
    startPolling();
}

function createNewSession() {
    reservationState.sessionId = generateUUID();
    saveToLocalStorage();
}

// Save to localStorage
function saveToLocalStorage() {
    const data = {
        sessionId: reservationState.sessionId,
        firstReservedAt: reservationState.firstReservedAt,
        expiresAt: reservationState.expiresAt,
        extended: reservationState.extended,
        products: {}
    };

    // Collect products from cart
    cart.forEach(item => {
        data.products[item.productId] = {
            quantity: item.qty,
            name: item.name,
            price: item.price
        };
    });

    localStorage.setItem('exclusive_reservation_{{ page.token }}', JSON.stringify(data));
}

// Restore reservation from localStorage
async function restoreReservation(data) {
    console.log('[Reservation] Restoring reservation:', data);
    try {
        const response = await fetch(`/exclusive/{{ page.token }}/restore`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                session_id: data.sessionId,
                products: data.products
            })
        });

        const result = await response.json();
        console.log('[Reservation] Restore response:', result);

        if (result.success) {
            // Restore cart state
            Object.entries(result.restored).forEach(([productId, qty]) => {
                console.log(`[Reservation] Restoring product ${productId} with qty ${qty}`);
                const input = document.querySelector(`[data-product-id="${productId}"] .qty-input`);
                console.log(`[Reservation] Found input:`, input);
                if (input) {
                    input.value = qty;
                }
            });

            // Show expired products toast
            if (result.expired.length > 0) {
                result.expired.forEach(productId => {
                    const productName = data.products[productId]?.name || 'Produkt';
                    showToast(`Rezerwacja wygas≈Ça: ${productName}`, 'warning');
                });
            }

            // Update reservation state - only show header if products were actually restored
            const hasRestoredProducts = Object.values(result.restored).some(qty => qty > 0);
            if (result.session && hasRestoredProducts) {
                reservationState.expiresAt = result.session.expires_at;
                reservationState.firstReservedAt = result.session.first_reserved_at;
                reservationState.extended = result.session.extended || false;
                showReservationHeader();
            } else if (result.session && !hasRestoredProducts) {
                // Session exists but no products - clear it
                hideReservationHeader();
                localStorage.removeItem('exclusive_reservation_{{ page.token }}');
            }

            updateCart();
        }
    } catch (error) {
        console.error('Failed to restore reservation:', error);
    }
}

// Modified increaseQty with reservation
async function increaseQtyWithReservation(btn) {
    if (btn.disabled) return;

    const quantityControl = btn.closest('.quantity-control');
    if (!quantityControl) return;

    const input = quantityControl.querySelector('.qty-input');
    if (!input) return;

    // Get product info
    const productSection = input.closest('.section-product, .set-item, .variant-product');
    const productId = productSection.dataset.productId;

    let val = parseInt(input.value) || 0;

    // Optimistic update - immediately decrease displayed availability
    optimisticUpdateAvailability(productId, -1);

    // Try to reserve
    try {
        const response = await fetch(`/exclusive/{{ page.token }}/reserve`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                session_id: reservationState.sessionId,
                product_id: productId,
                quantity: 1,
                action: val === 0 ? 'add' : 'increase'
            })
        });

        const result = await response.json();

        if (result.success) {
            // Update input
            input.value = val + 1;

            // Update reservation state
            if (result.reservation.first_reservation_at) {
                reservationState.firstReservedAt = result.reservation.first_reservation_at;
                reservationState.expiresAt = result.reservation.expires_at;
                showReservationHeader();
            }

            updateCart();
            saveToLocalStorage();
        } else {
            // Rollback optimistic update
            optimisticUpdateAvailability(productId, +1);

            // Show error
            if (result.error === 'insufficient_availability') {
                showUnavailablePopup(result.message, result.check_back_at);
            } else {
                showToast(result.message || 'B≈ÇƒÖd rezerwacji', 'error');
            }
        }
    } catch (error) {
        // Rollback optimistic update
        optimisticUpdateAvailability(productId, +1);

        console.error('Reservation failed:', error);
        showToast('B≈ÇƒÖd po≈ÇƒÖczenia. Spr√≥buj ponownie.', 'error');
    }
}

// Modified decreaseQty with release
async function decreaseQtyWithReservation(btn) {
    if (btn.disabled) return;

    const quantityControl = btn.closest('.quantity-control');
    if (!quantityControl) return;

    const input = quantityControl.querySelector('.qty-input');
    if (!input) return;

    let val = parseInt(input.value) || 0;
    if (val === 0) return;

    const productSection = input.closest('.section-product, .set-item, .variant-product');
    const productId = productSection.dataset.productId;

    // Optimistic update - immediately increase displayed availability
    optimisticUpdateAvailability(productId, +1);

    try {
        const response = await fetch(`/exclusive/{{ page.token }}/release`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                session_id: reservationState.sessionId,
                product_id: productId,
                quantity: 1,
                action: 'decrease'
            })
        });

        const result = await response.json();

        if (result.success) {
            input.value = val - 1;
            updateCart();
            saveToLocalStorage();

            // If no more reservations, hide header
            if (cart.length === 0) {
                hideReservationHeader();
            }
        } else {
            // Rollback optimistic update
            optimisticUpdateAvailability(productId, -1);
        }
    } catch (error) {
        // Rollback optimistic update
        optimisticUpdateAvailability(productId, -1);
        console.error('Release failed:', error);
    }
}

// Polling availability (every 1 second)
function startPolling() {
    if (reservationState.pollingInterval) return;

    reservationState.pollingInterval = setInterval(async () => {
        await checkAvailability();
    }, 1000);
}

async function checkAvailability() {
    try {
        const response = await fetch(
            `/exclusive/{{ page.token }}/availability?session_id=${reservationState.sessionId}`
        );

        if (!response.ok) {
            console.warn(`Availability check returned ${response.status}`);
            return;
        }

        const result = await response.json();

        if (result.success) {
            // Update button states based on availability
            Object.entries(result.products).forEach(([productId, data]) => {
                updateProductAvailability(productId, data);
            });

            // Update session state
            if (result.session.has_reservations) {
                reservationState.expiresAt = result.session.expires_at;
                reservationState.extended = result.session.extended;
                updateReservationTimer();
            } else {
                hideReservationHeader();
            }
        }
    } catch (error) {
        // Network error - silently fail (probably offline)
        console.debug('Availability check failed (network):', error.message);
    }
}

// Store last known availability for optimistic updates
let productAvailability = {};

function updateProductAvailability(productId, data) {
    // Store availability for optimistic updates
    productAvailability[productId] = data.available;

    const productElements = document.querySelectorAll(`[data-product-id="${productId}"]`);

    productElements.forEach(element => {
        const quantityControl = element.querySelector('.quantity-control');
        if (!quantityControl) return;

        const plusBtn = quantityControl.querySelector('.qty-plus');
        const input = quantityControl.querySelector('.qty-input');

        const currentQty = parseInt(input.value) || 0;

        // Disable plus button if no more available globally
        const shouldDisable = data.available <= 0;

        if (shouldDisable) {
            plusBtn.disabled = true;
            plusBtn.style.opacity = '0.5';
            plusBtn.style.cursor = 'not-allowed';
        } else {
            plusBtn.disabled = false;
            plusBtn.style.opacity = '1';
            plusBtn.style.cursor = 'pointer';
        }
    });

    // Update availability info elements
    renderAvailabilityInfo(productId, data.available);
}

// Render availability info (used for both backend updates and optimistic updates)
function renderAvailabilityInfo(productId, available) {
    const availabilityElements = document.querySelectorAll(`[data-availability-for="${productId}"]`);
    availabilityElements.forEach(el => {
        // Remove all state classes
        el.classList.remove('availability-low', 'availability-none', 'availability-unlimited', 'availability-loading', 'availability-updating');

        // Check if unlimited (999999 means no limit)
        if (available >= 999999) {
            el.classList.add('availability-unlimited');
            el.textContent = '';
        } else if (available <= 0) {
            el.classList.add('availability-none');
            el.textContent = 'Niedostƒôpne';
        } else if (available <= 3) {
            el.classList.add('availability-low');
            el.textContent = `Dostƒôpne: ${available}`;
        } else {
            el.textContent = `Dostƒôpne: ${available}`;
        }
    });
}

// Optimistic update - immediately update availability display
function optimisticUpdateAvailability(productId, delta) {
    if (productAvailability[productId] === undefined) return;
    if (productAvailability[productId] >= 999999) return; // Unlimited - no change

    // Update stored value
    productAvailability[productId] = Math.max(0, productAvailability[productId] + delta);

    // Add updating class for visual feedback
    const availabilityElements = document.querySelectorAll(`[data-availability-for="${productId}"]`);
    availabilityElements.forEach(el => el.classList.add('availability-updating'));

    // Render new value
    renderAvailabilityInfo(productId, productAvailability[productId]);
}

// Show/hide reservation header
function showReservationHeader() {
    const header = document.getElementById('reservationHeader');
    header.classList.remove('hidden');

    // Reset extend button - will be properly updated by updateReservationTimer
    const extendBtn = document.getElementById('extendBtn');
    extendBtn.disabled = true; // Start disabled, updateReservationTimer will enable if < 2 min
    extendBtn.textContent = reservationState.extended ? 'Przed≈Çu≈ºono' : 'Przed≈Çu≈º +2 min';

    startCountdown();
}

function hideReservationHeader() {
    const header = document.getElementById('reservationHeader');
    header.classList.add('hidden');
    stopCountdown();

    // Reset extended state when hiding header
    reservationState.extended = false;
    reservationState.firstReservedAt = null;
    reservationState.expiresAt = null;
}

// Countdown timer
function startCountdown() {
    if (reservationState.countdownInterval) return;

    reservationState.countdownInterval = setInterval(() => {
        updateReservationTimer();
    }, 1000);
}

function stopCountdown() {
    if (reservationState.countdownInterval) {
        clearInterval(reservationState.countdownInterval);
        reservationState.countdownInterval = null;
    }
}

function updateReservationTimer() {
    if (!reservationState.expiresAt) return;

    const now = Math.floor(Date.now() / 1000); // Current timestamp in seconds
    const diff = reservationState.expiresAt - now;

    if (diff <= 0) {
        // Expired
        showToast('Twoja rezerwacja wygas≈Ça', 'error');
        clearReservation();
        return;
    }

    const minutes = Math.floor(diff / 60);
    const seconds = diff % 60;

    const timerEl = document.getElementById('reservationTimer');
    timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

    // Update extend button - active only when < 2 minutes remaining and not already extended
    const extendBtn = document.getElementById('extendBtn');
    const canExtend = !reservationState.extended && diff < 120; // 120 seconds = 2 minutes
    extendBtn.disabled = !canExtend;

    if (reservationState.extended) {
        extendBtn.textContent = 'Przed≈Çu≈ºono';
    } else if (diff >= 120) {
        extendBtn.textContent = 'Przed≈Çu≈º +2 min';
    } else {
        extendBtn.textContent = 'Przed≈Çu≈º +2 min';
    }

    // Warning if < 2 minutes
    const header = document.getElementById('reservationHeader');
    if (diff < 120) {
        header.classList.add('reservation-warning');
    } else {
        header.classList.remove('reservation-warning');
    }
}

// Extend reservation
async function extendReservation() {
    if (reservationState.extended) return;

    try {
        const response = await fetch(`/exclusive/{{ page.token }}/extend`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                session_id: reservationState.sessionId
            })
        });

        const result = await response.json();

        if (result.success) {
            reservationState.expiresAt = result.new_expires_at;
            reservationState.extended = true;
            saveToLocalStorage();
            showToast('Rezerwacja przed≈Çu≈ºona o 2 minuty', 'success');
        } else {
            showToast(result.message || 'Nie mo≈ºna przed≈Çu≈ºyƒá rezerwacji', 'error');
        }
    } catch (error) {
        console.error('Extend failed:', error);
        showToast('B≈ÇƒÖd przed≈Çu≈ºania rezerwacji', 'error');
    }
}

// Clear reservation
function clearReservation() {
    reservationState.firstReservedAt = null;
    reservationState.expiresAt = null;
    reservationState.extended = false;

    // Clear cart
    document.querySelectorAll('.qty-input').forEach(input => {
        input.value = 0;
    });

    cart = [];
    updateCart();

    localStorage.removeItem('exclusive_reservation_{{ page.token }}');
    hideReservationHeader();
}

// Show unavailable popup
function showUnavailablePopup(message, checkBackAtTimestamp) {
    // Convert timestamp (seconds) to Warsaw time
    const checkBackDate = new Date(checkBackAtTimestamp * 1000);
    const formatter = new Intl.DateTimeFormat('pl-PL', {
        timeZone: 'Europe/Warsaw',
        hour: '2-digit',
        minute: '2-digit'
    });
    const timeStr = formatter.format(checkBackDate);

    const modal = document.createElement('div');
    modal.className = 'unavailable-modal';
    modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10001;';
    modal.innerHTML = `
        <div class="unavailable-content" style="background:white;padding:32px;border-radius:12px;max-width:500px;text-align:center;">
            <div class="unavailable-icon" style="font-size:48px;margin-bottom:16px;">‚ö†Ô∏è</div>
            <h3 style="margin-bottom:16px;">Produkt zarezerwowany</h3>
            <p style="margin-bottom:16px;">${message}</p>
            <p class="check-back" style="margin-bottom:24px;">Sprawd≈∫ dostƒôpno≈õƒá o <strong>${timeStr}</strong></p>
            <button onclick="this.closest('.unavailable-modal').remove()" class="btn-close-modal" style="padding:12px 24px;background:#7B2CBF;color:white;border:none;border-radius:8px;cursor:pointer;">
                Rozumiem
            </button>
        </div>
    `;

    document.body.appendChild(modal);
}

// Replace original functions with reservation-aware versions
window.increaseQty = increaseQtyWithReservation;
window.decreaseQty = decreaseQtyWithReservation;

// ============================================
// Remove Item from Cart Functions
// ============================================

// Remove a regular product from cart (releases all reservations for this product)
async function removeProductFromCart(productId) {
    console.log(`[Cart] Removing product ${productId} from cart`);

    // Find the input for this product and get current quantity
    const productSection = document.querySelector(`[data-product-id="${productId}"]`);
    if (!productSection) {
        console.error(`[Cart] Product section not found for id ${productId}`);
        return;
    }

    const input = productSection.querySelector('.qty-input');
    if (!input) {
        console.error(`[Cart] Input not found for product ${productId}`);
        return;
    }

    const currentQty = parseInt(input.value) || 0;
    if (currentQty === 0) return;

    // Release all quantity for this product
    try {
        const response = await fetch(`/exclusive/{{ page.token }}/release`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                session_id: reservationState.sessionId,
                product_id: productId,
                quantity: currentQty
            })
        });

        const result = await response.json();
        console.log(`[Cart] Release result:`, result);

        // Set input to 0 regardless of API result
        input.value = 0;
        updateCart();

        // Check if this was the last reserved product
        await checkAvailability();

    } catch (error) {
        console.error('[Cart] Error releasing product:', error);
        // Still update the UI
        input.value = 0;
        updateCart();
    }
}

// Remove a full set from cart
function removeFullSetFromCart(sectionId) {
    console.log(`[Cart] Removing full set from section ${sectionId}`);

    // Find the full set section and its input
    const fullSetSection = document.querySelector(`.full-set-section[data-section-id="${sectionId}"]`);
    if (!fullSetSection) {
        console.error(`[Cart] Full set section not found for id ${sectionId}`);
        return;
    }

    const input = fullSetSection.querySelector('.full-set-qty-input');
    if (!input) {
        console.error(`[Cart] Full set input not found in section`);
        return;
    }

    const confettiContainer = fullSetSection.querySelector('.full-set-confetti-container');

    // Set to 0 and trigger fade-out animation
    input.value = 0;

    if (confettiContainer) {
        confettiContainer.classList.add('fade-out');
        setTimeout(() => {
            confettiContainer.classList.remove('has-items', 'fade-out');
        }, 500);
    }

    updateCart();
}

// ============================================
// Full Set Functions (No Reservation System)
// ============================================

// Store full set quantities (separate from regular products)
let fullSets = {};

// Increase full set quantity
function increaseFullSet(btn) {
    if (btn.disabled) return;

    const quantityControl = btn.closest('.quantity-control');
    if (!quantityControl) return;

    const input = quantityControl.querySelector('.qty-input');
    if (!input) return;

    const fullSetSection = btn.closest('.full-set-section');
    const confettiContainer = fullSetSection.querySelector('.full-set-confetti-container');
    const sectionId = fullSetSection.dataset.sectionId;

    let val = parseInt(input.value) || 0;
    input.value = val + 1;

    // Add has-items class for active state
    confettiContainer.classList.add('has-items');

    // Trigger confetti on first add (big celebration)
    if (val === 0) {
        triggerConfetti(fullSetSection, true); // true = big celebration
        // Add celebrate animation
        confettiContainer.classList.add('celebrate');
        setTimeout(() => {
            confettiContainer.classList.remove('celebrate');
        }, 800);
    } else {
        // Medium celebration for subsequent adds
        triggerConfetti(fullSetSection, false);
    }

    updateCart();
}

// Decrease full set quantity
function decreaseFullSet(btn) {
    if (btn.disabled) return;

    const quantityControl = btn.closest('.quantity-control');
    if (!quantityControl) return;

    const input = quantityControl.querySelector('.qty-input');
    if (!input) return;

    const fullSetSection = btn.closest('.full-set-section');
    const confettiContainer = fullSetSection.querySelector('.full-set-confetti-container');

    let val = parseInt(input.value) || 0;
    if (val > 0) {
        input.value = val - 1;

        // If going to 0, trigger fade-out animation
        if (val - 1 === 0) {
            confettiContainer.classList.add('fade-out');
            setTimeout(() => {
                confettiContainer.classList.remove('has-items', 'fade-out');
            }, 500);
        }

        updateCart();
    }
}

// Update full set quantity from input
function updateFullSetQty(input) {
    let val = parseInt(input.value) || 0;
    if (val < 0) val = 0;
    input.value = val;

    const fullSetSection = input.closest('.full-set-section');
    const confettiContainer = fullSetSection.querySelector('.full-set-confetti-container');

    // Update has-items class based on value
    if (val > 0) {
        if (!confettiContainer.classList.contains('has-items')) {
            confettiContainer.classList.add('has-items', 'celebrate');
            triggerConfetti(fullSetSection, true);
            setTimeout(() => {
                confettiContainer.classList.remove('celebrate');
            }, 800);
        }
    } else {
        confettiContainer.classList.add('fade-out');
        setTimeout(() => {
            confettiContainer.classList.remove('has-items', 'fade-out');
        }, 500);
    }

    updateCart();
}

// Confetti explosion effect
function triggerConfetti(container, isBig = true) {
    const confettiContainer = container.querySelector('.full-set-confetti-container');
    confettiContainer.classList.add('confetti-active');

    // More vibrant colors
    const colors = ['#ff6b6b', '#feca57', '#48dbfb', '#ff9ff3', '#54a0ff', '#5f27cd', '#00d2d3', '#ff9f43', '#ee5a24', '#ffffff'];
    const shapes = ['circle', 'circle', 'square', 'star', 'circle'];

    // More particles for big celebration
    const particleCount = isBig ? 35 : 18;
    const spreadMultiplier = isBig ? 1.5 : 1;
    const duration = isBig ? 1 : 0.7;

    for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = `confetti-particle ${shapes[Math.floor(Math.random() * shapes.length)]}`;

        // Start from center-right (near plus button)
        const startX = 80 + (Math.random() - 0.5) * 20;
        const startY = 50 + (Math.random() - 0.5) * 30;

        // Spread in all directions
        const angle = (Math.random() * 360) * (Math.PI / 180);
        const distance = 60 + Math.random() * 100 * spreadMultiplier;
        const tx = Math.cos(angle) * distance;
        const ty = Math.sin(angle) * distance - 40; // Bias upward
        const rot = Math.random() * 720 - 360;

        const size = isBig ? (6 + Math.random() * 8) : (5 + Math.random() * 5);

        particle.style.cssText = `
            left: ${startX}%;
            top: ${startY}%;
            width: ${size}px;
            height: ${size}px;
            background: ${colors[Math.floor(Math.random() * colors.length)]};
            --tx: ${tx}px;
            --ty: ${ty}px;
            --rot: ${rot}deg;
            animation: confettiExplode ${duration}s ease-out forwards;
            animation-delay: ${Math.random() * 0.1}s;
        `;

        confettiContainer.appendChild(particle);

        setTimeout(() => {
            particle.remove();
        }, duration * 1000 + 200);
    }

    setTimeout(() => {
        confettiContainer.classList.remove('confetti-active');
    }, 400);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initReservationSystem();
    initFullSetButtons();
});

// Initialize full set button states
function initFullSetButtons() {
    document.querySelectorAll('.full-set-qty-input').forEach(input => {
        const val = parseInt(input.value) || 0;
        const quantityControl = input.closest('.quantity-control');
        const minusBtn = quantityControl.querySelector('.qty-minus');

        if (val <= 0) {
            minusBtn.disabled = true;
            minusBtn.style.opacity = '0.5';
            minusBtn.style.cursor = 'not-allowed';
        }
    });
}
</script>
{% endblock %}
