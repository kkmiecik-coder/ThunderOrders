{% extends "client/base_client.html" %}

{% block title %}Dashboard Klienta - ThunderOrders{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/client/dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="client-dashboard">
    <!-- Header -->
    <div class="dashboard-header">
        <div class="header-content">
            <h1 class="dashboard-title">
                Witaj z powrotem, <span class="title-gradient">{{ current_user.first_name }}!</span>
            </h1>
        </div>
    </div>

    <!-- Kafelki z metrykami -->
    <div class="dashboard-metrics">
        <!-- RzƒÖd 1: Zam√≥wienia -->
        <div class="metric-card">
            <div class="metric-icon">üì¶</div>
            <div class="metric-content">
                <h3 class="metric-title">Wszystkie zam√≥wienia</h3>
                <p class="metric-value">{{ orders.all }}</p>
                <p class="metric-subtitle">≈ÅƒÖcznie</p>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon">üöÄ</div>
            <div class="metric-content">
                <h3 class="metric-title">W realizacji</h3>
                <p class="metric-value">{{ orders.in_progress }}</p>
                <p class="metric-subtitle">Zam√≥wienia w trakcie</p>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon">‚úÖ</div>
            <div class="metric-content">
                <h3 class="metric-title">Dostarczone</h3>
                <p class="metric-value">{{ orders.delivered }}</p>
                <p class="metric-subtitle">Zako≈Ñczone</p>
            </div>
        </div>

        <!-- RzƒÖd 2: Payment Status -->
        <a href="{{ url_for('orders.client_list', payment_status='paid') }}" class="metric-card metric-card-success metric-card-clickable">
            <div class="metric-icon">üí∞</div>
            <div class="metric-content">
                <h3 class="metric-title">Zap≈Çacone</h3>
                <p class="metric-value">{{ payment.paid | format_currency }}</p>
                <p class="metric-subtitle">≈ÅƒÖcznie op≈Çacone</p>
            </div>
        </a>

        <a href="{{ url_for('orders.client_list', payment_status='unpaid') }}" class="metric-card metric-card-warning metric-card-clickable">
            <div class="metric-icon">üí≥</div>
            <div class="metric-content">
                <h3 class="metric-title">Do zap≈Çaty</h3>
                <p class="metric-value">{{ payment.to_pay | format_currency }}</p>
                <p class="metric-subtitle">Pozosta≈Ço do op≈Çacenia</p>
            </div>
        </a>
    </div>

    <!-- Grid: Wykres + Ostatnie zam√≥wienia -->
    <div class="dashboard-grid">
        <!-- Wykres zam√≥wie≈Ñ -->
        <div class="dashboard-section">
            <div class="widget">
                <div class="widget-header">
                    <h2 class="widget-title">Moje zam√≥wienia</h2>
                    <select id="chartPeriod" class="chart-period-select">
                        <option value="7">7 dni</option>
                        <option value="14">14 dni</option>
                        <option value="30" selected>30 dni</option>
                        <option value="90">3 miesiƒÖce</option>
                        <option value="180">6 miesiƒôcy</option>
                        <option value="365">12 miesiƒôcy</option>
                    </select>
                </div>
                <div class="widget-body">
                    <div class="chart-container">
                        <canvas id="ordersChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ostatnie zam√≥wienia -->
        <div class="dashboard-section">
            <div class="widget widget-orders">
                <div class="widget-header">
                    <h2 class="widget-title">üì¶ Ostatnie Zam√≥wienia</h2>
                    <a href="{{ url_for('orders.client_list') }}" class="widget-link">Zobacz wszystkie ‚Üí</a>
                </div>
                <div class="widget-body widget-body-table">
                    {% if recent_orders|length > 0 %}
                        <table class="recent-orders-table">
                            <thead>
                                <tr>
                                    <th>Numer</th>
                                    <th>Klient</th>
                                    <th>Status</th>
                                    <th class="text-right">Kwota</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in recent_orders %}
                                <tr onclick="window.location.href='{{ url_for('orders.client_detail', order_id=order.id) }}'" style="cursor: pointer;">
                                    <td>
                                        <span class="order-number-link">{{ order.order_number }}</span>
                                    </td>
                                    <td>
                                        <span class="order-client">{{ order.customer_name }}</span>
                                    </td>
                                    <td>
                                        <span class="order-status" style="background-color: {{ order.status_badge_color }}; color: white;">
                                            {{ order.status_display_name }}
                                        </span>
                                    </td>
                                    <td class="text-right">
                                        <span class="order-amount">{{ "%.2f"|format(order.effective_grand_total) }} PLN</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <div class="empty-state">
                            <p class="empty-icon">üì≠</p>
                            <p class="empty-text">Brak zam√≥wie≈Ñ</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
    const textColor = isDarkMode ? 'rgba(255, 255, 255, 0.8)' : '#424242';
    const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

    // Orders Chart
    const ordersCtx = document.getElementById('ordersChart');
    if (ordersCtx) {
        const ordersChart = new Chart(ordersCtx.getContext('2d'), {
            type: 'line',
            data: {
                labels: {{ chart_data['labels'] | tojson }},
                datasets: [{
                    label: 'Liczba zam√≥wie≈Ñ',
                    data: {{ chart_data['values'] | tojson }},
                    backgroundColor: 'rgba(255, 133, 0, 0.2)',
                    borderColor: '#FF8500',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#FF8500',
                    pointBorderColor: '#fff',
                    pointHoverRadius: 6,
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: isDarkMode ? 'rgba(0, 0, 0, 0.8)' : 'white',
                        titleColor: textColor,
                        bodyColor: textColor,
                        borderColor: gridColor,
                        borderWidth: 1,
                        padding: 12,
                        displayColors: false,
                        callbacks: {
                            label: function(context) {
                                return 'Zam√≥wienia: ' + context.parsed.y;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: textColor,
                            stepSize: 1,
                            precision: 0
                        },
                        grid: { color: gridColor }
                    },
                    x: {
                        ticks: {
                            color: textColor,
                            maxRotation: 45,
                            minRotation: 0
                        },
                        grid: { color: gridColor }
                    }
                }
            }
        });

        // Theme change listener
        document.addEventListener('themeChanged', function(e) {
            const newTheme = e.detail.theme;
            const newTextColor = newTheme === 'dark' ? 'rgba(255, 255, 255, 0.8)' : '#424242';
            const newGridColor = newTheme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

            ordersChart.options.scales.y.ticks.color = newTextColor;
            ordersChart.options.scales.y.grid.color = newGridColor;
            ordersChart.options.scales.x.ticks.color = newTextColor;
            ordersChart.options.scales.x.grid.color = newGridColor;
            ordersChart.options.plugins.tooltip.backgroundColor = newTheme === 'dark' ? 'rgba(0, 0, 0, 0.8)' : 'white';
            ordersChart.options.plugins.tooltip.titleColor = newTextColor;
            ordersChart.options.plugins.tooltip.bodyColor = newTextColor;
            ordersChart.update();
        });

        // Period change listener
        const periodSelect = document.getElementById('chartPeriod');
        if (periodSelect) {
            periodSelect.addEventListener('change', async function() {
                const period = this.value;

                try {
                    const response = await fetch(`/client/api/chart-data?period=${period}`);
                    const data = await response.json();

                    // Update chart data
                    ordersChart.data.labels = data.labels;
                    ordersChart.data.datasets[0].data = data.values;
                    ordersChart.update();
                } catch (error) {
                    console.error('Error fetching chart data:', error);
                }
            });
        }
    }
});
</script>
{% endblock %}
