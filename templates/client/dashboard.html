{% extends "client/base_client.html" %}

{% block title %}Dashboard Klienta - ThunderOrders{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/client/dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="client-dashboard">
    <!-- Header -->
    <div class="dashboard-header">
        <div class="header-content">
            <h1 class="dashboard-title">
                Witaj z powrotem, <span class="title-gradient">{{ current_user.first_name }}!</span>
            </h1>
        </div>
    </div>

    <!-- Kafelki z metrykami -->
    <div class="dashboard-metrics">
        <!-- RzƒÖd 1: Zam√≥wienia -->
        <a href="{{ url_for('orders.client_list') }}" class="metric-card metric-card-primary metric-card-clickable">
            <div class="metric-icon">üì¶</div>
            <div class="metric-content">
                <h3 class="metric-title">Wszystkie zam√≥wienia</h3>
                <p class="metric-value">{{ orders.all }}</p>
                <p class="metric-subtitle">≈ÅƒÖcznie</p>
            </div>
        </a>

        <a href="{{ url_for('orders.client_list', statuses='nowe,oczekujace,w_realizacji,spakowane,wyslane') }}" class="metric-card metric-card-progress metric-card-clickable">
            <div class="metric-icon">üöÄ</div>
            <div class="metric-content">
                <h3 class="metric-title">W realizacji</h3>
                <p class="metric-value">{{ orders.in_progress }}</p>
                <p class="metric-subtitle">Zam√≥wienia w trakcie</p>
            </div>
        </a>

        <a href="{{ url_for('orders.client_list', status='dostarczone') }}" class="metric-card metric-card-success metric-card-clickable">
            <div class="metric-icon">‚úÖ</div>
            <div class="metric-content">
                <h3 class="metric-title">Dostarczone</h3>
                <p class="metric-value">{{ orders.delivered }}</p>
                <p class="metric-subtitle">Zako≈Ñczone</p>
            </div>
        </a>

        <!-- RzƒÖd 2: Payment Status -->
        <a href="{{ url_for('orders.client_list', payment_status='unpaid') }}" class="metric-card metric-card-warning metric-card-clickable">
            <div class="metric-icon">üí≥</div>
            <div class="metric-content">
                <h3 class="metric-title">Do zap≈Çaty</h3>
                <p class="metric-value">{{ payment.to_pay | format_currency }}</p>
                <p class="metric-subtitle">Pozosta≈Ço do op≈Çacenia</p>
            </div>
        </a>

        <a href="{{ url_for('client.shipping_requests_list') }}" class="metric-card metric-card-info metric-card-clickable">
            <div class="metric-icon">üì¨</div>
            <div class="metric-content">
                <h3 class="metric-title">Czeka na wysy≈Çkƒô</h3>
                <p class="metric-value">{{ orders.awaiting_shipping }}</p>
                <p class="metric-subtitle">Zleƒá wysy≈Çkƒô</p>
            </div>
        </a>
    </div>

    <!-- Exclusive Pages Widget -->
    {% if exclusive_pages.visible|length > 0 %}
    <div class="exclusive-widget-container">
        <div class="widget widget-exclusive" id="exclusiveWidget">
            <div class="widget-header">
                <h2 class="widget-title">‚ú® Strony Exclusive</h2>
            </div>
            <div class="widget-body widget-body-table">
                <!-- Desktop: Table view -->
                <table class="exclusive-table exclusive-desktop">
                    <thead>
                        <tr>
                            <th>Nazwa</th>
                            <th>Status</th>
                            <th>Czas</th>
                            <th class="text-center">Link</th>
                        </tr>
                    </thead>
                    <tbody id="exclusiveTableBody">
                        {# Visible pages #}
                        {% for page in exclusive_pages.visible %}
                        <tr>
                            <td>
                                <span class="exclusive-name">{{ page.name }}</span>
                            </td>
                            <td>
                                {% if page.status == 'active' %}
                                    <span class="exclusive-status exclusive-status-live">
                                        <span class="live-dot"></span>LIVE
                                    </span>
                                {% elif page.status == 'ended' and page.is_fully_closed %}
                                    <span class="exclusive-status exclusive-status-closed">Zamkniƒôta</span>
                                {% elif page.status == 'ended' %}
                                    <span class="exclusive-status exclusive-status-ended">Zako≈Ñczona</span>
                                {% else %}
                                    <span class="exclusive-status exclusive-status-{{ page.status }}">
                                        {% if page.status == 'scheduled' %}Zaplanowana
                                        {% elif page.status == 'paused' %}Wstrzymana
                                        {% endif %}
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="exclusive-timing{% if page.status in ['active', 'scheduled'] %} exclusive-timing-important{% endif %}"
                                      data-status="{{ page.status }}"
                                      data-starts="{{ page.starts_at.isoformat() if page.starts_at else '' }}"
                                      data-ends="{{ page.ends_at.isoformat() if page.ends_at else '' }}">
                                </span>
                            </td>
                            <td class="text-center">
                                <a href="{{ url_for('exclusive.order_page', token=page.token) }}" class="exclusive-link-btn" target="_blank">
                                    Otw√≥rz ‚Üí
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                        {# Buffer pages (hidden) #}
                        {% for page in exclusive_pages.buffer %}
                        <tr class="exclusive-buffered" style="display: none;">
                            <td>
                                <span class="exclusive-name">{{ page.name }}</span>
                            </td>
                            <td>
                                {% if page.status == 'active' %}
                                    <span class="exclusive-status exclusive-status-live">
                                        <span class="live-dot"></span>LIVE
                                    </span>
                                {% elif page.status == 'ended' and page.is_fully_closed %}
                                    <span class="exclusive-status exclusive-status-closed">Zamkniƒôta</span>
                                {% elif page.status == 'ended' %}
                                    <span class="exclusive-status exclusive-status-ended">Zako≈Ñczona</span>
                                {% else %}
                                    <span class="exclusive-status exclusive-status-{{ page.status }}">
                                        {% if page.status == 'scheduled' %}Zaplanowana
                                        {% elif page.status == 'paused' %}Wstrzymana
                                        {% endif %}
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="exclusive-timing{% if page.status in ['active', 'scheduled'] %} exclusive-timing-important{% endif %}"
                                      data-status="{{ page.status }}"
                                      data-starts="{{ page.starts_at.isoformat() if page.starts_at else '' }}"
                                      data-ends="{{ page.ends_at.isoformat() if page.ends_at else '' }}">
                                </span>
                            </td>
                            <td class="text-center">
                                <a href="{{ url_for('exclusive.order_page', token=page.token) }}" class="exclusive-link-btn" target="_blank">
                                    Otw√≥rz ‚Üí
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <!-- Mobile: Cards view -->
                <div class="exclusive-cards exclusive-mobile" id="exclusiveCardsBody">
                    {# Visible pages #}
                    {% for page in exclusive_pages.visible %}
                    <div class="exclusive-card">
                        <div class="exclusive-card-header">
                            <span class="exclusive-name">{{ page.name }}</span>
                            {% if page.status == 'active' %}
                                <span class="exclusive-status exclusive-status-live">
                                    <span class="live-dot"></span>LIVE
                                </span>
                            {% elif page.status == 'ended' and page.is_fully_closed %}
                                <span class="exclusive-status exclusive-status-closed">Zamkniƒôta</span>
                            {% elif page.status == 'ended' %}
                                <span class="exclusive-status exclusive-status-ended">Zako≈Ñczona</span>
                            {% else %}
                                <span class="exclusive-status exclusive-status-{{ page.status }}">
                                    {% if page.status == 'scheduled' %}Zaplanowana
                                    {% elif page.status == 'paused' %}Wstrzymana
                                    {% endif %}
                                </span>
                            {% endif %}
                        </div>
                        <div class="exclusive-card-footer">
                            <span class="exclusive-timing{% if page.status in ['active', 'scheduled'] %} exclusive-timing-important{% endif %}"
                                  data-status="{{ page.status }}"
                                  data-starts="{{ page.starts_at.isoformat() if page.starts_at else '' }}"
                                  data-ends="{{ page.ends_at.isoformat() if page.ends_at else '' }}">
                            </span>
                            <a href="{{ url_for('exclusive.order_page', token=page.token) }}" class="exclusive-card-btn" target="_blank">
                                Otw√≥rz ‚Üí
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                    {# Buffer pages (hidden) #}
                    {% for page in exclusive_pages.buffer %}
                    <div class="exclusive-card exclusive-buffered" style="display: none;">
                        <div class="exclusive-card-header">
                            <span class="exclusive-name">{{ page.name }}</span>
                            {% if page.status == 'active' %}
                                <span class="exclusive-status exclusive-status-live">
                                    <span class="live-dot"></span>LIVE
                                </span>
                            {% elif page.status == 'ended' and page.is_fully_closed %}
                                <span class="exclusive-status exclusive-status-closed">Zamkniƒôta</span>
                            {% elif page.status == 'ended' %}
                                <span class="exclusive-status exclusive-status-ended">Zako≈Ñczona</span>
                            {% else %}
                                <span class="exclusive-status exclusive-status-{{ page.status }}">
                                    {% if page.status == 'scheduled' %}Zaplanowana
                                    {% elif page.status == 'paused' %}Wstrzymana
                                    {% endif %}
                                </span>
                            {% endif %}
                        </div>
                        <div class="exclusive-card-footer">
                            <span class="exclusive-timing{% if page.status in ['active', 'scheduled'] %} exclusive-timing-important{% endif %}"
                                  data-status="{{ page.status }}"
                                  data-starts="{{ page.starts_at.isoformat() if page.starts_at else '' }}"
                                  data-ends="{{ page.ends_at.isoformat() if page.ends_at else '' }}">
                            </span>
                            <a href="{{ url_for('exclusive.order_page', token=page.token) }}" class="exclusive-card-btn" target="_blank">
                                Otw√≥rz ‚Üí
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                {% if exclusive_pages.remaining > 0 %}
                <div class="exclusive-show-more" id="exclusiveShowMore">
                    <button type="button" class="show-more-btn" id="exclusiveLoadMoreBtn"
                            data-visible="{{ exclusive_pages.visible|length }}"
                            data-buffer="{{ exclusive_pages.buffer|length }}"
                            data-total="{{ exclusive_pages.total }}"
                            data-remaining="{{ exclusive_pages.remaining }}">
                        Poka≈º {{ [exclusive_pages.remaining, 5]|min }} wiƒôcej ‚Üí
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Grid: Wykres + Ostatnie zam√≥wienia -->
    <div class="dashboard-grid">
        <!-- Wykres zam√≥wie≈Ñ -->
        <div class="dashboard-section">
            <div class="widget">
                <div class="widget-header">
                    <h2 class="widget-title">Moje zam√≥wienia</h2>
                    <select id="chartPeriod" class="chart-period-select">
                        <option value="7">7 dni</option>
                        <option value="14">14 dni</option>
                        <option value="30" selected>30 dni</option>
                        <option value="90">3 miesiƒÖce</option>
                        <option value="180">6 miesiƒôcy</option>
                        <option value="365">12 miesiƒôcy</option>
                    </select>
                </div>
                <div class="widget-body">
                    <div class="chart-container">
                        <canvas id="ordersChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ostatnie zam√≥wienia -->
        <div class="dashboard-section">
            <div class="widget widget-orders" id="recentOrdersWidget">
                <div class="widget-header">
                    <h2 class="widget-title">üì¶ Ostatnie Zam√≥wienia</h2>
                    <a href="{{ url_for('orders.client_list') }}" class="widget-link">Zobacz wszystkie ‚Üí</a>
                </div>
                <div class="widget-body widget-body-table">
                    {% if recent_orders.visible|length > 0 %}
                        <table class="recent-orders-table">
                            <thead>
                                <tr>
                                    <th>Numer</th>
                                    <th>Klient</th>
                                    <th>Status</th>
                                    <th class="text-right">Kwota</th>
                                </tr>
                            </thead>
                            <tbody id="recentOrdersTableBody">
                                {# Visible orders #}
                                {% for order in recent_orders.visible %}
                                <tr onclick="window.location.href='{{ url_for('orders.client_detail', order_id=order.id) }}'" style="cursor: pointer;">
                                    <td>
                                        <span class="order-number-link">{{ order.order_number }}</span>
                                    </td>
                                    <td>
                                        <span class="order-client">{{ order.customer_name }}</span>
                                    </td>
                                    <td>
                                        <span class="order-status" style="background-color: {{ order.status_badge_color }}; color: white;">
                                            {{ order.status_display_name }}
                                        </span>
                                    </td>
                                    <td class="text-right">
                                        <span class="order-amount">{{ "%.2f"|format(order.effective_grand_total) }} PLN</span>
                                    </td>
                                </tr>
                                {% endfor %}
                                {# Buffer orders (hidden, will be shown on "load more") #}
                                {% for order in recent_orders.buffer %}
                                <tr class="orders-buffered" style="display: none;" onclick="window.location.href='{{ url_for('orders.client_detail', order_id=order.id) }}'">
                                    <td>
                                        <span class="order-number-link">{{ order.order_number }}</span>
                                    </td>
                                    <td>
                                        <span class="order-client">{{ order.customer_name }}</span>
                                    </td>
                                    <td>
                                        <span class="order-status" style="background-color: {{ order.status_badge_color }}; color: white;">
                                            {{ order.status_display_name }}
                                        </span>
                                    </td>
                                    <td class="text-right">
                                        <span class="order-amount">{{ "%.2f"|format(order.effective_grand_total) }} PLN</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% if recent_orders.remaining > 0 %}
                            <div class="orders-show-more" id="ordersShowMore">
                                <button type="button" class="show-more-btn" id="ordersLoadMoreBtn"
                                        data-visible="{{ recent_orders.visible|length }}"
                                        data-buffer="{{ recent_orders.buffer|length }}"
                                        data-total="{{ recent_orders.total }}"
                                        data-remaining="{{ recent_orders.remaining }}">
                                    Poka≈º {{ [recent_orders.remaining, 5]|min }} wiƒôcej ‚Üí
                                </button>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="empty-state">
                            <p class="empty-icon">üì≠</p>
                            <p class="empty-text">Brak zam√≥wie≈Ñ</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
    const textColor = isDarkMode ? 'rgba(255, 255, 255, 0.8)' : '#424242';
    const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

    // Orders Chart
    const ordersCtx = document.getElementById('ordersChart');
    if (ordersCtx) {
        const ordersChart = new Chart(ordersCtx.getContext('2d'), {
            type: 'line',
            data: {
                labels: {{ chart_data['labels'] | tojson }},
                datasets: [{
                    label: 'Liczba zam√≥wie≈Ñ',
                    data: {{ chart_data['values'] | tojson }},
                    backgroundColor: 'rgba(255, 133, 0, 0.2)',
                    borderColor: '#FF8500',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#FF8500',
                    pointBorderColor: '#fff',
                    pointHoverRadius: 6,
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: isDarkMode ? 'rgba(0, 0, 0, 0.8)' : 'white',
                        titleColor: textColor,
                        bodyColor: textColor,
                        borderColor: gridColor,
                        borderWidth: 1,
                        padding: 12,
                        displayColors: false,
                        callbacks: {
                            label: function(context) {
                                return 'Zam√≥wienia: ' + context.parsed.y;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: textColor,
                            stepSize: 1,
                            precision: 0
                        },
                        grid: { color: gridColor }
                    },
                    x: {
                        ticks: {
                            color: textColor,
                            maxRotation: 45,
                            minRotation: 0
                        },
                        grid: { color: gridColor }
                    }
                }
            }
        });

        // Theme change listener
        document.addEventListener('themeChanged', function(e) {
            const newTheme = e.detail.theme;
            const newTextColor = newTheme === 'dark' ? 'rgba(255, 255, 255, 0.8)' : '#424242';
            const newGridColor = newTheme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

            ordersChart.options.scales.y.ticks.color = newTextColor;
            ordersChart.options.scales.y.grid.color = newGridColor;
            ordersChart.options.scales.x.ticks.color = newTextColor;
            ordersChart.options.scales.x.grid.color = newGridColor;
            ordersChart.options.plugins.tooltip.backgroundColor = newTheme === 'dark' ? 'rgba(0, 0, 0, 0.8)' : 'white';
            ordersChart.options.plugins.tooltip.titleColor = newTextColor;
            ordersChart.options.plugins.tooltip.bodyColor = newTextColor;
            ordersChart.update();
        });

        // Period change listener
        const periodSelect = document.getElementById('chartPeriod');
        if (periodSelect) {
            periodSelect.addEventListener('change', async function() {
                const period = this.value;

                try {
                    const response = await fetch(`/client/api/chart-data?period=${period}`);
                    const data = await response.json();

                    // Update chart data
                    ordersChart.data.labels = data.labels;
                    ordersChart.data.datasets[0].data = data.values;
                    ordersChart.update();
                } catch (error) {
                    console.error('Error fetching chart data:', error);
                }
            });
        }
    }

    // ====================================
    // EXCLUSIVE PAGES - DYNAMIC TIMING
    // ====================================
    function updateExclusiveTimings() {
        const timingElements = document.querySelectorAll('.exclusive-timing');
        const now = new Date();

        timingElements.forEach(el => {
            const status = el.dataset.status;
            const startsAt = el.dataset.starts ? new Date(el.dataset.starts) : null;
            const endsAt = el.dataset.ends ? new Date(el.dataset.ends) : null;

            let text = '';

            if (status === 'scheduled' && startsAt) {
                const diffMs = startsAt - now;
                const diffHours = diffMs / (1000 * 60 * 60);

                if (diffHours > 24) {
                    // > 24h - show date and time
                    text = `Start: ${formatDateTime(startsAt)}`;
                } else if (diffMs > 0) {
                    // < 24h - show countdown
                    text = `Aktywna za ${formatCountdown(diffMs)}`;
                } else {
                    text = 'Oczekuje na start';
                }
            } else if (status === 'active') {
                if (endsAt) {
                    const diffMs = endsAt - now;
                    if (diffMs > 0) {
                        text = `Zamkniƒôcie za ${formatCountdown(diffMs)}`;
                    } else {
                        text = 'Ko≈Ñczy siƒô...';
                    }
                } else {
                    text = 'Bez daty zako≈Ñczenia';
                }
            } else if (status === 'ended') {
                if (endsAt) {
                    text = `Zamkniƒôto ${formatDateTime(endsAt)}`;
                } else {
                    text = 'Zako≈Ñczona';
                }
            } else if (status === 'paused') {
                text = 'Sprzeda≈º wstrzymana';
            } else {
                text = '‚Äî';
            }

            el.textContent = text;
        });
    }

    function formatDateTime(date) {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${day}.${month}.${year} ${hours}:${minutes}`;
    }

    function formatCountdown(ms) {
        const totalSeconds = Math.floor(ms / 1000);
        const days = Math.floor(totalSeconds / 86400);
        const hours = Math.floor((totalSeconds % 86400) / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);

        if (days > 0) {
            return `${days}d ${hours}h`;
        } else if (hours > 0) {
            return `${hours}h ${minutes}m`;
        } else {
            return `${minutes}m`;
        }
    }

    // Initial update and refresh every minute
    updateExclusiveTimings();
    setInterval(updateExclusiveTimings, 60000);

    // ====================================
    // EXCLUSIVE PAGES - LAZY LOADING
    // ====================================
    (function() {
        const loadMoreBtn = document.getElementById('exclusiveLoadMoreBtn');
        const tableBody = document.getElementById('exclusiveTableBody');
        const cardsBody = document.getElementById('exclusiveCardsBody');
        const showMoreContainer = document.getElementById('exclusiveShowMore');

        if (!loadMoreBtn) return;

        let currentOffset = parseInt(loadMoreBtn.dataset.visible) + parseInt(loadMoreBtn.dataset.buffer);
        let isLoading = false;

        // Create table row HTML from page data
        function createTableRowHTML(page) {
            const statusHTML = getStatusHTML(page);
            const timingClass = page.status === 'active' || page.status === 'scheduled' ? ' exclusive-timing-important' : '';

            return `
                <tr>
                    <td><span class="exclusive-name">${page.name}</span></td>
                    <td>${statusHTML}</td>
                    <td>
                        <span class="exclusive-timing${timingClass}"
                              data-status="${page.status}"
                              data-starts="${page.starts_at || ''}"
                              data-ends="${page.ends_at || ''}">
                        </span>
                    </td>
                    <td class="text-center">
                        <a href="${page.page_url}" class="exclusive-link-btn" target="_blank">Otw√≥rz ‚Üí</a>
                    </td>
                </tr>
            `;
        }

        // Create card HTML from page data
        function createCardHTML(page) {
            const statusHTML = getStatusHTML(page);
            const timingClass = page.status === 'active' || page.status === 'scheduled' ? ' exclusive-timing-important' : '';

            return `
                <div class="exclusive-card">
                    <div class="exclusive-card-header">
                        <span class="exclusive-name">${page.name}</span>
                        ${statusHTML}
                    </div>
                    <div class="exclusive-card-footer">
                        <span class="exclusive-timing${timingClass}"
                              data-status="${page.status}"
                              data-starts="${page.starts_at || ''}"
                              data-ends="${page.ends_at || ''}">
                        </span>
                        <a href="${page.page_url}" class="exclusive-card-btn" target="_blank">Otw√≥rz ‚Üí</a>
                    </div>
                </div>
            `;
        }

        // Get status badge HTML
        function getStatusHTML(page) {
            if (page.is_live) {
                return '<span class="exclusive-status exclusive-status-live"><span class="live-dot"></span>LIVE</span>';
            }
            return `<span class="exclusive-status exclusive-status-${page.status_class}">${page.status_text}</span>`;
        }

        // Fetch more pages from API
        async function fetchMorePages(offset, limit = 5) {
            try {
                const response = await fetch(`/client/api/exclusive-pages?offset=${offset}&limit=${limit}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching exclusive pages:', error);
                return null;
            }
        }

        // Update button text
        function updateButtonText(remaining) {
            if (remaining <= 0) {
                showMoreContainer.style.display = 'none';
            } else {
                loadMoreBtn.textContent = `Poka≈º ${Math.min(remaining, 5)} wiƒôcej ‚Üí`;
                loadMoreBtn.dataset.remaining = remaining;
            }
        }

        // Handle load more click
        loadMoreBtn.addEventListener('click', async function(e) {
            e.preventDefault();

            if (isLoading) return;

            // 1. Show buffered items first (both table rows and cards)
            const bufferedRows = tableBody ? tableBody.querySelectorAll('.exclusive-buffered') : [];
            const bufferedCards = cardsBody ? cardsBody.querySelectorAll('.exclusive-buffered') : [];
            let shownFromBuffer = 0;

            bufferedRows.forEach((row, index) => {
                if (index < 5 && row.style.display === 'none') {
                    row.style.display = '';
                    row.classList.remove('exclusive-buffered');
                    shownFromBuffer++;
                }
            });

            bufferedCards.forEach((card, index) => {
                if (index < 5 && card.style.display === 'none') {
                    card.style.display = '';
                    card.classList.remove('exclusive-buffered');
                }
            });

            // Calculate new remaining
            let remaining = parseInt(loadMoreBtn.dataset.remaining) - shownFromBuffer;

            // 2. If we showed buffered items, fetch more for the buffer in background
            if (shownFromBuffer > 0 && remaining > 0) {
                isLoading = true;
                loadMoreBtn.textContent = '≈Åadowanie...';

                const data = await fetchMorePages(currentOffset, 5);

                if (data && data.success && data.pages.length > 0) {
                    // Add new rows as buffered (hidden)
                    data.pages.forEach(page => {
                        // Add table row
                        if (tableBody) {
                            const rowHTML = createTableRowHTML(page);
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = rowHTML;
                            const newRow = tempDiv.firstElementChild;
                            newRow.classList.add('exclusive-buffered');
                            newRow.style.display = 'none';
                            tableBody.appendChild(newRow);
                        }

                        // Add card
                        if (cardsBody) {
                            const cardHTML = createCardHTML(page);
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = cardHTML;
                            const newCard = tempDiv.firstElementChild;
                            newCard.classList.add('exclusive-buffered');
                            newCard.style.display = 'none';
                            cardsBody.appendChild(newCard);
                        }
                    });

                    currentOffset += data.pages.length;

                    // Update timing displays for newly added elements
                    updateExclusiveTimings();
                }

                isLoading = false;
            }

            // Recalculate remaining based on actual visible items
            const visibleRows = tableBody ? tableBody.querySelectorAll('tr:not([style*="display: none"])').length : 0;
            const total = parseInt(loadMoreBtn.dataset.total);
            remaining = Math.max(0, total - visibleRows);

            updateButtonText(remaining);
        });
    })();

    // ====================================
    // RECENT ORDERS - LAZY LOADING
    // ====================================
    (function() {
        const loadMoreBtn = document.getElementById('ordersLoadMoreBtn');
        const tableBody = document.getElementById('recentOrdersTableBody');
        const showMoreContainer = document.getElementById('ordersShowMore');

        if (!loadMoreBtn || !tableBody) return;

        let currentOffset = parseInt(loadMoreBtn.dataset.visible) + parseInt(loadMoreBtn.dataset.buffer);
        let isLoading = false;

        // Create row HTML from order data
        function createRowHTML(order) {
            return `
                <tr onclick="window.location.href='${order.detail_url}'" style="cursor: pointer;">
                    <td>
                        <span class="order-number-link">${order.order_number}</span>
                    </td>
                    <td>
                        <span class="order-client">${order.customer_name}</span>
                    </td>
                    <td>
                        <span class="order-status" style="background-color: ${order.status_badge_color}; color: white;">
                            ${order.status_display_name}
                        </span>
                    </td>
                    <td class="text-right">
                        <span class="order-amount">${order.effective_grand_total.toFixed(2)} PLN</span>
                    </td>
                </tr>
            `;
        }

        // Fetch more orders from API
        async function fetchMoreOrders(offset, limit = 5) {
            try {
                const response = await fetch(`/client/api/recent-orders?offset=${offset}&limit=${limit}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching recent orders:', error);
                return null;
            }
        }

        // Update button text
        function updateButtonText(remaining) {
            if (remaining <= 0) {
                showMoreContainer.style.display = 'none';
            } else {
                loadMoreBtn.textContent = `Poka≈º ${Math.min(remaining, 5)} wiƒôcej ‚Üí`;
                loadMoreBtn.dataset.remaining = remaining;
            }
        }

        // Handle load more click
        loadMoreBtn.addEventListener('click', async function(e) {
            e.preventDefault();

            if (isLoading) return;

            // 1. Show buffered rows first
            const bufferedRows = tableBody.querySelectorAll('.orders-buffered');
            let shownFromBuffer = 0;

            bufferedRows.forEach((row, index) => {
                if (index < 5 && row.style.display === 'none') {
                    row.style.display = '';
                    row.classList.remove('orders-buffered');
                    shownFromBuffer++;
                }
            });

            // Calculate new remaining
            let remaining = parseInt(loadMoreBtn.dataset.remaining) - shownFromBuffer;

            // 2. If we showed buffered rows, fetch more for the buffer in background
            if (shownFromBuffer > 0 && remaining > 0) {
                isLoading = true;
                loadMoreBtn.textContent = '≈Åadowanie...';

                const data = await fetchMoreOrders(currentOffset, 5);

                if (data && data.success && data.orders.length > 0) {
                    // Add new rows as buffered (hidden)
                    data.orders.forEach(order => {
                        const rowHTML = createRowHTML(order);
                        const tempTable = document.createElement('table');
                        tempTable.innerHTML = `<tbody>${rowHTML}</tbody>`;
                        const newRow = tempTable.querySelector('tr');
                        newRow.classList.add('orders-buffered');
                        newRow.style.display = 'none';
                        tableBody.appendChild(newRow);
                    });

                    currentOffset += data.orders.length;
                }

                isLoading = false;
            }

            // Recalculate remaining based on actual visible rows
            const visibleRows = tableBody.querySelectorAll('tr:not([style*="display: none"])').length;
            const total = parseInt(loadMoreBtn.dataset.total);
            remaining = Math.max(0, total - visibleRows);

            updateButtonText(remaining);
        });
    })();
});
</script>
{% endblock %}
