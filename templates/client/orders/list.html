{% extends "client/base_client.html" %}

{% block title %}Moje zam√≥wienia - ThunderOrders{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/client/orders.css') }}">
{% endblock %}

{% block content %}
<div class="orders-list-page client-view">
    <!-- Page Header -->
    <div class="page-header">
        <h1>Moje zam√≥wienia</h1>
    </div>

    <!-- Filters Panel -->
    <div class="filters-panel">
        <form method="get" action="{{ url_for('orders.client_list') }}" class="client-filters" id="filters-form">
            <!-- Status Filter (Custom Multi-Select) -->
            <div class="form-group">
                <label for="status-input">STATUS:</label>
                <div class="custom-select-wrapper" id="status-select-wrapper">
                    <div class="custom-select-trigger" id="status-trigger">
                        <span id="status-label">Wszystkie</span>
                        <svg class="select-arrow" width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                            <path d="M2 4l4 4 4-4" stroke="currentColor" stroke-width="2" fill="none"/>
                        </svg>
                    </div>
                    <div class="custom-select-dropdown" id="status-dropdown">
                        <div class="select-option" data-value="">
                            <span>Wszystkie</span>
                        </div>
                        {% for status in statuses %}
                        <div class="select-option" data-value="{{ status.slug }}">
                            <span>{{ status.name }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    <input type="hidden" name="status" id="status-input" value="{{ request.args.get('status', '') }}">
                </div>
            </div>

            <!-- Date From Filter -->
            <div class="form-group">
                <label for="date_from">OD:</label>
                <input type="date" name="date_from" id="date_from" class="form-input" value="{{ request.args.get('date_from', '') }}">
            </div>

            <!-- Date To Filter -->
            <div class="form-group">
                <label for="date_to">DO:</label>
                <input type="date" name="date_to" id="date_to" class="form-input" value="{{ request.args.get('date_to', '') }}">
            </div>

            <!-- Search Filter (NEW) -->
            <div class="form-group form-group-search">
                <label for="search">SZUKAJ:</label>
                <div class="input-icon-wrapper">
                    <svg class="input-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <input type="text"
                           name="search"
                           id="search"
                           class="form-input form-input-icon"
                           placeholder="Numer zam√≥wienia..."
                           value="{{ request.args.get('search', '') }}">
                </div>
            </div>

            <!-- Filter Button -->
            <div class="form-group">
                <button type="submit" class="btn btn-primary">Filtruj</button>
            </div>
        </form>

        <!-- Active Filters Badges -->
        <div class="active-filters" id="active-filters" style="display: none;">
            <div class="filters-badges" id="filters-badges">
                <!-- Badges will be dynamically added here -->
            </div>
            <a href="{{ url_for('orders.client_list') }}" class="btn btn-clear" id="clear-filters-btn">Wyczy≈õƒá</a>
        </div>
    </div>

    <!-- Orders Table -->
    <div class="table-container">
        {% if orders.items %}
        <table class="orders-table orders-table-new">
            <thead>
                <tr>
                    <th class="col-number">Numer</th>
                    <th class="col-items hide-mobile">Przedmioty</th>
                    <th class="col-amount text-right">Kwota</th>
                    <th class="col-extra">Info dodatkowe</th>
                    <th class="col-date">Data z≈Ço≈ºenia</th>
                    <th class="col-actions">Akcje</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders.items %}
                <tr data-order-id="{{ order.id }}">
                    <!-- Kolumna 1: Numer zam√≥wienia -->
                    <td class="col-number" data-label="Numer">
                        <a href="{{ url_for('orders.client_detail', order_id=order.id) }}" class="order-number-link">
                            {{ order.order_number }}
                        </a>
                    </td>

                    <!-- Kolumna 2: Przedmioty (max 3 + toggle) -->
                    <td class="col-items hide-mobile" data-label="Przedmioty">
                        <div class="items-list">
                            {% set visible_items = order.items[:3] %}
                            {% set hidden_items = order.items[3:] %}

                            {% for item in visible_items %}
                            <div class="item-row{% if item.is_full_set %} item-full-set{% elif item.is_custom %} item-custom{% endif %}">
                                <div class="item-thumb-wrapper">
                                    {% if item.is_full_set %}
                                    <div class="item-thumb item-thumb-icon" style="background: linear-gradient(135deg, #9D4EDD 0%, #7B2CBF 100%);">‚ú®</div>
                                    {% elif item.is_custom %}
                                    <div class="item-thumb item-thumb-icon" style="background: linear-gradient(135deg, #FF8500 0%, #FF6D00 100%);">üì¶</div>
                                    {% else %}
                                    <img src="{{ item.product_image_url }}" alt="" class="item-thumb" loading="lazy">
                                    {% endif %}

                                    {% if item.quantity > 1 %}
                                    <span class="item-qty-badge">{{ item.quantity }}</span>
                                    {% endif %}
                                </div>
                                <div class="item-details">
                                    <span class="item-name" title="{{ item.product_name }}">
                                        {{ item.quantity }}√ó {{ item.product_name|truncate(35, True) }}
                                    </span>
                                    <span class="item-price">{{ "%.2f"|format(item.price) }} z≈Ç/szt</span>
                                </div>
                            </div>
                            {% endfor %}

                            <!-- Ukryte produkty (toggle) -->
                            {% if hidden_items|length > 0 %}
                            <div class="items-hidden" id="hiddenItems-{{ order.id }}" style="display: none;">
                                {% for item in hidden_items %}
                                <div class="item-row{% if item.is_full_set %} item-full-set{% elif item.is_custom %} item-custom{% endif %}">
                                    <div class="item-thumb-wrapper">
                                        {% if item.is_full_set %}
                                        <div class="item-thumb item-thumb-icon" style="background: linear-gradient(135deg, #9D4EDD 0%, #7B2CBF 100%);">‚ú®</div>
                                        {% elif item.is_custom %}
                                        <div class="item-thumb item-thumb-icon" style="background: linear-gradient(135deg, #FF8500 0%, #FF6D00 100%);">üì¶</div>
                                        {% else %}
                                        <img src="{{ item.product_image_url }}" alt="" class="item-thumb" loading="lazy">
                                        {% endif %}
                                        {% if item.quantity > 1 %}
                                        <span class="item-qty-badge">{{ item.quantity }}</span>
                                        {% endif %}
                                    </div>
                                    <div class="item-details">
                                        <span class="item-name" title="{{ item.product_name }}">
                                            {{ item.quantity }}√ó {{ item.product_name|truncate(35, True) }}
                                        </span>
                                        <span class="item-price">{{ "%.2f"|format(item.price) }} z≈Ç/szt</span>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <button type="button" class="items-toggle-btn" onclick="toggleOrderItems({{ order.id }}, {{ order.items|length }})">
                                <span class="toggle-text">W sumie {{ order.items|length }} przedmiot√≥w - poka≈º pozosta≈Çe</span>
                            </button>
                            {% endif %}
                        </div>
                    </td>

                    <!-- Kolumna 3: Kwota -->
                    <td class="col-amount text-right" data-label="Kwota">
                        <span class="amount-cell">{{ "%.2f"|format(order.total_amount) }} PLN</span>
                    </td>

                    <!-- Kolumna 4: Info dodatkowe (status + ikony) -->
                    <td class="col-extra" data-label="Info">
                        <div class="extra-info">
                            <!-- Status badge -->
                            <span class="badge status-badge" style="background-color: {{ order.status_badge_color }}; color: #fff;">
                                {{ order.status_display_name }}
                            </span>
                            <!-- Ikony status√≥w -->
                            <div class="status-icons">
                                <!-- P≈Çatno≈õƒá -->
                                <span class="status-icon {% if order.is_fully_paid %}status-icon-active{% elif order.is_partially_paid or order.is_overpaid %}status-icon-warning{% else %}status-icon-inactive{% endif %}" data-tooltip="{% if order.is_fully_paid %}Op≈Çacone{% elif order.is_overpaid %}Nadp≈Çata{% elif order.is_partially_paid %}Czƒô≈õciowo op≈Çacone{% else %}Brak wp≈Çaty{% endif %}">
                                    $
                                </span>
                                <!-- Tracking -->
                                {% if order.has_tracking %}
                                <a href="{{ order.first_tracking_url }}" target="_blank" class="status-icon status-icon-active status-icon-link" data-tooltip="Przesy≈Çka {{ order.first_tracking_number }}">
                                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M0 3.5A1.5 1.5 0 0 1 1.5 2h9A1.5 1.5 0 0 1 12 3.5V5h1.02a1.5 1.5 0 0 1 1.17.563l1.481 1.85a1.5 1.5 0 0 1 .329.938V10.5a1.5 1.5 0 0 1-1.5 1.5H14a2 2 0 1 1-4 0H5a2 2 0 1 1-3.998-.085A1.5 1.5 0 0 1 0 10.5v-7zm1.294 7.456A1.999 1.999 0 0 1 4.732 11h5.536a2.01 2.01 0 0 1 .732-.732V3.5a.5.5 0 0 0-.5-.5h-9a.5.5 0 0 0-.5.5v7a.5.5 0 0 0 .294.456zM12 10a2 2 0 0 1 1.732 1h.768a.5.5 0 0 0 .5-.5V8.35a.5.5 0 0 0-.11-.312l-1.48-1.85A.5.5 0 0 0 13.02 6H12v4zm-9 1a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm9 0a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/>
                                    </svg>
                                </a>
                                {% else %}
                                <span class="status-icon status-icon-inactive" data-tooltip="Brak listu przewozowego">
                                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M0 3.5A1.5 1.5 0 0 1 1.5 2h9A1.5 1.5 0 0 1 12 3.5V5h1.02a1.5 1.5 0 0 1 1.17.563l1.481 1.85a1.5 1.5 0 0 1 .329.938V10.5a1.5 1.5 0 0 1-1.5 1.5H14a2 2 0 1 1-4 0H5a2 2 0 1 1-3.998-.085A1.5 1.5 0 0 1 0 10.5v-7zm1.294 7.456A1.999 1.999 0 0 1 4.732 11h5.536a2.01 2.01 0 0 1 .732-.732V3.5a.5.5 0 0 0-.5-.5h-9a.5.5 0 0 0-.5.5v7a.5.5 0 0 0 .294.456zM12 10a2 2 0 0 1 1.732 1h.768a.5.5 0 0 0 .5-.5V8.35a.5.5 0 0 0-.11-.312l-1.48-1.85A.5.5 0 0 0 13.02 6H12v4zm-9 1a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm9 0a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/>
                                    </svg>
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </td>

                    <!-- Kolumna 5: Data -->
                    <td class="col-date" data-label="Data">
                        <div class="date-cell-new">
                            <span class="date-created">{{ order.created_at|format_datetime('%d.%m.%Y %H:%M') }}</span>
                            <span class="date-updated" title="Ostatnia zmiana">{{ order.updated_at|format_datetime('%d.%m.%Y %H:%M') }}</span>
                        </div>
                    </td>

                    <!-- Kolumna 6: Akcje (ikona oka) -->
                    <td class="col-actions" data-label="Akcje">
                        <a href="{{ url_for('orders.client_detail', order_id=order.id) }}"
                           class="btn-icon"
                           title="Szczeg√≥≈Çy zam√≥wienia">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
                                <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
                            </svg>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Pagination -->
        {% if orders.pages > 1 %}
        <div class="pagination">
            <div class="pagination-info">
                Strona {{ orders.page }} z {{ orders.pages }} ({{ orders.total }} zam√≥wie≈Ñ)
            </div>
            <div class="pagination-controls">
                {% if orders.has_prev %}
                <a href="{{ url_for('orders.client_list', page=orders.prev_num, **request.args) }}"
                   class="pagination-btn">
                    ¬´ Poprzednia
                </a>
                {% endif %}

                {% for page_num in orders.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                    {% if page_num %}
                        <a href="{{ url_for('orders.client_list', page=page_num, **request.args) }}"
                           class="pagination-btn {% if page_num == orders.page %}active{% endif %}">
                            {{ page_num }}
                        </a>
                    {% else %}
                        <span class="pagination-ellipsis">...</span>
                    {% endif %}
                {% endfor %}

                {% if orders.has_next %}
                <a href="{{ url_for('orders.client_list', page=orders.next_num, **request.args) }}"
                   class="pagination-btn">
                    Nastƒôpna ¬ª
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% else %}
        <div class="empty-state">
            <svg width="64" height="64" fill="currentColor" viewBox="0 0 16 16">
                <path d="M0 2.5A.5.5 0 0 1 .5 2H2a.5.5 0 0 1 .485.379L2.89 4H14.5a.5.5 0 0 1 .485.621l-1.5 6A.5.5 0 0 1 13 11H4a.5.5 0 0 1-.485-.379L1.61 3H.5a.5.5 0 0 1-.5-.5zM3.14 5l1.25 5h8.22l1.25-5H3.14zM5 13a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0zm9-1a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0z"/>
            </svg>
            <h3>Brak zam√≥wie≈Ñ</h3>
            <p>Nie masz jeszcze ≈ºadnych zam√≥wie≈Ñ</p>
            <a href="#" class="btn btn-primary">Z≈Ç√≥≈º pierwsze zam√≥wienie</a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/pages/client/orders-list.js') }}"></script>
{% endblock %}
