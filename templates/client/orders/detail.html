{% extends "client/base_client.html" %}

{% block title %}Zamówienie {{ order.order_number }} - ThunderOrders{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/client/order-detail.css') }}">
{% endblock %}

{% block content %}
<div class="order-detail-page client-view">
    <!-- Header -->
    <div class="order-header">
        <div class="order-header-main">
            <a href="{{ url_for('orders.client_list') }}" class="back-link">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                </svg>
                Powrót do listy
            </a>
            <h1>{{ order.order_number }}</h1>
            <span class="badge" style="background-color: {{ order.type_badge_color }}; color: #fff;">{{ order.type_display_name }}</span>
            <span class="badge" style="background-color: {{ order.status_badge_color }}; color: #fff;">{{ order.status_display_name }}</span>
        </div>
        <div class="order-header-right">
            <span class="order-total">{{ "%.2f"|format(order.effective_total) }} PLN</span>
        </div>
    </div>

    <div class="content-layout">
        <!-- Left Column: Main Content -->
        <div class="content-main">
            <!-- Products Card -->
            <div class="card products-card">
                <div class="card-header">
                    <h2>Zamówione produkty</h2>
                    <span class="items-count">{{ order_items|length }} {% if order_items|length == 1 %}pozycja{% elif order_items|length < 5 %}pozycje{% else %}pozycji{% endif %}</span>
                </div>
                <div class="table-wrapper">
                    <table class="products-table">
                        <thead>
                            <tr>
                                <th class="col-image"></th>
                                <th class="col-name">Nazwa</th>
                                <th class="col-qty text-center">Ilość</th>
                                <th class="col-price text-right">Cena</th>
                                <th class="col-total text-right">Wartość</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in order_items %}
                            <tr>
                                <td class="col-image" data-label="">
                                    <img src="{{ item.product_image_url }}" alt="{{ item.product_name }}" class="product-thumb">
                                </td>
                                <td class="col-name" data-label="Nazwa">
                                    <div class="product-name-cell">
                                        <span class="product-name">{{ item.product_name }}</span>
                                        <div class="product-codes">
                                            {% if item.product_sku %}
                                            <span>SKU: {{ item.product_sku }}</span>
                                            {% endif %}
                                            {% if item.product_ean %}
                                            <span>EAN: {{ item.product_ean }}</span>
                                            {% endif %}
                                        </div>
                                        <!-- Mobile values row -->
                                        <div class="mobile-values-row">
                                            <span class="mobile-value"><span class="label">Ilość:</span> {{ item.quantity }}</span>
                                            <span class="mobile-value"><span class="label">Cena:</span> {{ "%.2f"|format(item.price) }} PLN</span>
                                            <span class="mobile-value total"><span class="label">Wartość:</span> {{ "%.2f"|format(item.total) }} PLN</span>
                                        </div>
                                    </div>
                                </td>
                                <td class="col-qty text-center" data-label="Ilość">
                                    <span class="quantity-badge">{{ item.quantity }}</span>
                                </td>
                                <td class="col-price text-right" data-label="Cena">
                                    {{ "%.2f"|format(item.price) }} PLN
                                </td>
                                <td class="col-total text-right" data-label="Wartość">
                                    <strong>{{ "%.2f"|format(item.total) }} PLN</strong>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    <!-- Order Summary Box -->
                    <div class="order-summary-box">
                        <div class="order-summary-inner">
                            <div class="summary-row">
                                <span class="summary-label">Produkty:</span>
                                <span class="summary-value">{{ "%.2f"|format(order.total_amount) }} PLN</span>
                            </div>
                            <div class="summary-row">
                                <span class="summary-label">Dostawa:</span>
                                <span class="summary-value">
                                    {% if order.shipping_cost and order.shipping_cost > 0 %}
                                        {{ "%.2f"|format(order.shipping_cost) }} PLN
                                    {% else %}
                                        <span class="shipping-pending">Wkrótce</span>
                                    {% endif %}
                                </span>
                            </div>
                            <div class="summary-row summary-total">
                                <span class="summary-label">Suma:</span>
                                <span class="summary-value">
                                    {{ "%.2f"|format(order.effective_total) }} PLN
                                    {% if not order.shipping_cost or order.shipping_cost <= 0 %}
                                        <span class="plus-shipping">+ dostawa</span>
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payments & Shipping Grid -->
            <div class="payments-shipping-grid">
                    <!-- LEFT: Payments Card -->
                    <div class="card payments-card">
                        <div class="card-header">
                            <h2>Płatności</h2>
                        </div>
                        <div class="payment-cards-container">
                            <!-- Section 1: Płatność za zamówienie -->
                            <div class="payment-proof-section">
                                <div class="payment-proof-header">
                                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16" class="payment-icon">
                                        <path d="M0 1.5A.5.5 0 0 1 .5 1H2a.5.5 0 0 1 .485.379L2.89 3H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 12H4a.5.5 0 0 1-.491-.408L2.01 3.607 1.61 2H.5a.5.5 0 0 1-.5-.5zM3.102 4l1.313 7h8.17l1.313-7H3.102zM5 12a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm7 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm-7 1a1 1 0 1 1 0 2 1 1 0 0 1 0-2zm7 0a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                                    </svg>
                                    <div class="payment-proof-title">
                                        <h3>Zamówienie</h3>
                                    </div>
                                </div>
                                <div class="payment-proof-body">
                                    <div class="payment-info-row">
                                        <span class="payment-label">Kwota:</span>
                                        <span class="payment-amount">{{ "%.2f"|format(order.total_amount) }} PLN</span>
                                    </div>
                                    {% if order.payment_method %}
                                    <div class="payment-info-row">
                                        <span class="payment-label">Sposób:</span>
                                        <span class="payment-method-value">{{ order.payment_method }}</span>
                                    </div>
                                    {% endif %}
                                    {% if order.has_payment_proof_order %}
                                    <div class="payment-info-row">
                                        <span class="payment-label">Status:</span>
                                        {% if order.payment_proof_order_is_pending %}
                                            <span class="badge badge-warning">Oczekuje</span>
                                        {% elif order.payment_proof_order_is_approved %}
                                            <span class="badge badge-success">Potwierdzona</span>
                                        {% elif order.payment_proof_order_is_rejected %}
                                            <span class="badge badge-danger">Odrzucona</span>
                                        {% endif %}
                                    </div>
                                    <div class="payment-info-row">
                                        <span class="payment-label">Dowód:</span>
                                        <a href="{{ url_for('static', filename=order.payment_proof_order_file) }}" target="_blank" class="payment-proof-link">Podgląd</a>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="payment-proof-actions">
                                    {% if order.is_payment_proof_upload_disabled %}
                                        <button type="button" class="btn btn-sm btn-disabled" disabled>Wgraj dowód</button>
                                        <p class="upload-disabled-message">Funkcja aktywna po zakończeniu sprzedaży</p>
                                    {% elif order.can_upload_payment_proof_order %}
                                        <button type="button" class="btn btn-sm btn-primary" onclick="openPaymentProofModal('order')">Wgraj dowód</button>
                                    {% elif order.payment_proof_order_is_rejected %}
                                        <div class="rejection-info">
                                            <p class="rejection-reason">{{ order.payment_proof_order_rejection_reason }}</p>
                                            <button type="button" class="btn btn-sm btn-primary" onclick="openPaymentProofModal('order')">Ponów wysyłkę</button>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Separator -->
                            <div class="payment-separator"></div>

                            <!-- Section 2: Płatność za dostawę -->
                            <div class="payment-proof-section">
                                <div class="payment-proof-header">
                                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16" class="payment-icon">
                                        <path d="M0 3.5A1.5 1.5 0 0 1 1.5 2h9A1.5 1.5 0 0 1 12 3.5V5h1.02a1.5 1.5 0 0 1 1.17.563l1.481 1.85a1.5 1.5 0 0 1 .329.938V10.5a1.5 1.5 0 0 1-1.5 1.5H14a2 2 0 1 1-4 0H5a2 2 0 1 1-3.998-.085A1.5 1.5 0 0 1 0 10.5v-7zm1.294 7.456A1.999 1.999 0 0 1 4.732 11h5.536a2.01 2.01 0 0 1 .732-.732V3.5a.5.5 0 0 0-.5-.5h-9a.5.5 0 0 0-.5.5v7a.5.5 0 0 0 .294.456zM12 10a2 2 0 0 1 1.732 1h.768a.5.5 0 0 0 .5-.5V8.35a.5.5 0 0 0-.11-.312l-1.48-1.85A.5.5 0 0 0 13.02 6H12v4zm-9 1a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm9 0a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/>
                                    </svg>
                                    <div class="payment-proof-title">
                                        <h3>Dostawa</h3>
                                    </div>
                                </div>
                                <div class="payment-proof-body">
                                    {% set sr = order.shipping_request %}
                                    {% if not order.shipping_cost or order.shipping_cost <= 0 %}
                                        <div class="payment-pending">
                                            <p class="text-muted">Czekam na wycenę dostawy</p>
                                        </div>
                                    {% else %}
                                        <div class="payment-info-row">
                                            <span class="payment-label">Kwota:</span>
                                            <span class="payment-amount">{{ "%.2f"|format(order.shipping_cost) }} PLN</span>
                                        </div>
                                        {% if sr and sr.payment_method %}
                                        <div class="payment-info-row">
                                            <span class="payment-label">Sposób:</span>
                                            <span class="payment-method-value">{{ sr.payment_method }}</span>
                                        </div>
                                        {% endif %}
                                        {# Używamy dowodu wpłaty ze zlecenia wysyłki (współdzielone między zamówieniami) #}
                                        {% if sr and sr.has_payment_proof %}
                                        <div class="payment-info-row">
                                            <span class="payment-label">Status:</span>
                                            {% if sr.payment_proof_is_pending %}
                                                <span class="badge badge-warning">Oczekuje</span>
                                            {% elif sr.payment_proof_is_approved %}
                                                <span class="badge badge-success">Potwierdzona</span>
                                            {% elif sr.payment_proof_is_rejected %}
                                                <span class="badge badge-danger">Odrzucona</span>
                                            {% endif %}
                                        </div>
                                        <div class="payment-info-row">
                                            <span class="payment-label">Dowód:</span>
                                            <a href="{{ url_for('static', filename=sr.payment_proof_file) }}" target="_blank" class="payment-proof-link">Podgląd</a>
                                        </div>
                                        {# Pokaż inne zamówienia współdzielące ten dowód #}
                                        {% set other_orders = order.shipping_request_other_orders %}
                                        {% if other_orders %}
                                        <div class="payment-info-row shared-payment-info">
                                            <span class="payment-label">Razem z:</span>
                                            <span class="shared-orders-list">
                                                {% for other in other_orders[:3] %}
                                                <a href="{{ url_for('orders.client_detail', order_id=other.id) }}" class="shared-order-badge">{{ other.order_number }}</a>
                                                {% endfor %}
                                                {% if other_orders|length > 3 %}
                                                <span class="shared-orders-more">+{{ other_orders|length - 3 }}</span>
                                                {% endif %}
                                            </span>
                                        </div>
                                        {% endif %}
                                        {% endif %}
                                    {% endif %}
                                </div>
                                {% if order.shipping_cost and order.shipping_cost > 0 %}
                                <div class="payment-proof-actions">
                                    {% if order.is_payment_proof_upload_disabled %}
                                        <button type="button" class="btn btn-sm btn-disabled" disabled>Wgraj dowód</button>
                                        <p class="upload-disabled-message">Funkcja aktywna po zakończeniu sprzedaży</p>
                                    {% elif sr and sr.can_upload_payment_proof %}
                                        <button type="button" class="btn btn-sm btn-primary" onclick="openPaymentProofModal('shipping')">Wgraj dowód</button>
                                    {% elif sr and sr.payment_proof_is_rejected %}
                                        <div class="rejection-info">
                                            <p class="rejection-reason">{{ sr.payment_proof_rejection_reason }}</p>
                                            <button type="button" class="btn btn-sm btn-primary" onclick="openPaymentProofModal('shipping')">Ponów wysyłkę</button>
                                        </div>
                                    {% elif not sr %}
                                        {# Brak zlecenia wysyłki - nie można wgrać dowodu #}
                                        <p class="text-muted small">Utwórz zlecenie wysyłki, aby móc wgrać dowód</p>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT: Shipping Card -->
                    <div class="card shipping-card">
                        <div class="card-header">
                            <h2>Wysyłka</h2>
                        </div>
                        <div class="shipping-content">
                            {% if order.shipping_request %}
                                {% set sr = order.shipping_request %}
                                <!-- Zamówienie jest w zleceniu wysyłki -->
                                <div class="shipping-request-info">
                                    <!-- Numer zlecenia (link do listy zleceń) + Status -->
                                    <div class="shipping-request-header">
                                        <a href="{{ url_for('client.shipping_requests_list') }}" class="shipping-request-number-link">{{ sr.request_number }}</a>
                                        <span class="badge status-badge" style="background-color: {{ sr.status_badge_color }}; color: #fff;">
                                            {{ sr.status_display_name }}
                                        </span>
                                    </div>

                                    <!-- Inne zamówienia w tym zleceniu -->
                                    {% set other_orders = order.shipping_request_other_orders %}
                                    {% if other_orders %}
                                    <div class="shipping-other-orders">
                                        <span class="label">Razem z:</span>
                                        <div class="other-orders-list">
                                            {% for other in other_orders[:3] %}
                                            <a href="{{ url_for('orders.client_detail', order_id=other.id) }}" class="other-order-badge">{{ other.order_number }}</a>
                                            {% endfor %}
                                            {% if other_orders|length > 3 %}
                                            <span class="other-orders-more">+{{ other_orders|length - 3 }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}

                                    <!-- Numer przesyłki (zawsze wyświetlany) -->
                                    <div class="shipping-info-row">
                                        <span class="label">Nr przesyłki:</span>
                                        {% if sr.tracking_number %}
                                            {% if sr.tracking_url %}
                                            <a href="{{ sr.tracking_url }}" target="_blank" class="tracking-link">{{ sr.tracking_number }}</a>
                                            {% else %}
                                            <span class="value tracking-number">{{ sr.tracking_number }}</span>
                                            {% endif %}
                                        {% else %}
                                        <span class="value text-muted">Wkrótce</span>
                                        {% endif %}
                                    </div>
                                </div>
                            {% else %}
                                <!-- Brak zlecenia wysyłki -->
                                <svg width="48" height="48" fill="currentColor" viewBox="0 0 16 16" class="shipping-icon">
                                    <path d="M0 3.5A1.5 1.5 0 0 1 1.5 2h9A1.5 1.5 0 0 1 12 3.5V5h1.02a1.5 1.5 0 0 1 1.17.563l1.481 1.85a1.5 1.5 0 0 1 .329.938V10.5a1.5 1.5 0 0 1-1.5 1.5H14a2 2 0 1 1-4 0H5a2 2 0 1 1-3.998-.085A1.5 1.5 0 0 1 0 10.5v-7zm1.294 7.456A1.999 1.999 0 0 1 4.732 11h5.536a2.01 2.01 0 0 1 .732-.732V3.5a.5.5 0 0 0-.5-.5h-9a.5.5 0 0 0-.5.5v7a.5.5 0 0 0 .294.456zM12 10a2 2 0 0 1 1.732 1h.768a.5.5 0 0 0 .5-.5V8.35a.5.5 0 0 0-.11-.312l-1.48-1.85A.5.5 0 0 0 13.02 6H12v4zm-9 1a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm9 0a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/>
                                </svg>
                                <p class="text-muted">To zamówienie nie jest jeszcze przypisane do zlecenia wysyłki</p>
                                <a href="{{ url_for('client.shipping_requests_list') }}" class="btn btn-primary">
                                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                                    </svg>
                                    Stwórz zlecenie
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>

            <!-- Timeline / Comments Card -->
            <div class="card timeline-card">
                <div class="card-header">
                    <h2>Wiadomości</h2>
                </div>

                {% set comment_count = timeline|selectattr('type', 'equalto', 'comment')|list|length %}
                {% if comment_count > 0 %}
                <div class="timeline" id="timeline">
                    {% for event in timeline %}
                        {% if event.type == 'comment' %}
                            <div class="timeline-item comment {% if event.is_from_admin %}from-admin{% else %}from-client{% endif %}">
                                <div class="timeline-avatar">
                                    {{ event.user.first_name[0] }}{{ event.user.last_name[0] }}
                                </div>
                                <div class="timeline-content">
                                    <div class="timeline-header">
                                        <strong>{{ event.user.full_name }}</strong>
                                        <span class="timeline-role">{% if event.is_from_admin %}(Sprzedawca){% else %}(Ty){% endif %}</span>
                                        <span class="timeline-date">{{ event.created_at|format_datetime }}</span>
                                    </div>
                                    <p class="timeline-message">{{ event.comment }}</p>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
                {% else %}
                <div class="timeline-empty-state">
                    <svg width="64" height="64" viewBox="0 0 16 16" fill="currentColor" class="empty-icon">
                        <path d="M2.678 11.894a1 1 0 0 1 .287.801 10.97 10.97 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8.06 8.06 0 0 0 8 14c3.996 0 7-2.807 7-6 0-3.192-3.004-6-7-6S1 4.808 1 8c0 1.468.617 2.83 1.678 3.894zm-.493 3.905a21.682 21.682 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a9.68 9.68 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105z"/>
                    </svg>
                    <h3>Brak wiadomości</h3>
                    <p>Rozpocznij rozmowę z naszym zespołem. Twoje wiadomości pojawią się tutaj.</p>
                </div>
                {% endif %}

                <!-- Add Comment Form -->
                <form hx-post="{{ url_for('orders.client_add_comment', order_id=order.id) }}"
                      hx-target="#timeline"
                      hx-swap="afterbegin"
                      class="comment-form">
                    {{ comment_form.hidden_tag() }}
                    <div class="form-group">
                        <label for="comment">Napisz wiadomość do sprzedawcy</label>
                        {{ comment_form.comment(class="form-textarea", placeholder="Twoja wiadomość...", rows=4) }}
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"/>
                            </svg>
                            Wyślij wiadomość
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Right Column: Sidebar -->
        <div class="content-sidebar">
            <!-- Order Info Card -->
            <div class="card info-card">
                <h3>Informacje o zamówieniu</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <label>Numer zamówienia</label>
                        <span class="value-highlight">{{ order.order_number }}</span>
                    </div>
                    <div class="info-item">
                        <label>Status</label>
                        <span class="badge" style="background-color: {{ order.status_badge_color }}; color: #fff;">{{ order.status_display_name }}</span>
                    </div>
                </div>

                <!-- Additional Info Section with Dropdown -->
                <div class="additional-info-section">
                    <h4>Dodatkowe informacje</h4>
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Data utworzenia</label>
                            <span>{{ order.created_at|format_datetime('%Y-%m-%d %H:%M') }}</span>
                        </div>
                        <div class="info-item">
                            <label>Ostatnia aktualizacja</label>
                            <span>{{ order.updated_at|format_datetime('%Y-%m-%d %H:%M') }}</span>
                        </div>
                    </div>

                    <!-- Order History Dropdown (ALL activity logs) -->
                    {% if order_history and order_history|length > 0 %}
                    <div class="collapsible-section">
                        <button class="collapsible-trigger" onclick="toggleSection(this)">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="chevron">
                                <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
                            </svg>
                            Historia zamówienia
                        </button>
                        <div class="collapsible-content">
                            <div class="history-list">
                                {% for history_item in order_history %}
                                <div class="history-item">
                                    <span class="history-icon">{{ history_item.action_icon }}</span>
                                    {% if history_item.is_status_change %}
                                        {# Zmiana statusu - kolorowy badge #}
                                        <span class="history-text">
                                            Zmiana statusu:
                                            <span class="badge" style="background-color: {{ history_item.status_color }}; color: #fff; font-size: 0.7rem; padding: 0.15rem 0.4rem; border-radius: 4px; margin-left: 0.25rem;">
                                                {{ history_item.status_name }}
                                            </span>
                                            {% if history_item.user_name != 'System' %}
                                            <span class="history-user">przez {{ history_item.user_name }}</span>
                                            {% endif %}
                                        </span>
                                    {% else %}
                                        {# Inne akcje - zwykły tekst #}
                                        <span class="history-text">
                                            {{ history_item.action_label }}
                                            {% if history_item.user_name != 'System' %}
                                            <span class="history-user">przez {{ history_item.user_name }}</span>
                                            {% endif %}
                                        </span>
                                    {% endif %}
                                    <span class="history-date">{{ history_item.created_at|format_datetime('%Y-%m-%d %H:%M') }}</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Tracking Card -->
            {% if order.tracking_number %}
            <div class="card tracking-card">
                <h3>Śledzenie przesyłki</h3>
                <div class="tracking-info">
                    <div class="tracking-item">
                        <label>Kurier</label>
                        <span class="value-bold">{{ order.courier or '—' }}</span>
                    </div>
                    <div class="tracking-item">
                        <label>Numer przesyłki</label>
                        <span class="value-mono">{{ order.tracking_number }}</span>
                    </div>
                    {% if order.tracking_url %}
                    <a href="{{ order.tracking_url }}" target="_blank" class="btn btn-secondary btn-block">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5z"/>
                            <path d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0v-5z"/>
                        </svg>
                        Śledź przesyłkę
                    </a>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Notes Card (if present) -->
            {% if order.notes %}
            <div class="card notes-card">
                <h3>Twoje notatki</h3>
                <p class="notes-text">{{ order.notes }}</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
<!-- Payment Proof Upload Modal -->
<div id="paymentProofModal" class="modal-overlay">
    <div class="modal-content modal-medium">
        <div class="modal-header">
            <h2>Wgraj potwierdzenie płatności</h2>
            <button class="modal-close" onclick="closePaymentProofModal()">&times;</button>
        </div>

        <div class="modal-body">
            <div id="paymentInfoBox" class="payment-info-box">
                <!-- Dynamicznie wypełniane przez JS -->
            </div>

            <div id="paymentMethodsInfo" class="payment-methods-list">
                <!-- Załadowane przez JS -->
            </div>

            <form id="uploadPaymentProofForm" method="POST"
                  action="{{ url_for('orders.client_upload_payment_proof', order_id=order.id) }}"
                  enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="payment_method_name" id="selectedPaymentMethodName" value="">
                <input type="hidden" name="proof_type" id="selectedProofType" value="order">

                <div class="file-upload-section">
                    <label for="paymentProofFile">Plik (JPG, PNG lub PDF, max 5MB) *</label>
                    <input type="file"
                           id="paymentProofFile"
                           name="payment_proof"
                           accept=".jpg,.jpeg,.png,.pdf"
                           required>
                    <small class="form-text">Po wgraniu pliku NIE będzie można go zmienić (chyba że zostanie odrzucony przez administratora)</small>
                </div>
            </form>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closePaymentProofModal()">Anuluj</button>
            <button type="submit" form="uploadPaymentProofForm" class="btn btn-primary">Wgraj dowód</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/pages/client/order-detail.js') }}"></script>
{% endblock %}
