{% extends "client/base_client.html" %}

{% block title %}Zamówienie {{ order.order_number }} - ThunderOrders{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/client/order-detail.css') }}">
{% endblock %}

{% block content %}
<div class="od">
    <!-- ========== HERO BANNER ========== -->
    <div class="od-hero">
        <div class="od-hero__back">
            <a href="{{ url_for('orders.client_list') }}" class="od-back">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
            </a>
        </div>
        <div class="od-hero__body">
            <h1 class="od-hero__number">{{ order.order_number }}</h1>
            {% if order.is_exclusive and order.exclusive_page %}
            <span class="od-hero__page">{{ order.exclusive_page.name }}</span>
            {% endif %}
        </div>
    </div>

    <!-- ========== TWO-COL LAYOUT ========== -->
    <div class="od-grid">
        <!-- LEFT -->
        <div class="od-main">

            <!-- ===== PRODUCTS ===== -->
            <section class="od-section od-products">
                <div class="od-section__head">
                    <h2>Produkty</h2>
                    <span class="od-pill">{{ order_items|length }}</span>
                </div>
                <div class="od-products__list">
                    {% for item in order_items %}
                    <div class="od-product-row">
                        <img src="{{ item.product_image_url }}" alt="{{ item.product_name }}" class="od-product-row__img" loading="lazy">
                        <div class="od-product-row__info">
                            <span class="od-product-row__name">{{ item.product_name }}</span>
                            {% if item.product_sku or item.product_ean %}
                            <span class="od-product-row__codes">
                                {% if item.product_sku %}SKU: {{ item.product_sku }}{% endif %}
                                {% if item.product_sku and item.product_ean %} · {% endif %}
                                {% if item.product_ean %}EAN: {{ item.product_ean }}{% endif %}
                            </span>
                            {% endif %}
                        </div>
                        <span class="od-product-row__qty">×{{ item.quantity }}</span>
                        <span class="od-product-row__price">{{ "%.2f"|format(item.price) }}&nbsp;PLN</span>
                        <span class="od-product-row__total">{{ "%.2f"|format(item.total) }}&nbsp;PLN</span>
                    </div>
                    {% endfor %}
                </div>

                <!-- Summary -->
                <div class="od-summary">
                    <div class="od-summary__inner">
                    {% if order.is_exclusive %}
                    <div class="od-summary__row">
                        <span>Produkty</span>
                        <span>{{ "%.2f"|format(order.effective_total) }} PLN</span>
                    </div>
                    {% if order.payment_stages == 4 %}
                    <div class="od-summary__row">
                        <span>Dostawa Proxy</span>
                        <span>
                            {% if order.proxy_shipping_total > 0 %}
                                {{ "%.2f"|format(order.proxy_shipping_total) }} PLN
                            {% else %}
                                <em class="od-tbd">Wkrótce</em>
                            {% endif %}
                        </span>
                    </div>
                    {% endif %}
                    <div class="od-summary__row">
                        <span>CŁO/VAT</span>
                        <span>
                            {% if order.customs_vat_total > 0 %}
                                {{ "%.2f"|format(order.customs_vat_total) }} PLN
                            {% else %}
                                <em class="od-tbd">Wkrótce</em>
                            {% endif %}
                        </span>
                    </div>
                    <div class="od-summary__row">
                        <span>Dostawa PL</span>
                        <span>
                            {% if order.shipping_cost and order.shipping_cost > 0 %}
                                {{ "%.2f"|format(order.shipping_cost) }} PLN
                            {% else %}
                                <em class="od-tbd">Wkrótce</em>
                            {% endif %}
                        </span>
                    </div>
                    <div class="od-summary__row od-summary__row--total">
                        <span>Razem</span>
                        <span>
                            {% set known_sum = order.effective_total + (order.proxy_shipping_total if order.payment_stages == 4 else 0) + (order.shipping_cost if order.shipping_cost else 0) + order.customs_vat_total %}
                            {{ "%.2f"|format(known_sum) }} PLN
                            {% set missing = [] %}
                            {% if order.payment_stages == 4 and (not order.proxy_shipping_total or order.proxy_shipping_total <= 0) %}
                                {% set _ = missing.append('Proxy') %}
                            {% endif %}
                            {% if not order.shipping_cost or order.shipping_cost <= 0 %}
                                {% set _ = missing.append('Dostawa PL') %}
                            {% endif %}
                            {% if not order.customs_vat_total or order.customs_vat_total <= 0 %}
                                {% set _ = missing.append('CŁO/VAT') %}
                            {% endif %}
                            {% if missing %}
                                <small class="od-tbd">+ {{ missing|join(', ') }}</small>
                            {% endif %}
                        </span>
                    </div>
                    {% else %}
                    <div class="od-summary__row">
                        <span>Produkty</span>
                        <span>{{ "%.2f"|format(order.total_amount) }} PLN</span>
                    </div>
                    <div class="od-summary__row">
                        <span>Dostawa</span>
                        <span>
                            {% if order.shipping_cost and order.shipping_cost > 0 %}
                                {{ "%.2f"|format(order.shipping_cost) }} PLN
                            {% else %}
                                <em class="od-tbd">Wkrótce</em>
                            {% endif %}
                        </span>
                    </div>
                    <div class="od-summary__row od-summary__row--total">
                        <span>Razem</span>
                        <span>
                            {{ "%.2f"|format(order.effective_total) }} PLN
                            {% if not order.shipping_cost or order.shipping_cost <= 0 %}
                                <small class="od-tbd">+ dostawa</small>
                            {% endif %}
                        </span>
                    </div>
                    {% endif %}
                    </div>
                </div>
            </section>

            <!-- ===== PAYMENT + SHIPPING (side by side) ===== -->
            <div class="od-duo">
                <!-- PAYMENT -->
                {% set pc_status = order.product_payment_status %}
                {% set confirm_url = url_for('client.payment_confirmations') ~ '?preselect=' ~ order.id %}
                {% set has_uploadable = order.can_upload_product_payment
                    or (order.is_exclusive and order.payment_stages == 4 and order.can_upload_stage_2)
                    or (order.is_exclusive and order.can_upload_stage_3)
                    or (order.is_exclusive and order.can_upload_stage_4) %}
                <section class="od-section od-pay">
                    <div class="od-section__head">
                        <h2>Płatności</h2>
                        {% if has_uploadable %}
                        <a href="{{ confirm_url }}" class="od-pay__upload-btn">
                            <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                            Wgraj
                        </a>
                        {% endif %}
                    </div>

                    {# --- Row: Produkty (always) --- #}
                    <div class="od-pay__row">
                        <span>Produkty</span>
                        <span class="od-pay__badge od-pay__badge--{{ pc_status }}">
                            {% if pc_status == 'none' %}Brak{% elif pc_status == 'pending' %}Weryfikacja{% elif pc_status == 'approved' %}Zatwierdzona{% elif pc_status == 'rejected' %}Odrzucona{% endif %}
                        </span>
                        <span class="od-pay__amount">{{ "%.2f"|format(order.effective_total) }} PLN</span>
                    </div>

                    {% if order.is_exclusive %}
                    {# --- Row: Dostawa Proxy (only 4-stage) --- #}
                    {% if order.payment_stages == 4 %}
                    {% set s2_status = order.stage_2_status %}
                    <div class="od-pay__row">
                        <span>Dostawa Proxy</span>
                        {% if s2_status %}
                        <span class="od-pay__badge od-pay__badge--{{ s2_status }}">
                            {% if s2_status == 'none' %}Brak{% elif s2_status == 'pending' %}Weryfikacja{% elif s2_status == 'approved' %}Zatwierdzona{% elif s2_status == 'rejected' %}Odrzucona{% endif %}
                        </span>
                        {% endif %}
                        <span class="od-pay__amount">
                            {% if order.proxy_shipping_total > 0 %}
                                {{ "%.2f"|format(order.proxy_shipping_total) }} PLN
                            {% else %}
                                <em class="od-tbd">Wkrótce</em>
                            {% endif %}
                        </span>
                    </div>
                    {% endif %}

                    {# --- Row: CŁO/VAT --- #}
                    {% set s3_status = order.stage_3_status %}
                    <div class="od-pay__row">
                        <span>CŁO/VAT</span>
                        {% if s3_status %}
                        <span class="od-pay__badge od-pay__badge--{{ s3_status }}">
                            {% if s3_status == 'none' %}Brak{% elif s3_status == 'pending' %}Weryfikacja{% elif s3_status == 'approved' %}Zatwierdzona{% elif s3_status == 'rejected' %}Odrzucona{% endif %}
                        </span>
                        {% endif %}
                        <span class="od-pay__amount">
                            {% if order.customs_vat_total > 0 %}
                                {{ "%.2f"|format(order.customs_vat_total) }} PLN
                            {% else %}
                                <em class="od-tbd">Wkrótce</em>
                            {% endif %}
                        </span>
                    </div>

                    {# --- Row: Dostawa PL --- #}
                    {% set s4_status = order.stage_4_status %}
                    <div class="od-pay__row">
                        <span>Dostawa PL</span>
                        {% if s4_status %}
                        <span class="od-pay__badge od-pay__badge--{{ s4_status }}">
                            {% if s4_status == 'none' %}Brak{% elif s4_status == 'pending' %}Weryfikacja{% elif s4_status == 'approved' %}Zatwierdzona{% elif s4_status == 'rejected' %}Odrzucona{% endif %}
                        </span>
                        {% endif %}
                        <span class="od-pay__amount">
                            {% if order.shipping_cost and order.shipping_cost > 0 %}
                                {{ "%.2f"|format(order.shipping_cost) }} PLN
                            {% else %}
                                <em class="od-tbd">Wkrótce</em>
                            {% endif %}
                        </span>
                    </div>

                    {# --- Total (exclusive) --- #}
                    {% set remaining =
                        (order.effective_total if order.product_payment_status != 'approved' else 0)
                        + (order.proxy_shipping_total if (order.payment_stages == 4 and order.stage_2_status != 'approved' and order.proxy_shipping_total > 0) else 0)
                        + (order.customs_vat_total if (order.stage_3_status != 'approved' and order.customs_vat_total > 0) else 0)
                        + ((order.shipping_cost) if (order.stage_4_status != 'approved' and order.shipping_cost and order.shipping_cost > 0) else 0)
                    %}
                    <div class="od-pay__total">
                        <span>Do zapłaty</span>
                        <strong>{{ "%.2f"|format(remaining) }} PLN</strong>
                    </div>

                    {% else %}
                    {# --- Non-exclusive: Dostawa row --- #}
                    <div class="od-pay__row">
                        <span>Dostawa</span>
                        <span class="od-pay__amount">
                            {% if order.shipping_cost and order.shipping_cost > 0 %}
                                {{ "%.2f"|format(order.shipping_cost) }} PLN
                            {% else %}
                                <em class="od-tbd">Wkrótce</em>
                            {% endif %}
                        </span>
                    </div>

                    {# --- Total (non-exclusive) --- #}
                    {% set remaining_ne =
                        (order.effective_total if order.product_payment_status != 'approved' else 0)
                        + ((order.shipping_cost) if (order.shipping_cost and order.shipping_cost > 0) else 0)
                    %}
                    <div class="od-pay__total">
                        <span>Do zapłaty</span>
                        <strong>{{ "%.2f"|format(remaining_ne) }} PLN</strong>
                    </div>
                    {% endif %}

                    {# --- Rejection alert (product payment) --- #}
                    {% if pc_status == 'rejected' and order.product_payment_confirmation and order.product_payment_confirmation.rejection_reason %}
                    <div class="od-alert od-alert--error">
                        <strong>Produkty — odrzucono:</strong> {{ order.product_payment_confirmation.rejection_reason }}
                    </div>
                    {% endif %}

                    {# --- Rejection alert E2 (Dostawa Proxy) --- #}
                    {% if order.is_exclusive and order.payment_stages == 4 and s2_status == 'rejected' and order.stage_2_confirmation and order.stage_2_confirmation.rejection_reason %}
                    <div class="od-alert od-alert--error">
                        <strong>Dostawa Proxy — odrzucono:</strong> {{ order.stage_2_confirmation.rejection_reason }}
                    </div>
                    {% endif %}

                    {# --- Rejection alert E3 (CŁO/VAT) --- #}
                    {% if order.is_exclusive and s3_status == 'rejected' and order.stage_3_confirmation and order.stage_3_confirmation.rejection_reason %}
                    <div class="od-alert od-alert--error">
                        <strong>CŁO/VAT — odrzucono:</strong> {{ order.stage_3_confirmation.rejection_reason }}
                    </div>
                    {% endif %}

                    {# --- Rejection alert E4 (Dostawa PL) --- #}
                    {% if order.is_exclusive and s4_status == 'rejected' and order.stage_4_confirmation and order.stage_4_confirmation.rejection_reason %}
                    <div class="od-alert od-alert--error">
                        <strong>Dostawa PL — odrzucono:</strong> {{ order.stage_4_confirmation.rejection_reason }}
                    </div>
                    {% endif %}
                </section>

                <!-- SHIPPING -->
                <section class="od-section od-ship">
                    <h2>Dostawa PL</h2>
                    {% if order.shipping_request %}
                        {% set sr = order.shipping_request %}
                        <div class="od-ship__active">
                            <div class="od-ship__head">
                                <a href="{{ url_for('client.shipping_requests_list') }}" class="od-ship__num">{{ sr.request_number }}</a>
                                <span class="od-dot" style="--dot-color: {{ sr.status_badge_color }};"></span>
                                <span class="od-ship__status">{{ sr.status_display_name }}</span>
                            </div>
                            {% set other_orders = order.shipping_request_other_orders %}
                            {% if other_orders %}
                            <div class="od-ship__others">
                                <span class="od-ship__others-label">Razem z:</span>
                                {% for other in other_orders[:3] %}
                                <a href="{{ url_for('orders.client_detail', order_id=other.id) }}" class="od-chip">{{ other.order_number }}</a>
                                {% endfor %}
                                {% if other_orders|length > 3 %}
                                <span class="od-chip od-chip--muted">+{{ other_orders|length - 3 }}</span>
                                {% endif %}
                            </div>
                            {% endif %}
                            <div class="od-ship__tracking">
                                <span class="od-label">Nr przesyłki</span>
                                {% if sr.tracking_number %}
                                    {% if sr.tracking_url %}
                                    <a href="{{ sr.tracking_url }}" target="_blank" class="od-mono-link">{{ sr.tracking_number }}</a>
                                    {% else %}
                                    <span class="od-mono">{{ sr.tracking_number }}</span>
                                    {% endif %}
                                {% else %}
                                <em class="od-tbd">Wkrótce</em>
                                {% endif %}
                            </div>
                        </div>
                    {% else %}
                        <div class="od-ship__empty">
                            <svg width="40" height="40" fill="none" stroke="currentColor" stroke-width="1.2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
                            <p>Brak zlecenia wysyłki</p>
                            <a href="{{ url_for('client.shipping_requests_list') }}" class="od-btn od-btn--sm">Stwórz zlecenie</a>
                        </div>
                    {% endif %}
                </section>
            </div>

            <!-- ===== MESSAGES (CHAT) ===== -->
            <section class="od-section od-chat">
                <h2>Wiadomości</h2>
                {% set comment_count = timeline|selectattr('type', 'equalto', 'comment')|list|length %}

                <div class="od-chat__body" id="timeline">
                    {% if comment_count > 0 %}
                        {% for event in timeline %}
                            {% if event.type == 'comment' %}
                            <div class="od-msg {% if event.is_from_admin %}od-msg--in{% else %}od-msg--out{% endif %}">
                                <div class="od-msg__avatar">{{ event.user.first_name[0] }}{{ event.user.last_name[0] }}</div>
                                <div class="od-msg__bubble">
                                    <div class="od-msg__head">
                                        <strong>{% if event.is_from_admin %}{{ event.user.full_name }}{% else %}Ty{% endif %}</strong>
                                        <time>{{ event.created_at|format_datetime }}</time>
                                    </div>
                                    <p>{{ event.comment }}</p>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                    <div class="od-chat__empty">
                        <svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                        <p>Brak wiadomości</p>
                        <small>Napisz do nas - odpowiemy jak najszybciej</small>
                    </div>
                    {% endif %}
                </div>

                <form hx-post="{{ url_for('orders.client_add_comment', order_id=order.id) }}"
                      hx-target="#timeline"
                      hx-swap="afterbegin"
                      class="od-chat__form">
                    {{ comment_form.hidden_tag() }}
                    <div class="od-chat__input-row">
                        {{ comment_form.comment(class="od-chat__input", placeholder="Napisz wiadomość...", rows=1) }}
                        <button type="submit" class="od-chat__send" title="Wyślij">
                            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                        </button>
                    </div>
                </form>
            </section>
        </div>

        <!-- RIGHT SIDEBAR -->
        <aside class="od-side">
            <!-- Info card -->
            <div class="od-card">
                <h3>Szczegóły</h3>
                <dl class="od-dl">
                    <div class="od-dl__item">
                        <dt>Numer</dt>
                        <dd class="od-mono">{{ order.order_number }}</dd>
                    </div>
                    <div class="od-dl__item">
                        <dt>Status</dt>
                        <dd><span class="od-status-tag" style="background-color: {{ order.status_badge_color }};">{{ order.status_display_name }}</span></dd>
                    </div>
                    <div class="od-dl__item">
                        <dt>Utworzono</dt>
                        <dd>{{ order.created_at|format_datetime('%Y-%m-%d %H:%M') }}</dd>
                    </div>
                    <div class="od-dl__item">
                        <dt>Aktualizacja</dt>
                        <dd>{{ order.updated_at|format_datetime('%Y-%m-%d %H:%M') }}</dd>
                    </div>
                </dl>

                {% if order_history and order_history|length > 0 %}
                <div class="od-collapse">
                    <button class="od-collapse__trigger" data-action="toggle-section">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16" class="od-collapse__chevron"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg>
                        Historia ({{ order_history|length }})
                    </button>
                    <div class="od-collapse__body">
                        {% for h in order_history %}
                        <div class="od-hist">
                            <span class="od-hist__dot {% if h.is_status_change %}od-hist__dot--accent{% endif %}"></span>
                            <div class="od-hist__text">
                                {% if h.is_status_change %}
                                    Zmiana statusu → <span class="od-hist__tag" style="background:{{ h.status_color }};">{{ h.status_name }}</span>
                                {% else %}
                                    {{ h.action_label }}
                                {% endif %}
                            </div>
                            <time class="od-hist__time">{{ h.created_at|format_datetime('%m-%d %H:%M') }}</time>
                            {% if h.user_name != 'System' %}<span class="od-hist__user">{{ h.user_name }}</span>{% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Tracking card -->
            {% if order.tracking_number %}
            <div class="od-card">
                <h3>Przesyłka</h3>
                <dl class="od-dl">
                    <div class="od-dl__item">
                        <dt>Kurier</dt>
                        <dd>{{ order.courier or '—' }}</dd>
                    </div>
                    <div class="od-dl__item">
                        <dt>Numer</dt>
                        <dd class="od-mono">{{ order.tracking_number }}</dd>
                    </div>
                </dl>
                {% if order.tracking_url %}
                <a href="{{ order.tracking_url }}" target="_blank" class="od-btn od-btn--full od-btn--secondary">
                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                    Śledź przesyłkę
                </a>
                {% endif %}
            </div>
            {% endif %}

            <!-- Notes -->
            {% if order.notes %}
            <div class="od-card od-card--accent">
                <h3>Notatki</h3>
                <p class="od-note">{{ order.notes }}</p>
            </div>
            {% endif %}
        </aside>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/pages/client/order-detail.js') }}"></script>
{% endblock %}
