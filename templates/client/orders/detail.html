{% extends "client/base_client.html" %}

{% block title %}Zamówienie {{ order.order_number }} - ThunderOrders{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/client/order-detail.css') }}">
{% endblock %}

{% block content %}
<div class="order-detail-page client-view">
    <!-- Header -->
    <div class="order-header">
        <div class="order-header-main">
            <a href="{{ url_for('orders.client_list') }}" class="back-link">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                </svg>
                Powrót do listy
            </a>
            <h1>{{ order.order_number }}</h1>
            <span class="badge" style="background-color: {{ order.type_badge_color }}; color: #fff;">{{ order.type_display_name }}</span>
            <span class="badge" style="background-color: {{ order.status_badge_color }}; color: #fff;">{{ order.status_display_name }}</span>
        </div>
        <div class="order-header-right">
            <span class="order-total">{{ "%.2f"|format(order.effective_total) }} PLN</span>
        </div>
    </div>

    <div class="content-layout">
        <!-- Left Column: Main Content -->
        <div class="content-main">
            <!-- Products Card -->
            <div class="card products-card">
                <div class="card-header">
                    <h2>Zamówione produkty</h2>
                    <span class="items-count">{{ order_items|length }} {% if order_items|length == 1 %}pozycja{% elif order_items|length < 5 %}pozycje{% else %}pozycji{% endif %}</span>
                </div>
                <div class="table-wrapper">
                    <table class="products-table">
                        <thead>
                            <tr>
                                <th class="col-image"></th>
                                <th class="col-name">Nazwa</th>
                                <th class="col-qty text-center">Ilość</th>
                                <th class="col-price text-right">Cena</th>
                                <th class="col-total text-right">Wartość</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in order_items %}
                            <tr>
                                <td class="col-image" data-label="">
                                    <img src="{{ item.product_image_url }}" alt="{{ item.product_name }}" class="product-thumb">
                                </td>
                                <td class="col-name" data-label="Nazwa">
                                    <div class="product-name-cell">
                                        <span class="product-name">{{ item.product_name }}</span>
                                        <div class="product-codes">
                                            {% if item.product_sku %}
                                            <span>SKU: {{ item.product_sku }}</span>
                                            {% endif %}
                                            {% if item.product_ean %}
                                            <span>EAN: {{ item.product_ean }}</span>
                                            {% endif %}
                                        </div>
                                        <!-- Mobile values row -->
                                        <div class="mobile-values-row">
                                            <span class="mobile-value"><span class="label">Ilość:</span> {{ item.quantity }}</span>
                                            <span class="mobile-value"><span class="label">Cena:</span> {{ "%.2f"|format(item.price) }} PLN</span>
                                            <span class="mobile-value total"><span class="label">Wartość:</span> {{ "%.2f"|format(item.total) }} PLN</span>
                                        </div>
                                    </div>
                                </td>
                                <td class="col-qty text-center" data-label="Ilość">
                                    <span class="quantity-badge">{{ item.quantity }}</span>
                                </td>
                                <td class="col-price text-right" data-label="Cena">
                                    {{ "%.2f"|format(item.price) }} PLN
                                </td>
                                <td class="col-total text-right" data-label="Wartość">
                                    <strong>{{ "%.2f"|format(item.total) }} PLN</strong>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    <!-- Order Summary Box -->
                    <div class="order-summary-box">
                        <div class="order-summary-inner">
                            <div class="summary-row">
                                <span class="summary-label">Produkty:</span>
                                <span class="summary-value">{{ "%.2f"|format(order.total_amount) }} PLN</span>
                            </div>
                            <div class="summary-row">
                                <span class="summary-label">Dostawa:</span>
                                <span class="summary-value">
                                    {% if order.shipping_cost and order.shipping_cost > 0 %}
                                        {{ "%.2f"|format(order.shipping_cost) }} PLN
                                    {% else %}
                                        <span class="shipping-pending">Wkrótce</span>
                                    {% endif %}
                                </span>
                            </div>
                            <div class="summary-row summary-total">
                                <span class="summary-label">Suma:</span>
                                <span class="summary-value">
                                    {{ "%.2f"|format(order.effective_total) }} PLN
                                    {% if not order.shipping_cost or order.shipping_cost <= 0 %}
                                        <span class="plus-shipping">+ dostawa</span>
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shipping Grid -->
            <div class="payments-shipping-grid">
                    <!-- Shipping Card -->
                    <div class="card shipping-card">
                        <div class="card-header">
                            <h2>Wysyłka</h2>
                        </div>
                        <div class="shipping-content">
                            {% if order.shipping_request %}
                                {% set sr = order.shipping_request %}
                                <!-- Zamówienie jest w zleceniu wysyłki -->
                                <div class="shipping-request-info">
                                    <!-- Numer zlecenia (link do listy zleceń) + Status -->
                                    <div class="shipping-request-header">
                                        <a href="{{ url_for('client.shipping_requests_list') }}" class="shipping-request-number-link">{{ sr.request_number }}</a>
                                        <span class="badge status-badge" style="background-color: {{ sr.status_badge_color }}; color: #fff;">
                                            {{ sr.status_display_name }}
                                        </span>
                                    </div>

                                    <!-- Inne zamówienia w tym zleceniu -->
                                    {% set other_orders = order.shipping_request_other_orders %}
                                    {% if other_orders %}
                                    <div class="shipping-other-orders">
                                        <span class="label">Razem z:</span>
                                        <div class="other-orders-list">
                                            {% for other in other_orders[:3] %}
                                            <a href="{{ url_for('orders.client_detail', order_id=other.id) }}" class="other-order-badge">{{ other.order_number }}</a>
                                            {% endfor %}
                                            {% if other_orders|length > 3 %}
                                            <span class="other-orders-more">+{{ other_orders|length - 3 }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}

                                    <!-- Numer przesyłki (zawsze wyświetlany) -->
                                    <div class="shipping-info-row">
                                        <span class="label">Nr przesyłki:</span>
                                        {% if sr.tracking_number %}
                                            {% if sr.tracking_url %}
                                            <a href="{{ sr.tracking_url }}" target="_blank" class="tracking-link">{{ sr.tracking_number }}</a>
                                            {% else %}
                                            <span class="value tracking-number">{{ sr.tracking_number }}</span>
                                            {% endif %}
                                        {% else %}
                                        <span class="value text-muted">Wkrótce</span>
                                        {% endif %}
                                    </div>
                                </div>
                            {% else %}
                                <!-- Brak zlecenia wysyłki -->
                                <svg width="48" height="48" fill="currentColor" viewBox="0 0 16 16" class="shipping-icon">
                                    <path d="M0 3.5A1.5 1.5 0 0 1 1.5 2h9A1.5 1.5 0 0 1 12 3.5V5h1.02a1.5 1.5 0 0 1 1.17.563l1.481 1.85a1.5 1.5 0 0 1 .329.938V10.5a1.5 1.5 0 0 1-1.5 1.5H14a2 2 0 1 1-4 0H5a2 2 0 1 1-3.998-.085A1.5 1.5 0 0 1 0 10.5v-7zm1.294 7.456A1.999 1.999 0 0 1 4.732 11h5.536a2.01 2.01 0 0 1 .732-.732V3.5a.5.5 0 0 0-.5-.5h-9a.5.5 0 0 0-.5.5v7a.5.5 0 0 0 .294.456zM12 10a2 2 0 0 1 1.732 1h.768a.5.5 0 0 0 .5-.5V8.35a.5.5 0 0 0-.11-.312l-1.48-1.85A.5.5 0 0 0 13.02 6H12v4zm-9 1a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm9 0a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/>
                                </svg>
                                <p class="text-muted">To zamówienie nie jest jeszcze przypisane do zlecenia wysyłki</p>
                                <a href="{{ url_for('client.shipping_requests_list') }}" class="btn btn-primary">
                                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                                    </svg>
                                    Stwórz zlecenie
                                </a>
                            {% endif %}
                        </div>
                    </div>

                    {# Widget płatności #}
                    {% set pc_status = order.product_payment_status %}
                    <div class="card pc-widget-card">
                        <div class="card-header">
                            <h2>Płatności</h2>
                        </div>
                        <div class="pc-widget-body">
                            {# Tabela płatności (div-based) #}
                            <div class="pc-payments-table">
                                <div class="pc-payments-header">
                                    <div class="pc-payments-col pc-col-type">Rodzaj</div>
                                    <div class="pc-payments-col pc-col-status">Status</div>
                                    <div class="pc-payments-col pc-col-amount">Kwota</div>
                                </div>

                                {# Wiersz: Produkty #}
                                <div class="pc-payments-row">
                                    <div class="pc-payments-col pc-col-type" data-label="Rodzaj">Produkty</div>
                                    <div class="pc-payments-col pc-col-status" data-label="Status">
                                        {% if pc_status == 'none' %}
                                            <span class="badge badge-secondary">Brak potwierdzenia</span>
                                        {% elif pc_status == 'pending' %}
                                            <span class="badge badge-warning">Oczekuje</span>
                                        {% elif pc_status == 'approved' %}
                                            <span class="badge badge-success">Zatwierdzona</span>
                                        {% elif pc_status == 'rejected' %}
                                            <span class="badge badge-error">Odrzucona</span>
                                        {% endif %}
                                    </div>
                                    <div class="pc-payments-col pc-col-amount" data-label="Kwota">{{ "%.2f"|format(order.effective_total) }} PLN</div>
                                </div>

                                {# Tutaj w przyszłości dodamy kolejne wiersze (np. Wysyłka) #}
                            </div>

                            {# Suma do zapłaty #}
                            <div class="pc-widget-amount">
                                <span class="pc-widget-amount-label">Kwota do zapłaty:</span>
                                <span class="pc-widget-amount-value">{{ "%.2f"|format(order.effective_total) }} PLN</span>
                            </div>

                            {# Info o odrzuceniu (jeśli dotyczy) #}
                            {% if pc_status == 'rejected' and order.product_payment_confirmation and order.product_payment_confirmation.rejection_reason %}
                            <div class="pc-widget-rejection">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 8v4"/>
                                    <path d="M12 16h.01"/>
                                </svg>
                                <div>
                                    <strong>Powód odrzucenia:</strong>
                                    <p>{{ order.product_payment_confirmation.rejection_reason }}</p>
                                </div>
                            </div>
                            {% endif %}

                            {# Przycisk akcji #}
                            {% if order.can_upload_product_payment %}
                            <a href="{{ url_for('client.payment_confirmations') }}?preselect={{ order.id }}" class="btn btn-primary pc-widget-btn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="17 8 12 3 7 8"/>
                                    <line x1="12" y1="3" x2="12" y2="15"/>
                                </svg>
                                {% if order.has_product_payment_confirmation %}
                                    Wgraj ponownie
                                {% else %}
                                    Wgraj potwierdzenie płatności
                                {% endif %}
                            </a>
                            {% elif pc_status == 'approved' %}
                            <div class="pc-widget-status-info pc-widget-status-approved">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                    <polyline points="22 4 12 14.01 9 11.01"/>
                                </svg>
                                Płatność zatwierdzona
                            </div>
                            {% else %}
                            <div class="pc-widget-status-info pc-widget-status-disabled">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 16v-4"/>
                                    <path d="M12 8h.01"/>
                                </svg>
                                Upload niedostępny na obecnym etapie zamówienia
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

            <!-- Timeline / Comments Card -->
            <div class="card timeline-card">
                <div class="card-header">
                    <h2>Wiadomości</h2>
                </div>

                {% set comment_count = timeline|selectattr('type', 'equalto', 'comment')|list|length %}
                {% if comment_count > 0 %}
                <div class="timeline" id="timeline">
                    {% for event in timeline %}
                        {% if event.type == 'comment' %}
                            <div class="timeline-item comment {% if event.is_from_admin %}from-admin{% else %}from-client{% endif %}">
                                <div class="timeline-avatar">
                                    {{ event.user.first_name[0] }}{{ event.user.last_name[0] }}
                                </div>
                                <div class="timeline-content">
                                    <div class="timeline-header">
                                        <strong>{{ event.user.full_name }}</strong>
                                        <span class="timeline-role">{% if event.is_from_admin %}(Sprzedawca){% else %}(Ty){% endif %}</span>
                                        <span class="timeline-date">{{ event.created_at|format_datetime }}</span>
                                    </div>
                                    <p class="timeline-message">{{ event.comment }}</p>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
                {% else %}
                <div class="timeline-empty-state">
                    <svg width="64" height="64" viewBox="0 0 16 16" fill="currentColor" class="empty-icon">
                        <path d="M2.678 11.894a1 1 0 0 1 .287.801 10.97 10.97 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8.06 8.06 0 0 0 8 14c3.996 0 7-2.807 7-6 0-3.192-3.004-6-7-6S1 4.808 1 8c0 1.468.617 2.83 1.678 3.894zm-.493 3.905a21.682 21.682 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a9.68 9.68 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105z"/>
                    </svg>
                    <h3>Brak wiadomości</h3>
                    <p>Rozpocznij rozmowę z naszym zespołem. Twoje wiadomości pojawią się tutaj.</p>
                </div>
                {% endif %}

                <!-- Add Comment Form -->
                <form hx-post="{{ url_for('orders.client_add_comment', order_id=order.id) }}"
                      hx-target="#timeline"
                      hx-swap="afterbegin"
                      class="comment-form">
                    {{ comment_form.hidden_tag() }}
                    <div class="form-group">
                        <label for="comment">Napisz wiadomość do sprzedawcy</label>
                        {{ comment_form.comment(class="form-textarea", placeholder="Twoja wiadomość...", rows=4) }}
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"/>
                            </svg>
                            Wyślij wiadomość
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Right Column: Sidebar -->
        <div class="content-sidebar">
            <!-- Order Info Card -->
            <div class="card info-card">
                <h3>Informacje o zamówieniu</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <label>Numer zamówienia</label>
                        <span class="value-highlight">{{ order.order_number }}</span>
                    </div>
                    <div class="info-item">
                        <label>Status</label>
                        <span class="badge" style="background-color: {{ order.status_badge_color }}; color: #fff;">{{ order.status_display_name }}</span>
                    </div>
                </div>

                <!-- Additional Info Section with Dropdown -->
                <div class="additional-info-section">
                    <h4>Dodatkowe informacje</h4>
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Data utworzenia</label>
                            <span>{{ order.created_at|format_datetime('%Y-%m-%d %H:%M') }}</span>
                        </div>
                        <div class="info-item">
                            <label>Ostatnia aktualizacja</label>
                            <span>{{ order.updated_at|format_datetime('%Y-%m-%d %H:%M') }}</span>
                        </div>
                    </div>

                    <!-- Order History Dropdown (ALL activity logs) -->
                    {% if order_history and order_history|length > 0 %}
                    <div class="collapsible-section">
                        <button class="collapsible-trigger" onclick="toggleSection(this)">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="chevron">
                                <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
                            </svg>
                            Historia zamówienia
                        </button>
                        <div class="collapsible-content">
                            <div class="history-list">
                                {% for history_item in order_history %}
                                <div class="history-item">
                                    <span class="history-icon">{{ history_item.action_icon }}</span>
                                    {% if history_item.is_status_change %}
                                        {# Zmiana statusu - kolorowy badge #}
                                        <span class="history-text">
                                            Zmiana statusu:
                                            <span class="badge" style="background-color: {{ history_item.status_color }}; color: #fff; font-size: 0.7rem; padding: 0.15rem 0.4rem; border-radius: 4px; margin-left: 0.25rem;">
                                                {{ history_item.status_name }}
                                            </span>
                                            {% if history_item.user_name != 'System' %}
                                            <span class="history-user">przez {{ history_item.user_name }}</span>
                                            {% endif %}
                                        </span>
                                    {% else %}
                                        {# Inne akcje - zwykły tekst #}
                                        <span class="history-text">
                                            {{ history_item.action_label }}
                                            {% if history_item.user_name != 'System' %}
                                            <span class="history-user">przez {{ history_item.user_name }}</span>
                                            {% endif %}
                                        </span>
                                    {% endif %}
                                    <span class="history-date">{{ history_item.created_at|format_datetime('%Y-%m-%d %H:%M') }}</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Tracking Card -->
            {% if order.tracking_number %}
            <div class="card tracking-card">
                <h3>Śledzenie przesyłki</h3>
                <div class="tracking-info">
                    <div class="tracking-item">
                        <label>Kurier</label>
                        <span class="value-bold">{{ order.courier or '—' }}</span>
                    </div>
                    <div class="tracking-item">
                        <label>Numer przesyłki</label>
                        <span class="value-mono">{{ order.tracking_number }}</span>
                    </div>
                    {% if order.tracking_url %}
                    <a href="{{ order.tracking_url }}" target="_blank" class="btn btn-secondary btn-block">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5z"/>
                            <path d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0v-5z"/>
                        </svg>
                        Śledź przesyłkę
                    </a>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Notes Card (if present) -->
            {% if order.notes %}
            <div class="card notes-card">
                <h3>Twoje notatki</h3>
                <p class="notes-text">{{ order.notes }}</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/pages/client/order-detail.js') }}"></script>
{% endblock %}
