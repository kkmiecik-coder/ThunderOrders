{% extends "client/base_client.html" %}

{% block title %}Potwierdzenia p≈Çatno≈õci - ThunderOrders{% endblock %}

{% block extra_css %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/client/payment-confirmations.css') }}">
{% endblock %}

{% block content %}
<div class="payment-confirmations-page client-view">
    <!-- Page Header -->
    <div class="page-header">
        <h1>Potwierdzenia p≈Çatno≈õci</h1>
        <p class="page-description">
            Wgraj potwierdzenia przelew√≥w dla swoich zam√≥wie≈Ñ. Mo≈ºesz zaznaczyƒá wiele zam√≥wie≈Ñ i wgraƒá jedno potwierdzenie dla wszystkich.
        </p>
    </div>

    <!-- Akcje - przycisk "Wykonaj p≈Çatno≈õƒá" -->
    <div class="pc-actions-bar">
        <button
            id="execute-payment-btn"
            class="btn btn-primary"
            disabled
        >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
            Wykonaj p≈Çatno≈õƒá
        </button>

        <div class="pc-selected-info">
            Zaznaczono: <span id="selected-count">0</span> zam√≥wie≈Ñ
        </div>
    </div>

    <!-- Orders Table -->
    <div class="table-container">
        {% if orders %}
        <table class="orders-table orders-table-new">
            <thead>
                <tr>
                    <th class="pc-col-checkbox">
                        <input
                            type="checkbox"
                            id="select-all"
                            title="Zaznacz wszystkie"
                        >
                    </th>
                    <th class="col-number">Numer zam√≥wienia</th>
                    <th class="col-items hide-mobile">Produkty</th>
                    <th class="col-amount">Kwota do zap≈Çaty</th>
                    <th class="col-paid hide-mobile">Zap≈Çacono</th>
                    <th class="col-remaining hide-mobile">Pozosta≈Ço</th>
                    <th class="col-payments">P≈Çatno≈õci</th>
                    <th class="col-actions">Akcje</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                <tr data-order-id="{{ order.id }}">
                    <td class="pc-col-checkbox" data-label="">
                        <input
                            type="checkbox"
                            class="order-checkbox"
                            data-order-id="{{ order.id }}"
                            data-order-number="{{ order.order_number }}"
                            data-amount="{{ order.effective_total }}"
                            data-product-status="{{ order.product_payment_status }}"
                            {% if not order.can_upload_product_payment %}disabled{% endif %}
                        >
                    </td>

                    <td class="col-number" data-label="Numer">
                        <a href="{{ url_for('orders.client_detail', order_id=order.id) }}" class="order-number-link">
                            {{ order.order_number }}
                        </a>
                    </td>

                    <td class="col-items hide-mobile" data-label="Produkty">
                        <div class="items-list">
                            {% set visible_items = order.sorted_items[:3] %}
                            {% set hidden_items = order.sorted_items[3:] %}

                            {% for item in visible_items %}
                            <div class="item-row{% if item.is_full_set %} item-full-set{% elif item.is_custom %} item-custom{% endif %}">
                                <div class="item-thumb-wrapper">
                                    {% if item.is_full_set %}
                                    <div class="item-thumb item-thumb-icon" style="background: linear-gradient(135deg, #9D4EDD 0%, #7B2CBF 100%);">‚ú®</div>
                                    {% elif item.is_custom %}
                                    <div class="item-thumb item-thumb-icon" style="background: linear-gradient(135deg, #FF8500 0%, #FF6D00 100%);">üì¶</div>
                                    {% else %}
                                    <img src="{{ item.product_image_url }}" alt="" class="item-thumb" loading="lazy">
                                    {% endif %}
                                    {% if item.quantity > 1 %}
                                    <span class="item-qty-badge">{{ item.quantity }}</span>
                                    {% endif %}
                                </div>
                                <div class="item-details">
                                    <span class="item-name{% if item.is_set_fulfilled == False %} text-outside-set{% endif %}" title="{{ item.product_name }}">
                                        {{ item.quantity }}√ó {{ item.product_name|truncate(35, True) }}
                                    </span>
                                    <span class="item-price">{{ "%.2f"|format(item.price) }} z≈Ç/szt</span>
                                </div>
                            </div>
                            {% endfor %}

                            {% if hidden_items|length > 0 %}
                            <div class="items-hidden" id="hiddenItems-{{ order.id }}" style="display: none;">
                                {% for item in hidden_items %}
                                <div class="item-row{% if item.is_full_set %} item-full-set{% elif item.is_custom %} item-custom{% endif %}">
                                    <div class="item-thumb-wrapper">
                                        {% if item.is_full_set %}
                                        <div class="item-thumb item-thumb-icon" style="background: linear-gradient(135deg, #9D4EDD 0%, #7B2CBF 100%);">‚ú®</div>
                                        {% elif item.is_custom %}
                                        <div class="item-thumb item-thumb-icon" style="background: linear-gradient(135deg, #FF8500 0%, #FF6D00 100%);">üì¶</div>
                                        {% else %}
                                        <img src="{{ item.product_image_url }}" alt="" class="item-thumb" loading="lazy">
                                        {% endif %}
                                        {% if item.quantity > 1 %}
                                        <span class="item-qty-badge">{{ item.quantity }}</span>
                                        {% endif %}
                                    </div>
                                    <div class="item-details">
                                        <span class="item-name{% if item.is_set_fulfilled == False %} text-outside-set{% endif %}" title="{{ item.product_name }}">
                                            {{ item.quantity }}√ó {{ item.product_name|truncate(35, True) }}
                                        </span>
                                        <span class="item-price">{{ "%.2f"|format(item.price) }} z≈Ç/szt</span>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <button type="button" class="items-toggle-btn" onclick="toggleOrderItems({{ order.id }}, {{ order.sorted_items|length }})">
                                <span class="toggle-text">W sumie {{ order.sorted_items|length }} przedmiot√≥w - poka≈º pozosta≈Çe</span>
                            </button>
                            {% endif %}
                        </div>
                    </td>

                    <td class="col-amount" data-label="Kwota do zap≈Çaty">
                        <span class="amount-cell">{{ "%.2f"|format(order.grand_total) }} z≈Ç</span>
                    </td>

                    <td class="col-paid hide-mobile" data-label="Zap≈Çacono">
                        <span class="amount-cell pc-paid-value">{{ "%.2f"|format(order.paid_amount) }} z≈Ç</span>
                    </td>

                    <td class="col-remaining hide-mobile" data-label="Pozosta≈Ço">
                        {% set remaining = order.remaining_amount %}
                        <span class="amount-cell pc-remaining-value{% if remaining > 0 %} pc-remaining-positive{% endif %}">
                            {{ "%.2f"|format(remaining) }} z≈Ç
                        </span>
                    </td>

                    <td class="col-payments" data-label="P≈Çatno≈õci">
                        {% set status = order.product_payment_status %}
                        <div class="pc-payment-stages">
                            <div class="pc-stage-row">
                                <span class="pc-stage-label">Produkty</span>
                                <div class="pc-stage-status">
                                    {% if status == 'none' %}
                                    <span class="pc-status-icon pc-status-none" title="Brak potwierdzenia">
                                        <img src="{{ url_for('static', filename='img/icons/payment-none.svg') }}" alt="Brak potwierdzenia" width="18" height="18">
                                    </span>
                                    {% elif status == 'pending' %}
                                    <span class="pc-status-icon pc-status-pending" title="Oczekuje na weryfikacjƒô">
                                        <img src="{{ url_for('static', filename='img/icons/payment-pending.svg') }}" alt="Oczekuje na weryfikacjƒô" width="18" height="18">
                                    </span>
                                    {% elif status == 'approved' %}
                                    <span class="pc-status-icon pc-status-approved" title="Potwierdzone">
                                        <img src="{{ url_for('static', filename='img/icons/payment-approved.svg') }}" alt="Potwierdzone" width="18" height="18">
                                    </span>
                                    {% elif status == 'rejected' %}
                                    <span class="pc-status-icon pc-status-rejected" title="Odrzucone ‚Äî wgraj ponownie">
                                        <img src="{{ url_for('static', filename='img/icons/payment-rejected.svg') }}" alt="Odrzucone" width="18" height="18">
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                            {% if status == 'rejected' and order.product_payment_confirmation and order.product_payment_confirmation.rejection_reason %}
                            <div class="pc-rejection-reason">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 16v-4"/>
                                    <path d="M12 8h.01"/>
                                </svg>
                                <span>{{ order.product_payment_confirmation.rejection_reason }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </td>

                    <td class="col-actions" data-label="Akcje">
                        {% if order.can_upload_product_payment %}
                        <button
                            type="button"
                            class="btn btn-sm btn-primary pc-row-action-btn"
                            data-order-id="{{ order.id }}"
                            data-order-number="{{ order.order_number }}"
                            data-amount="{{ order.effective_total }}"
                            onclick="openPaymentForOrder(this)"
                        >
                            Wykonaj p≈Çatno≈õƒá
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="pc-empty-state">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 12h-6l-2 3h-4l-2-3H2"/>
                <path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/>
            </svg>
            <h3>Brak zam√≥wie≈Ñ wymagajƒÖcych potwierdzenia</h3>
            <p>Nie masz ≈ºadnych zam√≥wie≈Ñ oczekujƒÖcych na potwierdzenie p≈Çatno≈õci.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal p≈Çatno≈õci -->
<div id="payment-modal" class="modal-overlay">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h2 class="modal-title">Wykonaj p≈Çatno≈õƒá</h2>
            <button type="button" class="modal-close" id="modal-close-btn">&times;</button>
        </div>

        <div class="modal-body">
            <!-- Wizard steps indicator -->
            <div class="wizard-steps">
                <div class="wizard-step active" data-step="1">
                    <span class="step-number">1</span>
                    <span class="step-label">Wyb√≥r p≈Çatno≈õci</span>
                </div>
                <div class="wizard-step" data-step="2">
                    <span class="step-number">2</span>
                    <span class="step-label">Przelew i potwierdzenie</span>
                </div>
            </div>

            <!-- Krok 1: Lista zam√≥wie≈Ñ z etapami -->
            <div class="wizard-content" id="pc-wizard-step-1">
                <div id="pc-orders-stages">
                    <!-- JS wype≈Çnia listƒô zam√≥wie≈Ñ z kafelkami etap√≥w -->
                </div>
                <div class="pc-summary-box pc-summary-box-inline">
                    <div class="pc-summary-row pc-summary-total">
                        <span class="pc-summary-label">Kwota do przelewu:</span>
                        <span class="pc-summary-value pc-summary-amount" id="wizard-total-amount">0.00 z≈Ç</span>
                    </div>
                </div>
            </div>

            <!-- Krok 2: Dane do przelewu + upload -->
            <div class="wizard-content" id="pc-wizard-step-2" style="display: none;">
                <h3 class="pc-section-title">Dane do przelewu</h3>
                <div id="payment-methods-container">
                    <div class="pc-loading">≈Åadowanie metod p≈Çatno≈õci...</div>
                </div>
                <div class="pc-summary-box pc-summary-box-inline">
                    <div class="pc-summary-row pc-summary-total">
                        <span class="pc-summary-label">Kwota do przelewu:</span>
                        <span class="pc-summary-value pc-summary-amount" id="total-amount-value">0.00 z≈Ç</span>
                    </div>
                </div>

                <hr class="pc-separator">

                <h3 class="pc-section-title">Wgraj potwierdzenie przelewu</h3>
                <form id="upload-form" enctype="multipart/form-data">
                    <div class="pc-upload-area" id="upload-dropzone">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        <p class="pc-upload-text">PrzeciƒÖgnij plik tutaj lub <span class="pc-upload-browse">wybierz z dysku</span></p>
                        <span class="pc-upload-hint">JPG, PNG, PDF ‚Äî max 5MB</span>
                        <input
                            type="file"
                            id="proof-file"
                            name="proof_file"
                            accept=".jpg,.jpeg,.png,.pdf"
                            required
                        >
                    </div>
                    <div class="pc-file-preview" id="file-preview"></div>
                </form>
            </div>
        </div>

        <!-- Footer z nawigacjƒÖ wizard -->
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="wizard-back-btn" style="display: none;">Wstecz</button>
            <button type="button" class="btn btn-secondary" id="cancel-btn">Anuluj</button>
            <button type="button" class="btn btn-primary" id="wizard-next-btn" disabled>Dalej</button>
            <button type="submit" class="btn btn-primary" id="submit-btn" form="upload-form" style="display: none;">Prze≈õlij potwierdzenie</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/pages/client/payment-confirmations.js') }}"></script>
{% endblock %}
