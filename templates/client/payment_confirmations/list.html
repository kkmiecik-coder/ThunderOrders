{% extends "client/base_client.html" %}

{% block title %}Potwierdzenia p≈Çatno≈õci - ThunderOrders{% endblock %}

{% block extra_css %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/client/payment-confirmations.css') }}">
{% endblock %}

{% block content %}
<div class="payment-confirmations-page client-view">
    <!-- Page Header -->
    <div class="page-header">
        <h1>Potwierdzenia p≈Çatno≈õci</h1>
        <p class="page-description">
            Wgraj potwierdzenia przelew√≥w dla swoich zam√≥wie≈Ñ. Mo≈ºesz zaznaczyƒá wiele zam√≥wie≈Ñ i wgraƒá jedno potwierdzenie dla wszystkich.
        </p>
    </div>

    <!-- Akcje - przycisk "Wykonaj p≈Çatno≈õƒá" -->
    <div class="pc-actions-bar">
        <button
            id="execute-payment-btn"
            class="btn btn-primary"
            disabled
        >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
            Wykonaj p≈Çatno≈õƒá
        </button>

        <div class="pc-selected-info">
            Zaznaczono: <span id="selected-count">0</span> zam√≥wie≈Ñ
        </div>
    </div>

    <!-- Orders Table -->
    <div class="table-container">
        {% if orders %}
        <table class="orders-table orders-table-new">
            <thead>
                <tr>
                    <th class="pc-col-checkbox">
                        <input
                            type="checkbox"
                            id="select-all"
                            title="Zaznacz wszystkie"
                        >
                    </th>
                    <th class="col-number">Numer zam√≥wienia</th>
                    <th class="col-items hide-mobile">Produkty</th>
                    <th class="col-amount">Kwota</th>
                    <th class="col-stage">E1: Produkt</th>
                    {% if any_order_has_4_stages %}
                    <th class="col-stage">E2: Wysy≈Çka KR</th>
                    {% endif %}
                    <th class="col-stage">E3: C≈Ço/VAT</th>
                    <th class="col-stage">E4: Wysy≈Çka PL</th>
                    <th class="col-actions">Akcje</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                <tr data-order-id="{{ order.id }}"
                    data-payment-stages="{{ order.payment_stages or 3 }}"
                    data-stage2-status="{{ order.stage_2_status or '' }}"
                    data-stage3-status="{{ order.stage_3_status }}"
                    data-stage4-status="{{ order.stage_4_status }}"
                    data-can-upload-stage2="{{ 'true' if order.can_upload_stage_2 else 'false' }}"
                    data-can-upload-stage3="{{ 'true' if order.can_upload_stage_3 else 'false' }}"
                    data-can-upload-stage4="{{ 'true' if order.can_upload_stage_4 else 'false' }}"
                    data-proxy-shipping-amount="{{ order.proxy_shipping_total }}"
                    data-customs-vat-amount="{{ order.customs_vat_total }}"
                    data-shipping-cost-amount="{{ order.shipping_cost or 0 }}"
                >
                    <td class="pc-col-checkbox" data-label="">
                        <input
                            type="checkbox"
                            class="order-checkbox"
                            data-order-id="{{ order.id }}"
                            data-order-number="{{ order.order_number }}"
                            data-amount="{{ order.effective_total }}"
                            data-product-status="{{ order.product_payment_status }}"
                            data-payment-stages="{{ order.payment_stages or 3 }}"
                            {% if not (order.can_upload_product_payment or order.can_upload_stage_2 or order.can_upload_stage_3 or order.can_upload_stage_4) %}disabled{% endif %}
                        >
                    </td>

                    <td class="col-number" data-label="Numer">
                        <a href="{{ url_for('orders.client_detail', order_id=order.id) }}" class="order-number-link">
                            {{ order.order_number }}
                        </a>
                    </td>

                    <td class="col-items hide-mobile" data-label="Produkty">
                        <div class="items-list">
                            {% set visible_items = order.sorted_items[:3] %}
                            {% set hidden_items = order.sorted_items[3:] %}

                            {% for item in visible_items %}
                            <div class="item-row{% if item.is_full_set %} item-full-set{% elif item.is_custom %} item-custom{% endif %}">
                                <div class="item-thumb-wrapper">
                                    {% if item.is_full_set %}
                                    <div class="item-thumb item-thumb-icon" style="background: linear-gradient(135deg, #9D4EDD 0%, #7B2CBF 100%);">‚ú®</div>
                                    {% elif item.is_custom %}
                                    <div class="item-thumb item-thumb-icon" style="background: linear-gradient(135deg, #FF8500 0%, #FF6D00 100%);">üì¶</div>
                                    {% else %}
                                    <img src="{{ item.product_image_url }}" alt="" class="item-thumb" loading="lazy">
                                    {% endif %}
                                    {% if item.quantity > 1 %}
                                    <span class="item-qty-badge">{{ item.quantity }}</span>
                                    {% endif %}
                                </div>
                                <div class="item-details">
                                    <span class="item-name{% if item.is_set_fulfilled == False %} text-outside-set{% endif %}" title="{{ item.product_name }}">
                                        {{ item.quantity }}√ó {{ item.product_name|truncate(35, True) }}
                                    </span>
                                    <span class="item-price">{{ "%.2f"|format(item.price) }} z≈Ç/szt</span>
                                </div>
                            </div>
                            {% endfor %}

                            {% if hidden_items|length > 0 %}
                            <div class="items-hidden" id="hiddenItems-{{ order.id }}" style="display: none;">
                                {% for item in hidden_items %}
                                <div class="item-row{% if item.is_full_set %} item-full-set{% elif item.is_custom %} item-custom{% endif %}">
                                    <div class="item-thumb-wrapper">
                                        {% if item.is_full_set %}
                                        <div class="item-thumb item-thumb-icon" style="background: linear-gradient(135deg, #9D4EDD 0%, #7B2CBF 100%);">‚ú®</div>
                                        {% elif item.is_custom %}
                                        <div class="item-thumb item-thumb-icon" style="background: linear-gradient(135deg, #FF8500 0%, #FF6D00 100%);">üì¶</div>
                                        {% else %}
                                        <img src="{{ item.product_image_url }}" alt="" class="item-thumb" loading="lazy">
                                        {% endif %}
                                        {% if item.quantity > 1 %}
                                        <span class="item-qty-badge">{{ item.quantity }}</span>
                                        {% endif %}
                                    </div>
                                    <div class="item-details">
                                        <span class="item-name{% if item.is_set_fulfilled == False %} text-outside-set{% endif %}" title="{{ item.product_name }}">
                                            {{ item.quantity }}√ó {{ item.product_name|truncate(35, True) }}
                                        </span>
                                        <span class="item-price">{{ "%.2f"|format(item.price) }} z≈Ç/szt</span>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <button type="button" class="items-toggle-btn" onclick="toggleOrderItems({{ order.id }}, {{ order.sorted_items|length }})">
                                <span class="toggle-text">W sumie {{ order.sorted_items|length }} przedmiot√≥w - poka≈º pozosta≈Çe</span>
                            </button>
                            {% endif %}
                        </div>
                    </td>

                    <td class="col-amount" data-label="Kwota">
                        <span class="amount-cell">{{ "%.2f"|format(order.effective_total) }} z≈Ç</span>
                    </td>

                    <!-- E1: Produkt -->
                    <td class="col-stage" data-label="E1">
                        {% set e1_status = order.product_payment_status %}
                        {% if e1_status == 'approved' %}
                            <span class="pc-stage-badge pc-stage-badge-paid">Op≈Çacone</span>
                        {% elif e1_status == 'pending' %}
                            <span class="pc-stage-badge pc-stage-badge-pending">Weryfikacja</span>
                        {% elif e1_status == 'rejected' %}
                            <span class="pc-stage-badge pc-stage-badge-rejected">Odrzucone</span>
                        {% else %}
                            <span class="pc-stage-badge pc-stage-badge-soon">Oczekuje</span>
                        {% endif %}
                    </td>

                    <!-- E2: Wysy≈Çka KR - tylko dla 4-p≈Çatno≈õciowych -->
                    {% if any_order_has_4_stages %}
                    <td class="col-stage" data-label="E2">
                        {% if order.payment_stages == 4 %}
                            {% set e2_status = order.stage_2_status %}
                            {% if e2_status == 'approved' %}
                                <span class="pc-stage-badge pc-stage-badge-paid">Op≈Çacone</span>
                            {% elif e2_status == 'pending' %}
                                <span class="pc-stage-badge pc-stage-badge-pending">Weryfikacja</span>
                            {% elif e2_status == 'rejected' %}
                                <span class="pc-stage-badge pc-stage-badge-rejected">Odrzucone</span>
                            {% elif order.can_upload_stage_2 %}
                                <span class="pc-stage-badge pc-stage-badge-ready">Do zap≈Çaty</span>
                            {% else %}
                                <span class="pc-stage-badge pc-stage-badge-locked">Zablokowane</span>
                            {% endif %}
                        {% else %}
                            <span class="pc-stage-badge pc-stage-badge-na">Nie dotyczy</span>
                        {% endif %}
                    </td>
                    {% endif %}

                    <!-- E3: C≈Ço/VAT - zawsze -->
                    <td class="col-stage" data-label="E3">
                        {% set e3_status = order.stage_3_status %}
                        {% if e3_status == 'approved' %}
                            <span class="pc-stage-badge pc-stage-badge-paid">Op≈Çacone</span>
                        {% elif e3_status == 'pending' %}
                            <span class="pc-stage-badge pc-stage-badge-pending">Weryfikacja</span>
                        {% elif e3_status == 'rejected' %}
                            <span class="pc-stage-badge pc-stage-badge-rejected">Odrzucone</span>
                        {% elif order.can_upload_stage_3 %}
                            <span class="pc-stage-badge pc-stage-badge-ready">Do zap≈Çaty</span>
                        {% else %}
                            <span class="pc-stage-badge pc-stage-badge-locked">Zablokowane</span>
                        {% endif %}
                    </td>

                    <!-- E4: Wysy≈Çka PL - zawsze -->
                    <td class="col-stage" data-label="E4">
                        {% set e4_status = order.stage_4_status %}
                        {% if e4_status == 'approved' %}
                            <span class="pc-stage-badge pc-stage-badge-paid">Op≈Çacone</span>
                        {% elif e4_status == 'pending' %}
                            <span class="pc-stage-badge pc-stage-badge-pending">Weryfikacja</span>
                        {% elif e4_status == 'rejected' %}
                            <span class="pc-stage-badge pc-stage-badge-rejected">Odrzucone</span>
                        {% elif order.can_upload_stage_4 %}
                            <span class="pc-stage-badge pc-stage-badge-ready">Do zap≈Çaty</span>
                        {% else %}
                            <span class="pc-stage-badge pc-stage-badge-locked">Zablokowane</span>
                        {% endif %}
                    </td>

                    <td class="col-actions" data-label="Akcje">
                        {% if order.can_upload_product_payment or order.can_upload_stage_2 or order.can_upload_stage_3 or order.can_upload_stage_4 %}
                        <button
                            type="button"
                            class="btn btn-sm btn-primary pc-row-action-btn"
                            data-order-id="{{ order.id }}"
                            data-order-number="{{ order.order_number }}"
                            data-amount="{{ order.effective_total }}"
                            onclick="openPaymentForOrder(this)"
                        >
                            Wykonaj p≈Çatno≈õƒá
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="pc-empty-state">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 12h-6l-2 3h-4l-2-3H2"/>
                <path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/>
            </svg>
            <h3>Brak zam√≥wie≈Ñ wymagajƒÖcych potwierdzenia</h3>
            <p>Nie masz ≈ºadnych zam√≥wie≈Ñ oczekujƒÖcych na potwierdzenie p≈Çatno≈õci.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal p≈Çatno≈õci -->
<div id="payment-modal" class="modal-overlay">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h2 class="modal-title">Wykonaj p≈Çatno≈õƒá</h2>
            <button type="button" class="modal-close" id="modal-close-btn">&times;</button>
        </div>

        <div class="modal-body">
            <!-- Wizard steps indicator -->
            <div class="wizard-steps">
                <div class="wizard-step active" data-step="1">
                    <span class="step-number">1</span>
                    <span class="step-label">Wyb√≥r p≈Çatno≈õci</span>
                </div>
                <div class="wizard-step" data-step="2">
                    <span class="step-number">2</span>
                    <span class="step-label">Przelew i potwierdzenie</span>
                </div>
            </div>

            <!-- Krok 1: Lista zam√≥wie≈Ñ z etapami -->
            <div class="wizard-content" id="pc-wizard-step-1">
                <div id="pc-orders-stages">
                    <!-- JS wype≈Çnia listƒô zam√≥wie≈Ñ z kafelkami etap√≥w -->
                </div>
                <div class="pc-summary-box pc-summary-box-inline">
                    <div class="pc-summary-row pc-summary-total">
                        <span class="pc-summary-label">Kwota do przelewu:</span>
                        <span class="pc-summary-value pc-summary-amount" id="wizard-total-amount">0.00 z≈Ç</span>
                    </div>
                </div>
            </div>

            <!-- Krok 2: Dane do przelewu + upload -->
            <div class="wizard-content" id="pc-wizard-step-2" style="display: none;">
                <h3 class="pc-section-title">Dane do przelewu</h3>
                <div id="payment-methods-container">
                    <div class="pc-loading">≈Åadowanie metod p≈Çatno≈õci...</div>
                </div>
                <div class="pc-summary-box pc-summary-box-inline">
                    <div class="pc-summary-row pc-summary-total">
                        <span class="pc-summary-label">Kwota do przelewu:</span>
                        <span class="pc-summary-value pc-summary-amount" id="total-amount-value">0.00 z≈Ç</span>
                    </div>
                </div>

                <hr class="pc-separator">

                <h3 class="pc-section-title">Wgraj potwierdzenie przelewu</h3>
                <form id="upload-form" enctype="multipart/form-data">
                    <div class="pc-upload-area" id="upload-dropzone">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        <p class="pc-upload-text">PrzeciƒÖgnij plik tutaj lub <span class="pc-upload-browse">wybierz z dysku</span></p>
                        <span class="pc-upload-hint">JPG, PNG, PDF ‚Äî max 5MB</span>
                        <input
                            type="file"
                            id="proof-file"
                            name="proof_file"
                            accept=".jpg,.jpeg,.png,.pdf"
                            required
                        >
                    </div>
                    <div class="pc-file-preview" id="file-preview"></div>
                </form>
            </div>
        </div>

        <!-- Footer z nawigacjƒÖ wizard -->
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="wizard-back-btn" style="display: none;">Wstecz</button>
            <button type="button" class="btn btn-secondary" id="cancel-btn">Anuluj</button>
            <button type="button" class="btn btn-primary" id="wizard-next-btn" disabled>Dalej</button>
            <button type="submit" class="btn btn-primary" id="submit-btn" form="upload-form" style="display: none;">Prze≈õlij potwierdzenie</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/pages/client/payment-confirmations.js') }}"></script>
{% endblock %}
